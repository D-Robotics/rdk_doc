<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-docs_s docs-version-current docs-doc-page docs-doc-id-Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Sunrise camera 开发说明 | RDK DOC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" property="og:title" content="Sunrise camera 开发说明 | RDK DOC"><meta data-rh="true" name="description" content="Sunrise camera 系统设计"><meta data-rh="true" property="og:description" content="Sunrise camera 系统设计"><link data-rh="true" rel="icon" href="/rdk_doc/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"7. 进阶开发","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development"},{"@type":"ListItem","position":2,"name":"7.3 多媒体开发指南","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/03_multimedia_development"},{"@type":"ListItem","position":3,"name":"7.3.2 多媒体应用开发 ","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/02_multimedia_application"},{"@type":"ListItem","position":4,"name":"Sunrise camera 开发说明","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide"}]}</script><script src="https://hm.baidu.com/hm.js?24dd63cad43b63889ea6bede5fd1ab9e" async></script><link rel="stylesheet" href="/rdk_doc/en/assets/css/styles.0fbd7d27.css">
<script src="/rdk_doc/en/assets/js/runtime~main.a8126181.js" defer="defer"></script>
<script src="/rdk_doc/en/assets/js/main.c7b8d15d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">D-Robotics</b></a><a class="navbar__item navbar__link" href="/rdk_doc/en/RDK">RDK X3 / X5</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rdk_doc/en/rdk_s/RDK">RDK S100</a><a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>EN</a><ul class="dropdown__menu"><li><a href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">CN</a></li><li><a href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">EN</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rdk_doc/en/rdk_s/RDK">D-Robotics RDK 套件</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Quick_start">1. 快速开始</a><button aria-label="Expand sidebar category &#x27;1. 快速开始&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/System_configuration">2. 系统配置</a><button aria-label="Expand sidebar category &#x27;2. 系统配置&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Basic_Application">3. 基础应用开发</a><button aria-label="Expand sidebar category &#x27;3. 基础应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Basic_Development">4. 算法应用开发</a><button aria-label="Expand sidebar category &#x27;4. 算法应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Robot_development">5. 机器人应用开发</a><button aria-label="Expand sidebar category &#x27;5. 机器人应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Application_case">6. 应用开发指南</a><button aria-label="Expand sidebar category &#x27;6. 应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rdk_doc/en/rdk_s/Advanced_development">7. 进阶开发</a><button aria-label="Collapse sidebar category &#x27;7. 进阶开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/hardware_development">7.1 硬件开发指南</a><button aria-label="Expand sidebar category &#x27;7.1 硬件开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/linux_development">7.2. Linux开发指南</a><button aria-label="Expand sidebar category &#x27;7.2. Linux开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/rdk_s/03_multimedia_development">7.3 多媒体开发指南</a><button aria-label="Collapse sidebar category &#x27;7.3 多媒体开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/category/731-s100-多媒体开发指南">7.3.1 S100 多媒体开发指南</a><button aria-label="Expand sidebar category &#x27;7.3.1 S100 多媒体开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/rdk_s/02_multimedia_application">7.3.2 多媒体应用开发 </a><button aria-label="Collapse sidebar category &#x27;7.3.2 多媒体应用开发 &#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/overview">示例代码介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_vin">sample_vin 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_isp">sample_isp 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_pym">sample_pym 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_gdc">sample_gdc 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_codec">sample_codec 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_gpu_3d">sample_gpu_3d 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sample_pipeline">sample_pipeline 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_user_guide">sunrise camera 使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_develop_guide">Sunrise camera 开发说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/hbmem_sample_guide">hbmem sample 使用说明</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/04_toolchain_development">7.4 算法工具链开发指南</a><button aria-label="Expand sidebar category &#x27;7.4 算法工具链开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/05_MCU_development">7.5 MCU开发指南</a><button aria-label="Expand sidebar category &#x27;7.5 MCU开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/rdk_gen">7.6 RDK S100构建系统开发指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/FAQ">8. 常见问题</a><button aria-label="Expand sidebar category &#x27;8. 常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Appendix">9. 附录</a><button aria-label="Expand sidebar category &#x27;9. 附录&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rdk_doc/en/rdk_s/Release_Note/roadmap">10. 版本发布</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rdk_doc/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/Advanced_development"><span>7. 进阶开发</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/03_multimedia_development"><span>7.3 多媒体开发指南</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/02_multimedia_application"><span>7.3.2 多媒体应用开发 </span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Sunrise camera 开发说明</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Sunrise camera 开发说明</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sunrise-camera-系统设计">Sunrise camera 系统设计<a href="#sunrise-camera-系统设计" class="hash-link" aria-label="Direct link to Sunrise camera 系统设计" title="Direct link to Sunrise camera 系统设计">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="系统框图">系统框图<a href="#系统框图" class="hash-link" aria-label="Direct link to 系统框图" title="Direct link to 系统框图">​</a></h3>
<p>Sunrise camera 实现了智能摄像机、智能分析盒等多种应用方案。</p>
<p>Sunrise camera 源码包括用户操作层的 WebPages、通信模块层、功能模块层；本文档主要介绍这三个模块的设计。</p>
<p>Hal 层模块包括多媒体相关模块调用接口库， BPU 模块推理库等；</p>
<p>Kernel 版本包含标准驱动库的基础上，系统 BSP。</p>
<p>软件框图如下所示：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/software_framework.png" alt="software_framwork" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="微核设计">微核设计<a href="#微核设计" class="hash-link" aria-label="Direct link to 微核设计" title="Direct link to 微核设计">​</a></h3>
<p>微核架构（ microkernel architecture ）又称为“插件架构”（ plug-in architecture ），指的是软件的内核相对较小，主要功能和业务逻辑都通过插件实现。</p>
<p>内核（ core ）通常只包含系统运行的最小功能。插件则是互相独立的，插件之间的通信，应该减少到最低，避免出现互相依赖的问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="架构优缺点">架构优缺点<a href="#架构优缺点" class="hash-link" aria-label="Direct link to 架构优缺点" title="Direct link to 架构优缺点">​</a></h3>
<p><strong>优点</strong></p>
<p>良好的功能延伸性，需要什么功能 ，开发插件即可。</p>
<p>功能之间是隔离的，插件可以独立的加载和卸载，容易部署。</p>
<p>可定制性高，适应不同的开发需要。</p>
<p>可以渐进式开发，逐步添加功能。</p>
<p><strong>缺点</strong></p>
<p>扩展性差，内核通常是一个独立单元，不容易做成分布式。</p>
<p>开发难度相对较高，因为涉及到插件与内核的通信，以及插件登记。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sunrise-camera-架构视图">Sunrise camera 架构视图<a href="#sunrise-camera-架构视图" class="hash-link" aria-label="Direct link to Sunrise camera 架构视图" title="Direct link to Sunrise camera 架构视图">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模块划分">模块划分<a href="#模块划分" class="hash-link" aria-label="Direct link to 模块划分" title="Direct link to 模块划分">​</a></h3>
<table><thead><tr><th><strong>模块</strong></th><th><strong>目录</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>事件总线模块</td><td>communicate</td><td>实现模块的事件注册、事件接收、事件分发</td></tr><tr><td>公共库模块</td><td>common</td><td>公共操作函数， log/lock，线程操作，队列操作等</td></tr><tr><td>Camera 模块</td><td>Platform</td><td>芯片平台相关代码，实现硬件差异部分的封装</td></tr><tr><td>对外交互模块</td><td>Transport</td><td>设备和外接交互部分， rtspserver、 websocket 等</td></tr><tr><td>主程序入口</td><td>Main</td><td>Main 函数入口</td></tr></tbody></table>
<p><strong>顶层代码结构</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common						# 公共库模块代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── communicate					# 事件总线模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config						# 编译配置目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── main						# 主入口程序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile					# 编译脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── makefile.param				# 编译配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Platform					# Camera 模块，平台、应用场景代码，芯片 IP 相关代码都在本目录下实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── start_app.sh				# 启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── sunrise_camera.service 		# 开启自启动配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── third_party					# 依赖的第三方库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Transport					# rtspserver 和 websocket 模块代码实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── VERSION						# 版本信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── WebServer					# web 页面的程序和资源文件</span><br></span></code></pre></div></div>
<p><strong>编译</strong></p>
<ol>
<li>登录设备，进入目录：<code>/app/multimedia_samples/sunrise_camera</code></li>
<li>执行命令: <code>make</code></li>
<li>生成的目标文件：<code>sunrise_camera</code></li>
</ol>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:/app/multimedia_samples/sunrise_camera# ls sunrise_camera/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log  sunrise_camera  www</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="事件总线模块-communicate-">事件总线模块（ communicate ）<a href="#事件总线模块-communicate-" class="hash-link" aria-label="Direct link to 事件总线模块（ communicate ）" title="Direct link to 事件总线模块（ communicate ）">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>事件总线模块，最小运行单位；根据编译选项调用不同模块的注册接口函数，并且完成不同模块 CMD 的接收和分发。</p>
<p>当模块间交互时，接收到的 CMD 如果已经注册和使能，则中转到受理子模块处理，处理完成后向请求模块返回处理结果。</p>
<p>当模块间交互时，接收到的 CMD 没有注册或者未使能，则 CMD 调用失败。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能描述">功能描述<a href="#功能描述" class="hash-link" aria-label="Direct link to 功能描述" title="Direct link to 功能描述">​</a></h4>
<ol>
<li>模块插件静态插拔控制</li>
<li>模块 CMD 指令中转</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/event_bus.png" alt="event_bus" class="img_ev3q"></p>
<p>示例：</p>
<p>camera 子模块中定义了 SDK_CMD_CAMERA_GET_CHIP_TYPE 命令，调用 camera_cmd_register 函数注册该 CMD 后，当 websocket 子模块收到 web 页面请求获取芯片类型时， websocket 模块可以通过以下代码调用 camera 子模块中的接口。</p>
<p>整个过程如下图所示：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/event_bus_flow.png" alt="event_bus_flow" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="模块代码结构">模块代码结构<a href="#模块代码结构" class="hash-link" aria-label="Direct link to 模块代码结构" title="Direct link to 模块代码结构">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── sdk_common_cmd.h			# 定义系统中所有子模块的 CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── sdk_common_struct.h		    # 定义每个 CMD 对应使用到的数据结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── sdk_communicate.h			# 定义本模块接口函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── sdk_communicate.c			# 接口代码实现</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="接口描述">接口描述<a href="#接口描述" class="hash-link" aria-label="Direct link to 接口描述" title="Direct link to 接口描述">​</a></h4>
<p><strong>sdk_globle_prerare</strong></p>
<p>各子模块的 xxx_cmd_register() 函数会集中放到这个函数中，主程序启动时，通过调用本接口将所有子模块需要注册并使能的的 CMD 注册进子系统中。</p>
<p>每个子模块都要实现 xxx_cmd_register()，在该函数中实现子模块 CMD 注册。这是整个系统能够正常运行的基本前提。</p>
<p>示例：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/cmd_register.png" alt="cmd_register" class="img_ev3q"></p>
<p><strong>sdk_cmd_register</strong></p>
<p>CMD 注册接口。</p>
<p><strong>sdk_cmd_unregister</strong></p>
<p>CMD 注销接口。</p>
<p><strong>sdk_cmd_impl</strong></p>
<p>子模块通过调用本接口实现调用其他子模块实现的接口功能。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="公共库模块-common-">公共库模块（ common ）<a href="#公共库模块-common-" class="hash-link" aria-label="Direct link to 公共库模块（ common ）" title="Direct link to 公共库模块（ common ）">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述-1">概述<a href="#概述-1" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>程序公共库类，包含但不限于日志操作、锁操作、线程封装、base64 ；</p>
<p>本模块主要把编程中会使用到的公共类、公共函数进行封装；避免相同操作的函数实现在多处出现。</p>
<p>本模块的更新影响所有模块，需要谨慎操作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能描述-1">功能描述<a href="#功能描述-1" class="hash-link" aria-label="Direct link to 功能描述" title="Direct link to 功能描述">​</a></h4>
<p>无</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="模块代码结构-1">模块代码结构<a href="#模块代码结构-1" class="hash-link" aria-label="Direct link to 模块代码结构" title="Direct link to 模块代码结构">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile					# 编译脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── makefile.param</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── include				    # 头文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── aes256.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── base64.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── cJSON_Direct.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── cmap.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── common_utils.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── cqueue.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── gen_rand.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── lock_utils.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── mqueue.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── mthread.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── nalu_utils.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── sha256.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── stream_define.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── stream_manager.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── utils_log.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── src                      # 实现源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── aes256.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── base64.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── cJSON_Direct.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── cmap.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── common_utils.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── cqueue.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── gen_rand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── lock_utils.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── mqueue.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── mthread.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── nalu_utils.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── sha256.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── stream_manager.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── utils_log.c</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="platform-模块">Platform 模块<a href="#platform-模块" class="hash-link" aria-label="Direct link to Platform 模块" title="Direct link to Platform 模块">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述-2">概述<a href="#概述-2" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>模块主要包括：视频编码、 ISP 控制、图像控制、抓拍、视频输出、算法运算等。</p>
<p>本模块内部结构如下：</p>
<p>api_vpp 作为本模块入口，定义支持的 CMD 命令集；</p>
<p>solution_handle 完成应用配置读写、场景接口赋值；</p>
<p>vpp_camera_impl、 vpp_box_impl 实现应用场景功能；</p>
<p>vp_wrap 实现多媒体模块的接口封装；</p>
<p>bpu_wrap 模块实现算法推理接口和后处理方法的封装。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/platform_module.png" alt="platform_module" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能描述-2">功能描述<a href="#功能描述-2" class="hash-link" aria-label="Direct link to 功能描述" title="Direct link to 功能描述">​</a></h4>
<p>新增一个应用场景的实现，只要实现 vpp_ops_t 结构体定义的接口即可。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">vpp_ops</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">init_param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 VIN、 VSE、 VENC、 BPU 等模块的配置参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// sdk 初始化，根据配置初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">uninit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 反初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 启动媒体相关的各个模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 本模块支持的 CMD 都通过以下两个接口简直实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">param_set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SOLUTION_PARAM_E type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">param_get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SOLUTION_PARAM_E type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token class-name">vpp_ops_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>启动一个应用方案（以启动 vpp_camera 为例）的流程如下：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/vpp_camera_flow.png" alt="vpp_camera_flow" class="img_ev3q"></p>
<p>其他子模块的初始化、启动流程都可以参考本流程图。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="模块代码结构-2">模块代码结构<a href="#模块代码结构-2" class="hash-link" aria-label="Direct link to 模块代码结构" title="Direct link to 模块代码结构">​</a></h4>
<p>代码路径： Platform/S100</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api                                   # CMD 注册</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── bpu_wrap                              # bpu 算法接口使用封装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── main                                  # CMD 注册的实际功能接口实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile                              # 编译脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── makefile.param                        # 编译配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── model_zoom                            # 算法模型仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── test_data                             # 存放测试用的视频码流文件和程序配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── vpp_impl                              # 应用方案的功能实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── vp_sensors -&gt; ../../../vp_sensors/    # Camera Sensor 配置代码，本目录下的代码与其他 sample 模块共用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── vp_wrap                               # 多媒体接口的封装</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="对外交互模块-transport-">对外交互模块（ Transport ）<a href="#对外交互模块-transport-" class="hash-link" aria-label="Direct link to 对外交互模块（ Transport ）" title="Direct link to 对外交互模块（ Transport ）">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述-3">概述<a href="#概述-3" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>遵循传输协议与终端或平台交互的具体子模块；包含通过网络、 rtspserver 和 websocket 通信模块；</p>
<p>交互模块是模块间交互最多的部分，需要严格遵守设计约定。在向其他模块请求数据时都要通过定义的模块 CMD 进行处理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="meida-server-模块">Meida Server 模块<a href="#meida-server-模块" class="hash-link" aria-label="Direct link to Meida Server 模块" title="Direct link to Meida Server 模块">​</a></h4>
<p>本模块是对 ZLMediakit 的封装实现，把 ZLMediakit 封装成 init、 create_media、push_video 等几个简单接口。目前支持 H264和H265 码流的推流。</p>
<p>本模块的启动和使用可以参考 主程序入口 章节的流程介绍。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="wesocket-server-模块">Wesocket Server 模块<a href="#wesocket-server-模块" class="hash-link" aria-label="Direct link to Wesocket Server 模块" title="Direct link to Wesocket Server 模块">​</a></h4>
<p>本模块完成与 web 上的操作交互，在 web 上进行相应操作后， websocket server 接收到相应 kind 的命令和参数，在代码 handle_user_massage.c 的 handle_user_msg 函数中处理进行相应的功能处理，如果要添加新的交互命令，请在该函数中增加。</p>
<p>目前支持的交互命令：场景切换、场景参数获取和设置、获取芯片类型、 h264 码率设置、系统时间同步、 websocket 码流拉流和停止等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主程序入口-main-">主程序入口（ main ）<a href="#主程序入口-main-" class="hash-link" aria-label="Direct link to 主程序入口（ main ）" title="Direct link to 主程序入口（ main ）">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述-4">概述<a href="#概述-4" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>主程序入口，模块启动。</p>
<p>当前基本的子模块启动顺序如下，需要注意各模块启动顺序需要根据子模块间的依赖关系顺序启动。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="执行流程">执行流程<a href="#执行流程" class="hash-link" aria-label="Direct link to 执行流程" title="Direct link to 执行流程">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/main_flow.png" alt="main_flow" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="webserver">WebServer<a href="#webserver" class="hash-link" aria-label="Direct link to WebServer" title="Direct link to WebServer">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="概述-5">概述<a href="#概述-5" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4>
<p>本模块通过 ZLMediakit 实现 HTTP协议的 web 服务，让用户可以直接通过浏览器预览视频和配置应用场景。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="功能描述-3">功能描述<a href="#功能描述-3" class="hash-link" aria-label="Direct link to 功能描述" title="Direct link to 功能描述">​</a></h4>
<p><code>WebServer/www</code>目录下提供了： 资源文件、web 页面、 css、 js 程序。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-bpu-进行算法推理">使用 BPU 进行算法推理<a href="#使用-bpu-进行算法推理" class="hash-link" aria-label="Direct link to 使用 BPU 进行算法推理" title="Direct link to 使用 BPU 进行算法推理">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="概述-6">概述<a href="#概述-6" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h3>
<p>本模块完成算法模型加载、数据前处理、推理、算法后处理并返回 json 格式的结果。</p>
<p>模块运行时序如下：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/bpu_flow.png" alt="bpu_flow" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加一个新模型流程">添加一个新模型流程<a href="#添加一个新模型流程" class="hash-link" aria-label="Direct link to 添加一个新模型流程" title="Direct link to 添加一个新模型流程">​</a></h3>
<p>当前 sunrise_camera 仅支持少量算法模型的运行，在实际应用中不可避免要跑其他的模型来测试效果，本节描述新增一个算法模型的基本步骤。</p>
<table><thead><tr><th><strong>项目</strong></th><th><strong>源码文件</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>准备算法模型</td><td>放到 Platform/s100/model_zoom 目录下（*.hbm）</td><td>在本目录添加可以在开发板上运行的定点算法模型 (系统自带的模型文文件存储在：<code>/opt/hobot/model/s100/basic/</code>)</td></tr><tr><td>添加模型配置</td><td>bpu_wrap.c</td><td>在 bpu_models 中添加新模型的名称、指定算法模型文件，推理和后处理函数接口</td></tr><tr><td>推理线程处理函数</td><td>bpu_wrap.c</td><td>在处理函数中准备输出 tensor，调用 <strong>hbDNNInfer</strong> 推理，得到结果后，把结果放入 output 队列。示例：<strong>inference_yolov5s</strong></td></tr><tr><td>后处理线程函数</td><td>bpu_wrap.c</td><td>从 output 队列中取出算法结果，调用后处理方法进行处理，得到 json 格式的结果字符串。如果设置了回调函数，则调用回调。示例：<strong>post_process_yolov5s</strong></td></tr><tr><td>后处理代码</td><td>yolov5_post_process.cpp</td><td>算法模型都要对应后处理方法，比如分类模型要把返回的 id 和类型名对应起来，检测模型要把检测框映射到原始图像的位置上。</td></tr><tr><td>Web 页面上增加渲染处理</td><td>WebServer/www/js/DisplayWindowManager.js</td><td>非必须</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="准备算法模型">准备算法模型<a href="#准备算法模型" class="hash-link" aria-label="Direct link to 准备算法模型" title="Direct link to 准备算法模型">​</a></h4>
<p>开发板上支持运行的算法模型有两种后缀名， bin 文件和 hbm 文件：</p>
<ol>
<li>bin 模型：通过算法工具链转换（ PTQ ）得到的模型，以 bin 作为后缀</li>
<li>hbm 模型：通过定点模型训练框架（ QAT ）直接训练得到的算法模型</li>
</ol>
<p>算法模型的详细开发说明请参考《量化工具链开发指南》文档。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="添加初始化过程">添加初始化过程<a href="#添加初始化过程" class="hash-link" aria-label="Direct link to 添加初始化过程" title="Direct link to 添加初始化过程">​</a></h4>
<p>在 bpu_wrap.c 中的 bpu_models 数组中定义新的算法模型，添加新模型的名称、指定算法模型文件，推理和后处理函数接口：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bpu_model_descriptor bpu_models</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;yolov5s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                   </span><span class="token comment" style="color:#999988;font-style:italic">// 算法名称， web 客户端上会显示这个名称给用户选择</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;../model_zoom/yolov5s_672x672_nv12.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 算法模型文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inference_func </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inference_yolov5s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                       </span><span class="token comment" style="color:#999988;font-style:italic">// 推理函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_proc_func </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> post_process_yolov5s                     </span><span class="token comment" style="color:#999988;font-style:italic">// 后处理函数，如果这部分比较简单，可以合并到推理函数中一起处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> 省略 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>算法任务启动时，根据 <code>model_name</code> 启动相应的推理线程和算法后处理线程。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="推理线程处理函数">推理线程处理函数<a href="#推理线程处理函数" class="hash-link" aria-label="Direct link to 推理线程处理函数" title="Direct link to 推理线程处理函数">​</a></h4>
<p>在推理线程中实现输出结果 tensor 的准备；从 yuv 队列中取出 yuv 数据，调用 HB_BPU_runModel 推理得到算法结果；再把算法结果推进 output Queue，供后处理使用。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">inference_yolov5s</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 准备模型输出节点 tensor， 5 组输出 buff 轮转，简单处理，理论上后处理的速度是要比算法推理更快的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hbDNNTensor output_tensors</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">int32_t</span><span class="token plain"> cur_ouput_buf_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepare_output_tensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_tensors</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dnn_handle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">SC_LOGE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;prepare model output tensor failed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">privThread</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">eState </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> E_THREAD_RUNNING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 获取需要进行算法运算的图像数据，格式基本都是 NV12 的 yuv</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">mQueueDequeueTimed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">m_input_queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">input_tensor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> E_QUEUE_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 模型推理 infer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		hbDNNInferCtrlParam infer_ctrl_param</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">HB_DNN_INITIALIZE_INFER_CTRL_PARAM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">infer_ctrl_param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hbDNNInfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">task_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">input_tensor</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">m_dnn_tensor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				dnn_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">infer_ctrl_param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 后处理数据入队</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Yolo5PostProcessInfo_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		post_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Yolo5PostProcessInfo_t </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Yolo5PostProcessInfo_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		… …</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">mQueueEnqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">m_output_queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cur_ouput_buf_idx</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cur_ouput_buf_idx </span><span class="token operator" style="color:#393A34">%=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="后处理线程函数">后处理线程函数<a href="#后处理线程函数" class="hash-link" aria-label="Direct link to 后处理线程函数" title="Direct link to 后处理线程函数">​</a></h4>
<p>后处理线程中实现从 output queue 中获取算法结果；调用后处理函数；调用算法任务回调函数处理算法结果（当前的回调有作用的都是直接发送给 web，在 web 上渲染算法结果）。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">post_process_yolov5s</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	tsThread </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">privThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tsThread</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Yolov5PostProcessInfo_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">mThreadSetName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">privThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">__func__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">bpu_handle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bpu_handle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">bpu_handle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">privThread</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pvThreadData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">privThread</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">eState </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> E_THREAD_RUNNING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 从后处理数据队列中获取数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">mQueueDequeueTimed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">m_output_queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> E_QUEUE_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Yolov5PostProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 进行后处理，比如得到检测框、过滤低置信度的结果、把检测框的宽高缩放为显示视频的宽高等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">// 算法任务结果回调，当前的应用场景是把算法结果通过 websocket 发送给浏览器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bpu_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">m_userdata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">SC_LOGI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			post_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">mThreadFinish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">privThread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="后处理代码">后处理代码<a href="#后处理代码" class="hash-link" aria-label="Direct link to 后处理代码" title="Direct link to 后处理代码">​</a></h4>
<p>每个算法模型建议都添加一个后处理方法：</p>
<ul>
<li>yolov5 ： yolo5_post_process.cpp</li>
<li>mobilenet_v2 ：分类模型的处理较简单，就是把 id 和类型名进行对应</li>
</ul>
<p>在后处理方法中要完成以下几件事情：</p>
<p>分析输出结果，分类模型要完成类型名的匹配，检测模型要完成算法结果框到原始图像坐标的映射等；</p>
<p>算法结果处理成 json 格式。为了方便使用，在函数中进行 json 格式化，比如传导给 web  ，这里输出的结果可以直接使用。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Yolov5 输出 tensor 格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 3 次下采样得到三组缩小后的 gred，然后对每个 gred 进行三次预测，最后输出结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Yolov5PostProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Yolov5PostProcessInfo_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">post_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hbDNNTensor </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">tensor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> post_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">output_tensor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Detection</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> dets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Detection</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> det_restuls</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">uint32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">str_dets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 根据置信度过滤检测框</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> default_yolov5_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strides</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">_postProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">tensor</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> post_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 计算交并比来合并检测框，传入交并比阈值 (0.65) 和返回 box 数量 (5000)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">yolov5_nms</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> post_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">nms_threshold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> post_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">nms_top_k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> det_restuls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">stringstream out_string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 算法结果转换成 json 格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\&quot;timestamp\&quot;: &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> post_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tv_sec </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> post_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tv_usec</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;,\&quot;detection_result\&quot;: [&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> det_restuls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> det_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> det_restuls</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> det_ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> det_restuls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	out_string </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;]&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	str_dets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	str_dets</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">out_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token char">&#x27;\0&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">snprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str_dets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">c_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> str_dets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="web-页面上增加渲染处理">Web 页面上增加渲染处理<a href="#web-页面上增加渲染处理" class="hash-link" aria-label="Direct link to Web 页面上增加渲染处理" title="Direct link to Web 页面上增加渲染处理">​</a></h4>
<p>本部分非必须实现部分，在当前的实现中，所有算法结果会渲染到 web 页面上，数据流程是在算法后处理返回 json 格式的结果后，通过 websocket 发送结果信息给到 web 页面，在 web 实现了一个画布，在画布上渲染算法结果。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 通用的算法回调函数，目前都是通过 websocket 想 web 上发送</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">int32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpu_wrap_general_result_handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">int32_t</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">int32_t</span><span class="token plain"> pipeline_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ws_msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pipeline_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// json 算法结果添加标志信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 分配内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ws_msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ws_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">SC_LOGE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to allocate memory for ws_msg&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ws_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{\&quot;kind\&quot;:10, \&quot;pipeline\&quot;:%d,&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pipeline_id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">strcat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ws_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">strcat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ws_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;}&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SDK_Cmd_Impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SDK_CMD_WEBSOCKET_SEND_MSG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ws_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ws_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>在 <code>WebServer/www/js/WebSocketProtocolHandler.js</code> 文件中已经支持了通用的分类和目标检测的算法处理逻辑，如果需要渲染新类型算法模型的结果，需要修改 <code>js</code> 代码。</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// web 页面上 websocket 接收数据的处理函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">handleMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> 省略 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 解析命令类型并调用对应的回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> 省略 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REQUEST_TYPES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ALOG_RESULT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">userCallbacks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">onAlogResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">userCallbacks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">onAlogResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> 省略 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">未知的命令类型: kind=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation property-access">kind</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;消息解析失败:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> 省略 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-08-14T06:21:30.000Z" itemprop="dateModified">Aug 14, 2025</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/sunrise_camera_user_guide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">sunrise camera 使用说明</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/multimedia_application/hbmem_sample_guide"><div class="pagination-nav__sublabel">Next </div><div class="pagination-nav__label">hbmem sample 使用说明</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#sunrise-camera-系统设计" class="table-of-contents__link toc-highlight">Sunrise camera 系统设计</a><ul><li><a href="#系统框图" class="table-of-contents__link toc-highlight">系统框图</a></li><li><a href="#微核设计" class="table-of-contents__link toc-highlight">微核设计</a></li><li><a href="#架构优缺点" class="table-of-contents__link toc-highlight">架构优缺点</a></li></ul></li><li><a href="#sunrise-camera-架构视图" class="table-of-contents__link toc-highlight">Sunrise camera 架构视图</a><ul><li><a href="#模块划分" class="table-of-contents__link toc-highlight">模块划分</a></li><li><a href="#事件总线模块-communicate-" class="table-of-contents__link toc-highlight">事件总线模块（ communicate ）</a><ul><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#功能描述" class="table-of-contents__link toc-highlight">功能描述</a></li><li><a href="#模块代码结构" class="table-of-contents__link toc-highlight">模块代码结构</a></li><li><a href="#接口描述" class="table-of-contents__link toc-highlight">接口描述</a></li></ul></li><li><a href="#公共库模块-common-" class="table-of-contents__link toc-highlight">公共库模块（ common ）</a><ul><li><a href="#概述-1" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#功能描述-1" class="table-of-contents__link toc-highlight">功能描述</a></li><li><a href="#模块代码结构-1" class="table-of-contents__link toc-highlight">模块代码结构</a></li></ul></li><li><a href="#platform-模块" class="table-of-contents__link toc-highlight">Platform 模块</a><ul><li><a href="#概述-2" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#功能描述-2" class="table-of-contents__link toc-highlight">功能描述</a></li><li><a href="#模块代码结构-2" class="table-of-contents__link toc-highlight">模块代码结构</a></li></ul></li><li><a href="#对外交互模块-transport-" class="table-of-contents__link toc-highlight">对外交互模块（ Transport ）</a><ul><li><a href="#概述-3" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#meida-server-模块" class="table-of-contents__link toc-highlight">Meida Server 模块</a></li><li><a href="#wesocket-server-模块" class="table-of-contents__link toc-highlight">Wesocket Server 模块</a></li></ul></li><li><a href="#主程序入口-main-" class="table-of-contents__link toc-highlight">主程序入口（ main ）</a><ul><li><a href="#概述-4" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#执行流程" class="table-of-contents__link toc-highlight">执行流程</a></li></ul></li><li><a href="#webserver" class="table-of-contents__link toc-highlight">WebServer</a><ul><li><a href="#概述-5" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#功能描述-3" class="table-of-contents__link toc-highlight">功能描述</a></li></ul></li></ul></li><li><a href="#使用-bpu-进行算法推理" class="table-of-contents__link toc-highlight">使用 BPU 进行算法推理</a><ul><li><a href="#概述-6" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#添加一个新模型流程" class="table-of-contents__link toc-highlight">添加一个新模型流程</a><ul><li><a href="#准备算法模型" class="table-of-contents__link toc-highlight">准备算法模型</a></li><li><a href="#添加初始化过程" class="table-of-contents__link toc-highlight">添加初始化过程</a></li><li><a href="#推理线程处理函数" class="table-of-contents__link toc-highlight">推理线程处理函数</a></li><li><a href="#后处理线程函数" class="table-of-contents__link toc-highlight">后处理线程函数</a></li><li><a href="#后处理代码" class="table-of-contents__link toc-highlight">后处理代码</a></li><li><a href="#web-页面上增加渲染处理" class="table-of-contents__link toc-highlight">Web 页面上增加渲染处理</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.guyuehome.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GuYueHome<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contact US</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 D-Robotics.</div></div></div></footer></div>
</body>
</html>