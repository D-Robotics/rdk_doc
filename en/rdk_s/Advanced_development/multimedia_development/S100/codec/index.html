<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-docs_s docs-version-current docs-doc-page docs-doc-id-Advanced_development/multimedia_development/S100/codec" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Codec | RDK DOC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" property="og:title" content="Codec | RDK DOC"><meta data-rh="true" name="description" content="System Overview"><meta data-rh="true" property="og:description" content="System Overview"><link data-rh="true" rel="icon" href="/rdk_doc/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/codec" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/codec" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"7. Advanced Development","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development"},{"@type":"ListItem","position":2,"name":"7.3 Multimedia Development Guide","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/03_multimedia_development"},{"@type":"ListItem","position":3,"name":"7.3.1 S100 Multimedia Development Guide","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/category/731-s100-多媒体开发指南"},{"@type":"ListItem","position":4,"name":"Codec","item":"https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec"}]}</script><script src="https://hm.baidu.com/hm.js?24dd63cad43b63889ea6bede5fd1ab9e" async></script><link rel="stylesheet" href="/rdk_doc/en/assets/css/styles.0fbd7d27.css">
<script src="/rdk_doc/en/assets/js/runtime~main.001a929b.js" defer="defer"></script>
<script src="/rdk_doc/en/assets/js/main.6514280c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">D-Robotics</b></a><a class="navbar__item navbar__link" href="/rdk_doc/en/RDK">RDK X3 / X5</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rdk_doc/en/rdk_s/RDK">RDK S100</a><a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>EN</a><ul class="dropdown__menu"><li><a href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/codec" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">CN</a></li><li><a href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">EN</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rdk_doc/en/rdk_s/RDK">D-Robotics RDK Kit</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Quick_start">1. Quick Start</a><button aria-label="Expand sidebar category &#x27;1. Quick Start&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/System_configuration">2. System Configuration</a><button aria-label="Expand sidebar category &#x27;2. System Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Basic_Application">3. Basic Application Development</a><button aria-label="Expand sidebar category &#x27;3. Basic Application Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Basic_Development">4. Algorithm Application Development</a><button aria-label="Expand sidebar category &#x27;4. Algorithm Application Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Robot_development">5. Robotics Application Development</a><button aria-label="Expand sidebar category &#x27;5. Robotics Application Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Application_case">6. Application Development Guide</a><button aria-label="Expand sidebar category &#x27;6. Application Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rdk_doc/en/rdk_s/Advanced_development">7. Advanced Development</a><button aria-label="Collapse sidebar category &#x27;7. Advanced Development&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/hardware_development">7.1 Hardware Development Guide</a><button aria-label="Expand sidebar category &#x27;7.1 Hardware Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/linux_development">7.2. Linux Development Guide</a><button aria-label="Expand sidebar category &#x27;7.2. Linux Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/rdk_s/03_multimedia_development">7.3 Multimedia Development Guide</a><button aria-label="Collapse sidebar category &#x27;7.3 Multimedia Development Guide&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/rdk_s/category/731-s100-多媒体开发指南">7.3.1 S100 Multimedia Development Guide</a><button aria-label="Collapse sidebar category &#x27;7.3.1 S100 Multimedia Development Guide&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camsys">Camsys Subsystem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup">Camera Bring-up</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/codec">Codec</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/display">Display Subsystem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camerasync">Multi-Camera and Synchronization with Lidar</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/02_multimedia_application">7.3.2 Multimedia Application Development </a><button aria-label="Expand sidebar category &#x27;7.3.2 Multimedia Application Development &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/04_toolchain_development">7.4 Algorithm Toolchain Development Guide</a><button aria-label="Expand sidebar category &#x27;7.4 Algorithm Toolchain Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/rdk_s/05_MCU_development">7.5 MCU Development Guide</a><button aria-label="Expand sidebar category &#x27;7.5 MCU Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/rdk_s/Advanced_development/rdk_gen">7.6 RDK S100 Build System Development Guide</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/FAQ">8. FAQ</a><button aria-label="Expand sidebar category &#x27;8. FAQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/rdk_s/Appendix">9. Appendix</a><button aria-label="Expand sidebar category &#x27;9. Appendix&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rdk_doc/en/rdk_s/Release_Note/roadmap">10. Version release</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rdk_doc/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/Advanced_development"><span>7. Advanced Development</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/03_multimedia_development"><span>7.3 Multimedia Development Guide</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/rdk_s/category/731-s100-多媒体开发指南"><span>7.3.1 S100 Multimedia Development Guide</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Codec</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Codec</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-overview">System Overview<a href="#system-overview" class="hash-link" aria-label="Direct link to System Overview" title="Direct link to System Overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>Codec (Coder-Decoder) refers to a codec used to compress or decompress media data such as video, images, and audio. The S100 SoC includes two hardware codec units: VPU (Video Processing Unit) and JPU (JPEG Processing Unit), providing 4K@90fps video codec capability and 4K@90fps image codec capability.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jpu-hardware-features">JPU Hardware Features<a href="#jpu-hardware-features" class="hash-link" aria-label="Direct link to JPU Hardware Features" title="Direct link to JPU Hardware Features">​</a></h4>
<table><thead><tr><th><strong>HW Feature</strong></th><th><strong>Feature Indicator</strong></th></tr></thead><tbody><tr><td>HW number</td><td>1</td></tr><tr><td>maximum input</td><td>8192x8192</td></tr><tr><td>minimum input</td><td>32x32</td></tr><tr><td>performance</td><td>4K@90fps</td></tr><tr><td>max instance</td><td>64</td></tr><tr><td>input image format</td><td>4:0:0, 4:2:0, 4:2:2, 4:4:0, and 4:4:4 color format</td></tr><tr><td>output image format</td><td>4:0:0, 4:2:0, 4:2:2, 4:4:0, and 4:4:4 color format</td></tr><tr><td>input crop</td><td>Supports</td></tr><tr><td>bitrate control</td><td>FIXQP(MJPEG)</td></tr><tr><td>rotation</td><td>90, 180, 270</td></tr><tr><td>mirror</td><td>Vertical, Horizontal, Vertical+Horizontal</td></tr><tr><td>quantization table</td><td>Supports Custom Settings</td></tr><tr><td>huffman table</td><td>Supports Custom Settings</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="vpu-hardware-features">VPU Hardware Features<a href="#vpu-hardware-features" class="hash-link" aria-label="Direct link to VPU Hardware Features" title="Direct link to VPU Hardware Features">​</a></h4>
<table><thead><tr><th><strong>HW Feature</strong></th><th><strong>Feature Indicator</strong></th></tr></thead><tbody><tr><td>HW number</td><td>1</td></tr><tr><td>maximum input</td><td>8192x4096</td></tr><tr><td>minimum input</td><td>256x128</td></tr><tr><td>input alignment required</td><td>width 32, height 8</td></tr><tr><td>performance</td><td>4K@90fps</td></tr><tr><td>max instance</td><td>32</td></tr><tr><td>input image format</td><td>4:2:0, 4:2:2 color format</td></tr><tr><td>output image format</td><td>4:2:0, 4:2:2 color format</td></tr><tr><td>input crop</td><td>Supports</td></tr><tr><td>bitrate control</td><td>CBR, VBR, AVBR, FIXQP, QPMAP</td></tr><tr><td>rotation</td><td>90, 180, 270</td></tr><tr><td>mirror</td><td>Vertical, Horizontal, Vertical+Horizontal</td></tr><tr><td>long-term reference prediction</td><td>Supports Custom Settings</td></tr><tr><td>intra refresh</td><td>Supports</td></tr><tr><td>deblocking filter</td><td>Supports</td></tr><tr><td>request IDR</td><td>Supports</td></tr><tr><td>ROI mode</td><td>mode1: Users can set multiple zones’(up to 64) qp value(0-51), should not work with CBR or AVBR mode mode2: Users can set multiple zones’(up to 64) important level(0-8), should work with CBR or AVBR mode</td></tr><tr><td>GOP mode</td><td>0: Custom GOP 1 : I-I-I-I,..I (all intra, gop_size=1) 2 : I-P-P-P,… P (consecutive P, gop_size=1) 3 : I-B-B-B,…B (consecutive B, gop_size=1) 4 : I-B-P-B-P,… (gop_size=2) 5 : I-B-B-B-P,… (gop_size=4) 6 : I-P-P-P-P,… (consecutive P, gop_size=4) 7 : I-B-B-B-B,… (consecutive B, gop_size=4) 8 : I-B-B-B-B-B-B-B-B,… (random access, gop_size=8) 9 : I-P-P-P,… P (consecutive P, gop_size = 1, with single reference)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="software-features">Software Features<a href="#software-features" class="hash-link" aria-label="Direct link to Software Features" title="Direct link to Software Features">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="overall-framework">Overall Framework<a href="#overall-framework" class="hash-link" aria-label="Direct link to Overall Framework" title="Direct link to Overall Framework">​</a></h4>
<p>The MediaCodec subsystem provides components for audio/video and image codec, raw stream packaging, and video recording. This system primarily encapsulates underlying codec hardware resources and software codec libraries to offer codec capabilities to upper layers. Developers can implement H.265 and H.264 video encoding/decoding functionalities using the provided codec APIs, use JPEG encoding to save camera data as JPEG images, or utilize the video recording feature to record camera data.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/2f8364ee5efbb8cb14136e0dc942248e.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bitrate-control-modes">Bitrate Control Modes<a href="#bitrate-control-modes" class="hash-link" aria-label="Direct link to Bitrate Control Modes" title="Direct link to Bitrate Control Modes">​</a></h4>
<p>MediaCodec supports bitrate control for H.264/H.265 and MJPEG protocols, offering five bitrate control methods for H.264/H.265 encoding channels—CBR, VBR, AVBR, FixQp, and QpMap—and FixQp bitrate control for MJPEG encoding channels.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="cbr-description">CBR Description<a href="#cbr-description" class="hash-link" aria-label="Direct link to CBR Description" title="Direct link to CBR Description">​</a></h5>
<p>CBR stands for Constant Bitrate, ensuring stable overall encoding bitrate. Below are parameter descriptions for CBR mode:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th><th><strong>Range</strong></th><th><strong>Default</strong></th></tr></thead><tbody><tr><td>intra_period</td><td>I-frame interval</td><td>[0,2047]</td><td>28</td></tr><tr><td>intra_qp</td><td>QP value for I-frames</td><td>[0,51]</td><td>0</td></tr><tr><td>bit_rate</td><td>Target average bitrate, in kbps</td><td>[0,700000]</td><td>0</td></tr><tr><td>frame_rate</td><td>Target frame rate, in fps</td><td>[1,240]</td><td>30</td></tr><tr><td>initial_rc_qp</td><td>Initial QP value for rate control; if outside [0,51], the encoder internally determines the initial value</td><td>[0,63]</td><td>63</td></tr><tr><td>vbv_buffer_size</td><td>VBV buffer size in ms; actual VBV buffer size = bit_rate * vbv_buffer_size / 1000 (kb). Buffer size affects encoding quality and bitrate control accuracy: smaller buffers yield higher bitrate control precision but lower image quality; larger buffers improve image quality but increase bitrate fluctuation.</td><td>[10,3000]</td><td>10</td></tr><tr><td>ctu_level_rc_enable</td><td>H.264/H.265 rate control can operate at CTU level for higher bitrate control precision at the cost of encoding quality. This mode cannot be used with ROI encoding; it is automatically disabled when ROI encoding is enabled.</td><td>[0,1]</td><td>0</td></tr><tr><td>min_qp_I</td><td>Minimum QP value for I-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_I</td><td>Maximum QP value for I-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>min_qp_P</td><td>Minimum QP value for P-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_P</td><td>Maximum QP value for P-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>min_qp_B</td><td>Minimum QP value for B-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_B</td><td>Maximum QP value for B-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>hvs_qp_enable</td><td>H.264/H.265 rate control can operate at sub-CTU level, adjusting sub-macroblock QP values to improve subjective image quality.</td><td>[0,1]</td><td>1</td></tr><tr><td>hvs_qp_scale</td><td>Effective when hvs_qp_enable is enabled; represents QP scaling factor.</td><td>[0,4]</td><td>2</td></tr><tr><td>max_delta_qp</td><td>Effective when hvs_qp_enable is enabled; specifies maximum allowable deviation for HVS QP values.</td><td>[0,51]</td><td>10</td></tr><tr><td>qp_map_enable</td><td>Enables QP map for ROI encoding.</td><td>[0,1]</td><td>0</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="vbr-description">VBR Description<a href="#vbr-description" class="hash-link" aria-label="Direct link to VBR Description" title="Direct link to VBR Description">​</a></h5>
<p>VBR stands for Variable Bitrate, allocating higher QP (lower quality, higher compression) for simple scenes and lower QP (higher quality) for complex scenes to maintain consistent visual quality. Below are parameter descriptions for VBR mode:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th><th><strong>Range</strong></th><th><strong>Default</strong></th></tr></thead><tbody><tr><td>intra_period</td><td>I-frame interval</td><td>[0,2047]</td><td>28</td></tr><tr><td>intra_qp</td><td>QP value for I-frames</td><td>[0,51]</td><td>0</td></tr><tr><td>frame_rate</td><td>Target frame rate, in fps</td><td>[1,240]</td><td>0</td></tr><tr><td>qp_map_enable</td><td>Enables QP map for ROI encoding</td><td>[0,1]</td><td>0</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="avbr-description">AVBR Description<a href="#avbr-description" class="hash-link" aria-label="Direct link to AVBR Description" title="Direct link to AVBR Description">​</a></h5>
<p>AVBR stands for Average Variable Bitrate, allocating lower bitrates for simple scenes and sufficient bitrates for complex scenes—similar to VBR—while maintaining an average bitrate close to the target over time, thus controlling output file size—similar to CBR. It is a compromise between CBR and VBR, producing relatively stable bitrate and image quality. Below are parameter descriptions for AVBR mode:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th><th><strong>Range</strong></th><th><strong>Default</strong></th></tr></thead><tbody><tr><td>intra_period</td><td>I-frame interval</td><td>[0,2047]</td><td>28</td></tr><tr><td>intra_qp</td><td>QP value for I-frames</td><td>[0,51]</td><td>0</td></tr><tr><td>bit_rate</td><td>Target average bitrate, in kbps</td><td>[0,700000]</td><td>0</td></tr><tr><td>frame_rate</td><td>Target frame rate, in fps</td><td>[1,240]</td><td>30</td></tr><tr><td>initial_rc_qp</td><td>Initial QP value for rate control; if outside [0,51], the encoder internally determines the initial value</td><td>[0,63]</td><td>63</td></tr><tr><td>vbv_buffer_size</td><td>VBV buffer size in ms; actual VBV buffer size = bit_rate * vbv_buffer_size / 1000 (kb). Buffer size affects encoding quality and bitrate control accuracy: smaller buffers yield higher bitrate control precision but lower image quality; larger buffers improve image quality but increase bitrate fluctuation.</td><td>[10,3000]</td><td>3000</td></tr><tr><td>ctu_level_rc_enable</td><td>H.264/H.265 rate control can operate at CTU level for higher bitrate control precision at the cost of encoding quality. This mode cannot be used with ROI encoding; it is automatically disabled when ROI encoding is enabled.</td><td>[0,1]</td><td>0</td></tr><tr><td>min_qp_I</td><td>Minimum QP value for I-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_I</td><td>Maximum QP value for I-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>min_qp_P</td><td>Minimum QP value for P-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_P</td><td>Maximum QP value for P-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>min_qp_B</td><td>Minimum QP value for B-frames</td><td>[0,51]</td><td>8</td></tr><tr><td>max_qp_B</td><td>Maximum QP value for B-frames</td><td>[0,51]</td><td>51</td></tr><tr><td>hvs_qp_enable</td><td>H.264/H.265 rate control can operate at sub-CTU level, adjusting sub-macroblock QP values to improve subjective image quality.</td><td>[0,1]</td><td>1</td></tr><tr><td>hvs_qp_scale</td><td>Effective when hvs_qp_enable is enabled; represents QP scaling factor.</td><td>[0,4]</td><td>2</td></tr><tr><td>max_delta_qp</td><td>Effective when hvs_qp_enable is enabled; specifies maximum allowable deviation for HVS QP values.</td><td>[0,51]</td><td>10</td></tr><tr><td>qp_map_enable</td><td>Enables QP map for ROI encoding.</td><td>[0,1]</td><td>0</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="fixqp-description">FixQp Description<a href="#fixqp-description" class="hash-link" aria-label="Direct link to FixQp Description" title="Direct link to FixQp Description">​</a></h5>
<p>FixQp assigns fixed QP values to each I-frame and P-frame, with separate values allowed for I/P frames. Below are parameter descriptions for FixQp mode:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th><th><strong>Range</strong></th><th><strong>Default</strong></th></tr></thead><tbody><tr><td>intra_period</td><td>I-frame interval</td><td>[0,2047]</td><td>28</td></tr><tr><td>frame_rate</td><td>Target frame rate, in fps</td><td>[1,240]</td><td>30</td></tr><tr><td>force_qp_I</td><td>Forced QP value for I-frames</td><td>[0,51]</td><td>0</td></tr><tr><td>force_qp_P</td><td>Forced QP value for P-frames</td><td>[0,51]</td><td>0</td></tr><tr><td>force_qp_B</td><td>Forced QP value for B-frames</td><td>[0,51]</td><td>0</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="qpmap-description">QPMAP Description<a href="#qpmap-description" class="hash-link" aria-label="Direct link to QPMAP Description" title="Direct link to QPMAP Description">​</a></h5>
<p>QPMAP allows specifying QP values for each block within a frame: 32x32 for H.265 and 16x16 for H.264. Below are parameter descriptions for QPMAP mode:</p>
<table><thead><tr><th><strong>Parameter</strong></th><th><strong>Description</strong></th><th><strong>Range</strong></th><th><strong>Default</strong></th></tr></thead><tbody><tr><td>intra_period</td><td>I-frame interval</td><td>[0,2047]</td><td>28</td></tr><tr><td>frame_rate</td><td>Target frame rate, in fps</td><td>[1,240]</td><td>30</td></tr><tr><td>qp_map_array</td><td>Specifies QP map table; for H.265, sub-CTU size is 32x32—each sub-CTU requires one QP value (1 byte), ordered in raster scan.</td><td>Pointer address</td><td>NULL</td></tr><tr><td>qp_map_array_count</td><td>Specifies size of QP map table.</td><td>[0, MC_VIDEO_MAX_SUB_CTU_NUM] &amp;&amp; (ALIGN64(picWidth)&gt;&gt;5) * (ALIGN64(picHeight)&gt;&gt;5)</td><td>0</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-methods">Debugging Methods<a href="#debugging-methods" class="hash-link" aria-label="Direct link to Debugging Methods" title="Direct link to Debugging Methods">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-quality-tuning">Encoding Quality Tuning<a href="#encoding-quality-tuning" class="hash-link" aria-label="Direct link to Encoding Quality Tuning" title="Direct link to Encoding Quality Tuning">​</a></h4>
<p>In current customer usage scenarios involving video encoding with the codec, CBR mode is commonly selected. In complex scenes, hardware automatically increases bitrate to maintain video quality, resulting in larger-than-expected output files. To balance video quality and actual bitrate, settings for bit_rate and max_qp_I/P must be coordinated. Below shows actual bitrate and QP under all-I-frame mode with a target bitrate of 15000 kbps across different scene complexities and max_qp_I values (data due to varying scene complexity):</p>
<table><thead><tr><th>Scene &amp; Parameters</th><th>Outdoor Daytime Complex Scene bitrate(15000) max_qp_I(35)</th><th>Outdoor Daytime Complex Scene bitrate(15000) max_qp_I(38)</th><th>Outdoor Daytime Complex Scene bitrate(15000) max_qp_I(39)</th></tr></thead><tbody><tr><td>Bit allocation (bps) (higher = better quality)</td><td>60300045</td><td>42186920</td><td>35898230</td></tr><tr><td>Avg QP (lower = better quality)</td><td>35</td><td>38</td><td>39</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="gop-structure-description">GOP Structure Description<a href="#gop-structure-description" class="hash-link" aria-label="Direct link to GOP Structure Description" title="Direct link to GOP Structure Description">​</a></h4>
<p>H.264/H.265 encoding supports configurable GOP structures, allowing users to select from three preset GOP structures or define custom GOP structures.</p>
<p>A GOP structure table defines a periodic GOP pattern applied throughout the encoding process. Elements within a single structure table are described below. Reference frames for each picture can be specified; if frames after an IDR reference frames before the IDR, the encoder internally handles this to prevent cross-IDR referencing—users need not manage this. When defining custom GOP structures, users must specify the number of structure tables (up to 3), ordered by decoding sequence.</p>
<p>Below describes elements within the structure table:</p>
<table><thead><tr><th>Element</th><th>Description</th></tr></thead><tbody><tr><td>Type</td><td>Frame type (I, P, B)</td></tr><tr><td>POC</td><td>Display order within GOP, range [1, gop_size].</td></tr><tr><td>QPoffset</td><td>Quantization parameter for pictures in custom GOP</td></tr><tr><td>NUM_REF_PIC_L0</td><td>Indicates multi-reference pictures for P-frames; valid only when PIC_TYPE is P.</td></tr><tr><td>temporal_id</td><td>Temporal layer of frame; frames cannot predict from frames with higher temporal_id (0~6).</td></tr><tr><td>1st_ref_POC</td><td>POC of first reference picture in L0</td></tr><tr><td>2nd_ref_POC</td><td>For B-frames, first reference picture POC is in L1; for P-frames, second reference picture POC is in L0. reference_L1 and reference_L0 may share the same POC in B-slices, but different POCs are recommended for compression efficiency.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="preset-gop-structures">Preset GOP Structures<a href="#preset-gop-structures" class="hash-link" aria-label="Direct link to Preset GOP Structures" title="Direct link to Preset GOP Structures">​</a></h5>
<p>Nine preset GOP structures are supported:</p>
<table><thead><tr><th>Index</th><th>GOP Structure</th><th>Low Latency (encoding order = display order)</th><th>GOP Size</th><th>Encoding Order</th><th>Min Source Frame Buffer Count</th><th>Min Decoded Picture Buffer Count</th><th>Period Requirement (I-frame interval)</th></tr></thead><tbody><tr><td>1</td><td>I</td><td>Yes</td><td>1</td><td>I0-I1-I2…</td><td>1</td><td>1</td><td></td></tr><tr><td>2</td><td>P</td><td>Yes</td><td>1</td><td>P0-P1-P2…</td><td>1</td><td>2</td><td></td></tr><tr><td>3</td><td>B</td><td>Yes</td><td>1</td><td>B0-B1-B2…</td><td>1</td><td>3</td><td></td></tr><tr><td>4</td><td>BP</td><td>No</td><td>2</td><td>B1-P0-B3-P2…</td><td>1</td><td>3</td><td></td></tr><tr><td>5</td><td>BBBP</td><td>Yes</td><td>1</td><td>B2-B1-B3-P0…</td><td>7</td><td>4</td><td></td></tr><tr><td>6</td><td>PPPP</td><td>Yes</td><td>4</td><td>P0-P1-P2-P3…</td><td>1</td><td>2</td><td></td></tr><tr><td>7</td><td>BBBB</td><td>Yes</td><td>4</td><td>B0-B1-B2-B3…</td><td>1</td><td>3</td><td></td></tr><tr><td>8</td><td>BBBB BBBB</td><td>Yes</td><td>1</td><td>B3-B2-B4-B1-B6-B5-B7-B0…</td><td>12</td><td>5</td><td></td></tr><tr><td>9</td><td>P</td><td>Yes</td><td>1</td><td>P0</td><td>1</td><td>2</td><td></td></tr></tbody></table>
<p>GOP Preset 1</p>
<ul>
<li>Contains only I-frames with no inter-frame referencing;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/b02cc41ab083664ba3f8a3bef1543afa.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/fa1da95bc8801b2d6225b2abf1b2f2d3.png" alt="" class="img_ev3q">GOP Preset 2</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>P-frames reference 2 forward reference frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/e3c2f773a89f6ee2fe2dab03200b6fd0.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/8fa5f892bd7282e82ac8ed96011c943d.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 3</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference 2 forward reference frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/03bbdf35dc3e2a1b38f9e05d7038d064.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/e1b5707ea0c32b6a0c1658527a6186dd.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 4</p>
<ul>
<li>Contains only I-frames, P-frames, and B-frames;</li>
<li>P-frames reference 2 forward reference frames;</li>
<li>B-frames reference 1 forward reference frame and 1 backward reference frame;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/17e10e6a27db202fe9a0c2b5f3d5dd50.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/972bbe22d2e7364c1c0a3db03f57343e.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 5</p>
<ul>
<li>Contains only I-frames, P-frames, and B-frames;</li>
<li>P-frames reference 2 forward reference frames;</li>
<li>B-frames reference 1 forward reference frame and 1 backward reference frame, where the backward reference frame can be either a P-frame or a B-frame;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/16ad2d15f0b22a91fda1450747a18422.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/8ff1393cdbb997c8768ea2f9f00c3c8b.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 6</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>P-frames reference 2 forward reference frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/a5fbffa7c85a3423729f06d45f83a601.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/1e88c6cbacb8fff86f5d5fc301e01abd.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 7</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference 2 forward reference frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/40cd6c4fa7cf66f9bf14c3675cb7ef20.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/be7fe30d2685e27e2b36f305ef745eb4.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 8</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference 1 forward reference frame and 1 backward reference frame;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/9c46efaf2a9106bcee2468098e209b1f.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/d016b90fa0a06e183b6871bc430a8714.png" alt="" class="img_ev3q"></p>
<p>GOP Preset 9</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>P-frames reference 1 forward reference frame;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/0bc1b9d3e73b4037b64236650738b5cd.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/937b45950423ff5006e378cb510d695d.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="vpu-debugging-method">VPU Debugging Method<a href="#vpu-debugging-method" class="hash-link" aria-label="Direct link to VPU Debugging Method" title="Direct link to VPU Debugging Method">​</a></h4>
<p>The VPU (Video Processing Unit) is a dedicated visual processing unit capable of efficiently handling video content. The VPU can perform encoding and decoding of H.265 video formats. Users can obtain the encoded/decoded bitstream through the interfaces provided by Codec.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-status">Encoding Status<a href="#encoding-status" class="hash-link" aria-label="Direct link to Encoding Status" title="Direct link to Encoding Status">​</a></h5>
<p>Encoding Debug Information</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">venc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">venc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode enc param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id     profile       level width height pix_fmt fbuf_count extern_buf_flag bsbuf_count bsbuf_size mirror rotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265        Main unspecified  </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">2160</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">13271040</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265cbr param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx rc_mode intra_period intra_qp bit_rate frame_rate initial_rc_qp vbv_buffer_size ctu_level_rc_enalbe min_qp_I max_qp_I min_qp_P max_qp_P min_qp_B max_qp_B hvs_qp_enable hvs_qp_scale qp_map_enable max_delta_qp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> h265cbr           </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">                   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode gop param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id gop_preset_idx custom_gop_size decoding_refresh_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265              </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode intra refresh</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id intra_refresh_mode intra_refresh_arg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode longterm ref</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id use_longterm longterm_pic_period longterm_pic_using_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode roi_params</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id roi_enable roi_map_array_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode mode_decision </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id mode_decision_enable pu04_delta_rate pu08_delta_rate pu16_delta_rate pu32_delta_rate pu04_intra_planar_delta_rate pu04_intra_dc_delta_rate pu04_intra_angle_delta_rate pu08_intra_planar_delta_rate pu08_intra_dc_delta_rate pu08_intra_angle_delta_rate pu16_intra_planar_delta_rate pu16_intra_dc_delta_rate pu16_intra_angle_delta_rate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode mode_decision </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id pu32_intra_planar_delta_rate pu32_intra_dc_delta_rate pu32_intra_angle_delta_rate cu08_intra_delta_rate cu08_inter_delta_rate cu08_merge_delta_rate cu16_intra_delta_rate cu16_inter_delta_rate cu16_merge_delta_rate cu32_intra_delta_rate cu32_inter_delta_rate cu32_merge_delta_rate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265_transform</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id chroma_cb_qp_offset chroma_cr_qp_offset user_scaling_list_enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265_pred_unit</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id intra_nxn_enable constrained_intra_pred_flag strong_intra_smoothing_enabled_flag max_num_merge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                                   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265 timing</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id vui_num_units_in_tick vui_time_scale vui_num_ticks_poc_diff_one_minus1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                  </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">30000</span><span class="token plain">                                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265 slice params</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id h265_independent_slice_mode h265_independent_slice_arg h265_dependent_slice_mode h265_dependent_slice_arg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265 deblk filter</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id slice_deblocking_filter_disabled_flag slice_beta_offset_div2 slice_tc_offset_div2 slice_loop_filter_across_slices_enabled_flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                                     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                                            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode h265 sao param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id sample_adaptive_offset_enabled_flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode status</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id cur_input_buf_cnt cur_output_buf_cnt left_recv_frame left_enc_frame total_input_buf_cnt total_output_buf_cnt     fps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    h265                 </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                </span><span class="token number" style="color:#36acaa">1093</span><span class="token plain">                 </span><span class="token number" style="color:#36acaa">1089</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">35</span><br></span></code></pre></div></div>
<p>Parameter Explanation</p>
<table><thead><tr><th>Debug Info Group</th><th>Status Parameter</th><th>Description</th></tr></thead><tbody><tr><td>encode enc param</td><td>Basic Encoding Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>profile: Profile type<br>level: H.265 level type<br>width: Encoding width<br>height: Encoding height<br>pix_fmt: Input frame pixel format<br>fbuf_count: Number of input frame buffers<br>extern_buf_flag: Whether external input buffers are used<br>bsbuf_count: Number of bitstream buffers<br>bsbuf_size: Bitstream buffer size<br>mirror: Whether mirroring is enabled<br>rotate: Whether rotation is enabled</td></tr><tr><td>encode h265cbr param</td><td>CBR Rate Control Parameters</td><td>enc_idx: Encoding instance index<br>rc_mode: Rate control mode<br>intra_period: I-frame interval<br>intra_qp: QP value for I-frames<br>bit_rate: Bitrate<br>frame_rate: Frame rate<br>initial_rc_qp: Initial QP value<br>vbv_buffer_size: VBV buffer size<br>ctu_level_rc_enalbe: Whether rate control operates at CTU level<br>min_qp_I: Minimum QP for I-frames<br>max_qp_I: Maximum QP for I-frames<br>min_qp_P: Minimum QP for P-frames<br>max_qp_P: Maximum QP for P-frames<br>min_qp_B: Minimum QP for B-frames<br>max_qp_B: Maximum QP for B-frames<br>hvs_qp_enable: Whether rate control operates at sub-CTU level<br>hvs_qp_scale: QP scaling factor<br>qp_map_enable: Enable QP map for ROI encoding<br>max_delta_qp: Maximum allowable deviation for HVS QP values</td></tr><tr><td>encode gop param</td><td>GOP Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>gop_preset_idx: Selected preset GOP structure<br>custom_gop_size: GOP size when using custom GOP<br>decoding_refresh_type: Specific type of IDR frame</td></tr><tr><td>encode intra refresh</td><td>Intra Refresh Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>intra_refresh_mode: Intra refresh mode<br>intra_refresh_arg: Intra refresh argument</td></tr><tr><td>encode longterm ref</td><td>Long-Term Reference Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>use_longterm: Enable long-term reference frames<br>longterm_pic_period: Period for long-term reference frames<br>longterm_pic_using_period: Period for referencing long-term reference frames</td></tr><tr><td>encode roi_params</td><td>ROI Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>roi_enable: Enable ROI encoding<br>roi_map_array_count: Number of elements in ROI map</td></tr><tr><td>encode mode_decision 1</td><td>Block Mode Decision Parameters 1</td><td>Various mode selection parameter values, including pu04_delta_rate, pu08_delta_rate, etc.</td></tr><tr><td>encode mode_decision 2</td><td>Block Mode Decision Parameters 2</td><td>Various mode selection parameter values, including pu32_intra_planar_delta_rate, pu32_intra_dc_delta_rate, etc.</td></tr><tr><td>encode h265_transform</td><td>Transform Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>chroma_cb_qp_offset: QP offset for Cb component<br>chroma_cr_qp_offset: QP offset for Cr component<br>user_scaling_list_enable: Enable user-defined scaling list</td></tr><tr><td>encode h265_pred_unit</td><td>Prediction Unit Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>intra_nxn_enable: Enable intra NXN PUs<br>constrained_intra_pred_flag: Whether intra prediction is constrained<br>strong_intra_smoothing_enabled_flag: Whether bidirectional linear interpolation is used in filtering<br>max_num_merge: Number of merge candidates</td></tr><tr><td>encode h265 timing</td><td>Timing Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>vui_num_units_in_tick: Number of time units per tick<br>vui_time_scale: Number of time units per second<br>vui_num_ticks_poc_diff_one_minus1: Number of clock ticks corresponding to a picture order count difference of 1</td></tr><tr><td>encode h265 slice params</td><td>Slice Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>h265_independent_slice_mode: Independent slice encoding mode<br>h265_independent_slice_arg: Size of independent slices<br>h265_dependent_slice_mode: Dependent slice encoding mode<br>h265_dependent_slice_arg: Size of dependent slices</td></tr><tr><td>encode h265 deblk filter</td><td>Deblocking Filter Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>slice_deblocking_filter_disabled_flag: Whether in-slice deblocking filtering is disabled<br>slice_beta_offset_div2: β deblocking parameter offset for current slice<br>slice_tc_offset_div2: tC deblocking parameter offset for current slice<br>slice_loop_filter_across_slices_enabled_flag: Whether cross-slice boundary filtering is enabled</td></tr><tr><td>encode h265 sao param</td><td>SAO Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>sample_adaptive_offset_enabled_flag: Whether sample adaptive offset is applied to reconstructed pictures after deblocking</td></tr><tr><td>encode status</td><td>Current Encoding Status Parameters</td><td>enc_idx: Encoding instance index<br>enc_id: Encoding type<br>cur_input_buf_cnt: Number of currently used input buffers<br>cur_output_buf_cnt: Number of currently used output buffers<br>left_recv_frame: Remaining frames to receive (valid only when receive_frame_number is set)<br>left_enc_frame: Remaining frames to encode (valid only when receive_frame_number is set)<br>total_input_buf_cnt: Total number of input buffers used so far<br>total_output_buf_cnt: Total number of output buffers used so far<br>fps: Current frame rate</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="decoding-status">Decoding Status<a href="#decoding-status" class="hash-link" aria-label="Direct link to Decoding Status" title="Direct link to Decoding Status">​</a></h5>
<p>Decoding Debug Information</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">vdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx dec_id feed_mode pix_fmt bitstream_buf_size bitstream_buf_count frame_buf_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   h265     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">13271040</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">h265 decode param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx dec_id reorder_enable skip_mode bandwidth_Opt cra_as_bla dec_temporal_id_mode target_dec_temporal_id_plus1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   h265        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode frameinfo</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx dec_id display_width display_height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   h265       </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">2160</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode status</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx dec_id cur_input_buf_cnt cur_output_buf_cnt total_input_buf_cnt total_output_buf_cnt fps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   h265          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">458</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">453</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">53</span><br></span></code></pre></div></div>
<p>Parameter Explanation</p>
<table><thead><tr><th>Debug Info Group</th><th>Status Parameter</th><th>Description</th></tr></thead><tbody><tr><td>decode param</td><td>Basic Decoding Parameters</td><td>dec_idx: Decoding instance index<br>dec_id: Decoding type<br>feed_mode: Data feeding mode<br>pix_fmt: Output pixel format<br>bitstream_buf_size: Input bitstream buffer size<br>bitstream_buf_count: Number of input bitstream buffers<br>frame_buf_count: Number of output frame buffers</td></tr><tr><td>h265 decode param</td><td>H.265 Decoding Basic Parameters</td><td>dec_idx: Decoding instance index<br>dec_id: Decoding type<br>reorder_enable: Enable decoder to output frames in display order<br>skip_mode: Enable frame decode skip mode<br>bandwidth_Opt: Enable bandwidth optimization mode<br>cra_as_bla: Treat CRA as BLA<br>dec_temporal_id_mode: Temporal ID selection mode<br>target_dec_temporal_id_plus1: Specified temporal ID value</td></tr><tr><td>decode frameinfo</td><td>Decoded Output Frame Info</td><td>dec_idx: Decoding instance index<br>dec_id: Decoding type<br>display_width: Display width<br>display_height: Display height</td></tr><tr><td>decode status</td><td>Current Decoding Status Parameters</td><td>dec_idx: Decoding instance index<br>dec_id: Decoding type<br>cur_input_buf_cnt: Number of currently used input buffers<br>cur_output_buf_cnt: Number of currently used output buffers<br>total_input_buf_cnt: Total number of input buffers used so far<br>total_output_buf_cnt: Total number of output buffers used so far<br>fps: Current frame rate</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jpu-debugging-method">JPU Debugging Method<a href="#jpu-debugging-method" class="hash-link" aria-label="Direct link to JPU Debugging Method" title="Direct link to JPU Debugging Method">​</a></h4>
<p>The JPU (JPEG Processing Unit) is primarily used to perform JPEG/MJPEG encoding and decoding. Users can input YUV data for encoding or JPEG images for decoding via the CODEC interface, and obtain the encoded JPEG images or decoded YUV data after JPU processing.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-status-1">Encoding Status<a href="#encoding-status-1" class="hash-link" aria-label="Direct link to Encoding Status" title="Direct link to Encoding Status">​</a></h5>
<p>Encoding Debug Information</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jenc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jenc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id width height pix_fmt fbuf_count extern_buf_flag bsbuf_count bsbuf_size mirror rotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    jpeg  </span><span class="token number" style="color:#36acaa">1920</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1088</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">3137536</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode rc param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx   rc_mode frame_rate quality_factor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> noratecontrol          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">encode status</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enc_idx  enc_id cur_input_buf_cnt cur_output_buf_cnt left_recv_frame left_enc_frame total_input_buf_cnt total_output_buf_cnt     fps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    jpeg                 </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">              </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                </span><span class="token number" style="color:#36acaa">4344</span><span class="token plain">                 </span><span class="token number" style="color:#36acaa">4340</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">287</span><br></span></code></pre></div></div>
<p>Parameter Explanation</p>
<table><thead><tr><th>Debug Info Group</th><th>Status Parameter</th><th>Description</th></tr></thead><tbody><tr><td>encode param</td><td>Basic Encoding Parameters</td><td>enc_idx: Encoding instance<br>enc_id: Encoding type<br>width: Image width<br>height: Image height<br>pix_fmt: Pixel format<br>fbuf_count: Number of input framebuffer buffers<br>extern_buf_flag: Whether user-allocated input buffers are used<br>bsbuf_count: Number of output bitstream buffers<br>bsbuf_size: Size of output bitstream buffer<br>mirror: Whether mirroring is enabled<br>rotate: Whether rotation is enabled</td></tr><tr><td>encode rc param</td><td>MJPEG Rate Control Parameters</td><td>enc_idx: Encoding instance<br>rc_mode: Rate control mode<br>frame_rate: Target frame rate<br>quality_factor: Quantization factor</td></tr><tr><td>encode status</td><td>Current Encoding Status Parameters</td><td>enc_idx: Encoding instance ID<br>enc_id: Encoding type<br>cur_input_buf_cnt: Number of currently used input buffers<br>cur_output_buf_cnt: Number of currently used output buffers<br>left_recv_frame: Remaining frames to receive (valid only if receive_frame_number is set)<br>left_enc_frame: Remaining frames to encode (valid only if receive_frame_number is set)<br>total_input_buf_cnt: Total number of input buffers used so far<br>total_output_buf_cnt: Total number of output buffers used so far<br>fps: Current frame rate</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="decoding-status-1">Decoding Status<a href="#decoding-status-1" class="hash-link" aria-label="Direct link to Decoding Status" title="Direct link to Decoding Status">​</a></h5>
<p>Decoding Debug Information</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jpu</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode param</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx  dec_id feed_mode pix_fmt bitstream_buf_size bitstream_buf_count frame_buf_count mirror rotate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    jpeg         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">3133440</span><span class="token plain">                   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode frameinfo</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx  dec_id display_width display_height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    jpeg          </span><span class="token number" style="color:#36acaa">1920</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">1088</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">decode status</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec_idx  dec_id cur_input_buf_cnt cur_output_buf_cnt total_input_buf_cnt total_output_buf_cnt     fps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    jpeg                 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                </span><span class="token number" style="color:#36acaa">3779</span><span class="token plain">                 </span><span class="token number" style="color:#36acaa">3779</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">264</span><br></span></code></pre></div></div>
<p>Parameter Explanation</p>
<table><thead><tr><th>Debug Info Group</th><th>Status Parameter</th><th>Description</th></tr></thead><tbody><tr><td>decode param</td><td>Basic Decoding Parameters</td><td>dec_idx: Decoding instance<br>dec_id: Decoding type<br>feed_mode: Feed mode<br>pix_fmt: Pixel format<br>bitstream_buf_size: Size of input bitstream buffer<br>bitstream_buf_count: Number of input bitstream buffers<br>frame_buf_count: Number of output framebuffer buffers<br>mirror: Whether mirroring is enabled<br>rotate: Whether rotation is enabled</td></tr><tr><td>decode frameinfo</td><td>Decoded Frame Info</td><td>dec_idx: Decoding instance ID<br>dec_id: Decoding type<br>display_width: Display width<br>display_height: Display height</td></tr><tr><td>decode status</td><td>Current Decoding Status Parameters</td><td>dec_idx: Decoding instance ID<br>dec_id: Decoding type<br>cur_input_buf_cnt: Number of currently used input buffers<br>cur_output_buf_cnt: Number of currently used output buffers<br>total_input_buf_cnt: Total number of input buffers used so far<br>total_output_buf_cnt: Total number of output buffers used so far<br>fps: Current frame rate</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="typical-scenarios">Typical Scenarios<a href="#typical-scenarios" class="hash-link" aria-label="Direct link to Typical Scenarios" title="Direct link to Typical Scenarios">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="single-stream-encoding">Single-Stream Encoding<a href="#single-stream-encoding" class="hash-link" aria-label="Direct link to Single-Stream Encoding" title="Direct link to Single-Stream Encoding">​</a></h4>
<p>The single-stream encoding scenario is illustrated below. Scenario 0 is a simple case: YUV video/image files are read from eMMC, encoded by VPU hardware into H.26x bitstreams or by JPU hardware into JPEG images, and finally saved back to eMMC as files. Scenario 1 is a more complex pipeline where camera-captured data is encoded, compressed, and either stored or transmitted over network/PCIe.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/788c1e3b839232111ccd53d35d25e278.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="single-stream-decoding">Single-Stream Decoding<a href="#single-stream-decoding" class="hash-link" aria-label="Direct link to Single-Stream Decoding" title="Direct link to Single-Stream Decoding">​</a></h4>
<p>The single-stream decoding scenario is illustrated below. Scenario 0 is a simple case: H.26x bitstreams or JPEG image files are read from eMMC, decoded by VPU or JPU hardware into YUV data, and saved back to eMMC as files. Scenario 1 is a complex pipeline where encoded video or image data is received via network or PCIe, decoded by VPU or JPU hardware, and displayed via IDE.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/e50f9bf3c4d1ecfbd36b354f9009e8bc.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="multi-stream-encoding">Multi-Stream Encoding<a href="#multi-stream-encoding" class="hash-link" aria-label="Direct link to Multi-Stream Encoding" title="Direct link to Multi-Stream Encoding">​</a></h4>
<p>The multi-stream encoding scenario is shown below. Scenario 0 is a simple file-input case. Scenario 1 is a complex pipeline involving multiple modules. Note that in Scenario 1, the capabilities and limitations of all modules in the pipeline must be carefully considered.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/272e3467c640af379d1b4c0a1de27eae.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="multi-stream-decoding">Multi-Stream Decoding<a href="#multi-stream-decoding" class="hash-link" aria-label="Direct link to Multi-Stream Decoding" title="Direct link to Multi-Stream Decoding">​</a></h4>
<p>The multi-stream decoding scenario is shown below. Scenario 0 is a simple file-input case. Scenario 1 is a complex pipeline involving multiple modules. Note that in Scenario 1, the capabilities and limitations of all modules in the pipeline must be carefully considered.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/04f0aba90a1d65017dfeb90f9afa43e2.png" alt="" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="codec-api">Codec API<a href="#codec-api" class="hash-link" aria-label="Direct link to Codec API" title="Direct link to Codec API">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mediacodec-interface-description">MediaCodec Interface Description<a href="#mediacodec-interface-description" class="hash-link" aria-label="Direct link to MediaCodec Interface Description" title="Direct link to MediaCodec Interface Description">​</a></h3>
<p>The MediaCodec module is primarily used for audio, video, and JPEG image encoding/decoding. This module provides a set of interfaces to facilitate user input of data to be processed and retrieval of processed data. It supports multiple concurrent encoding or decoding instances. Video and JPEG image encoding/decoding are hardware-accelerated, requiring users to link against <code>libmultimedia.so</code>. Audio encoding/decoding is software-based using FFmpeg interfaces, requiring users to link against <code>libffmedia.so</code>. The table below lists the video and audio codecs supported on RDK S100. Note that AAC encoding/decoding requires a license; users must obtain proper authorization before enabling related features.</p>
<p>H.265 supports up to Main profile and Level 5.1, with Main-tier support. H.264 supports up to High profile and Level 5.2. MJPEG/JPEG supports ISO/IEC 10918-1 Baseline sequential. Supported audio codecs include: G.711 A-law/Mu-law, G.729 ADPCM, ADPCM IMA WAV, FLAC, AAC LC, AAC Main, AAC SSR, AAC LTP, AAC LD, AAC HE, and AAC HEv2 (AAC requires a license).</p>
<p>Additionally, video and image sources include two types: images from VIO input and user-provided YUV data (which may be loaded from files or received over a network). Audio sources include two types: audio from MIC input (digitized by the Audio Codec) and user-provided PCM data (which may be loaded from files or received over a network).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="gop">GOP<a href="#gop" class="hash-link" aria-label="Direct link to GOP" title="Direct link to GOP">​</a></h4>
<p>H.264/H.265 encoding supports GOP structure configuration. Users can select from nine predefined GOP structures or define custom GOP structures.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="gop-structure-table">GOP Structure Table<a href="#gop-structure-table" class="hash-link" aria-label="Direct link to GOP Structure Table" title="Direct link to GOP Structure Table">​</a></h5>
<p>A GOP structure table defines a periodic GOP pattern used throughout the encoding process. Elements in a single structure table are described below. Users can specify reference frames for each picture. If a frame after an IDR references a frame before the IDR, the encoder automatically handles this to avoid invalid references—users need not worry about such cases. When defining a custom GOP, users must specify the number of structure tables (up to 3), and tables must be ordered in decoding sequence.</p>
<table><thead><tr><th>Element</th><th>Description</th></tr></thead><tbody><tr><td>Type</td><td>Slice type (I, P)</td></tr><tr><td>POC</td><td>Display order of the frame within a GOP, ranging from 1 to GOP size</td></tr><tr><td>QPoffset</td><td>Quantization parameter offset for the picture in the custom GOP</td></tr><tr><td>NUM_REF_PIC_L0</td><td>Flag to enable multi-reference pictures for P frames. Valid only if PIC_TYPE is P</td></tr><tr><td>temporal_id</td><td>Temporal layer of the frame. A frame cannot reference another frame with a higher temporal_id (range: 0–6).</td></tr><tr><td>1st_ref_POC</td><td>POC of the first reference picture in L0</td></tr><tr><td>2nd_ref_POC</td><td>POC of the first reference picture in L1 if Type is B; POC of the second reference picture in L0 if Type is P. Note that reference_L1 can share the same POC as reference_L0 in B slices, but for better compression efficiency, it is recommended that reference_L1 and reference_L0 have different POCs.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="predefined-gop-structures">Predefined GOP Structures<a href="#predefined-gop-structures" class="hash-link" aria-label="Direct link to Predefined GOP Structures" title="Direct link to Predefined GOP Structures">​</a></h5>
<table><thead><tr><th>Index</th><th>GOP Structure</th><th>Low Delay (encoding order = display order)</th><th>GOP Size</th><th>Encoding Order</th><th>Minimum Source Frame Buffer</th><th>Minimum Decoded Picture Buffer</th><th>Intra Period (I Frame Interval) Requirement</th></tr></thead><tbody><tr><td>1</td><td>I</td><td>Yes</td><td>1</td><td>I0-I1-I2…</td><td>1</td><td>1</td><td></td></tr><tr><td>2</td><td>P</td><td>Yes</td><td>1</td><td>P0-P1-P2…</td><td>1</td><td>2</td><td></td></tr><tr><td>3</td><td>B</td><td>Yes</td><td>1</td><td>B0-B1-B2…</td><td>1</td><td>3</td><td></td></tr><tr><td>4</td><td>BP</td><td>No</td><td>2</td><td>B1-P0-B3-P2…</td><td>1</td><td>3</td><td>Multiple of 2</td></tr><tr><td>5</td><td>BBBP</td><td>Yes</td><td>1</td><td>B2-B1-B3-P0…</td><td>7</td><td>4</td><td>Multiple of 4</td></tr><tr><td>6</td><td>PPPP</td><td>Yes</td><td>4</td><td>P0-P1-P2-P3…</td><td>1</td><td>2</td><td></td></tr><tr><td>7</td><td>BBBB</td><td>Yes</td><td>4</td><td>B0-B1-B2-B3…</td><td>1</td><td>3</td><td></td></tr><tr><td>8</td><td>BBBB BBBB</td><td>Yes</td><td>1</td><td>B3-B2-B4-B1-B6-B5-B7-B0…</td><td>12</td><td>5</td><td>Multiple of 8</td></tr><tr><td>9</td><td>P</td><td>Yes</td><td>1</td><td>P0</td><td>1</td><td>2</td><td></td></tr></tbody></table>
<p>The following describes the nine predefined GOP structures.</p>
<p>GOP Preset 1</p>
<ul>
<li>Contains only I-frames with no inter-frame references;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop1.png" alt="gop1" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop2.png" alt="gop2" class="img_ev3q"></p>
<p>GOP Preset 2</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>P-frames reference two previous frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop3.png" alt="gop3" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop4.png" alt="gop4" class="img_ev3q"></p>
<p>GOP Preset 3</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference two previous frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop5.png" alt="gop5" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop6.png" alt="gop6" class="img_ev3q"></p>
<p>GOP Preset 4</p>
<ul>
<li>Contains I-, P-, and B-frames;</li>
<li>P-frames reference two previous frames;</li>
<li>B-frames reference one previous and one future frame;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop7.png" alt="gop7" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop8.png" alt="gop8" class="img_ev3q"></p>
<p>GOP Preset 5</p>
<ul>
<li>Contains I-, P-, and B-frames;</li>
<li>P-frames reference two previous frames;</li>
<li>B-frames reference one previous and one future frame (which can be either P or B);</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop9.png" alt="gop9" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop10.png" alt="gop10" class="img_ev3q"></p>
<p>GOP Preset 6</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>P-frames reference two previous frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop11.png" alt="gop11" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop12.png" alt="gop12" class="img_ev3q"></p>
<p>GOP Preset 7</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference two previous frames;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop13.png" alt="gop13" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop14.png" alt="gop14" class="img_ev3q"></p>
<p>GOP Preset 8</p>
<ul>
<li>Contains only I-frames and B-frames;</li>
<li>B-frames reference one previous and one future frame;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop15.png" alt="gop15" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop16.png" alt="gop16" class="img_ev3q"></p>
<p>GOP Preset 9</p>
<ul>
<li>Contains only I-frames and P-frames;</li>
<li>Each P-frame references one forward reference frame;</li>
<li>Low latency;</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop17.png" alt="gop17" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/gop18.png" alt="gop18" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="long-term-reference-frames">Long-term Reference Frames<a href="#long-term-reference-frames" class="hash-link" aria-label="Direct link to Long-term Reference Frames" title="Direct link to Long-term Reference Frames">​</a></h4>
<p>Users can specify the interval for long-term reference frames and the interval at which frames reference long-term reference frames, as shown in the figure below:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/reference_frame.png" alt="reference_frame" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="intra-refresh">Intra Refresh<a href="#intra-refresh" class="hash-link" aria-label="Direct link to Intra Refresh" title="Direct link to Intra Refresh">​</a></h4>
<p>Intra Refresh mode enhances error resilience by periodically inserting intra-coded MBs/CTUs within non-I frames. It provides the decoder with more recovery points to prevent image corruption caused by temporal errors. Users can specify the number of consecutive rows, columns, or step size of MBs/CTUs to force the encoder to insert intra-coded units. Additionally, users may specify the size of intra-coded units, allowing the encoder to internally determine which blocks require intra coding.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rate-control">Rate Control<a href="#rate-control" class="hash-link" aria-label="Direct link to Rate Control" title="Direct link to Rate Control">​</a></h4>
<p>MediaCodec supports bitrate control for H.264, H.265, and MJPEG codecs. For H.264 and H.265 encoding channels, it supports five rate control modes: CBR, VBR, AVBR, FixQp, and QpMap. For MJPEG encoding channels, it supports FixQp mode.</p>
<ul>
<li>CBR ensures a stable overall encoded bitrate;</li>
<li>VBR maintains consistent visual quality;</li>
<li>AVBR balances both bitrate and quality, producing a relatively stable stream in terms of both bitrate and image quality;</li>
<li>FixQp fixes the QP value for every I-frame and P-frame;</li>
<li>QpMap assigns a specific QP value to each block within a frame (block size is 32×32 for H.265 and 16×16 for H.264).</li>
</ul>
<p>For CBR and AVBR, the encoder internally determines an appropriate QP value for each frame to maintain constant bitrate. The encoder supports three levels of rate control: frame-level, CTU/MB-level, and subCTU/subMB-level.</p>
<ul>
<li>Frame-level control calculates a single QP per frame based on the target bitrate to ensure bitrate stability.</li>
<li>CTU/MB-level control assigns a QP to each 64×64 CTU or 16×16 MB according to its target bitrate, achieving finer bitrate control, though frequent QP adjustments may cause visual quality instability.</li>
<li>subCTU/subMB-level control assigns a QP to each 32×32 subCTU or 8×8 subMB. Complex blocks receive higher QP values, while static blocks receive lower QP values—since the human eye is more sensitive to static regions than complex ones. Detection of complex vs. static regions relies on internal hardware modules. This level aims to improve subjective visual quality while maintaining bitrate stability, resulting in higher SSIM scores but potentially lower PSNR scores.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="roi">ROI<a href="#roi" class="hash-link" aria-label="Direct link to ROI" title="Direct link to ROI">​</a></h4>
<p>ROI encoding works similarly to QpMap: users must assign a QP value to each block in raster-scan order, as illustrated below:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/roi_map.png" alt="roi_map" class="img_ev3q"></p>
<p>For H.264, each block is 16×16; for H.265, it is 32×32. In the ROI map, each QP value occupies one byte, ranging from 0 to 51. ROI encoding can operate alongside CBR or AVBR.</p>
<ul>
<li>When CBR/AVBR is disabled, the actual QP for each block equals the value specified in the ROI map.</li>
<li>When CBR/AVBR is enabled, the actual QP for block <em>i</em> is calculated as:</li>
</ul>
<p>QP(i) = MQP(i) + RQP(i) - ROIAvgQP</p>
<p>where:</p>
<ul>
<li>MQP is the value from the ROI map,</li>
<li>RQP is the QP determined by the encoder’s internal rate control,</li>
<li>ROIAvgQP is the average QP value across the entire ROI map.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="inputoutput-buffer-management">Input/Output Buffer Management<a href="#inputoutput-buffer-management" class="hash-link" aria-label="Direct link to Input/Output Buffer Management" title="Direct link to Input/Output Buffer Management">​</a></h4>
<p>MediaCodec uses two types of buffers: input and output. Typically, these buffers are allocated uniformly by MediaCodec via the ION interface, so users do not need to manage allocation directly. Instead, users should call <code>dequeue</code> to obtain an available buffer before use and <code>queue</code> to return it after processing.</p>
<p>However, to reduce unnecessary buffer copying in certain scenarios—e.g., when using PYM’s output buffer directly as MediaCodec input (since PYM allocates this buffer internally via ION)—MediaCodec also supports user-allocated input buffers. In such cases, users must allocate physically contiguous buffers via the ION interface and set the <code>external_frame_buf</code> field in <code>media_codec_context_t</code> before configuring MediaCodec.</p>
<p>Note: Even when providing external input buffers, users must still perform <code>dequeue</code> to retrieve buffer metadata (e.g., virtual and physical addresses), populate this information, and then call <code>queue</code>.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/buffer.png" alt="buffer" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="frame-rate-control">Frame Rate Control<a href="#frame-rate-control" class="hash-link" aria-label="Direct link to Frame Rate Control" title="Direct link to Frame Rate Control">​</a></h4>
<p>MediaCodec does not currently support internal frame rate control.</p>
<ul>
<li>If users do <strong>not</strong> enable direct VIO–MediaCodec interaction via <code>hb_mm_mc_set_camera</code>, they must manually control the input buffer frame rate.</li>
<li>If VIO–MediaCodec interaction <strong>is</strong> enabled, users only manage output buffers; input buffering is handled automatically. In this mode, MediaCodec performs no frame rate control on input buffers. If encoding stalls or the input buffer queue becomes full, MediaCodec will wait until space becomes available before proceeding.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="frame-skip-configuration">Frame Skip Configuration<a href="#frame-skip-configuration" class="hash-link" aria-label="Direct link to Frame Skip Configuration" title="Direct link to Frame Skip Configuration">​</a></h4>
<p>Users can call <code>hb_mm_mc_skip_pic</code> to set the next queued input frame to &quot;skip&quot; mode. This mode applies only to non-I frames. In skip mode, the encoder ignores the input frame and instead generates the reconstructed frame by reusing the previous frame’s reconstruction, encoding the current input as a P-frame.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jpeg-codec-limitations">JPEG Codec Limitations<a href="#jpeg-codec-limitations" class="hash-link" aria-label="Direct link to JPEG Codec Limitations" title="Direct link to JPEG Codec Limitations">​</a></h4>
<ul>
<li>
<p>For JPEG/MJPEG <strong>encoding</strong>:</p>
<ul>
<li>With YUV420/YUV422 input: width must be 16-byte aligned, height 8-byte aligned.</li>
<li>With YUV440/YUV444/YUV400 input: both width and height must be 8-byte aligned.</li>
<li>If cropping is applied, the crop origin (x, y) must also be 8-byte aligned.</li>
</ul>
</li>
<li>
<p>For JPEG/MJPEG <strong>encoding with 90°/270° rotation</strong>:</p>
<ul>
<li>YUV420: width 16-aligned, height 8-aligned.</li>
<li>YUV422/YUV440: width 16-aligned, height 16-aligned.</li>
<li>YUV444/YUV400: width and height 8-aligned.</li>
<li>With cropping:<!-- -->
<ul>
<li>YUV420: crop width 16-aligned, crop height 8-aligned.</li>
<li>YUV422/YUV440: crop width 16-aligned, crop height 16-aligned.</li>
<li>YUV444/YUV400: crop width and height 8-aligned.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>For JPEG/MJPEG <strong>encoding with 90°/270° rotation</strong>:</p>
<ul>
<li>YUV422 input becomes YUV440 after rotation.</li>
<li>YUV440 input becomes YUV422 after rotation.</li>
</ul>
</li>
<li>
<p>For JPEG/MJPEG <strong>decoding with rotation or mirroring</strong>:</p>
<ul>
<li>Output YUV format must match input format, <strong>except</strong>:<!-- -->
<ul>
<li>When decoding YUV422 JPEG/MJPEG with 90°/270° rotation, output format must be YUV440p, YUYV, YVYU, UYVY, or VYUY.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>JPEG/MJPEG <strong>decoding</strong>: Rotation/mirroring cannot be used simultaneously with cropping.</p>
</li>
<li>
<p>JPEG/MJPEG <strong>decoding</strong>: Output buffer dimensions must align with the input format’s MCU width and height. If cropping is enabled, all crop parameters (origin x/y and width/height) must also align with the MCU dimensions.<br>
<!-- -->(MCU sizes: 420 → 16×16, 422 → 16×8, 440 → 8×16, 400 → 8×8, 444 → 8×8.)</p>
</li>
<li>
<p>JPEG/MJPEG <strong>decoding</strong>: Output format Packed YUV444 requires input in YUV444 format.</p>
</li>
<li>
<p>JPEG/MJPEG <strong>decoding</strong>: Only supports <code>MC_FEEDING_MODE_FRAME_SIZE</code> mode.</p>
</li>
<li>
<p>JPEG <strong>encoding</strong>: If the user specifies the bitstream buffer size, an additional 4KB must be allocated.</p>
</li>
<li>
<p>JPEG <strong>encoding</strong>: Since the encoder processes data in 16×16 units, non-aligned input may result in padding differences in the final encoded data. This does not affect valid pixel data but is a hardware limitation; caution is advised when performing MD5 comparisons.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-reference">API Reference<a href="#api-reference" class="hash-link" aria-label="Direct link to API Reference" title="Direct link to API Reference">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_descriptor">hb_mm_mc_get_descriptor<a href="#hb_mm_mc_get_descriptor" class="hash-link" aria-label="Direct link to hb_mm_mc_get_descriptor" title="Direct link to hb_mm_mc_get_descriptor">​</a></h4>
<p>【Function Declaration】</p>
<p>const media_codec_descriptor_t* hb_mm_mc_get_descriptor(media_codec_id_t codec_id);</p>
<p>【Parameters】</p>
<ul>
<li>[IN] media_codec_id_t codec_id: Specifies the codec type.</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>Non-null: Codec descriptor containing information.</li>
<li>NULL: No descriptor found for the given codec ID.</li>
</ul>
<p>【Description】</p>
<p>Retrieves codec information supported by MediaCodec based on <code>codec_id</code>, including codec name, detailed description, MIME type, and supported profiles.</p>
<p>【Example  】</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_codec.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_error.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">media_codec_descriptor_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_get_descriptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEDIA_CODEC_ID_H265</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_default_context">hb_mm_mc_get_default_context<a href="#hb_mm_mc_get_default_context" class="hash-link" aria-label="Direct link to hb_mm_mc_get_default_context" title="Direct link to hb_mm_mc_get_default_context">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_default_context(media_codec_id_t codec_id, hb_bool encoder, media_codec_context_t *context);</p>
<p>【Parameters】</p>
<ul>
<li>[IN] media_codec_id_t codec_id: Specifies the codec type.</li>
<li>[IN] hb_bool encoder: Indicates whether the codec is an encoder (<code>true</code>) or decoder (<code>false</code>).</li>
<li>[OUT] media_codec_context_t *context: Receives the default context for the specified codec.</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Success.</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters.</li>
</ul>
<p>【Description】</p>
<p>Obtains the default configuration attributes for a specified codec.</p>
<p>【Example】</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_codec.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_error.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_context_t</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_get_default_context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEDIA_CODEC_ID_H265</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_initialize">hb_mm_mc_initialize<a href="#hb_mm_mc_initialize" class="hash-link" aria-label="Direct link to hb_mm_mc_initialize" title="Direct link to hb_mm_mc_initialize">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_initialize(media_codec_context_t *context)</p>
<p>【Parameters】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context configuration for the codec.</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Success.</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error.</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters.</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not permitted.</li>
<li>HB_MEDIA_ERR_INSUFFICIENT_RES: Insufficient internal memory resources.</li>
<li>HB_MEDIA_ERR_NO_FREE_INSTANCE: No free instance available (max: 32 for Video, 64 for MJPEG/JPEG, 32 for Audio).</li>
</ul>
<p>【Description】</p>
<p>Initializes an encoder or decoder. Upon success, MediaCodec enters the <code>MEDIA_CODEC_STATE_INITIALIZED</code> state.</p>
<p>【Example】</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_codec.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;hb_media_error.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> Uint64 </span><span class="token function" style="color:#d73a49">osal_gettime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">timespec</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">clock_gettime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CLOCK_MONOTONIC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">tp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">tp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tv_sec</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tv_nsec</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">MediaCodecTestContext</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_context_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">inputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> MediaCodecTestContext</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">AsyncMediaCtx</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_context_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lastStream</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 startTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">int32_t</span><span class="token plain"> duration</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> AsyncMediaCtx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_encoder_input_buffer_available</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hb_ptr userdata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">media_codec_buffer_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">inputBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">asyncCtx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Int noMoreInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">noMoreInput</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        curTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">osal_gettime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curTime </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">startTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">duration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vir_ptr</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to rewind input file\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vir_ptr</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to read input file\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s There is no more input data!\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TAG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        noMoreInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vframe_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_encoder_output_buffer_available</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hb_ptr userdata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">media_codec_buffer_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outputBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">media_codec_output_buffer_info_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">extraInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">asyncCtx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">mc_265_output_stream_info_t</span><span class="token plain"> info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> extraInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">video_stream_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vstream_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vir_ptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vstream_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputBuffer</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vstream_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stream_end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;There is no more output data!\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">lastStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_encoder_media_codec_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hb_ptr userdata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hb_s32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">asyncCtx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AsyncMediaCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncCtx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">lastStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ERROR happened!\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_vlc_buffer_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hb_ptr userdata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hb_s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> vlc_buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MediaCodecTestContext </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">userdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s %s VLC Buffer size = %d; Reset to %d.\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TAG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __FUNCTION__</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vlc_buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vlc_buf_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vlc_buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vlc_buf_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">do_async_encoding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> step </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AsyncMediaCtx asyncCtx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MediaCodecTestContext </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_context_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">inputFileName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">inputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outputFileName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">outputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_state_t</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MEDIA_CODEC_STATE_NONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputFileName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputFileName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">asyncCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AsyncMediaCtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">outFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outFile</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">duration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">osal_gettime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_callback_t</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">on_input_buffer_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    on_encoder_input_buffer_available</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">on_output_buffer_available </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    on_encoder_output_buffer_available</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">on_media_codec_message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> on_encoder_media_codec_message</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_set_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">asyncCtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_callback_t</span><span class="token plain"> callback2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">on_vlc_buffer_message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> on_vlc_buffer_message</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vlc_buf_size </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_set_vlc_buffer_listener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">callback2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_configure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">mc_av_codec_startup_params_t</span><span class="token plain"> startup_params</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">video_enc_startup_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receive_frame_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">startup_params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> ERR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">asyncCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">hb_mm_mc_stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">hb_mm_mc_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">hb_mm_mc_get_state</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_UNINITIALIZED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">hb_mm_mc_stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">hb_mm_mc_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> outputFileName</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MAX_FILE_PATH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./tmp.yuv&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> inputFileName</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MAX_FILE_PATH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./output.h265&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">mc_video_codec_enc_params_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">media_codec_context_t</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">media_codec_context_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">codec_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MEDIA_CODEC_ID_H265</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encoder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">video_enc_params</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">640</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">480</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pix_fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MC_PIXEL_FORMAT_YUV420P</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">frame_buf_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">external_frame_buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitstream_buf_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rc_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MC_AV_RC_MODE_H265CBR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hb_mm_mc_get_rate_control_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rc_params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rc_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h265_cbr_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bit_rate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rc_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h265_cbr_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_rate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rc_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h265_cbr_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intra_period </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">gop_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decoding_refresh_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">gop_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gop_preset_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rot_degree </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MC_CCW_0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mir_direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MC_DIRECTION_NONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">frame_cropping_flag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FALSE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputFileName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">outputFileName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outputFileName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">do_async_encoding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_callback">hb_mm_mc_set_callback<a href="#hb_mm_mc_set_callback" class="hash-link" aria-label="Direct link to hb_mm_mc_set_callback" title="Direct link to hb_mm_mc_set_callback">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_callback(media_codec_context_t *context,
const media_codec_callback_t *callback, hb_ptr userdata)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const media_codec_callback_t *callback: User-defined callback functions</li>
<li>[IN] hb_ptr userdata: Pointer to user data, which will be passed as an argument when the callback function is invoked</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
</ul>
<p>【Function Description】</p>
<p>Sets the callback function pointers. After calling this function, MediaCodec enters asynchronous operation mode.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_configure">hb_mm_mc_configure<a href="#hb_mm_mc_configure" class="hash-link" aria-label="Direct link to hb_mm_mc_configure" title="Direct link to hb_mm_mc_configure">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_configure(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INSUFFICIENT_RES: Insufficient internal memory resources</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Configures the encoder or decoder based on the input information. Upon successful invocation, MediaCodec enters the MEDIA_CODEC_STATE_CONFIGURED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_start">hb_mm_mc_start<a href="#hb_mm_mc_start" class="hash-link" aria-label="Direct link to hb_mm_mc_start" title="Direct link to hb_mm_mc_start">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_start(media_codec_context_t *context, const<br>
<!-- -->mc_av_codec_startup_params_t *info)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] mc_av_codec_startup_params_t *info: Startup parameters for audio/video encoding or decoding</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INSUFFICIENT_RES: Insufficient internal memory resources</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Starts the encoding/decoding process. MediaCodec will create the codec instance, set up sequences or parse the data stream, register Framebuffers, encode header information, etc. Upon successful invocation, MediaCodec enters the MEDIA_CODEC_STATE_STARTED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_stop">hb_mm_mc_stop<a href="#hb_mm_mc_stop" class="hash-link" aria-label="Direct link to hb_mm_mc_stop" title="Direct link to hb_mm_mc_stop">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_stop(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Stops the encoding/decoding process, terminates all child threads, and releases associated resources. Upon successful invocation, MediaCodec returns to the MEDIA_CODEC_STATE_INITIALIZED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_pause">hb_mm_mc_pause<a href="#hb_mm_mc_pause" class="hash-link" aria-label="Direct link to hb_mm_mc_pause" title="Direct link to hb_mm_mc_pause">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_pause(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Pauses the encoding/decoding process and suspends all child threads. Upon successful invocation, MediaCodec enters the MEDIA_CODEC_STATE_PAUSED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_flush">hb_mm_mc_flush<a href="#hb_mm_mc_flush" class="hash-link" aria-label="Direct link to hb_mm_mc_flush" title="Direct link to hb_mm_mc_flush">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_flush(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Flushes the input and output buffer queues, forcing the encoder/decoder to flush any unprocessed input or output buffers. After this function is called, MediaCodec enters the MEDIA_CODEC_STATE_FLUSHING state. Upon successful completion, MediaCodec returns to the MEDIA_CODEC_STATE_STARTED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_release">hb_mm_mc_release<a href="#hb_mm_mc_release" class="hash-link" aria-label="Direct link to hb_mm_mc_release" title="Direct link to hb_mm_mc_release">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_release(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Releases all internal resources held by MediaCodec. The user must call hb_mm_mc_stop to stop encoding/decoding before invoking this function. Upon successful completion, MediaCodec enters the MEDIA_CODEC_STATE_UNINITIALIZED state.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_state">hb_mm_mc_get_state<a href="#hb_mm_mc_get_state" class="hash-link" aria-label="Direct link to hb_mm_mc_get_state" title="Direct link to hb_mm_mc_get_state">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_state(media_codec_context_t *context,<br>
<!-- -->media_codec_state_t *state)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] media_codec_state_t *state: Current state of MediaCodec</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves the current state of MediaCodec.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_initialize">hb_mm_mc_initialize</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_status">hb_mm_mc_get_status<a href="#hb_mm_mc_get_status" class="hash-link" aria-label="Direct link to hb_mm_mc_get_status" title="Direct link to hb_mm_mc_get_status">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_status(media_codec_context_t *context,<br>
<!-- -->mc_inter_status_t *status)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_inter_status_t *status: Current internal status of MediaCodec</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Obtain the current internal state information of MediaCodec.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_fd">hb_mm_mc_get_fd</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer<a href="#hb_mm_mc_queue_input_buffer" class="hash-link" aria-label="Direct link to hb_mm_mc_queue_input_buffer" title="Direct link to hb_mm_mc_queue_input_buffer">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_queue_input_buffer(media_codec_context_t<br>
<!-- -->*context, media_codec_buffer_t *buffer, hb_s32 timeout)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] media_codec_buffer_t *buffer: Input buffer information</li>
<li>[IN] hb_s32 timeout: Timeout duration</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_INVALID_BUFFER: Invalid buffer</li>
<li>HB_MEDIA_ERR_WAIT_TIMEOUT: Wait timeout</li>
</ul>
<p>【Function Description】</p>
<p>Submit a buffer requiring processing into MediaCodec.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct MediaCodecTestContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t duration; // s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} MediaCodecTestContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uint64 osal_gettime(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct timespec tp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ((Uint64)tp.tv_sec*1000 + tp.tv_nsec/1000000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_sync_encoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *inFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *outFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int noMoreInput = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int lastStream = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 lastTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int needFlush = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_state_t state = MEDIA_CODEC_STATE_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!inFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile = fopen(outputFileName, &quot;wb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get current time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params.video_enc_startup_params.receive_frame_number = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_pause(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!noMoreInput) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;inputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                curTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ((curTime - lastTime)/1000 &lt; (uint32_t)ctx-&gt;duration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if(fseek(inFile, 0, SEEK_SET)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            printf(&quot;Failed to rewind input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            printf(&quot;Failed to read input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;Time up(%d)\n&quot;,ctx-&gt;duration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;There is no more input data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputBuffer.vframe_buf.frame_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            noMoreInput = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;Queue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastStream) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret &amp;&amp; outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fwrite(outputBuffer.vstream_buf.vir_ptr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputBuffer.vstream_buf.size, 1, outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Queue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (outputBuffer.vstream_buf.stream_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;There is no more output data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Dequeue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needFlush) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_flush(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            needFlush = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }while(TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_state(context, &amp;state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context &amp;&amp; state !=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MEDIA_CODEC_STATE_UNINITIALIZED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fclose(outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;./tmp.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;./output.stream&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = &amp;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.duration = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_sync_encoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_dequeue_input_buffer">hb_mm_mc_dequeue_input_buffer<a href="#hb_mm_mc_dequeue_input_buffer" class="hash-link" aria-label="Direct link to hb_mm_mc_dequeue_input_buffer" title="Direct link to hb_mm_mc_dequeue_input_buffer">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_dequeue_input_buffer(media_codec_context_t
*context, media_codec_buffer_t *buffer, hb_s32 timeout)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 timeout: Timeout duration</li>
<li>[OUT] media_codec_buffer_t *buffer: Input buffer information</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_INVALID_BUFFER: Invalid buffer</li>
<li>HB_MEDIA_ERR_WAIT_TIMEOUT: Wait timeout</li>
</ul>
<p>【Function Description】</p>
<p>Obtain an input buffer.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_queue_output_buffer">hb_mm_mc_queue_output_buffer<a href="#hb_mm_mc_queue_output_buffer" class="hash-link" aria-label="Direct link to hb_mm_mc_queue_output_buffer" title="Direct link to hb_mm_mc_queue_output_buffer">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_queue_output_buffer(media_codec_context_t
*context, media_codec_buffer_t *buffer, hb_s32 timeout)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] media_codec_buffer_t *buffer: Output buffer information</li>
<li>[IN] hb_s32 timeout: Timeout duration</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_INVALID_BUFFER: Invalid buffer</li>
<li>HB_MEDIA_ERR_WAIT_TIMEOUT: Wait timeout</li>
</ul>
<p>【Function Description】</p>
<p>Return a processed output buffer back to MediaCodec.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_dequeue_output_buffer">hb_mm_mc_dequeue_output_buffer<a href="#hb_mm_mc_dequeue_output_buffer" class="hash-link" aria-label="Direct link to hb_mm_mc_dequeue_output_buffer" title="Direct link to hb_mm_mc_dequeue_output_buffer">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_dequeue_output_buffer(media_codec_context_t
*context, media_codec_buffer_t *buffer,
media_codec_output_buffer_info_t *info, hb_s32 timeout)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 timeout: Timeout duration</li>
<li>[OUT] media_codec_buffer_t *buffer: Output buffer information</li>
<li>[IN] media_codec_output_buffer_info_t
*info: Information of the output bitstream</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
<li>HB_MEDIA_ERR_INVALID_BUFFER: Invalid buffer</li>
<li>HB_MEDIA_ERR_WAIT_TIMEOUT: Wait timeout</li>
</ul>
<p>【Function Description】</p>
<p>Obtain an output buffer.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_queue_input_buffer">hb_mm_mc_queue_input_buffer</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode<a href="#hb_mm_mc_get_longterm_ref_mode" class="hash-link" aria-label="Direct link to hb_mm_mc_get_longterm_ref_mode" title="Direct link to hb_mm_mc_get_longterm_ref_mode">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_longterm_ref_mode(media_codec_context_t
*context, mc_video_longterm_ref_mode_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_longterm_ref_mode_t
*params: Long-term reference frame mode parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieve parameters of the long-term reference frame mode, applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum ENC_CONFIG_MESSAGE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_NONE = (0 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_LONGTERM_REF = (1 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INTRA_REFRESH = (1 &lt;&lt; 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_RATE_CONTROL = (1 &lt;&lt; 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_DEBLK_FILTER = (1 &lt;&lt; 3),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SAO = (1 &lt;&lt; 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENTROPY = (1 &lt;&lt; 5),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI_TIMING = (1 &lt;&lt; 6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SLICE = (1 &lt;&lt; 7),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR = (1 &lt;&lt; 8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SKIP_PIC = (1 &lt;&lt; 9),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SMART_BG = (1 &lt;&lt; 10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MONOCHROMA = (1 &lt;&lt; 11),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_PRED_UNIT = (1 &lt;&lt; 12),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TRANSFORM = (1 &lt;&lt; 13),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ROI = (1 &lt;&lt; 14),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MODE_DECISION = (1 &lt;&lt; 15),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_USER_DATA = (1 &lt;&lt; 16),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MJPEG = (1 &lt;&lt; 17),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_JPEG = (1 &lt;&lt; 18),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_CAMERA = (1 &lt;&lt; 19),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INSERT_USERDATA = (1 &lt;&lt; 20),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI = (1 &lt;&lt; 21),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_3DNR = (1 &lt;&lt; 22),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR_HEADER = (1 &lt;&lt; 23),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENABLE_IDR = (1 &lt;&lt; 24),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TOTAL = (1 &lt;&lt; 25),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ENC_CONFIG_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct MediaCodecTestContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t duration; // seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MESSAGE message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_longterm_ref_mode_t ref_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rate_control_params_t rc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_intra_refresh_params_t intra_refr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_deblk_filter_params_t deblk_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h265_sao_params_t sao;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h264_entropy_params_t entropy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_params_t vui;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_timing_params_t vui_timing;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_slice_params_t slice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_3dnr_enc_params_t noise_reduction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_smart_bg_enc_params_t smart_bg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_pred_unit_params_t pred_unit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_transform_params_t transform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_roi_params_t roi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_mode_decision_params_t mode_decision;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} MediaCodecTestContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uint64 osal_gettime(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct timespec tp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ((Uint64)tp.tv_sec*1000 + tp.tv_nsec/1000000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8_t uuid[] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dc45e9bd-e6d948b7-962cd820-d923eeef+HorizonAI&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void set_message(MediaCodecTestContext *ctx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_longterm_ref_mode_t *ref_mode = &amp;ctx-&gt;ref_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_longterm_ref_mode(context, ref_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ref_mode-&gt;use_longterm = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ref_mode-&gt;longterm_pic_using_period = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ref_mode-&gt;longterm_pic_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_LONGTERM_REF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_LONGTERM_REF) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_longterm_ref_mode(context, &amp;ctx-&gt;ref_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_INTRA_REFRESH) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_intra_refresh_config(context, &amp;ctx-&gt;intra_refr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_intra_refresh_config(context, &amp;ctx-&gt;intra_refr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_SAO) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_sao_config(context, &amp;ctx-&gt;sao);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_sao_config(context, &amp;ctx-&gt;sao);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_ENTROPY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_entropy_config(context, &amp;ctx-&gt;entropy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_entropy_config(context, &amp;ctx-&gt;entropy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_VUI) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_set_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_VUI_TIMING) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_vui_timing_config(context, &amp;ctx-&gt;vui_timing);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_vui_timing_config(context, &amp;ctx-&gt;vui_timing);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rate_control_params_t *rc_params = &amp;ctx-&gt;rc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rc_params-&gt;mode = context-&gt;video_enc_params.rc_params.mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_rate_control_config(context, rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (rc_params-&gt;mode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H264CBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_cbr_params.intra_period = 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H264VBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_vbr_params.intra_qp = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_vbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H264AVBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.intra_period = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.intra_qp = 25;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.bit_rate = 2000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.vbv_buffer_size = 3000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.min_qp_I = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.max_qp_I = 50;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.min_qp_P = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.max_qp_P = 45;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.min_qp_B = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.max_qp_B = 48;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.hvs_qp_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.hvs_qp_scale = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.max_delta_qp = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_avbr_params.qp_map_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H264FIXQP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_fixqp_params.force_qp_I = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_fixqp_params.force_qp_P = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_fixqp_params.force_qp_B = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h264_fixqp_params.intra_period = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H264QPMAP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H265CBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_cbr_params.intra_period = 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H265VBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_vbr_params.intra_qp = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_vbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H265AVBR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.intra_period = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.intra_qp = 25;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.bit_rate = 2000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.vbv_buffer_size = 3000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.min_qp_I = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.max_qp_I = 50;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.min_qp_P = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.max_qp_P = 45;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.min_qp_B = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.max_qp_B = 48;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.hvs_qp_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.hvs_qp_scale = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.max_delta_qp = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_avbr_params.qp_map_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H265FIXQP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_fixqp_params.force_qp_I = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_fixqp_params.force_qp_P = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_fixqp_params.force_qp_B = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rc_params-&gt;h265_fixqp_params.intra_period = 23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case MC_AV_RC_MODE_H265QPMAP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_RATE_CONTROL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_RATE_CONTROL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_rate_control_config(context, &amp;ctx-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_deblk_filter_params_t *deblk_filter = &amp;ctx-&gt;deblk_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_deblk_filter_config(context, deblk_filter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H264) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h264_deblk.disable_deblocking_filter_idc = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h264_deblk.slice_alpha_c0_offset_div2 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h264_deblk.slice_beta_offset_div2 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h265_deblk.slice_deblocking_filter_disabled_flag = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h265_deblk.slice_beta_offset_div2 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h265_deblk.slice_tc_offset_div2 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deblk_filter-&gt;h265_deblk.slice_loop_filter_across_slices_enabled_flag = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_DEBLK_FILTER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_DEBLK_FILTER) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_deblk_filter_config(context, &amp;ctx-&gt;deblk_filter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H264) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_h264_entropy_params_t *entropy = &amp;ctx-&gt;entropy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_get_entropy_config(context, entropy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entropy-&gt;entropy_coding_mode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;message = ENC_CONFIG_ENTROPY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;message &amp; ENC_CONFIG_ENTROPY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_set_entropy_config(context, &amp;ctx-&gt;entropy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_SKIP_PIC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_SKIP_PIC) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_skip_pic(context, 0), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_REQUEST_IDR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_REQUEST_IDR) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_request_idr_frame(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_slice_params_t *slice = &amp;ctx-&gt;slice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_slice_config(context, slice);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H264) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h264_slice.h264_slice_mode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h264_slice.h264_slice_arg = 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h265_slice.h265_dependent_slice_mode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h265_slice.h265_dependent_slice_arg = 80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h265_slice.h265_independent_slice_mode = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slice-&gt;h265_slice.h265_independent_slice_arg = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_SLICE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_SLICE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_slice_config(context, &amp;ctx-&gt;slice);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_smart_bg_enc_params_t *smart_bg = &amp;ctx-&gt;smart_bg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_smart_bg_enc_config(context, smart_bg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;bg_detect_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;bg_threshold_diff = 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;bg_threshold_mean_diff = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;bg_lambda_qp = 32;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;bg_delta_qp = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smart_bg-&gt;s2fme_disable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_SMART_BG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_SMART_BG) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_smart_bg_enc_config(context, &amp;ctx-&gt;smart_bg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_pred_unit_params_t *pred_unit = &amp;ctx-&gt;pred_unit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_pred_unit_config(context, pred_unit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H264) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_unit-&gt;h264_intra_pred.constrained_intra_pred_flag = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_unit-&gt;h265_pred_unit.intra_nxn_enable = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_unit-&gt;h265_pred_unit.constrained_intra_pred_flag = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_unit-&gt;h265_pred_unit.strong_intra_smoothing_enabled_flag = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_unit-&gt;h265_pred_unit.max_num_merge = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_PRED_UNIT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_PRED_UNIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_pred_unit_config(context, &amp;ctx-&gt;pred_unit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_transform_params_t *transform = &amp;ctx-&gt;transform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_transform_config(context, transform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H264) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h264_transform.transform_8x8_enable = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h264_transform.chroma_cb_qp_offset = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h264_transform.chroma_cr_qp_offset = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h264_transform.user_scaling_list_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h265_transform.chroma_cb_qp_offset = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h265_transform.chroma_cr_qp_offset = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transform-&gt;h265_transform.user_scaling_list_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_TRANSFORM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_TRANSFORM) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_transform_config(context, &amp;ctx-&gt;transform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_roi_params_t *roi = &amp;ctx-&gt;roi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_roi_config(context, roi);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    roi-&gt;roi_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_ROI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_ROI) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_roi_config(context, &amp;ctx-&gt;roi);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_mode_decision_params_t *mode_decision = &amp;ctx-&gt;mode_decision;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_mode_decision_config(context, mode_decision);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;mode_decision_enable = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu04_delta_rate = 76;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu08_delta_rate = 80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu16_delta_rate = 86;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu32_delta_rate = 87;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu04_intra_planar_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu04_intra_dc_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu04_intra_angle_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu08_intra_planar_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu08_intra_dc_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu08_intra_angle_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu16_intra_planar_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu16_intra_dc_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu16_intra_angle_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu32_intra_planar_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu32_intra_dc_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;pu32_intra_angle_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu08_intra_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu08_inter_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu08_merge_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu16_intra_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu16_inter_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu16_merge_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu32_intra_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu32_inter_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_decision-&gt;cu32_merge_delta_rate = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ctx-&gt;message = ENC_CONFIG_MODE_DECISION;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_MODE_DECISION) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_mode_decision_config(context, &amp;ctx-&gt;mode_decision);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_INSERT_USERDATA) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_u32 length = sizeof(uuid)/sizeof(uuid[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_insert_user_data(context, uuid, length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ctx-&gt;message &amp; ENC_CONFIG_3DNR) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_get_3dnr_enc_config(context, &amp;ctx-&gt;noise_reduction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_3dnr_enc_config(context, &amp;ctx-&gt;noise_reduction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_ENABLE_IDR) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // disable idr frame first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;enable_idr_num) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_enable_idr_frame(context, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_REQUEST_IDR_HEADER) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_request_idr_header(context, ctx-&gt;force_idr_header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_sync_encoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *inFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *outFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int noMoreInput = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int lastStream = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 lastTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int needFlush = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_state_t state = MEDIA_CODEC_STATE_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!inFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile = fopen(outputFileName, &quot;wb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get current time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params.video_enc_startup_params.receive_frame_number = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_pause(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        set_message(ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!noMoreInput) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;inputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                curTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ((curTime - lastTime)/1000 &lt; (uint32_t)ctx-&gt;duration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if(fseek(inFile, 0, SEEK_SET)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            printf(&quot;Failed to rewind input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                printf(&quot;Failed to read input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Time up(%d)\n&quot;,ctx-&gt;duration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;There is no more input data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vframe_buf.frame_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    noMoreInput = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Queue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Dequeue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastStream) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info, 3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret &amp;&amp; outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fwrite(outputBuffer.vstream_buf.vir_ptr, outputBuffer.vstream_buf.size, 1, outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Queue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (/* condition */);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}if (outputBuffer.vstream_buf.stream_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;There is no more output data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;Dequeue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needFlush) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_flush(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            needFlush = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }while(TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_state(context, &amp;state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context &amp;&amp; state != MEDIA_CODEC_STATE_UNINITIALIZED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;./tmp.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;./output.stream&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = &amp;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.duration = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_sync_encoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_longterm_ref_mode">hb_mm_mc_set_longterm_ref_mode<a href="#hb_mm_mc_set_longterm_ref_mode" class="hash-link" aria-label="Direct link to hb_mm_mc_set_longterm_ref_mode" title="Direct link to hb_mm_mc_set_longterm_ref_mode">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_longterm_ref_mode(media_codec_context_t
*context, const mc_video_longterm_ref_mode_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_longterm_ref_mode_t
*params: Long-term reference frame mode parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets long-term reference frame mode parameters. These parameters are dynamic and applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_intra_refresh_config">hb_mm_mc_get_intra_refresh_config<a href="#hb_mm_mc_get_intra_refresh_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_intra_refresh_config" title="Direct link to hb_mm_mc_get_intra_refresh_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_intra_refresh_config(media_codec_context_t
*context, mc_video_intra_refresh_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_intra_refresh_params_t *params: Intra refresh parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves intra refresh parameters, applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_intra_refresh_config">hb_mm_mc_set_intra_refresh_config<a href="#hb_mm_mc_set_intra_refresh_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_intra_refresh_config" title="Direct link to hb_mm_mc_set_intra_refresh_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_intra_refresh_config(media_codec_context_t
*context, const mc_video_intra_refresh_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_intra_refresh_params_t
*params: Intra refresh parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets intra refresh mode parameters. These parameters are static and applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_rate_control_config">hb_mm_mc_get_rate_control_config<a href="#hb_mm_mc_get_rate_control_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_rate_control_config" title="Direct link to hb_mm_mc_get_rate_control_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_rate_control_config(media_codec_context_t
*context, mc_rate_control_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_rate_control_params_t *params: Rate control parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves rate control parameters. These parameters are dynamic and applicable to H.264/H.265/MJPEG.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_rate_control_config">hb_mm_mc_set_rate_control_config<a href="#hb_mm_mc_set_rate_control_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_rate_control_config" title="Direct link to hb_mm_mc_set_rate_control_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_rate_control_config(media_codec_context_t
*context, const mc_rate_control_params_t *params)【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_rate_control_params_t *params: Rate control parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets rate control parameters. These parameters are dynamic and applicable to H264/H265/MJPEG.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_deblk_filter_config">hb_mm_mc_get_deblk_filter_config<a href="#hb_mm_mc_get_deblk_filter_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_deblk_filter_config" title="Direct link to hb_mm_mc_get_deblk_filter_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_deblk_filter_config(media_codec_context_t<br>
<!-- -->*context, mc_video_deblk_filter_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_deblk_filter_params_t *params: Deblocking filter parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves deblocking filter parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_deblk_filter_config">hb_mm_mc_set_deblk_filter_config<a href="#hb_mm_mc_set_deblk_filter_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_deblk_filter_config" title="Direct link to hb_mm_mc_set_deblk_filter_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_deblk_filter_config(media_codec_context_t<br>
<!-- -->*context, const mc_video_deblk_filter_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_deblk_filter_params_t
*params: Deblocking filter parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets deblocking filter parameters. These parameters are dynamic and applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_sao_config">hb_mm_mc_get_sao_config<a href="#hb_mm_mc_get_sao_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_sao_config" title="Direct link to hb_mm_mc_get_sao_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_sao_config(media_codec_context_t *context,<br>
<!-- -->mc_h265_sao_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_h265_sao_params_t *params: SAO parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves SAO parameters, applicable to H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_sao_config">hb_mm_mc_set_sao_config<a href="#hb_mm_mc_set_sao_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_sao_config" title="Direct link to hb_mm_mc_set_sao_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_sao_config(media_codec_context_t *context,<br>
<!-- -->const mc_h265_sao_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_h265_sao_params_t *params: SAO parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets SAO parameters. These parameters are static and applicable to H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_entropy_config">hb_mm_mc_get_entropy_config<a href="#hb_mm_mc_get_entropy_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_entropy_config" title="Direct link to hb_mm_mc_get_entropy_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_entropy_config(media_codec_context_t *context, mc_h264_entropy_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] mc_h264_entropy_params_t *params: Entropy parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves entropy parameters, applicable to H264.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_entropy_config">hb_mm_mc_set_entropy_config<a href="#hb_mm_mc_set_entropy_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_entropy_config" title="Direct link to hb_mm_mc_set_entropy_config">​</a></h4>
<p>【Function Declaration】</p>
<p>extern hb_s32 hb_mm_mc_set_entropy_config(media_codec_context_t *context, const mc_h264_entropy_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_h264_entropy_params_t *params: Entropy parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets entropy parameters, applicable to H264.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_vui_timing_config">hb_mm_mc_get_vui_timing_config<a href="#hb_mm_mc_get_vui_timing_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_vui_timing_config" title="Direct link to hb_mm_mc_get_vui_timing_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_vui_timing_config(media_codec_context_t<br>
<!-- -->*context, mc_video_vui_timing_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_vui_timing_params_t *params: VUI Timing parameters</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Gets VUI Timing parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_vui_timing_config">hb_mm_mc_set_vui_timing_config<a href="#hb_mm_mc_set_vui_timing_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_vui_timing_config" title="Direct link to hb_mm_mc_set_vui_timing_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_vui_timing_config(media_codec_context_t *context, const mc_video_vui_timing_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_vui_timing_params_t *params: VUI Timing parameters</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets VUI Timing parameters. These parameters are static and applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_slice_config">hb_mm_mc_get_slice_config<a href="#hb_mm_mc_get_slice_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_slice_config" title="Direct link to hb_mm_mc_get_slice_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_slice_config(media_codec_context_t *context, mc_video_slice_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_slice_params_t *params: Slice encoding parameters</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Gets slice encoding parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_slice_config">hb_mm_mc_set_slice_config<a href="#hb_mm_mc_set_slice_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_slice_config" title="Direct link to hb_mm_mc_set_slice_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_slice_config(media_codec_context_t *context, const mc_video_slice_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_slice_params_t *params: Slice encoding parameters</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets slice encoding parameters. These parameters are dynamic and applicable to H264/H265. The number of slices per frame must not exceed 1500.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_insert_user_data">hb_mm_mc_insert_user_data<a href="#hb_mm_mc_insert_user_data" class="hash-link" aria-label="Direct link to hb_mm_mc_insert_user_data" title="Direct link to hb_mm_mc_insert_user_data">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_insert_user_data(media_codec_context_t *context, hb_u8 *data, hb_u32 length)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_u8 *data: User data</li>
<li>[IN] hb_u32 length: Length of user data</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Inserts user data into the encoded bitstream. This parameter is dynamic and applicable to H264/H265/MJPG/JPG.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_request_idr_frame">hb_mm_mc_request_idr_frame<a href="#hb_mm_mc_request_idr_frame" class="hash-link" aria-label="Direct link to hb_mm_mc_request_idr_frame" title="Direct link to hb_mm_mc_request_idr_frame">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_request_idr_frame(media_codec_context_t *context)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
</ul>
<p>【Function Description】</p>
<p>Requests an IDR frame. This interface supports dynamic configuration and is applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_skip_pic">hb_mm_mc_skip_pic<a href="#hb_mm_mc_skip_pic" class="hash-link" aria-label="Direct link to hb_mm_mc_skip_pic" title="Direct link to hb_mm_mc_skip_pic">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_skip_pic(media_codec_context_t *context, hb_s32 src_idx)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 src_idx: Source buffer index</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Enables skip-mode encoding for the specified picture. This interface supports dynamic configuration and is applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_smart_bg_enc_config">hb_mm_mc_get_smart_bg_enc_config<a href="#hb_mm_mc_get_smart_bg_enc_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_smart_bg_enc_config" title="Direct link to hb_mm_mc_get_smart_bg_enc_config">​</a></h4>
<p>【Function Declaration】</p>
<p>extern hb_s32<br>
<!-- -->hb_mm_mc_get_smart_bg_enc_config(media_codec_context_t<br>
<!-- -->*context, mc_video_smart_bg_enc_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_smart_bg_enc_params_t<br>
<!-- -->*params: Smart background encoding mode parameters</li>
</ul>
<p>【Return Value】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Get smart background encoding parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_smart_bg_enc_config">hb_mm_mc_set_smart_bg_enc_config<a href="#hb_mm_mc_set_smart_bg_enc_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_smart_bg_enc_config" title="Direct link to hb_mm_mc_set_smart_bg_enc_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_smart_bg_enc_config(media_codec_context_t<br>
<!-- -->*context, const mc_video_smart_bg_enc_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_smart_bg_enc_params_t<br>
<!-- -->*params: Smart background encoding mode parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Set smart background encoding parameters. These parameters are dynamic and applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_pred_unit_config">hb_mm_mc_get_pred_unit_config<a href="#hb_mm_mc_get_pred_unit_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_pred_unit_config" title="Direct link to hb_mm_mc_get_pred_unit_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_pred_unit_config(media_codec_context_t<br>
<!-- -->*context, mc_video_pred_unit_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_pred_unit_params_t *params: Prediction unit parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Get prediction unit parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_pred_unit_config">hb_mm_mc_set_pred_unit_config<a href="#hb_mm_mc_set_pred_unit_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_pred_unit_config" title="Direct link to hb_mm_mc_set_pred_unit_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_pred_unit_config(media_codec_context_t<br>
<!-- -->*context, const mc_video_pred_unit_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_pred_unit_params_t *params: Prediction unit parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Set prediction unit parameters. These parameters are dynamic and applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_transform_config">hb_mm_mc_get_transform_config<a href="#hb_mm_mc_get_transform_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_transform_config" title="Direct link to hb_mm_mc_get_transform_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_transform_config(media_codec_context_t<br>
<!-- -->*context, mc_video_transform_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_transform_params_t *params: Transform parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Get Transform parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_transform_config">hb_mm_mc_set_transform_config<a href="#hb_mm_mc_set_transform_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_transform_config" title="Direct link to hb_mm_mc_set_transform_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_transform_config(media_codec_context_t<br>
<!-- -->*context, const mc_video_transform_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_transform_params_t *params:<br>
<!-- -->Transform parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Set Transform parameters. These parameters are dynamic and applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_roi_config">hb_mm_mc_get_roi_config<a href="#hb_mm_mc_get_roi_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_roi_config" title="Direct link to hb_mm_mc_get_roi_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_roi_config(media_codec_context_t *context,<br>
<!-- -->mc_video_roi_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_roi_params_t *params: ROI encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Get ROI encoding parameters, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_roi_config">hb_mm_mc_set_roi_config<a href="#hb_mm_mc_set_roi_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_roi_config" title="Direct link to hb_mm_mc_set_roi_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_roi_config(media_codec_context_t *context,<br>
<!-- -->const mc_video_roi_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_roi_params_t *params: ROI encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】Set ROI encoding parameters. This parameter is a dynamic parameter and applies to H.264/H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_mode_decision_config">hb_mm_mc_get_mode_decision_config<a href="#hb_mm_mc_get_mode_decision_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_mode_decision_config" title="Direct link to hb_mm_mc_get_mode_decision_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_mode_decision_config(media_codec_context_t<br>
<!-- -->*context, mc_video_mode_decision_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_mode_decision_params_t *params: Mode decision parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieve mode decision parameters. This function applies to H265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_mode_decision_config">hb_mm_mc_set_mode_decision_config<a href="#hb_mm_mc_set_mode_decision_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_mode_decision_config" title="Direct link to hb_mm_mc_set_mode_decision_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_mode_decision_config(media_codec_context_t<br>
<!-- -->*context, const mc_video_mode_decision_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_mode_decision_params_t *params: Mode decision parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Set mode decision parameters. This parameter is a dynamic parameter and applies to H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_user_data">hb_mm_mc_get_user_data<a href="#hb_mm_mc_get_user_data" class="hash-link" aria-label="Direct link to hb_mm_mc_get_user_data" title="Direct link to hb_mm_mc_get_user_data">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_user_data(media_codec_context_t *context,<br>
<!-- -->mc_user_data_buffer_t *params , hb_s32 timeout)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_user_data_buffer_t *params: User data</li>
<li>[IN] timeout: Timeout duration</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieve user data from the decoded stream. This function applies to H.264/H.265.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int check_and_init_test(MediaCodecTestContext *ctx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName, *outputFileName, *inputMd5FileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx == NULL || ctx-&gt;context == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputMd5FileName = ctx-&gt;inputMd5FileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;%s[%d:%d] Thread work in %s mode\n&quot;, TAG, getpid(), gettid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;workMode == THREAD_WORK_MODE_SYNC ? &quot;sync&quot; :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (ctx-&gt;workMode == THREAD_WORK_MODE_ASYNC ? &quot;async&quot; : &quot;poll&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;%s[%d:%d] InputFileName = %s\n&quot;, TAG, getpid(), gettid(), inputFileName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;%s[%d:%d] OutputFileName = %s\n&quot;, TAG, getpid(), gettid(), outputFileName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;%s[%d:%d] InputMd5File = %s\n&quot;, TAG, getpid(), gettid(), inputMd5FileName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(inputFileName, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(outputFileName, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (inputFileName == NULL || outputFileName == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;inFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;outFile = fopen(outputFileName, &quot;wb+&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;outFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;inFile == NULL || ctx-&gt;outFile == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;md5Test == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (inputMd5FileName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;inMd5File = fopen(inputMd5FileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_NE(ctx-&gt;inMd5File, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;inMd5File == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // allocate ion buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;ionFd = ion_open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_GT(ctx-&gt;ionFd, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;ionFd &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;encoder == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Thread use %s buffer mode, %d rc mode\n&quot;, TAG, getpid(), gettid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;context-&gt;video_enc_params.external_frame_buf ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;external&quot; : &quot;internal&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;context-&gt;video_enc_params.rc_params.mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_enc_params.external_frame_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;exFb = (ExternalFrameBuffer *) malloc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;context-&gt;video_enc_params.frame_buf_count * sizeof(ExternalFrameBuffer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            EXPECT_NE(ctx-&gt;exFb, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;exFb == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Uint32 i=0; i&lt;ctx-&gt;context-&gt;video_enc_params.frame_buf_count; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exFb[i].buf.size = ctx-&gt;context-&gt;video_enc_params.width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                * ctx-&gt;context-&gt;video_enc_params.height * 3/2; // only for yuv420;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = allocate_ion_mem(ctx-&gt;ionFd, &amp;ctx-&gt;exFb[i].buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                EXPECT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exFb[i].valid = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exFb[i].src_idx = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Thread use %s buffer mode, %d feed mode.\n&quot;, TAG, getpid(), gettid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;context-&gt;video_dec_params.external_bitstream_buf ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;external&quot; : &quot;internal&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;context-&gt;video_dec_params.feed_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_dec_params.external_bitstream_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;exBs = (ExternalStreamBuffer *) malloc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count * sizeof(ExternalStreamBuffer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            EXPECT_NE(ctx-&gt;exBs, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;exBs == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Uint32 i=0; i&lt;ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exBs[i].buf.size = ctx-&gt;context-&gt;video_dec_params.bitstream_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = allocate_ion_mem(ctx-&gt;ionFd, &amp;ctx-&gt;exBs[i].buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                EXPECT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exBs[i].valid = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exBs[i].src_idx = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// open decode files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;encoder != TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;video_dec_params.feed_mode == MC_FEEDING_MODE_FRAME_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = avformat_open_input(&amp;ctx-&gt;avContext, ctx-&gt;inputFileName, 0, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_GE(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = avformat_find_stream_info(ctx-&gt;avContext, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_GE(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;videoIndex = av_find_best_stream(ctx-&gt;avContext, AVMEDIA_TYPE_VIDEO, -1, -1, NULL, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_GE(ctx-&gt;videoIndex, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;videoIndex &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        av_init_packet(&amp;ctx-&gt;avpacket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;feedingSize == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uint32_t KB = 1024;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int32_t probability10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            srand((uint32_t)time(NULL));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;feedingSize = rand() % MAX_FEEDING_SIZE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            probability10 = (ctx-&gt;feedingSize % 100) &lt; 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;feedingSize &lt; KB) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (probability10 == FALSE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx-&gt;feedingSize *= 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Feeding size = %d\n&quot;, TAG,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            getpid(), gettid(), ctx-&gt;feedingSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;firstPacket = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int check_and_release_test(MediaCodecTestContext *ctx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int md5Match, wholeFileSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint8_t *md5Buffer = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;inFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;outFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx == NULL || ctx-&gt;context == NULL || ctx-&gt;inFile == NULL ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;outFile == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;encoder != TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_dec_params.feed_mode == MC_FEEDING_MODE_FRAME_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;avContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                avformat_close_input(&amp;ctx-&gt;avContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;encoder == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_enc_params.external_frame_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;exFb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (Uint32 i=0; i&lt;ctx-&gt;context-&gt;video_enc_params.frame_buf_count; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = release_ion_mem(ctx-&gt;ionFd, &amp;ctx-&gt;exFb[i].buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                free(ctx-&gt;exFb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_dec_params.external_bitstream_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;exBs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (Uint32 i=0; i&lt;ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = release_ion_mem(ctx-&gt;ionFd, &amp;ctx-&gt;exBs[i].buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                free(ctx-&gt;exBs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;ionFd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ion_close(ctx-&gt;ionFd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;md5Test &amp;&amp; ctx-&gt;inMd5File) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fseek(ctx-&gt;outFile, 0, SEEK_END);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wholeFileSize = ftell(ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fseek(ctx-&gt;outFile, 0, SEEK_SET);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5Buffer = (uint8_t *)malloc(wholeFileSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_NE(md5Buffer, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (md5Buffer == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fread(md5Buffer, wholeFileSize, 1, ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5Match = compare_md5_value(MD5_SIZE, ctx-&gt;inMd5File,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5Buffer, wholeFileSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        free(md5Buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(ctx-&gt;inMd5File);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_EQ(md5Match, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (md5Match != 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(ctx-&gt;inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void on_vlc_buffer_message(hb_ptr userdata, hb_s32 * vlc_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)userdata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_NE(vlc_buf, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_GE(ctx-&gt;vlc_buf_size, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s %s VLC Buffer size = %d; Reset to %d.\n&quot;, TAG, __FUNCTION__,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *vlc_buf, ctx-&gt;vlc_buf_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *vlc_buf = ctx-&gt;vlc_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int read_input_streams(MediaCodecTestContext *ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_buffer_t *inputBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0, ret2 = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint32 bufIdx = 0, srcIdx = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Int32 doRead = TRUE, doRewind = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint8_t *seqHeader = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int seqHeaderSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *bufPtr = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int avalBufSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;inFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;outFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(inputBuffer, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx == NULL || ctx-&gt;context == NULL || ctx-&gt;inFile == NULL ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;outFile == NULL || inputBuffer == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Invalid parameters(%s).\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TAG, getpid(), gettid(), __FUNCTION__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;stabilityTest || ctx-&gt;pfTest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRewind = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        curTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((curTime - ctx-&gt;testStartTime)/1000 &lt; (uint32_t)ctx-&gt;duration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRead = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Time up(%d)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TAG, getpid(), gettid(), ctx-&gt;duration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRead = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;video_dec_params.external_bitstream_buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // release input buffer and take it as the new input buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (bufIdx = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bufIdx &lt; ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bufIdx++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;exBs[bufIdx].valid &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;exBs[bufIdx].src_idx == inputBuffer-&gt;vstream_buf.src_idx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                srcIdx = inputBuffer-&gt;vstream_buf.src_idx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EXPECT_NE(bufIdx, ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bufIdx == ctx-&gt;context-&gt;video_dec_params.bitstream_buf_count) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bufPtr = (void *)ctx-&gt;exBs[srcIdx].buf.virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_dec_params.feed_mode ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MC_FEEDING_MODE_FRAME_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avalBufSize = ctx-&gt;exBs[srcIdx].buf.size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avalBufSize = (ctx-&gt;exBs[srcIdx].buf.size &lt; (int)ctx-&gt;feedingSize) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;exBs[srcIdx].buf.size : ctx-&gt;feedingSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer-&gt;vstream_buf.fd = ctx-&gt;exBs[srcIdx].buf.fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer-&gt;vstream_buf.phy_ptr =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;exBs[srcIdx].buf.phys_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputBuffer-&gt;vstream_buf.vir_ptr =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (hb_u8 *)ctx-&gt;exBs[srcIdx].buf.virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bufPtr = (void *)inputBuffer-&gt;vstream_buf.vir_ptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;context-&gt;video_dec_params.feed_mode ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MC_FEEDING_MODE_FRAME_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avalBufSize = inputBuffer-&gt;vstream_buf.size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avalBufSize = (inputBuffer-&gt;vstream_buf.size &lt; ctx-&gt;feedingSize) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputBuffer-&gt;vstream_buf.size : ctx-&gt;feedingSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (doRead == FALSE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // MC_FEEDING_MODE_FRAME_SIZE mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;context-&gt;video_dec_params.feed_mode == MC_FEEDING_MODE_FRAME_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;avpacket.size == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = av_read_frame(ctx-&gt;avContext, &amp;ctx-&gt;avpacket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret &lt; 0 &amp;&amp; doRewind == FALSE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Failed to read input file (error=0x%x)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TAG, getpid(), gettid(), ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret &lt; 0 &amp;&amp; doRewind == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    avformat_close_input(&amp;ctx-&gt;avContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret2 = avformat_open_input(&amp;ctx-&gt;avContext, ctx-&gt;inputFileName, 0, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_GE(ret2, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret2 &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ret = ret2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*ret = avformat_find_stream_info(ctx-&gt;avContext, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_GE(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx-&gt;videoIndex = av_find_best_stream(ctx-&gt;avContext, AVMEDIA_TYPE_VIDEO, -1, -1, NULL, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_GE(ctx-&gt;videoIndex, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ctx-&gt;videoIndex &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ret = -1;break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    av_init_packet(&amp;ctx-&gt;avpacket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Reuse previous stream packet size %d\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid(), ctx-&gt;avpacket.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } while (ret &lt; 0 &amp;&amp; doRewind == TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret == AVERROR_EOF || ctx-&gt;avContext-&gt;pb-&gt;eof_reached == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] End of file!\n&quot;, TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] Failed to av_read_frame error(0x%08x)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TAG, getpid(), gettid(), ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Read packet size %d\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TAG, getpid(), gettid(), ctx-&gt;avpacket.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seqHeaderSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ctx-&gt;firstPacket) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AVCodecParameters* codec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int retSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            codec = ctx-&gt;avContext-&gt;streams[ctx-&gt;videoIndex]-&gt;codecpar;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seqHeader = (uint8_t*)malloc(codec-&gt;extradata_size + 1024);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (seqHeader == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] Failed to malloc seqHeader\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset((void*)seqHeader, 0x00, codec-&gt;extradata_size + 1024);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seqHeaderSize = build_dec_seq_header(seqHeader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;context-&gt;codec_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;avContext-&gt;streams[ctx-&gt;videoIndex], &amp;retSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (seqHeaderSize &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] Failed to build seqHeader\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;firstPacket = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((ctx-&gt;avpacket.size &lt;= avalBufSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; (seqHeaderSize &lt;= avalBufSize)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int bufSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (seqHeaderSize) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                memcpy(bufPtr, seqHeader, seqHeaderSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bufSize = seqHeaderSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /*memcpy((char *)bufPtr+bufSize,ctx-&gt;avpacket.data, ctx-&gt;avpacket.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bufSize += ctx-&gt;avpacket.size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                av_packet_unref(&amp;ctx-&gt;avpacket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;avpacket.size = 0;*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                memcpy(bufPtr,ctx-&gt;avpacket.data, ctx-&gt;avpacket.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bufSize = ctx-&gt;avpacket.size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                av_packet_unref(&amp;ctx-&gt;avpacket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx-&gt;avpacket.size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputBuffer-&gt;vstream_buf.size = bufSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] The stream buffer is too &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;small!\n&quot;, TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (seqHeader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            free(seqHeader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seqHeader = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // MC_FEEDING_MODE_STREAM_SIZE mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = fread(bufPtr, 1, avalBufSize, ctx-&gt;inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt;= 0 &amp;&amp; doRewind == FALSE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Failed to read input file (error=0x%x)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TAG, getpid(), gettid(), ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt;= 0 &amp;&amp; doRewind == TRUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(fseek(ctx-&gt;inFile, 0, SEEK_SET)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s Failed to rewind input file (pid=%d, tid=%d)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (ret == 0 &amp;&amp; doRewind == TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputBuffer-&gt;vstream_buf.size = ret &gt; 0 ? ret : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int write_output_frames(MediaCodecTestContext *ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_buffer_t *outputBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;inFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;outFile, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(outputBuffer, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx == NULL || ctx-&gt;context == NULL || ctx-&gt;inFile == NULL ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;outFile == NULL || outputBuffer == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Invalid parameters(%s).\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TAG, getpid(), gettid(), __FUNCTION__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ctx-&gt;stabilityTest &amp;&amp; !ctx-&gt;pfTest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fwrite(outputBuffer-&gt;vframe_buf.vir_ptr[0], outputBuffer-&gt;vframe_buf.size,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            1, ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int do_decode_params_checking(MediaCodecTestContext *ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_buffer_t *outputBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_NE(ctx-&gt;context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx == NULL || ctx-&gt;context == NULL || ctx-&gt;inFile == NULL ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx-&gt;outFile == NULL || outputBuffer == NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Invalid parameters(%s).\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TAG, getpid(), gettid(), __FUNCTION__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;enable_get_userdata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_user_data_buffer_t userdata = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_get_user_data(context, &amp;userdata, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Get userdata %d:\n&quot;, TAG, getpid(), gettid(), userdata.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (uint32_t i = 0; i &lt; userdata.size; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i &lt; 16) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] userdata[i]:%x\n&quot;, TAG, getpid(), gettid(), userdata.virt_addr[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] userdata[i]:%c\n&quot;, TAG, getpid(), gettid(), userdata.virt_addr[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_release_user_data(context, &amp;userdata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_sync_decoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int step = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_callback_t callback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t decStartTime = 0, decFinishTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;workMode = THREAD_WORK_MODE_SYNC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(check_and_init_test(ctx), 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get current time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx-&gt;testStartTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Step %d initialize (outFile=%s, FileFd=%p)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TAG, getpid(), gettid(), step++, ctx-&gt;outputFileName, ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback.on_vlc_buffer_message = on_vlc_buffer_message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;vlc_buf_size &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_vlc_buffer_listener(context, &amp;callback, ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Step %d configure\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s[%d:%d] Step %d start\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;startup_params, 0x00, sizeof(mc_av_codec_startup_params_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ctx-&gt;lastStream) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] Step %d dequeue input\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // process input buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] input buffer viraddr %p phy addr %x, size = %d\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid(), inputBuffer.vstream_buf.vir_ptr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vstream_buf.phy_ptr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vstream_buf.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Step %d feed input (pid=%d, tid=%d)\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = read_input_streams(ctx, &amp;inputBuffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] There is no more input data(ret=%d)!\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid(), ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vstream_buf.stream_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputBuffer.vstream_buf.size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx-&gt;lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //EXPECT_EQ(ret, (int32_t)TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Step %d queue input(size=%d)\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid(), step++, inputBuffer.vstream_buf.size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;delaytest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    decStartTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    char info[256];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    hb_mm_strerror(ret, info, 256);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] dequeue input buffer fail.(%s)\n&quot;, TAG, getpid(), gettid(), info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ctx-&gt;lastFrame) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;%s[%d:%d] Step %d dequeue output\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // process output buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] output bufferviraddr %p phy addr %x, size = %d, outFile = %p\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TAG, getpid(), gettid(), outputBuffer.vframe_buf.vir_ptr[0],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    outputBuffer.vframe_buf.phy_ptr[0],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    outputBuffer.vframe_buf.size, ctx-&gt;outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Step %d write output file\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;delaytest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    decFinishTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if ((decFinishTime - decStartTime) &gt;= ctx-&gt;delaytime) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        printf(&quot;%s[%d:%d] Decoding time is %d, more than %dms\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TAG, getpid(), gettid(), (decFinishTime - decStartTime), ctx-&gt;delaytime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ASSERT_LE((decFinishTime - decStartTime), ctx-&gt;delaytime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ASSERT_EQ(write_output_frames(ctx, &amp;outputBuffer), 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] Step %d queue output\n&quot;, TAG, getpid(), gettid(), step++);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ASSERT_EQ(do_decode_params_checking(ctx, &amp;outputBuffer), 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (outputBuffer.vframe_buf.frame_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] There is no more output data!\n&quot;, TAG, getpid(), gettid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx-&gt;lastFrame = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                char info[256];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hb_mm_strerror(ret, info, 256);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;%s[%d:%d] dequeue output buffer fail.(%s)\n&quot;, TAG, getpid(), gettid(), info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;stabilityTest &amp;&amp; ctx-&gt;lastStream ==1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }while(TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(check_and_release_test(ctx), 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;input.h265&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;output.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestWidth = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestHeight = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestPixFmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestFeedMode = MC_FEEDING_MODE_FRAME_SIZE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestCodec = TEST_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_dec_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = (media_codec_context_t *)malloc(sizeof(media_codec_context_t ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_NE(context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;codec_id = get_codec_id(mTestCodec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;encoder = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context-&gt;video_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;feed_mode = mTestFeedMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = mTestPixFmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_size = mTestWidth * mTestHeight * 3 / 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_H265) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.bandwidth_Opt = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.reorder_enable = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.skip_mode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.cra_as_bla = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.dec_temporal_id_mode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;h265_dec_config.target_dec_temporal_id_plus1 = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputMd5FileName[MAX_FILE_PATH];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx.md5Test) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        char inputMd5Suffix[MAX_FILE_PATH] = &quot;.md5&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snprintf(dedicatedSuffix, MAX_FILE_PATH, &quot;%s&quot;, &quot;dec&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snprintf(inputMd5FileName, MAX_FILE_PATH, &quot;%s%s_%s_%s%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dedicatedInputPrefix, mGlobalPixFmtName[mTestPixFmt],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dedicatedSuffix, mGlobalCodecName[mTestCodec], inputMd5Suffix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.inputMd5FileName = inputMd5FileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_sync_decoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context != NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        free(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_release_user_data">hb_mm_mc_release_user_data<a href="#hb_mm_mc_release_user_data" class="hash-link" aria-label="Direct link to hb_mm_mc_release_user_data" title="Direct link to hb_mm_mc_release_user_data">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_release_user_data(media_codec_context_t *context, const mc_user_data_buffer_t * params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_user_data_buffer_t * params: User data</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Releases user data from the decoded stream. Applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_user_data">hb_mm_mc_get_user_data</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_mjpeg_config">hb_mm_mc_get_mjpeg_config<a href="#hb_mm_mc_get_mjpeg_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_mjpeg_config" title="Direct link to hb_mm_mc_get_mjpeg_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_mjpeg_config(media_codec_context_t *context, mc_mjpeg_enc_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_mjpeg_enc_params_t *params: MJPEG encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves MJPEG encoding parameters. Applicable to MJPEG.</p>
<p>【Example Code】</p>
<div class="language-# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestCodec = TEST_CODEC_ID_MJPEG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestPixFmt = MC_PIXEL_FORMAT_NV12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char dedicatedSuffix[MAX_FILE_PATH] = &quot;_test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputSuffix[MAX_FILE_PATH] = &quot;.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputSuffixJpeg[MAX_FILE_PATH] = &quot;.jpg&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputSuffixMjpg[MAX_FILE_PATH] = &quot;.mjpg&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(inputFileName, MAX_FILE_PATH, &quot;%s%s%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mInputSpecPrefix, mTest12Bit ? mGlobal12BPixFmtName[mTestPixFmt]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : mGlobalPixFmtName[mTestPixFmt], inputSuffix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(outputFileName, MAX_FILE_PATH, &quot;%s%s%s%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mOutputSpecPrefix, mTest12Bit ? mGlobal12BPixFmtName[mTestPixFmt]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : mGlobalPixFmtName[mTestPixFmt], dedicatedSuffix,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestCodec == TEST_CODEC_ID_JPEG ? outputSuffixJpeg : outputSuffixMjpg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = (media_codec_context_t *)malloc(sizeof(media_codec_context_t ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_NE(context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;codec_id = mTestCodec == TEST_CODEC_ID_JPEG ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MEDIA_CODEC_ID_JPEG : MEDIA_CODEC_ID_MJPEG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context-&gt;video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = mTestWidth;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = mTestHeight;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = mTestPixFmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_MJPEG) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;rc_params.mode = MC_AV_RC_MODE_MJPEGFIXQP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_get_rate_control_config(context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;mjpeg_enc_config.restart_interval = mTestWidth/16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;mjpeg_enc_config.extended_sequential = mTest12Bit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;jpeg_enc_config.restart_interval = mTestWidth/16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;jpeg_enc_config.extended_sequential = mTest12Bit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_mjpeg_enc_params_t mjpeg_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;mjpeg_params, 0x00, sizeof(mjpeg_params));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_mjpeg_config(context, &amp;mjpeg_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_set_mjpeg_config(context, &amp;mjpeg_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context != NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        free(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_mjpeg_config">hb_mm_mc_set_mjpeg_config<a href="#hb_mm_mc_set_mjpeg_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_mjpeg_config" title="Direct link to hb_mm_mc_set_mjpeg_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_mjpeg_config(media_codec_context_t
*context, const mc_mjpeg_enc_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_mjpeg_enc_params_t *params: MJPEG encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets MJPEG encoding parameters. These parameters are dynamic and applicable to MJPEG.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_mjpeg_config">hb_mm_mc_get_mjpeg_config</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_jpeg_config">hb_mm_mc_get_jpeg_config<a href="#hb_mm_mc_get_jpeg_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_jpeg_config" title="Direct link to hb_mm_mc_get_jpeg_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_jpeg_config(media_codec_context_t
*context, mc_jpeg_enc_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_jpeg_enc_params_t *params: JPEG encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves JPEG encoding parameters, applicable to JPEG.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestCodec = TEST_CODEC_ID_JPEG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mTestPixFmt = MC_PIXEL_FORMAT_NV12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char dedicatedSuffix[MAX_FILE_PATH] = &quot;_test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputSuffix[MAX_FILE_PATH] = &quot;.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputSuffixJpeg[MAX_FILE_PATH] = &quot;.jpg&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputSuffixMjpg[MAX_FILE_PATH] = &quot;.mjpg&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(inputFileName, MAX_FILE_PATH, &quot;%s%s%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mInputSpecPrefix, mTest12Bit ? mGlobal12BPixFmtName[mTestPixFmt]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : mGlobalPixFmtName[mTestPixFmt], inputSuffix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(outputFileName, MAX_FILE_PATH, &quot;%s%s%s%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mOutputSpecPrefix, mTest12Bit ? mGlobal12BPixFmtName[mTestPixFmt]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : mGlobalPixFmtName[mTestPixFmt], dedicatedSuffix,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mTestCodec == TEST_CODEC_ID_JPEG ? outputSuffixJpeg : outputSuffixMjpg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = (media_codec_context_t *)malloc(sizeof(media_codec_context_t ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_NE(context, nullptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;codec_id = mTestCodec == TEST_CODEC_ID_JPEG ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_JPEG : MEDIA_CODEC_ID_MJPEG;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context-&gt;encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context-&gt;video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = mTestWidth;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = mTestHeight;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = mTestPixFmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context-&gt;codec_id == MEDIA_CODEC_ID_MJPEG) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;rc_params.mode = MC_AV_RC_MODE_MJPEGFIXQP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_get_rate_control_config(context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;mjpeg_enc_config.restart_interval = mTestWidth/16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;mjpeg_enc_config.extended_sequential = mTest12Bit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;jpeg_enc_config.restart_interval = mTestWidth/16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params-&gt;jpeg_enc_config.extended_sequential = mTest12Bit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_jpeg_enc_params_t jpeg_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;jpeg_params, 0x00, sizeof(jpeg_params));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_jpeg_config(context, &amp;jpeg_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jpeg_params.quality_factor = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jpeg_params.restart_interval = (((params-&gt;width+15)&gt;&gt;4) *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ((params-&gt;height+15)&gt;&gt;4) * 2) + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jpeg_params.crop_en = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_set_jpeg_config(context, &amp;jpeg_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)HB_MEDIA_ERR_INVALID_PARAMS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jpeg_params.restart_interval = 70;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_set_jpeg_config(context, &amp;jpeg_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context != NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        free(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_jpeg_config">hb_mm_mc_set_jpeg_config<a href="#hb_mm_mc_set_jpeg_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_jpeg_config" title="Direct link to hb_mm_mc_set_jpeg_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_jpeg_config(media_codec_context_t
*context, const mc_jpeg_enc_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_jpeg_enc_params_t *params: JPEG encoding parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets JPEG encoding parameters. These parameters are dynamic and applicable to JPEG encoding.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_jpeg_config">hb_mm_mc_get_jpeg_config</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_fd">hb_mm_mc_get_fd<a href="#hb_mm_mc_get_fd" class="hash-link" aria-label="Direct link to hb_mm_mc_get_fd" title="Direct link to hb_mm_mc_get_fd">​</a></h4>
<p><strong>Function Declaration</strong></p>
<p>hb_s32 hb_mm_mc_get_fd(media_codec_context_t * context, hb_s32 *fd)</p>
<p><strong>Parameter Description</strong></p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] hb_s32 *fd: File descriptor of the device node</li>
</ul>
<p><strong>Return Values</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>Function Description</strong></p>
<p>Obtains the file descriptor (fd) of the device node, which can be used with the select() operation to monitor codec results.</p>
<p><strong>Example Code</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct MediaCodecTestContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int abnormal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t duration; // s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} MediaCodecTestContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uint64 osal_gettime(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct timespec tp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ((Uint64)tp.tv_sec*1000 + tp.tv_nsec/1000000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_poll_encoding_select(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int pollFd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *outFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int lastStream = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fd_set readFds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_inter_status_t status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile = fopen(outputFileName, &quot;wb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_fd(context, &amp;pollFd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FD_ZERO(&amp;readFds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FD_SET(pollFd, &amp;readFds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = select(pollFd+1, &amp;readFds, NULL, NULL, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;Failed to select fd = %d.(err %s)\n&quot;, pollFd, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;abnormal = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (ret == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;Time out to select fd = %d.\n&quot;, pollFd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx-&gt;abnormal = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (FD_ISSET(pollFd, &amp;readFds)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ASSERT_EQ(hb_mm_mc_get_status(context, &amp;status), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ctx-&gt;testLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    printf(&quot;%s[%d:%d] output count %d input count %d\n&quot;, TAG, getpid(), gettid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    status.cur_output_buf_cnt, status.cur_input_buf_cnt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!ret &amp;&amp; outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fwrite(outputBuffer.vstream_buf.vir_ptr, outputBuffer.vstream_buf.size, 1, outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (outputBuffer.vstream_buf.stream_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        printf(&quot;There is no more output data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ctx-&gt;abnormal = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        printf(&quot;Dequeue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (!lastStream &amp;&amp; !ctx-&gt;abnormal);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (pollFd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_close_fd(context, pollFd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_poll_encoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pthread_t thread_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void* retVal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *inFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int noMoreInput = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_state_t state = MEDIA_CODEC_STATE_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!inFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params.video_enc_startup_params.receive_frame_number = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pthread_create(&amp;thread_id, NULL, (void* (*)(void*))do_poll_encoding_select, ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;inputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;There is no more input data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.frame_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                noMoreInput = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Queue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }while(!noMoreInput &amp;&amp; !ctx-&gt;abnormal);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pthread_join(thread_id, &amp;retVal);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_get_state(context, &amp;state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context &amp;&amp; state != MEDIA_CODEC_STATE_UNINITIALIZED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fclose(inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;./tmp.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;./output.stream&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = &amp;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.duration = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_poll_encoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_close_fd">hb_mm_mc_close_fd<a href="#hb_mm_mc_close_fd" class="hash-link" aria-label="Direct link to hb_mm_mc_close_fd" title="Direct link to hb_mm_mc_close_fd">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_close_fd(media_codec_context_t * context,
hb_s32 fd)</p>
<p>**【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 fd: File descriptor of the device node</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Closes the device node.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_fd">hb_mm_mc_get_fd</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_camera">hb_mm_mc_set_camera<a href="#hb_mm_mc_set_camera" class="hash-link" aria-label="Direct link to hb_mm_mc_set_camera" title="Direct link to hb_mm_mc_set_camera">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_camera(media_codec_context_t *context,
hb_s32 pipeline, hb_s32 channel_port_id)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 pipeline: Pipeline</li>
<li>[IN] hb_s32 channel_port_id: Channel port ID</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets VIO camera information. This parameter is static and applicable to H.264/H.265.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _media_codec_context {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_id_t codec_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool encoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 instance_index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_video_codec_enc_params_t video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_video_codec_dec_params_t video_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_audio_codec_enc_params_t audio_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_audio_codec_dec_params_t audio_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} media_codec_context_t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void MediaCodecAPITest::init_params_H265() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = mGlobalWidth;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = mGlobalHeight;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = mGlobalPixFmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init_params_H265();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(hb_mm_mc_initialize(&amp;context), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(hb_mm_mc_set_camera(&amp;context, 1, 1), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EXPECT_EQ(hb_mm_mc_release(&amp;context), (int32_t)0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_vui_config">hb_mm_mc_get_vui_config<a href="#hb_mm_mc_get_vui_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_vui_config" title="Direct link to hb_mm_mc_get_vui_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_vui_config(media_codec_context_t *context,
mc_video_vui_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] mc_video_vui_ params_t *params: VUI parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves VUI parameters.</p>
<p>【Additional Notes】</p>
<p>Currently, during video encoding, the default color range in the header information is set to full range mode. To set it to limited range, you must explicitly call the hb_mm_mc_set_vui_config interface.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum ENC_CONFIG_MESSAGE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_NONE = (0 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_LONGTERM_REF = (1 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INTRA_REFRESH = (1 &lt;&lt; 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_RATE_CONTROL = (1 &lt;&lt; 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_DEBLK_FILTER = (1 &lt;&lt; 3),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SAO = (1 &lt;&lt; 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENTROPY = (1 &lt;&lt; 5),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI_TIMING = (1 &lt;&lt; 6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SLICE = (1 &lt;&lt; 7),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR = (1 &lt;&lt; 8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SKIP_PIC = (1 &lt;&lt; 9),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SMART_BG = (1 &lt;&lt; 10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MONOCHROMA = (1 &lt;&lt; 11),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_PRED_UNIT = (1 &lt;&lt; 12),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TRANSFORM = (1 &lt;&lt; 13),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ROI = (1 &lt;&lt; 14),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MODE_DECISION = (1 &lt;&lt; 15),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_USER_DATA = (1 &lt;&lt; 16),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MJPEG = (1 &lt;&lt; 17),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_JPEG = (1 &lt;&lt; 18),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_CAMERA = (1 &lt;&lt; 19),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INSERT_USERDATA = (1 &lt;&lt; 20),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI = (1 &lt;&lt; 21),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_3DNR = (1 &lt;&lt; 22),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR_HEADER = (1 &lt;&lt; 23),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENABLE_IDR = (1 &lt;&lt; 24),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TOTAL = (1 &lt;&lt; 25),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ENC_CONFIG_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct MediaCodecTestContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t duration; // s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MESSAGE message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_longterm_ref_mode_t ref_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rate_control_params_t rc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_intra_refresh_params_t intra_refr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_deblk_filter_params_t deblk_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h265_sao_params_t sao;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h264_entropy_params_t entropy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_params_t vui;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_timing_params_t vui_timing;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_slice_params_t slice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_3dnr_enc_params_t noise_reduction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_smart_bg_enc_params_t smart_bg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_pred_unit_params_t pred_unit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_transform_params_t transform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_roi_params_t roi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_mode_decision_params_t mode_decision;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} MediaCodecTestContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uint64 osal_gettime(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct timespec tp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ((Uint64)tp.tv_sec*1000 + tp.tv_nsec/1000000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8_t uuid[] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;dc45e9bd-e6d948b7-962cd820-d923eeef+HorizonAI&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void set_message(MediaCodecTestContext *ctx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_VUI) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_get_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_sync_encoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *inFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *outFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int noMoreInput = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int lastStream = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 lastTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int needFlush = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_state_t state = MEDIA_CODEC_STATE_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!inFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile = fopen(outputFileName, &quot;wb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get current time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params.video_enc_startup_params.receive_frame_number = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_pause(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_message(ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!noMoreInput) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;inputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            curTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((curTime - lastTime)/1000 &lt; (uint32_t)ctx-&gt;duration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if(fseek(inFile, 0, SEEK_SET)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        printf(&quot;Failed to rewind input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            printf(&quot;Failed to read input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Time up(%d)\n&quot;,ctx-&gt;duration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;There is no more input data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.frame_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                noMoreInput = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Queue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!lastStream) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret &amp;&amp; outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fwrite(outputBuffer.vstream_buf.vir_ptr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputBuffer.vstream_buf.size, 1, outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Queue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (outputBuffer.vstream_buf.stream_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;There is no more output data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (needFlush) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_flush(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        needFlush = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}while(TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_state(context, &amp;state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (context &amp;&amp; state!=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_UNINITIALIZED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fclose(inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fclose(outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[]){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;./tmp.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;./output.stream&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = &amp;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_params_t *vui = &amp;ctx.vui;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_vui_config(context, vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vui-&gt;h265_vui.video_signal_type_present_flag = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vui-&gt;h265_vui.video_format = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vui-&gt;h265_vui.video_full_range_flag = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.message = ENC_CONFIG_VUI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_sync_encoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_vui_config">hb_mm_mc_set_vui_config<a href="#hb_mm_mc_set_vui_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_vui_config" title="Direct link to hb_mm_mc_set_vui_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_vui_config(media_codec_context_t *context,
const mc_video_vui_params_t *params)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] const mc_video_vui_params_t *params: VUI parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Sets VUI parameters, which are static parameters.</p>
<p>【Example Code】</p>
<p>Refer to <a href="#hb_mm_mc_get_vui_config">hb_mm_mc_get_vui_config</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_3dnr_enc_config">hb_mm_mc_get_3dnr_enc_config<a href="#hb_mm_mc_get_3dnr_enc_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_3dnr_enc_config" title="Direct link to hb_mm_mc_get_3dnr_enc_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_get_3dnr_enc_config(media_codec_context_t
*context, mc_video_3dnr_enc_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] mc_video_3dnr_enc_params_t *params: 3DNR parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Retrieves 3DNR parameters, which are dynamic parameters applicable to H.265.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum ENC_CONFIG_MESSAGE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_NONE = (0 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_LONGTERM_REF = (1 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INTRA_REFRESH = (1 &lt;&lt; 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_RATE_CONTROL = (1 &lt;&lt; 2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_DEBLK_FILTER = (1 &lt;&lt; 3),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SAO = (1 &lt;&lt; 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENTROPY = (1 &lt;&lt; 5),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI_TIMING = (1 &lt;&lt; 6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SLICE = (1 &lt;&lt; 7),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR = (1 &lt;&lt; 8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SKIP_PIC = (1 &lt;&lt; 9),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_SMART_BG = (1 &lt;&lt; 10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MONOCHROMA = (1 &lt;&lt; 11),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_PRED_UNIT = (1 &lt;&lt; 12),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TRANSFORM = (1 &lt;&lt; 13),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ROI = (1 &lt;&lt; 14),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MODE_DECISION = (1 &lt;&lt; 15),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_USER_DATA = (1 &lt;&lt; 16),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MJPEG = (1 &lt;&lt; 17),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_JPEG = (1 &lt;&lt; 18),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_CAMERA = (1 &lt;&lt; 19),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_INSERT_USERDATA = (1 &lt;&lt; 20),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_VUI = (1 &lt;&lt; 21),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_3DNR = (1 &lt;&lt; 22),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_REQUEST_IDR_HEADER = (1 &lt;&lt; 23),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_ENABLE_IDR = (1 &lt;&lt; 24),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_TOTAL = (1 &lt;&lt; 25),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ENC_CONFIG_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct MediaCodecTestContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32_t duration; // s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENC_CONFIG_MESSAGE message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_longterm_ref_mode_t ref_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rate_control_params_t rc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_intra_refresh_params_t intra_refr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_deblk_filter_params_t deblk_filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h265_sao_params_t sao;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_h264_entropy_params_t entropy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_params_t vui;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_vui_timing_params_t vui_timing;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_slice_params_t slice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_3dnr_enc_params_t noise_reduction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_smart_bg_enc_params_t smart_bg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_pred_unit_params_t pred_unit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_transform_params_t transform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_roi_params_t roi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_mode_decision_params_t mode_decision;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} MediaCodecTestContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uint64 osal_gettime(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct timespec tp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ((Uint64)tp.tv_sec*1000 + tp.tv_nsec/1000000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8_t uuid[] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;dc45e9bd-e6d948b7-962cd820-d923eeef+HorizonAI&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void set_message(MediaCodecTestContext *ctx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx-&gt;message &amp; ENC_CONFIG_VUI) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hb_mm_mc_get_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_set_vui_config(context, &amp;ctx-&gt;vui);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void do_sync_encoding(void *arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *inFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE *outFile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int noMoreInput = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int lastStream = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 lastTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uint64 curTime = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int needFlush = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext *ctx = (MediaCodecTestContext *)arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t *context = ctx-&gt;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *inputFileName = ctx-&gt;inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *outputFileName = ctx-&gt;outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_state_t state = MEDIA_CODEC_STATE_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inFile = fopen(inputFileName, &quot;rb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!inFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outFile = fopen(outputFileName, &quot;wb&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get current time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_initialize(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_configure(context);if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_startup_params_t startup_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup_params.video_enc_startup_params.receive_frame_number = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_start(context, &amp;startup_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_pause(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ERR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_message(ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!noMoreInput) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_buffer_t inputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;inputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_dequeue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            curTime = osal_gettime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((curTime - lastTime)/1000 &lt; (uint32_t)ctx-&gt;duration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if(fseek(inFile, 0, SEEK_SET)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        printf(&quot;Failed to rewind input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ret = fread(inputBuffer.vframe_buf.vir_ptr[0], 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputBuffer.vframe_buf.size, inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (ret &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            printf(&quot;Failed to read input file\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Time up(%d)\n&quot;,ctx-&gt;duration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;There is no more input data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inputBuffer.vframe_buf.frame_end = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                noMoreInput = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_queue_input_buffer(context, &amp;inputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Queue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue input buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!lastStream) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_buffer_t outputBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        media_codec_output_buffer_info_t info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;outputBuffer, 0x00, sizeof(media_codec_buffer_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;info, 0x00, sizeof(media_codec_output_buffer_info_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_dequeue_output_buffer(context, &amp;outputBuffer, &amp;info,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret &amp;&amp; outFile) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fwrite(outputBuffer.vstream_buf.vir_ptr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputBuffer.vstream_buf.size, 1, outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = hb_mm_mc_queue_output_buffer(context, &amp;outputBuffer, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Queue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (outputBuffer.vstream_buf.stream_end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;There is no more output data!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lastStream = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != (int32_t)HB_MEDIA_ERR_WAIT_TIMEOUT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;Dequeue output buffer fail.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (needFlush) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hb_mm_mc_flush(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        needFlush = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}while(TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mm_mc_get_state(context, &amp;state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (context &amp;&amp; state!=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_UNINITIALIZED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_stop(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_mm_mc_release(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (inFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fclose(inFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (outFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fclose(outFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char outputFileName[MAX_FILE_PATH] = &quot;./tmp.yuv&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char inputFileName[MAX_FILE_PATH] = &quot;./output.stream&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_H265;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;width = 640;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;height = 480;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;pix_fmt = MC_PIXEL_FORMAT_YUV420P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;external_frame_buf = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bitstream_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.mode = MC_AV_RC_MODE_H265CBR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_rate_control_config(&amp;context, &amp;params-&gt;rc_params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.bit_rate = 5000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.frame_rate = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rc_params.h265_cbr_params.intra_period = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.decoding_refresh_type = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;gop_params.gop_preset_idx = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;rot_degree = MC_CCW_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;mir_direction = MC_DIRECTION_NONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cropping_flag = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaCodecTestContext ctx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;ctx, 0x00, sizeof(ctx));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.context = &amp;context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.inputFileName = inputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.outputFileName = outputFileName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_3dnr_enc_params_t *noise_rd = &amp;ctx.noise_reduction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_get_3dnr_enc_config(context, noise_rd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noise_rd-&gt;nr_y_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noise_rd-&gt;nr_cb_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noise_rd-&gt;nr_cr_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noise_rd-&gt;nr_est_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.message = ENC_CONFIG_3DNR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_sync_encoding(&amp;ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_3dnr_enc_config">hb_mm_mc_set_3dnr_enc_config<a href="#hb_mm_mc_set_3dnr_enc_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_3dnr_enc_config" title="Direct link to hb_mm_mc_set_3dnr_enc_config">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_set_3dnr_enc_config(media_codec_context_t
*context, const mc_video_3dnr_enc_params_t *params);</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context：Context specifying the codec type</li>
<li>[IN] const mc_video_3dnr_enc_params_t *params：3DNR parameters</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS：Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Set the 3DNR parameters. This parameter is a dynamic one and is applicable to H265.</p>
<p>【Example Code】</p>
<p>Refer to  <a href="#hb_mm_mc_get_3dnr_enc_config">hb_mm_mc_get_3dnr_enc_config</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_request_idr_header">hb_mm_mc_request_idr_header<a href="#hb_mm_mc_request_idr_header" class="hash-link" aria-label="Direct link to hb_mm_mc_request_idr_header" title="Direct link to hb_mm_mc_request_idr_header">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_request_idr_header(media_codec_context_t
*context, hb_u32 force_header)</p>
<p>【Parameter Description】</p>
<ul>
<li>
<p>[IN] media_codec_context_t *context：Context specifying the codec type</p>
</li>
<li>
<p>[IN] hb_u32 force_header：</p>
<blockquote>
<p>0 : No froced header(VPS/SPS/PPS)</p>
<p>1 : Forced header before IDR frame</p>
<p>2 : Forced header before I frame for H264 or forced header before
CRA and IDR frame for H265</p>
</blockquote>
</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS：Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Request the IDR frame header information of the frame header ID, applicable to H264/H265.</p>
<p>【Example Code】</p>
<p>参考 <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_enable_idr_frame">hb_mm_mc_enable_idr_frame<a href="#hb_mm_mc_enable_idr_frame" class="hash-link" aria-label="Direct link to hb_mm_mc_enable_idr_frame" title="Direct link to hb_mm_mc_enable_idr_frame">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_enable_idr_frame(media_codec_context_t
*context, hb_bool enable)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] media_codec_context_t *context：Context specifying the codec type</li>
<li>[IN] hb_bool enable：0: Disable；1: Enable；</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS：Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Enable IDR frames, applicable for H264/H265.</p>
<p>【Example Code】</p>
<p>Refer to  <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_register_audio_encoder">hb_mm_mc_register_audio_encoder<a href="#hb_mm_mc_register_audio_encoder" class="hash-link" aria-label="Direct link to hb_mm_mc_register_audio_encoder" title="Direct link to hb_mm_mc_register_audio_encoder">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_register_audio_encoder(hb_s32 *handle,
mc_audio_encode_param_t *encoder)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] hb_s32 *handle：Encoder handle</li>
<li>[IN] mc_audio_encode_param_t *encoder：Audio encoder descriptor</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS：Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Register the audio encoder, applicable for Audio.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;include/aac.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_codec_enc_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_AAC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.audio_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;bit_rate = 128000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;packet_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;sample_fmt = MC_AV_SAMPLE_FMT_S16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;sample_rate = MC_AV_SAMPLE_RATE_16000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;channel_layout = MC_AV_CHANNEL_LAYOUT_STEREO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;channels = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_aac_enc_config_t config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.profile = MC_AAC_PROFILE_LOW;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.type = MC_AAC_DATA_TYPE_ADTS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;enc_config = &amp;config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_encode_param_t encoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoder.ff_type = MEDIA_CODEC_ID_AAC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(encoder.ff_codec_name, sizeof(encoder.ff_codec_name), &quot;aacenc&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoder.ff_audio_open_encoder = ff_audio_aac_open_encoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoder.ff_audio_encode_frame = ff_audio_aac_encode_frm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoder.ff_audio_close_encoder = ff_audio_aac_close_encoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_register_audio_encoder(&amp;handle, &amp;encoder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;handle = %d\n&quot;, handle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_unregister_audio_encoder(handle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_unregister_audio_encoder">hb_mm_mc_unregister_audio_encoder<a href="#hb_mm_mc_unregister_audio_encoder" class="hash-link" aria-label="Direct link to hb_mm_mc_unregister_audio_encoder" title="Direct link to hb_mm_mc_unregister_audio_encoder">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_unregister_audio_encoder(hb_s32 handle)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] hb_s32 *handle：encoder handle</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS：Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Unregister the audio encoder, applicable for Audio.</p>
<p>【Example Code】</p>
<p>参考 <a href="#hb_mm_mc_register_audio_encoder">hb_mm_mc_register_audio_encoder</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_register_audio_decoder">hb_mm_mc_register_audio_decoder<a href="#hb_mm_mc_register_audio_decoder" class="hash-link" aria-label="Direct link to hb_mm_mc_register_audio_decoder" title="Direct link to hb_mm_mc_register_audio_decoder">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_register_audio_decoder(hb_s32 *handle,
mc_audio_decode_param_t *decoder)</p>
<p>【Parameter Description】</p>
<ul>
<li>[IN] hb_s32 *handle：Decoder handle</li>
<li>[IN] mc_audio_decode_param_t *decoder：Audio decoder descriptor</li>
</ul>
<p>【Return Values】</p>
<ul>
<li>0：Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN： Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED：Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE：Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS： Invalid parameters</li>
</ul>
<p>【Function Description】</p>
<p>Register the audio decoder, applicable for Audio.</p>
<p>【Example Code】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;include/aac.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_codec_dec_params_t *params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_context_t context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;context, 0x00, sizeof(media_codec_context_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.codec_id = MEDIA_CODEC_ID_AAC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.encoder = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params = &amp;context.audio_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;feed_mode = MC_FEEDING_MODE_FRAME_SIZE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;packet_buf_size = 1024;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;packet_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_cache_size = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;frame_buf_count = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_aac_dec_config_t config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.sample_rate = MC_AV_SAMPLE_RATE_8000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.channels = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.sample_fmt = MC_AV_SAMPLE_FMT_S16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params-&gt;dec_config = &amp;config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_decode_param_t decoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoder.ff_type = MEDIA_CODEC_ID_AAC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snprintf(decoder.ff_codec_name, sizeof(decoder.ff_codec_name), &quot;aacdec&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoder.ff_audio_open_decoder = ff_audio_aac_open_decoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoder.ff_audio_decode_frame = ff_audio_aac_decode_frm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoder.ff_audio_close_decoder = ff_audio_aac_close_decoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_register_audio_decoder(&amp;handle, &amp;decoder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = hb_mm_mc_unregister_audio_decoder(handle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASSERT_EQ(ret, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_unregister_audio_decoder">hb_mm_mc_unregister_audio_decoder<a href="#hb_mm_mc_unregister_audio_decoder" class="hash-link" aria-label="Direct link to hb_mm_mc_unregister_audio_decoder" title="Direct link to hb_mm_mc_unregister_audio_decoder">​</a></h4>
<p>【Function Declaration】</p>
<p>hb_s32 hb_mm_mc_unregister_audio_decoder(hb_s32 handle)</p>
<p><strong>[Parameter Description]</strong></p>
<ul>
<li>[IN] hb_s32 *handle: Decoder handle;</li>
</ul>
<p><strong>[Return Values]</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>[Function Description]</strong></p>
<p>Unregisters an audio decoder. Applicable to Audio.</p>
<p><strong>[Example Code]</strong></p>
<p>Refer to <a href="#hb_mm_mc_register_audio_decoder">hb_mm_mc_register_audio_decoder</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_explicit_header_config">hb_mm_mc_get_explicit_header_config<a href="#hb_mm_mc_get_explicit_header_config" class="hash-link" aria-label="Direct link to hb_mm_mc_get_explicit_header_config" title="Direct link to hb_mm_mc_get_explicit_header_config">​</a></h4>
<p><strong>[Function Declaration]</strong></p>
<p>hb_s32 hb_mm_mc_get_explicit_header_config<br>
<!-- -->(media_codec_context_t *context, hb_s32 *status)</p>
<p><strong>[Parameter Description]</strong></p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] hb_s32 *status: Enable/disable encoding header information and IDR frame into a single frame</li>
</ul>
<p><strong>[Return Values]</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>[Function Description]</strong></p>
<p>Gets the configuration indicating whether header information and the IDR frame are encoded into a single frame.<br>
<!-- -->0: IDR and header information are separate<br>
<!-- -->1: IDR and header information are combined into one frame<br>
<!-- -->Applicable to H264/H265.</p>
<p><strong>[Example Code]</strong></p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_explicit_header_config">hb_mm_mc_set_explicit_header_config<a href="#hb_mm_mc_set_explicit_header_config" class="hash-link" aria-label="Direct link to hb_mm_mc_set_explicit_header_config" title="Direct link to hb_mm_mc_set_explicit_header_config">​</a></h4>
<p><strong>[Function Declaration]</strong></p>
<p>hb_s32 hb_mm_mc_set_explicit_header_config<br>
<!-- -->(media_codec_context_t *context, hb_s32 status)</p>
<p><strong>[Parameter Description]</strong></p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_s32 status: Enable/disable encoding header information and I-frame into a single frame</li>
</ul>
<p><strong>[Return Values]</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>[Function Description]</strong></p>
<p>Enables/disables encoding header information and I-frame into a single frame. This is a static parameter.<br>
<!-- -->0: IDR and header information are separate<br>
<!-- -->1: IDR and header information are combined into one frame<br>
<!-- -->Applicable to H264/H265.</p>
<p><strong>[Example Code]</strong></p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_get_roi_avg_qp">hb_mm_mc_get_roi_avg_qp<a href="#hb_mm_mc_get_roi_avg_qp" class="hash-link" aria-label="Direct link to hb_mm_mc_get_roi_avg_qp" title="Direct link to hb_mm_mc_get_roi_avg_qp">​</a></h4>
<p><strong>[Function Declaration]</strong></p>
<p>hb_s32 hb_mm_mc_get_roi_avg_qp(media_codec_context_t *<br>
<!-- -->context, hb_u32 * params)</p>
<p><strong>[Parameter Description]</strong></p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[OUT] hb_u32 *params: ROI average QP</li>
</ul>
<p><strong>[Return Values]</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>[Function Description]</strong></p>
<p>Gets the ROI average QP value. 0 indicates that the value is determined by the user-defined QP map. Applicable to H264/H265.</p>
<p><strong>[Example Code]</strong></p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_mm_mc_set_roi_avg_qp">hb_mm_mc_set_roi_avg_qp<a href="#hb_mm_mc_set_roi_avg_qp" class="hash-link" aria-label="Direct link to hb_mm_mc_set_roi_avg_qp" title="Direct link to hb_mm_mc_set_roi_avg_qp">​</a></h4>
<p><strong>[Function Declaration]</strong></p>
<p>hb_s32 hb_mm_mc_set_roi_avg_qp(media_codec_context_t *<br>
<!-- -->context, hb_u32 params)</p>
<p><strong>[Parameter Description]</strong></p>
<ul>
<li>[IN] media_codec_context_t *context: Context specifying the codec type</li>
<li>[IN] hb_u32 params: ROI average QP value</li>
</ul>
<p><strong>[Return Values]</strong></p>
<ul>
<li>0: Operation succeeded</li>
<li>HB_MEDIA_ERR_UNKNOWN: Unknown error</li>
<li>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED: Operation not allowed</li>
<li>HB_MEDIA_ERR_INVALID_INSTANCE: Invalid instance</li>
<li>HB_MEDIA_ERR_INVALID_PARAMS: Invalid parameters</li>
</ul>
<p><strong>[Function Description]</strong></p>
<p>Sets the ROI average QP value for encoding. This is a dynamic parameter.<br>
<!-- -->0: Indicates using the average of all values in the configured QP map.<br>
<!-- -->This setting takes effect only when the rate control (RC) mode is CBR or AVBR.<br>
<!-- -->Applicable to H264/H265.</p>
<p><strong>[Example Code]</strong></p>
<p>Refer to <a href="#hb_mm_mc_get_longterm_ref_mode">hb_mm_mc_get_longterm_ref_mode</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="main-parameter-descriptions">Main Parameter Descriptions<a href="#main-parameter-descriptions" class="hash-link" aria-label="Direct link to Main Parameter Descriptions" title="Direct link to Main Parameter Descriptions">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="media_codec_state_t">media_codec_state_t<a href="#media_codec_state_t" class="hash-link" aria-label="Direct link to media_codec_state_t" title="Direct link to media_codec_state_t">​</a></h4>
<p><strong>[Description]</strong></p>
<p>Defines the internal operational states of the Media codec.</p>
<p><strong>[Definition]</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum _media_codec_state {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_NONE = -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_UNINITIALIZED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_INITIALIZED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_CONFIGURED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_STARTED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_PAUSED,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_FLUSHING,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_ERROR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_STATE_TOTAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} media_codec_state_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="media_codec_id_t">media_codec_id_t<a href="#media_codec_id_t" class="hash-link" aria-label="Direct link to media_codec_id_t" title="Direct link to media_codec_id_t">​</a></h4>
<p><strong>[Description]</strong></p>
<p>Defines the codec IDs supported by MediaCodec.</p>
<p><strong>[Definition]</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum _media_codec_id {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_NONE = -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Video Codecs */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_H264,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_H265,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MJPEG,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_JPEG,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Audio Codecs */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_FLAC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_PCM_MULAW,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_PCM_ALAW,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_ADPCM_G726,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_ADPCM,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_AAC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MP3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MP2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_TAK,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_AC3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_WMA,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_AMR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_APE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_G729,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_G723,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_G722,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_IAC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_RALF,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_QDMC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_DTS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_GSM,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_TTA,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_QCELP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MLP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_ATRAC1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_IMC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_EAC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MP1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_SIPR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_OPUS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_CELT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_MOV_TEXT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MEDIA_CODEC_ID_TOTAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} media_codec_id_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_video_rate_control_mode_t">mc_video_rate_control_mode_t<a href="#mc_video_rate_control_mode_t" class="hash-link" aria-label="Direct link to mc_video_rate_control_mode_t" title="Direct link to mc_video_rate_control_mode_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the bitrate control modes for video. Currently, only H.264/H.265 and MJPEG encoding channels support bitrate control.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef enum _mc_video_rate_control_mode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_NONE = -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H264CBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H264VBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H264AVBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H264FIXQP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H264QPMAP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H265CBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H265VBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H265AVBR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H265FIXQP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_H265QPMAP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_MJPEGFIXQP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MC_AV_RC_MODE_TOTAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_video_rate_control_mode_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h264_cbr_params_t">mc_h264_cbr_params_t<a href="#mc_h264_cbr_params_t" class="hash-link" aria-label="Direct link to mc_h264_cbr_params_t" title="Direct link to mc_h264_cbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.264 CBR (Constant Bitrate) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h264_cbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bit_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 initial_rc_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 vbv_buffer_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 mb_level_rc_enalbe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 hvs_qp_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 hvs_qp_scale;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_delta_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h264_cbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h264_vbr_params_t">mc_h264_vbr_params_t<a href="#mc_h264_vbr_params_t" class="hash-link" aria-label="Direct link to mc_h264_vbr_params_t" title="Direct link to mc_h264_vbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.264 VBR (Variable Bitrate) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h264_vbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h264_vbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h264_avbr_params_t">mc_h264_avbr_params_t<a href="#mc_h264_avbr_params_t" class="hash-link" aria-label="Direct link to mc_h264_avbr_params_t" title="Direct link to mc_h264_avbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.264 AVBR (Adaptive Variable Bitrate) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h264_avbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bit_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 initial_rc_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 vbv_buffer_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 mb_level_rc_enalbe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 hvs_qp_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 hvs_qp_scale;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_delta_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h264_avbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h264_fix_qp_params_t">mc_h264_fix_qp_params_t<a href="#mc_h264_fix_qp_params_t" class="hash-link" aria-label="Direct link to mc_h264_fix_qp_params_t" title="Direct link to mc_h264_fix_qp_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.264 FixQP (Fixed Quantization Parameter) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h264_fix_qp_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h264_fix_qp_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h264_qp_map_params_t">mc_h264_qp_map_params_t<a href="#mc_h264_qp_map_params_t" class="hash-link" aria-label="Direct link to mc_h264_qp_map_params_t" title="Direct link to mc_h264_qp_map_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.264 QPMAP control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h264_qp_map_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_byte qp_map_array;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 qp_map_array_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h264_qp_map_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h265_cbr_params_t">mc_h265_cbr_params_t<a href="#mc_h265_cbr_params_t" class="hash-link" aria-label="Direct link to mc_h265_cbr_params_t" title="Direct link to mc_h265_cbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.265 CBR (Constant Bitrate) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h265_cbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bit_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 initial_rc_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 vbv_buffer_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 ctu_level_rc_enalbe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 hvs_qp_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 hvs_qp_scale;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_delta_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h265_cbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h265_vbr_params_t">mc_h265_vbr_params_t<a href="#mc_h265_vbr_params_t" class="hash-link" aria-label="Direct link to mc_h265_vbr_params_t" title="Direct link to mc_h265_vbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.265 VBR (Variable Bitrate) control mode.</p>
<p><strong>Definition</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h265_vbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h265_vbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h265_avbr_params_t">mc_h265_avbr_params_t<a href="#mc_h265_avbr_params_t" class="hash-link" aria-label="Direct link to mc_h265_avbr_params_t" title="Direct link to mc_h265_avbr_params_t">​</a></h4>
<p><strong>Description</strong></p>
<p>Defines the adjustable parameter set under H.265 AVBR (Adaptive Variable Bitrate) control mode.【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h265_avbr_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bit_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 initial_rc_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 vbv_buffer_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 ctu_level_rc_enalbe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 min_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 hvs_qp_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 hvs_qp_scale;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 max_delta_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool qp_map_enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h265_avbr_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h265_fix_qp_params_t">mc_h265_fix_qp_params_t<a href="#mc_h265_fix_qp_params_t" class="hash-link" aria-label="Direct link to mc_h265_fix_qp_params_t" title="Direct link to mc_h265_fix_qp_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the adjustable parameter set for H.265 under FixQP rate control mode.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h265_fix_qp_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_I;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 force_qp_B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h265_fix_qp_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_h265_qp_map_params_t">mc_h265_qp_map_params_t<a href="#mc_h265_qp_map_params_t" class="hash-link" aria-label="Direct link to mc_h265_qp_map_params_t" title="Direct link to mc_h265_qp_map_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the adjustable parameter set for H.265 under QPMAP rate control mode.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_h265_qp_map_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 intra_period;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_byte qp_map_array;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 qp_map_array_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_h265_qp_map_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_mjpeg_fix_qp_params_t">mc_mjpeg_fix_qp_params_t<a href="#mc_mjpeg_fix_qp_params_t" class="hash-link" aria-label="Direct link to mc_mjpeg_fix_qp_params_t" title="Direct link to mc_mjpeg_fix_qp_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the adjustable parameter set for MJPEG under FixQP rate control mode.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_mjpeg_fix_qp_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 quality_factor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_mjpeg_fix_qp_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_video_custom_gop_pic_params_t">mc_video_custom_gop_pic_params_t<a href="#mc_video_custom_gop_pic_params_t" class="hash-link" aria-label="Direct link to mc_video_custom_gop_pic_params_t" title="Direct link to mc_video_custom_gop_pic_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the data structure for a custom GOP structure table.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_video_custom_gop_pic_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 pic_type;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 poc_offset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 pic_qp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 num_ref_picL0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ref_pocL0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 ref_pocL1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 temporal_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_video_custom_gop_pic_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_inter_status_t">mc_inter_status_t<a href="#mc_inter_status_t" class="hash-link" aria-label="Direct link to mc_inter_status_t" title="Direct link to mc_inter_status_t">​</a></h4>
<p>【Description】</p>
<p>Defines internal status information of the media codec.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_inter_status {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 cur_input_buf_cnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u64 cur_input_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 cur_output_buf_cnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u64 cur_output_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 left_recv_frame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 left_enc_frame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 total_input_buf_cnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 total_output_buf_cnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 pipeline;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 channel_port_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_inter_status_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="media_codec_context_t">media_codec_context_t<a href="#media_codec_context_t" class="hash-link" aria-label="Direct link to media_codec_context_t" title="Direct link to media_codec_context_t">​</a></h4>
<p>【Description】</p>
<p>Defines the context of the Media codec.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _media_codec_context {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    media_codec_id_t codec_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool encoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 instance_index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_video_codec_enc_params_t video_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_video_codec_dec_params_t video_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_audio_codec_enc_params_t audio_enc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_audio_codec_dec_params_t audio_dec_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_ptr vpf_context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_cmd_prio_t priority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} media_codec_context_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_video_codec_enc_params_t">mc_video_codec_enc_params_t<a href="#mc_video_codec_enc_params_t" class="hash-link" aria-label="Direct link to mc_video_codec_enc_params_t" title="Direct link to mc_video_codec_enc_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines encoding parameters for the video encoder. Supported video encoder types include H.264, H.265, MJPEG, and JPEG.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_video_codec_enc_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 width, height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_pixel_format_t pix_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool external_frame_buf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bitstream_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bitstream_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rate_control_params_t rc_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_video_gop_params_t gop_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_rotate_degree_t rot_degree;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_mirror_direction_t mir_direction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_cropping_flag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_codec_rect_t crop_rect;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool enable_user_pts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_h264_enc_config_t h264_enc_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_h265_enc_config_t h265_enc_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_mjpeg_enc_config_t mjpeg_enc_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_jpeg_enc_config_t jpeg_enc_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_video_codec_enc_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_video_codec_dec_params_t">mc_video_codec_dec_params_t<a href="#mc_video_codec_dec_params_t" class="hash-link" aria-label="Direct link to mc_video_codec_dec_params_t" title="Direct link to mc_video_codec_dec_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines decoding parameters for the video decoder. Supported video decoder types include H.264, H.265, MJPEG, and JPEG.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_video_codec_dec_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_stream_feeding_mode_t feed_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_pixel_format_t pix_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bitstream_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bitstream_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_bool external_bitstream_buf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 frame_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_h264_dec_config_t h264_dec_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_h265_dec_config_t h265_dec_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_mjpeg_dec_config_t mjpeg_dec_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mc_jpeg_dec_config_t jpeg_dec_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_video_codec_dec_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_audio_codec_enc_params_t">mc_audio_codec_enc_params_t<a href="#mc_audio_codec_enc_params_t" class="hash-link" aria-label="Direct link to mc_audio_codec_enc_params_t" title="Direct link to mc_audio_codec_enc_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the encoding parameters for an audio codec.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_audio_codec_enc_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_u32 bit_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 frame_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 frame_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 packet_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_sample_format_t sample_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_sample_rate_t sample_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_audio_channel_layout_t channel_layout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 channels;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_ptr enc_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_audio_codec_enc_params_t;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mc_audio_codec_dec_params_t">mc_audio_codec_dec_params_t<a href="#mc_audio_codec_dec_params_t" class="hash-link" aria-label="Direct link to mc_audio_codec_dec_params_t" title="Direct link to mc_audio_codec_dec_params_t">​</a></h4>
<p>【Description】</p>
<p>Defines the decoding parameters for an audio codec.</p>
<p>【Definition】</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _mc_audio_codec_dec_params {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mc_av_stream_feeding_mode_t feed_mode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 packet_buf_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 packet_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 frame_cache_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 internal_frame_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_s32 frame_buf_count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hb_ptr dec_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} mc_audio_codec_dec_params_t;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="return-value-description">Return Value Description<a href="#return-value-description" class="hash-link" aria-label="Direct link to Return Value Description" title="Direct link to Return Value Description">​</a></h3>
<table><thead><tr><th>Error Code</th><th>Macro Definition</th><th>Description</th></tr></thead><tbody><tr><td>0xF0000001</td><td>HB_MEDIA_ERR_UNKNOWN</td><td>Unknown error</td></tr><tr><td>0xF0000002</td><td>HB_MEDIA_ERR_CODEC_NOT_FOUND</td><td>Corresponding codec not found</td></tr><tr><td>0xF0000003</td><td>HB_MEDIA_ERR_CODEC_OPEN_FAIL</td><td>Failed to open codec device</td></tr><tr><td>0xF0000004</td><td>HB_MEDIA_ERR_CODEC_RESPONSE_TIMEOUT</td><td>Codec response timeout</td></tr><tr><td>0xF0000005</td><td>HB_MEDIA_ERR_CODEC_INIT_FAIL</td><td>Codec initialization failed</td></tr><tr><td>0xF0000006</td><td>HB_MEDIA_ERR_OPERATION_NOT_ALLOWED</td><td>Operation not allowed</td></tr><tr><td>0xF0000007</td><td>HB_MEDIA_ERR_INSUFFICIENT_RES</td><td>Insufficient internal memory resources</td></tr><tr><td>0xF0000008</td><td>HB_MEDIA_ERR_NO_FREE_INSTANCE</td><td>No available instance (VPU supports up to 32, JPU up to 64, Audio up to 32)</td></tr><tr><td>0xF0000009</td><td>HB_MEDIA_ERR_INVALID_PARAMS</td><td>Invalid parameters</td></tr><tr><td>0xF000000A</td><td>HB_MEDIA_ERR_INVALID_INSTANCE</td><td>Invalid instance</td></tr><tr><td>0xF000000B</td><td>HB_MEDIA_ERR_INVALID_BUFFER</td><td>Invalid buffer</td></tr><tr><td>0xF000000C</td><td>HB_MEDIA_ERR_INVALID_COMMAND</td><td>Invalid command</td></tr><tr><td>0xF000000D</td><td>HB_MEDIA_ERR_WAIT_TIMEOUT</td><td>Wait timeout</td></tr><tr><td>0xF000000E</td><td>HB_MEDIA_ERR_FILE_OPERATION_FAILURE</td><td>File operation failed</td></tr><tr><td>0xF000000F</td><td>HB_MEDIA_ERR_PARAMS_SET_FAILURE</td><td>Parameter setting failed</td></tr><tr><td>0xF0000010</td><td>HB_MEDIA_ERR_PARAMS_GET_FAILURE</td><td>Parameter retrieval failed</td></tr><tr><td>0xF0000011</td><td>HB_MEDIA_ERR_CODING_FAILED</td><td>Encoding/decoding failed</td></tr><tr><td>0xF0000012</td><td>HB_MEDIA_ERR_OUTPUT_BUF_FULL</td><td>Output buffer full</td></tr><tr><td>0xF0000013</td><td>HB_MEDIA_ERR_UNSUPPORTED_FEATURE</td><td>Unsupported feature</td></tr><tr><td>0xF0000014</td><td>HB_MEDIA_ERR_INVALID_PRIORITY</td><td>Unsupported priority</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="codec-sample">Codec Sample<a href="#codec-sample" class="hash-link" aria-label="Direct link to Codec Sample" title="Direct link to Codec Sample">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-example">Encoding Example<a href="#encoding-example" class="hash-link" aria-label="Direct link to Encoding Example" title="Direct link to Encoding Example">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="function-overview">Function Overview<a href="#function-overview" class="hash-link" aria-label="Direct link to Function Overview" title="Direct link to Function Overview">​</a></h4>
<p>Encodes YUV images into H.264/H.265 video or JPG images.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="software-architecture-description">Software Architecture Description<a href="#software-architecture-description" class="hash-link" aria-label="Direct link to Software Architecture Description" title="Direct link to Software Architecture Description">​</a></h5>
<p>Uses MediaCodec&#x27;s poll mode to decouple input and output, enabling optimal encoding frame rate performance.<br>
<!-- -->In the main thread, YUV data is fed into the encoder: an empty input buffer is acquired, the YUV data&#x27;s address information (e.g., physical address) is configured, and then the input buffer is queued to notify the encoder to process this frame.<br>
<!-- -->In another thread, encoded output bitstreams are retrieved: upon receiving a hardware encoding completion notification via <code>select</code>, a filled output buffer is acquired, the encoded result is written to a file, and then the output buffer is returned.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/encoder2.png" alt="image" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-data-flow-description">Hardware Data Flow Description<a href="#hardware-data-flow-description" class="hash-link" aria-label="Direct link to Hardware Data Flow Description" title="Direct link to Hardware Data Flow Description">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/encoder1.png" alt="image" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="code-location-and-directory-structure">Code Location and Directory Structure<a href="#code-location-and-directory-structure" class="hash-link" aria-label="Direct link to Code Location and Directory Structure" title="Direct link to Code Location and Directory Structure">​</a></h5>
<p>The sample code is located at <code>source/hobot-sp-samples/debian/app/multimedia_demo/codec_demo</code> in the project directory.</p>
<p>Directory structure:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── sample_venc_vdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── input_3840x2160_yuv420p.h264</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── input_3840x2160_yuv420p.yuv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample_common.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample_vdec.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── sample_venc.c</span><br></span></code></pre></div></div>
<p>The root directory contains <code>README.md</code>, which briefly describes compilation commands, runtime help information, and usage instructions.</p>
<p>The <code>Makefile</code> under <code>sample_venc_vdec</code> is used to compile files in this directory. Specifically:</p>
<ul>
<li><code>sample.c</code> contains the main entry point,</li>
<li><code>sample_common.c</code> contains shared APIs,</li>
<li><code>sample_venc.c</code> contains encoding-related functions,</li>
<li><code>sample_vdec.c</code> contains decoding-related functions.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="compilation">Compilation<a href="#compilation" class="hash-link" aria-label="Direct link to Compilation" title="Direct link to Compilation">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-environment">Compilation Environment<a href="#compilation-environment" class="hash-link" aria-label="Direct link to Compilation Environment" title="Direct link to Compilation Environment">​</a></h5>
<p>After installing the <code>hobot-sp-samples_*.deb</code> package on the board, the <code>codec_demo</code> source code will be included.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-instructions">Compilation Instructions<a href="#compilation-instructions" class="hash-link" aria-label="Direct link to Compilation Instructions" title="Direct link to Compilation Instructions">​</a></h5>
<p>This sample primarily depends on API header files provided by <code>libmm</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span></code></pre></div></div>
<p>Compilation dependencies include the following libraries:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LIBS += -lpthread -ldl -lhbmem -lalog  -lmultimedia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIBS += -lavformat -lavcodec -lavutil -lswresample</span><br></span></code></pre></div></div>
<p>Compilation command:</p>
<p>On the board, navigate to <code>/app/multimedia_demo/codec_demo/sample_venc_vdec</code> and run:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="execution">Execution<a href="#execution" class="hash-link" aria-label="Direct link to Execution" title="Direct link to Execution">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="supported-platforms">Supported Platforms<a href="#supported-platforms" class="hash-link" aria-label="Direct link to Supported Platforms" title="Direct link to Supported Platforms">​</a></h5>
<p>RDKS100.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="board-deployment-and-configuration">Board Deployment and Configuration<a href="#board-deployment-and-configuration" class="hash-link" aria-label="Direct link to Board Deployment and Configuration" title="Direct link to Board Deployment and Configuration">​</a></h5>
<p>After flashing the system software image, the sample source code resides at <code>/app/multimedia_demo/codec_demo/sample_venc_vdec</code> on the board.</p>
<p>Required resources may include:</p>
<ul>
<li>Input YUV images: by default, raw 4K YUV streams and H.264 files are provided; for other tests, users must upload their own files.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="running-instructions">Running Instructions<a href="#running-instructions" class="hash-link" aria-label="Direct link to Running Instructions" title="Direct link to Running Instructions">​</a></h5>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="command-line-argument-description">Command-line Argument Description<a href="#command-line-argument-description" class="hash-link" aria-label="Direct link to Command-line Argument Description" title="Direct link to Command-line Argument Description">​</a></h6>
<p><code>sample_codec</code>: application name</p>
<p><code>-m</code>: encoding or decoding mode; default is encoding (0: encoder, 1: decoder)</p>
<p><code>-c</code>: codec type; default is H.264 (0: H.264, 1: H.265, 2: MJPEG, 3: JPEG)</p>
<p><code>-w</code>: image width; default is 3840</p>
<p><code>-h</code>: image height; default is 2160</p>
<p><code>-p</code>: pixel format for encoding/decoding; default is NV12 (0: YUV420P, 1: NV12, 2: NV21)</p>
<p><code>-n</code>: number of test threads; default is 1</p>
<p><code>-i</code>: input file path; default is <code>./input_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.yuv</code></p>
<p><code>-o</code>: output file path; default is <code>./output_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.{code_type}</code></p>
<p><code>-H</code>: print help information</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="help-menu">Help Menu<a href="#help-menu" class="hash-link" aria-label="Direct link to Help Menu" title="Direct link to Help Menu">​</a></h6>
<p>Run <code>./sample_codec --help</code> to display the help menu as follows:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Usage: ./sample_codec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -m --samplemode sample mode, default encoder, {0-encoder, 1-decoder}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -c --codecid codec id, default h264, {0-h264, 1-h265, 2-mjpeg, 3-jpeg}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -w --width width, default 3840</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -h --height height, default 2160</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -p --pixfmt pix fmt, default nv12, {0-yuv420p, 1-nv12, ..}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -n --threadnum test thread number, default 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -i --inputfile input file name, default ./input_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.yuv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -o --outputfile output file name, default ./output_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.{code_type}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -H --help print usage</span><br></span></code></pre></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="running-method">Running Method<a href="#running-method" class="hash-link" aria-label="Direct link to Running Method" title="Direct link to Running Method">​</a></h6>
<p>Prepare input source: place the test file (e.g., <code>input_3840x2160_nv12.yuv</code>) in the current directory, or specify the file path using <code>-i</code>.Encode a YUV image sequence with resolution 3840x2160 into an H264 video bitstream:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec</span><br></span></code></pre></div></div>
<p>Encode a YUV image sequence with resolution 1920x1080 into an H265 video bitstream:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -c 1 -w 1920 -h 1080</span><br></span></code></pre></div></div>
<p>Encode a single YUV image with resolution 1920x1088 into a JPG image:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -c 3 -w 1920 -h 1088</span><br></span></code></pre></div></div>
<p>Encode two YUV image sequences with resolution 3840x2160 into H265 videos:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -c 1 -n 2</span><br></span></code></pre></div></div>
<p>Encode four YUV image sequences with resolution 1920x1080 into H265 videos:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -c 1 -w 1920 -h 1080 -n 4</span><br></span></code></pre></div></div>
<p>VPU CROP read and encode: Read input data of size 1920x1300 (image dimensions not aligned as required) according to the crop region <code>{x=200, y=300, w=1280, h=720}</code> and encode it into an H265 video:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -c 1 -w 1920 -h 1300</span><br></span></code></pre></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="execution-result-description">Execution Result Description<a href="#execution-result-description" class="hash-link" aria-label="Direct link to Execution Result Description" title="Direct link to Execution Result Description">​</a></h6>
<p>The following figure shows a successful execution:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/encoder3.png" alt="image" class="img_ev3q"></p>
<p>Check whether the generated H264/H265/JPG files are valid:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/encoder4.png" alt="image" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decoding-examples">Decoding Examples<a href="#decoding-examples" class="hash-link" aria-label="Direct link to Decoding Examples" title="Direct link to Decoding Examples">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="function-overview-1">Function Overview<a href="#function-overview-1" class="hash-link" aria-label="Direct link to Function Overview" title="Direct link to Function Overview">​</a></h4>
<p>Decode H264/H265 videos or JPG images into YUV images.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="software-architecture">Software Architecture<a href="#software-architecture" class="hash-link" aria-label="Direct link to Software Architecture" title="Direct link to Software Architecture">​</a></h5>
<p>MediaCodec&#x27;s poll mode is adopted to decouple input and output, enabling optimal decoding frame rate performance.<br>
<!-- -->In the main thread, bitstream data is fed into the decoder: an empty input buffer is acquired, the physical address and other metadata of the bitstream data are configured, then the input buffer is queued to notify the decoder to process this frame.<br>
<!-- -->In another thread, decoded YUV images are retrieved: upon receiving a hardware decoding completion notification via <code>select</code>, a filled output buffer is acquired, the decoded result is written to a file, and the output buffer is released back.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/decoder2.png" alt="image" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-data-flow-description-1">Hardware Data Flow Description<a href="#hardware-data-flow-description-1" class="hash-link" aria-label="Direct link to Hardware Data Flow Description" title="Direct link to Hardware Data Flow Description">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/decoder1.png" alt="image" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="code-location-and-directory-structure-1">Code Location and Directory Structure<a href="#code-location-and-directory-structure-1" class="hash-link" aria-label="Direct link to Code Location and Directory Structure" title="Direct link to Code Location and Directory Structure">​</a></h5>
<p>Sample code is located under <code>source/hobot-sp-samples/debian/app/multimedia_demo/codec_demo</code> in the project directory.</p>
<p>Directory structure:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── sample_venc_vdec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── input_3840x2160_yuv420p.h264</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── input_3840x2160_yuv420p.yuv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample_common.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── sample_vdec.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── sample_venc.c</span><br></span></code></pre></div></div>
<p>The root directory contains <code>README.md</code>, which briefly describes compilation commands, runtime help, and usage instructions.</p>
<p>The <code>Makefile</code> under <code>sample_venc_vdec</code> is used for compiling this directory. Specifically:</p>
<ul>
<li><code>sample.c</code> contains the main entry point.</li>
<li><code>sample_common.c</code> provides common APIs.</li>
<li><code>sample_venc.c</code> implements encoding-related functions.</li>
<li><code>sample_vdec.c</code> implements decoding-related functions.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-1">Compilation<a href="#compilation-1" class="hash-link" aria-label="Direct link to Compilation" title="Direct link to Compilation">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-environment-1">Compilation Environment<a href="#compilation-environment-1" class="hash-link" aria-label="Direct link to Compilation Environment" title="Direct link to Compilation Environment">​</a></h5>
<p>After installing the <code>hobot-sp-samples_*.deb</code> package on the board, the <code>codec_demo</code> source code will be included.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-instructions-1">Compilation Instructions<a href="#compilation-instructions-1" class="hash-link" aria-label="Direct link to Compilation Instructions" title="Direct link to Compilation Instructions">​</a></h5>
<p>This sample primarily depends on API header files provided by <code>libmm</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_codec.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;hb_media_error.h&quot;</span><br></span></code></pre></div></div>
<p>Compilation requires the following libraries:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LIBS += -lpthread -ldl -lhbmem -lalog  -lmultimedia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIBS += -lavformat -lavcodec -lavutil -lswresample</span><br></span></code></pre></div></div>
<p>Compilation command:</p>
<p>On the board, navigate to <code>/app/multimedia_demo/codec_demo/sample_venc_vdec</code> and run:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="execution-1">Execution<a href="#execution-1" class="hash-link" aria-label="Direct link to Execution" title="Direct link to Execution">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="supported-platforms-1">Supported Platforms<a href="#supported-platforms-1" class="hash-link" aria-label="Direct link to Supported Platforms" title="Direct link to Supported Platforms">​</a></h5>
<p>RDKS100.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="board-deployment-and-configuration-1">Board Deployment and Configuration<a href="#board-deployment-and-configuration-1" class="hash-link" aria-label="Direct link to Board Deployment and Configuration" title="Direct link to Board Deployment and Configuration">​</a></h5>
<p>After flashing the system image, the sample source code resides at <code>/app/multimedia_demo/codec_demo/sample_venc_vdec</code> on the board.</p>
<p>Required resources may include:</p>
<ul>
<li>Default input YUV streams and H264 files in 4K format; users must upload other test files as needed.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="running-guide">Running Guide<a href="#running-guide" class="hash-link" aria-label="Direct link to Running Guide" title="Direct link to Running Guide">​</a></h5>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="parameter-description">Parameter Description<a href="#parameter-description" class="hash-link" aria-label="Direct link to Parameter Description" title="Direct link to Parameter Description">​</a></h6>
<p><code>sample_codec</code>: Application name</p>
<p><code>-m</code>: Encoding or decoding mode; default is encoding (<code>0</code>: encoder, <code>1</code>: decoder)</p>
<p><code>-c</code>: Codec type; default is H264 (<code>0</code>: H264, <code>1</code>: H265, <code>2</code>: mjpg, <code>3</code>: jpg)</p>
<p><code>-w</code>: Image width; default is 3840</p>
<p><code>-h</code>: Image height; default is 2160</p>
<p><code>-p</code>: Pixel format; default is nv12 (<code>0</code>: yuv420p, <code>1</code>: nv12, <code>2</code>: nv21)</p>
<p><code>-n</code>: Number of test threads; default is 1</p>
<p><code>-i</code>: Input file path; default is <code>./input_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.yuv</code></p>
<p><code>-o</code>: Output file path; default is <code>./output_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.{code_type}</code></p>
<p><code>-H</code>: Print help information</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="help-menu-1">Help Menu<a href="#help-menu-1" class="hash-link" aria-label="Direct link to Help Menu" title="Direct link to Help Menu">​</a></h6>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Usage: ./sample_codec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -m --samplemode sample mode, default encoder, {0-encoder, 1-decoder}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -c --codecid codec id, default h264, {0-h264, 1-h265, 2-mjpeg, 3-jpeg}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -w --width width, default 3840</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -h --height height, default 2160</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -p --pixfmt pix fmt, default nv12, {0-yuv420p, 1-nv12, ..}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -n --threadnum test thread number, default 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -i --inputfile input file name, default ./input_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.yuv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -o --outputfile output file name, default ./output_${w}x${h}_${pixfmt}&lt;_thread_idx&gt;.{code_type}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -H --help print usage</span><br></span></code></pre></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-run">How to Run<a href="#how-to-run" class="hash-link" aria-label="Direct link to How to Run" title="Direct link to How to Run">​</a></h6>
<p>Prepare input sources: place test files (e.g., <code>input_3840x2160_nv12.h264</code>) in the current directory, or specify the file path using <code>-i</code>.</p>
<p>Decode one H264 video stream with resolution 3840x2160 into YUV images:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -m 1</span><br></span></code></pre></div></div>
<p>Decode one H265 video stream with resolution 1920x1080 into YUV images:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -m 1 -c 1 -w 1920 -h 1080</span><br></span></code></pre></div></div>
<p>Decode one JPG image with resolution 1920x1088 into a YUV image:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -m 1 -c 3 -w 1920 -h 1088</span><br></span></code></pre></div></div>
<p>Decode two H264 video streams with resolution 3840x2160 into YUV images:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"></code></pre>
<p>Decode four 1920x1080 h265 video streams and generate YUV image files.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/app/multimedia_demo/codec_demo/sample_venc_vdec/sample_codec -m 1 -c 1 -n 4 -w 1920 -h 1080</span><br></span></code></pre></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="explanation-of-execution-results">Explanation of Execution Results<a href="#explanation-of-execution-results" class="hash-link" aria-label="Direct link to Explanation of Execution Results" title="Direct link to Explanation of Execution Results">​</a></h6>
<p>Successful execution is shown in the figure below:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/decoder3.png" alt="image" class="img_ev3q"></p>
<p>Use YUVPlayer to verify whether the generated YUV image files are valid.</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/codec/decoder4.png" alt="image" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-12T13:42:14.000Z" itemprop="dateModified">Dec 12, 2025</time></b></span></div></div></footer></article><nav class="pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Camera Bring-up</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/display"><div class="pagination-nav__sublabel">Next </div><div class="pagination-nav__label">Display Subsystem</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-overview" class="table-of-contents__link toc-highlight">System Overview</a><ul><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#jpu-hardware-features" class="table-of-contents__link toc-highlight">JPU Hardware Features</a></li><li><a href="#vpu-hardware-features" class="table-of-contents__link toc-highlight">VPU Hardware Features</a></li></ul></li><li><a href="#software-features" class="table-of-contents__link toc-highlight">Software Features</a><ul><li><a href="#overall-framework" class="table-of-contents__link toc-highlight">Overall Framework</a></li><li><a href="#bitrate-control-modes" class="table-of-contents__link toc-highlight">Bitrate Control Modes</a><ul><li><a href="#cbr-description" class="table-of-contents__link toc-highlight">CBR Description</a></li><li><a href="#vbr-description" class="table-of-contents__link toc-highlight">VBR Description</a></li><li><a href="#avbr-description" class="table-of-contents__link toc-highlight">AVBR Description</a></li><li><a href="#fixqp-description" class="table-of-contents__link toc-highlight">FixQp Description</a></li><li><a href="#qpmap-description" class="table-of-contents__link toc-highlight">QPMAP Description</a></li></ul></li></ul></li><li><a href="#debugging-methods" class="table-of-contents__link toc-highlight">Debugging Methods</a><ul><li><a href="#encoding-quality-tuning" class="table-of-contents__link toc-highlight">Encoding Quality Tuning</a></li><li><a href="#gop-structure-description" class="table-of-contents__link toc-highlight">GOP Structure Description</a><ul><li><a href="#preset-gop-structures" class="table-of-contents__link toc-highlight">Preset GOP Structures</a></li></ul></li><li><a href="#vpu-debugging-method" class="table-of-contents__link toc-highlight">VPU Debugging Method</a><ul><li><a href="#encoding-status" class="table-of-contents__link toc-highlight">Encoding Status</a></li><li><a href="#decoding-status" class="table-of-contents__link toc-highlight">Decoding Status</a></li></ul></li><li><a href="#jpu-debugging-method" class="table-of-contents__link toc-highlight">JPU Debugging Method</a><ul><li><a href="#encoding-status-1" class="table-of-contents__link toc-highlight">Encoding Status</a></li><li><a href="#decoding-status-1" class="table-of-contents__link toc-highlight">Decoding Status</a></li></ul></li></ul></li><li><a href="#typical-scenarios" class="table-of-contents__link toc-highlight">Typical Scenarios</a><ul><li><a href="#single-stream-encoding" class="table-of-contents__link toc-highlight">Single-Stream Encoding</a></li><li><a href="#single-stream-decoding" class="table-of-contents__link toc-highlight">Single-Stream Decoding</a></li><li><a href="#multi-stream-encoding" class="table-of-contents__link toc-highlight">Multi-Stream Encoding</a></li><li><a href="#multi-stream-decoding" class="table-of-contents__link toc-highlight">Multi-Stream Decoding</a></li></ul></li></ul></li><li><a href="#codec-api" class="table-of-contents__link toc-highlight">Codec API</a><ul><li><a href="#mediacodec-interface-description" class="table-of-contents__link toc-highlight">MediaCodec Interface Description</a><ul><li><a href="#gop" class="table-of-contents__link toc-highlight">GOP</a><ul><li><a href="#gop-structure-table" class="table-of-contents__link toc-highlight">GOP Structure Table</a></li><li><a href="#predefined-gop-structures" class="table-of-contents__link toc-highlight">Predefined GOP Structures</a></li></ul></li><li><a href="#long-term-reference-frames" class="table-of-contents__link toc-highlight">Long-term Reference Frames</a></li><li><a href="#intra-refresh" class="table-of-contents__link toc-highlight">Intra Refresh</a></li><li><a href="#rate-control" class="table-of-contents__link toc-highlight">Rate Control</a></li><li><a href="#roi" class="table-of-contents__link toc-highlight">ROI</a></li><li><a href="#inputoutput-buffer-management" class="table-of-contents__link toc-highlight">Input/Output Buffer Management</a></li><li><a href="#frame-rate-control" class="table-of-contents__link toc-highlight">Frame Rate Control</a></li><li><a href="#frame-skip-configuration" class="table-of-contents__link toc-highlight">Frame Skip Configuration</a></li><li><a href="#jpeg-codec-limitations" class="table-of-contents__link toc-highlight">JPEG Codec Limitations</a></li></ul></li><li><a href="#api-reference" class="table-of-contents__link toc-highlight">API Reference</a><ul><li><a href="#hb_mm_mc_get_descriptor" class="table-of-contents__link toc-highlight">hb_mm_mc_get_descriptor</a></li><li><a href="#hb_mm_mc_get_default_context" class="table-of-contents__link toc-highlight">hb_mm_mc_get_default_context</a></li><li><a href="#hb_mm_mc_initialize" class="table-of-contents__link toc-highlight">hb_mm_mc_initialize</a></li><li><a href="#hb_mm_mc_set_callback" class="table-of-contents__link toc-highlight">hb_mm_mc_set_callback</a></li><li><a href="#hb_mm_mc_configure" class="table-of-contents__link toc-highlight">hb_mm_mc_configure</a></li><li><a href="#hb_mm_mc_start" class="table-of-contents__link toc-highlight">hb_mm_mc_start</a></li><li><a href="#hb_mm_mc_stop" class="table-of-contents__link toc-highlight">hb_mm_mc_stop</a></li><li><a href="#hb_mm_mc_pause" class="table-of-contents__link toc-highlight">hb_mm_mc_pause</a></li><li><a href="#hb_mm_mc_flush" class="table-of-contents__link toc-highlight">hb_mm_mc_flush</a></li><li><a href="#hb_mm_mc_release" class="table-of-contents__link toc-highlight">hb_mm_mc_release</a></li><li><a href="#hb_mm_mc_get_state" class="table-of-contents__link toc-highlight">hb_mm_mc_get_state</a></li><li><a href="#hb_mm_mc_get_status" class="table-of-contents__link toc-highlight">hb_mm_mc_get_status</a></li><li><a href="#hb_mm_mc_queue_input_buffer" class="table-of-contents__link toc-highlight">hb_mm_mc_queue_input_buffer</a></li><li><a href="#hb_mm_mc_dequeue_input_buffer" class="table-of-contents__link toc-highlight">hb_mm_mc_dequeue_input_buffer</a></li><li><a href="#hb_mm_mc_queue_output_buffer" class="table-of-contents__link toc-highlight">hb_mm_mc_queue_output_buffer</a></li><li><a href="#hb_mm_mc_dequeue_output_buffer" class="table-of-contents__link toc-highlight">hb_mm_mc_dequeue_output_buffer</a></li><li><a href="#hb_mm_mc_get_longterm_ref_mode" class="table-of-contents__link toc-highlight">hb_mm_mc_get_longterm_ref_mode</a></li><li><a href="#hb_mm_mc_set_longterm_ref_mode" class="table-of-contents__link toc-highlight">hb_mm_mc_set_longterm_ref_mode</a></li><li><a href="#hb_mm_mc_get_intra_refresh_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_intra_refresh_config</a></li><li><a href="#hb_mm_mc_set_intra_refresh_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_intra_refresh_config</a></li><li><a href="#hb_mm_mc_get_rate_control_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_rate_control_config</a></li><li><a href="#hb_mm_mc_set_rate_control_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_rate_control_config</a></li><li><a href="#hb_mm_mc_get_deblk_filter_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_deblk_filter_config</a></li><li><a href="#hb_mm_mc_set_deblk_filter_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_deblk_filter_config</a></li><li><a href="#hb_mm_mc_get_sao_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_sao_config</a></li><li><a href="#hb_mm_mc_set_sao_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_sao_config</a></li><li><a href="#hb_mm_mc_get_entropy_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_entropy_config</a></li><li><a href="#hb_mm_mc_set_entropy_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_entropy_config</a></li><li><a href="#hb_mm_mc_get_vui_timing_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_vui_timing_config</a></li><li><a href="#hb_mm_mc_set_vui_timing_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_vui_timing_config</a></li><li><a href="#hb_mm_mc_get_slice_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_slice_config</a></li><li><a href="#hb_mm_mc_set_slice_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_slice_config</a></li><li><a href="#hb_mm_mc_insert_user_data" class="table-of-contents__link toc-highlight">hb_mm_mc_insert_user_data</a></li><li><a href="#hb_mm_mc_request_idr_frame" class="table-of-contents__link toc-highlight">hb_mm_mc_request_idr_frame</a></li><li><a href="#hb_mm_mc_skip_pic" class="table-of-contents__link toc-highlight">hb_mm_mc_skip_pic</a></li><li><a href="#hb_mm_mc_get_smart_bg_enc_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_smart_bg_enc_config</a></li><li><a href="#hb_mm_mc_set_smart_bg_enc_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_smart_bg_enc_config</a></li><li><a href="#hb_mm_mc_get_pred_unit_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_pred_unit_config</a></li><li><a href="#hb_mm_mc_set_pred_unit_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_pred_unit_config</a></li><li><a href="#hb_mm_mc_get_transform_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_transform_config</a></li><li><a href="#hb_mm_mc_set_transform_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_transform_config</a></li><li><a href="#hb_mm_mc_get_roi_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_roi_config</a></li><li><a href="#hb_mm_mc_set_roi_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_roi_config</a></li><li><a href="#hb_mm_mc_get_mode_decision_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_mode_decision_config</a></li><li><a href="#hb_mm_mc_set_mode_decision_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_mode_decision_config</a></li><li><a href="#hb_mm_mc_get_user_data" class="table-of-contents__link toc-highlight">hb_mm_mc_get_user_data</a></li><li><a href="#hb_mm_mc_release_user_data" class="table-of-contents__link toc-highlight">hb_mm_mc_release_user_data</a></li><li><a href="#hb_mm_mc_get_mjpeg_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_mjpeg_config</a></li><li><a href="#hb_mm_mc_set_mjpeg_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_mjpeg_config</a></li><li><a href="#hb_mm_mc_get_jpeg_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_jpeg_config</a></li><li><a href="#hb_mm_mc_set_jpeg_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_jpeg_config</a></li><li><a href="#hb_mm_mc_get_fd" class="table-of-contents__link toc-highlight">hb_mm_mc_get_fd</a></li><li><a href="#hb_mm_mc_close_fd" class="table-of-contents__link toc-highlight">hb_mm_mc_close_fd</a></li><li><a href="#hb_mm_mc_set_camera" class="table-of-contents__link toc-highlight">hb_mm_mc_set_camera</a></li><li><a href="#hb_mm_mc_get_vui_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_vui_config</a></li><li><a href="#hb_mm_mc_set_vui_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_vui_config</a></li><li><a href="#hb_mm_mc_get_3dnr_enc_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_3dnr_enc_config</a></li><li><a href="#hb_mm_mc_set_3dnr_enc_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_3dnr_enc_config</a></li><li><a href="#hb_mm_mc_request_idr_header" class="table-of-contents__link toc-highlight">hb_mm_mc_request_idr_header</a></li><li><a href="#hb_mm_mc_enable_idr_frame" class="table-of-contents__link toc-highlight">hb_mm_mc_enable_idr_frame</a></li><li><a href="#hb_mm_mc_register_audio_encoder" class="table-of-contents__link toc-highlight">hb_mm_mc_register_audio_encoder</a></li><li><a href="#hb_mm_mc_unregister_audio_encoder" class="table-of-contents__link toc-highlight">hb_mm_mc_unregister_audio_encoder</a></li><li><a href="#hb_mm_mc_register_audio_decoder" class="table-of-contents__link toc-highlight">hb_mm_mc_register_audio_decoder</a></li><li><a href="#hb_mm_mc_unregister_audio_decoder" class="table-of-contents__link toc-highlight">hb_mm_mc_unregister_audio_decoder</a></li><li><a href="#hb_mm_mc_get_explicit_header_config" class="table-of-contents__link toc-highlight">hb_mm_mc_get_explicit_header_config</a></li><li><a href="#hb_mm_mc_set_explicit_header_config" class="table-of-contents__link toc-highlight">hb_mm_mc_set_explicit_header_config</a></li><li><a href="#hb_mm_mc_get_roi_avg_qp" class="table-of-contents__link toc-highlight">hb_mm_mc_get_roi_avg_qp</a></li><li><a href="#hb_mm_mc_set_roi_avg_qp" class="table-of-contents__link toc-highlight">hb_mm_mc_set_roi_avg_qp</a></li></ul></li><li><a href="#main-parameter-descriptions" class="table-of-contents__link toc-highlight">Main Parameter Descriptions</a><ul><li><a href="#media_codec_state_t" class="table-of-contents__link toc-highlight">media_codec_state_t</a></li><li><a href="#media_codec_id_t" class="table-of-contents__link toc-highlight">media_codec_id_t</a></li><li><a href="#mc_video_rate_control_mode_t" class="table-of-contents__link toc-highlight">mc_video_rate_control_mode_t</a></li><li><a href="#mc_h264_cbr_params_t" class="table-of-contents__link toc-highlight">mc_h264_cbr_params_t</a></li><li><a href="#mc_h264_vbr_params_t" class="table-of-contents__link toc-highlight">mc_h264_vbr_params_t</a></li><li><a href="#mc_h264_avbr_params_t" class="table-of-contents__link toc-highlight">mc_h264_avbr_params_t</a></li><li><a href="#mc_h264_fix_qp_params_t" class="table-of-contents__link toc-highlight">mc_h264_fix_qp_params_t</a></li><li><a href="#mc_h264_qp_map_params_t" class="table-of-contents__link toc-highlight">mc_h264_qp_map_params_t</a></li><li><a href="#mc_h265_cbr_params_t" class="table-of-contents__link toc-highlight">mc_h265_cbr_params_t</a></li><li><a href="#mc_h265_vbr_params_t" class="table-of-contents__link toc-highlight">mc_h265_vbr_params_t</a></li><li><a href="#mc_h265_avbr_params_t" class="table-of-contents__link toc-highlight">mc_h265_avbr_params_t</a></li><li><a href="#mc_h265_fix_qp_params_t" class="table-of-contents__link toc-highlight">mc_h265_fix_qp_params_t</a></li><li><a href="#mc_h265_qp_map_params_t" class="table-of-contents__link toc-highlight">mc_h265_qp_map_params_t</a></li><li><a href="#mc_mjpeg_fix_qp_params_t" class="table-of-contents__link toc-highlight">mc_mjpeg_fix_qp_params_t</a></li><li><a href="#mc_video_custom_gop_pic_params_t" class="table-of-contents__link toc-highlight">mc_video_custom_gop_pic_params_t</a></li><li><a href="#mc_inter_status_t" class="table-of-contents__link toc-highlight">mc_inter_status_t</a></li><li><a href="#media_codec_context_t" class="table-of-contents__link toc-highlight">media_codec_context_t</a></li><li><a href="#mc_video_codec_enc_params_t" class="table-of-contents__link toc-highlight">mc_video_codec_enc_params_t</a></li><li><a href="#mc_video_codec_dec_params_t" class="table-of-contents__link toc-highlight">mc_video_codec_dec_params_t</a></li><li><a href="#mc_audio_codec_enc_params_t" class="table-of-contents__link toc-highlight">mc_audio_codec_enc_params_t</a></li><li><a href="#mc_audio_codec_dec_params_t" class="table-of-contents__link toc-highlight">mc_audio_codec_dec_params_t</a></li></ul></li><li><a href="#return-value-description" class="table-of-contents__link toc-highlight">Return Value Description</a></li></ul></li><li><a href="#codec-sample" class="table-of-contents__link toc-highlight">Codec Sample</a><ul><li><a href="#encoding-example" class="table-of-contents__link toc-highlight">Encoding Example</a><ul><li><a href="#function-overview" class="table-of-contents__link toc-highlight">Function Overview</a><ul><li><a href="#software-architecture-description" class="table-of-contents__link toc-highlight">Software Architecture Description</a></li><li><a href="#hardware-data-flow-description" class="table-of-contents__link toc-highlight">Hardware Data Flow Description</a></li><li><a href="#code-location-and-directory-structure" class="table-of-contents__link toc-highlight">Code Location and Directory Structure</a></li></ul></li><li><a href="#compilation" class="table-of-contents__link toc-highlight">Compilation</a><ul><li><a href="#compilation-environment" class="table-of-contents__link toc-highlight">Compilation Environment</a></li><li><a href="#compilation-instructions" class="table-of-contents__link toc-highlight">Compilation Instructions</a></li></ul></li><li><a href="#execution" class="table-of-contents__link toc-highlight">Execution</a><ul><li><a href="#supported-platforms" class="table-of-contents__link toc-highlight">Supported Platforms</a></li><li><a href="#board-deployment-and-configuration" class="table-of-contents__link toc-highlight">Board Deployment and Configuration</a></li><li><a href="#running-instructions" class="table-of-contents__link toc-highlight">Running Instructions</a></li></ul></li></ul></li><li><a href="#decoding-examples" class="table-of-contents__link toc-highlight">Decoding Examples</a><ul><li><a href="#function-overview-1" class="table-of-contents__link toc-highlight">Function Overview</a><ul><li><a href="#software-architecture" class="table-of-contents__link toc-highlight">Software Architecture</a></li><li><a href="#hardware-data-flow-description-1" class="table-of-contents__link toc-highlight">Hardware Data Flow Description</a></li><li><a href="#code-location-and-directory-structure-1" class="table-of-contents__link toc-highlight">Code Location and Directory Structure</a></li></ul></li><li><a href="#compilation-1" class="table-of-contents__link toc-highlight">Compilation</a><ul><li><a href="#compilation-environment-1" class="table-of-contents__link toc-highlight">Compilation Environment</a></li><li><a href="#compilation-instructions-1" class="table-of-contents__link toc-highlight">Compilation Instructions</a></li></ul></li><li><a href="#execution-1" class="table-of-contents__link toc-highlight">Execution</a><ul><li><a href="#supported-platforms-1" class="table-of-contents__link toc-highlight">Supported Platforms</a></li><li><a href="#board-deployment-and-configuration-1" class="table-of-contents__link toc-highlight">Board Deployment and Configuration</a></li><li><a href="#running-guide" class="table-of-contents__link toc-highlight">Running Guide</a></li></ul></li></ul></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.guyuehome.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GuYueHome<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contact US</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 D-Robotics.</div></div></div></footer></div>
</body>
</html>