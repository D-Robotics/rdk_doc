<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Advanced_development/toolchain_development/expert/note" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Appendix | RDK DOC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.d-robotics.cc/rdk_doc/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/expert/note"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Appendix | RDK DOC"><meta data-rh="true" name="description" content="Eager Mode"><meta data-rh="true" property="og:description" content="Eager Mode"><link data-rh="true" rel="icon" href="/rdk_doc/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/expert/note"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/expert/note" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/expert/note" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/expert/note" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"7. Advanced Development","item":"https://developer.d-robotics.cc/rdk_doc/en/Advanced_development"},{"@type":"ListItem","position":2,"name":"7.4 Algorithm Toolchain Development Guide","item":"https://developer.d-robotics.cc/rdk_doc/en/04_toolchain_development"},{"@type":"ListItem","position":3,"name":"7.4.3 Expert Guide","item":"https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/expert/"},{"@type":"ListItem","position":4,"name":"Appendix","item":"https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/expert/note"}]}</script><script src="https://hm.baidu.com/hm.js?24dd63cad43b63889ea6bede5fd1ab9e" async></script><link rel="stylesheet" href="/rdk_doc/en/assets/css/styles.0fbd7d27.css">
<script src="/rdk_doc/en/assets/js/runtime~main.60363b0d.js" defer="defer"></script>
<script src="/rdk_doc/en/assets/js/main.7a582d51.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rdk_doc/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">D-Robotics</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rdk_doc/en/RDK">RDK X3 / X5</a><a class="navbar__item navbar__link" href="/rdk_doc/en/rdk_s/RDK">RDK S100</a><a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>EN</a><ul class="dropdown__menu"><li><a href="/rdk_doc/Advanced_development/toolchain_development/expert/note" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">CN</a></li><li><a href="/rdk_doc/en/Advanced_development/toolchain_development/expert/note" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">EN</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rdk_doc/en/RDK">D-Robotics RDK Suite</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Quick_start">1. Quick Start</a><button aria-label="Expand sidebar category &#x27;1. Quick Start&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/System_configuration">2. System Configuration</a><button aria-label="Expand sidebar category &#x27;2. System Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Basic_Application">3. 基础应用开发 </a><button aria-label="Expand sidebar category &#x27;3. 基础应用开发 &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Basic_Development">4. Algorithm Application Development</a><button aria-label="Expand sidebar category &#x27;4. Algorithm Application Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Robot_development">5. Robotics Application</a><button aria-label="Expand sidebar category &#x27;5. Robotics Application&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Application_case">6. Application Development Guide</a><button aria-label="Expand sidebar category &#x27;6. Application Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rdk_doc/en/Advanced_development">7. Advanced Development</a><button aria-label="Collapse sidebar category &#x27;7. Advanced Development&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/hardware_development">7.1 Hardware Development Guide</a><button aria-label="Expand sidebar category &#x27;7.1 Hardware Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/linux_development">7.2. Linux Development Guide</a><button aria-label="Expand sidebar category &#x27;7.2. Linux Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/03_multimedia_development">7.3 RDK X3 Multimedia Development Guide</a><button aria-label="Expand sidebar category &#x27;7.3 RDK X3 Multimedia Development Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/04_toolchain_development">7.4 Algorithm Toolchain Development Guide</a><button aria-label="Collapse sidebar category &#x27;7.4 Algorithm Toolchain Development Guide&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/overview">7.4.1 Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/intermediate/">7.4.2 Advanced Guide</a><button aria-label="Expand sidebar category &#x27;7.4.2 Advanced Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/">7.4.3 Expert Guide</a><button aria-label="Collapse sidebar category &#x27;7.4.3 Expert Guide&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/environment_config">Environment Dependency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/quick_start">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/user_guide">Development Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/advanced_content">Deep Exploration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/api_reference">API Manual</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/note">Appendix</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/FAQ">8. FAQs</a><button aria-label="Expand sidebar category &#x27;8. FAQs&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/en/Appendix">9. Appendix</a><button aria-label="Expand sidebar category &#x27;9. Appendix&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rdk_doc/en/Release_Note/release_note">10. Version release</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rdk_doc/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/Advanced_development"><span>7. Advanced Development</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/04_toolchain_development"><span>7.4 Algorithm Toolchain Development Guide</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/"><span>7.4.3 Expert Guide</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Appendix</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Appendix</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eager-mode">Eager Mode<a href="#eager-mode" class="hash-link" aria-label="Direct link to Eager Mode" title="Direct link to Eager Mode">​</a></h2>
<p>Similar to PyTorch official recommendation, we suggest users to use fx quantization mode as the first choice. horizon_plugin_pytorch currently supports quantization with eager mode.
The overall process of eager mode follows the quantization interface and concept from PyTorch officially, therefore, it is recommended to first read the relevant part about eager mode in <a href="https://pytorch.org/docs/stable/quantization.html#quantization" target="_blank" rel="noopener noreferrer"><strong>PyTorch official documentation</strong></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="difference-with-fx-mode">Difference with fx mode<a href="#difference-with-fx-mode" class="hash-link" aria-label="Direct link to Difference with fx mode" title="Direct link to Difference with fx mode">​</a></h3>
<p>When using eager mode in horizon_plugin_pytorch, the main differences compared with fx mode are:</p>
<ul>
<li>Eager mode only supports module-based operators. You need to manually replace the functional operators in the floating-point model with Module-based operators in PyTorch or proprietary operators defined in horizon_plugin_pytorch, including but not limited to:</li>
</ul>
<table><thead><tr><th>Floating-point operators</th><th>Replaced operators</th></tr></thead><tbody><tr><td>torch.nn.functional.relu</td><td>torch.nn.ReLU()</td></tr><tr><td>a + b <br> torch.add</td><td>horizon.nn.quantized.FloatFunctional().add</td></tr><tr><td>Tensor.exp</td><td>horizon.nn.Exp()</td></tr><tr><td>torch.nn.functional.interpolate</td><td>horizon.nn.Interpolate()</td></tr></tbody></table>
<ul>
<li>You need to manually define the operators to be fused and explicitly call the fusion function, and specify to use <code>fuser_func</code> provided in horizon_plugin_pytorch. The example is shown below:</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> torch </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> horizon_plugin_pytorch </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> horizon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ConvBNReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sequential</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kernel_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ConvBNReLU</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in_channels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out_channels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">out_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kernel_size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kernel_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BatchNorm2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_features</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">out_channels</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Specify the operators that can be fused</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_modules</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inplace</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Specify the fuse function provided by horizon_plugin_pytorch in the horizon_plugin_pytorch package</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fuser_func</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_known_modules</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ConvBNReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Need to explicitly call the fuse function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">float_model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ConvBNReLU(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#   (0): ConvReLU2d(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     (0): Conv2d(1, 1, kernel_size=(1, 1), stride=(1, 1))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     (1): ReLU()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#   )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#   (1): Identity()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#   (2): Identity()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># )</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="usage-flow">Usage Flow<a href="#usage-flow" class="hash-link" aria-label="Direct link to Usage Flow" title="Direct link to Usage Flow">​</a></h3>
<p>The overall flow of quantization-aware training in Eager mode is shown in the following figure:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/expert/qat.svg" alt="qat" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="build-float-model">Build Float Model<a href="#build-float-model" class="hash-link" aria-label="Direct link to Build Float Model" title="Direct link to Build Float Model">​</a></h4>
<p>When building a float model in Eager mode, there are a few things to note:</p>
<ol>
<li>
<p>Insert quantization and dequantization nodes in the network. Generally, a quantization node should be inserted at the beginning of the float model, and a dequantization node should be inserted at the end. When the float model is converted to a QAT model for quantization-aware training, the inserted quantization node will quantize the input;</p>
</li>
<li>
<p>Replace some float-type function-form operators with operators inherited from Module in PyTorch or some proprietary operators provided by the Plugin;</p>
</li>
<li>
<p>Define the fusion function for float operators to fuse eligible operators.</p>
</li>
</ol>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optim </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> optim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> horizon_plugin_pytorch </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> horizon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> torch </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> torchvision </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transforms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DeQuantStub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> horizon_plugin_pytorch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> QuantStub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ConvBNReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sequential</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kernel_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ConvBNReLU</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in_channels</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in_channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out_channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> out_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kernel_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> kernel_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BatchNorm2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_features</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">out_channels</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Specify the floating point operators that can be fused</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_modules</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inplace</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fuser_func</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_known_modules</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ClassiFier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_channels</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ClassiFier</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_channels</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Build the floating point model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Net</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ConvBNReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MaxPool2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kernel_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ConvBNReLU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg_pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AvgPool2d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kernel_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ClassiFier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># To adapt to the BPU, when getting input from the camera, the scale of the QuantStub must be set to 1/128 explicitly.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> QuantStub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dequant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeQuantStub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Insert quantization node to quantize the input</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_pool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg_pool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Insert dequantization node to dequantize the output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dequant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Define the fusion function```python</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> horizon_plugin_pytorch </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> quantization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> m </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">modules</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ConvBNReLU</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="float-model-pretrain">Float Model Pretraining<a href="#float-model-pretrain" class="hash-link" aria-label="Direct link to Float Model Pretraining" title="Direct link to Float Model Pretraining">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">train_batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">epoch_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">neval_batches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;model.pt&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">AverageMeter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Computes and stores the average and current value&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmt</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;:f&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__str__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmtstr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{name} {val&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;} ({avg&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;})&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmtstr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__dict__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">criterion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CrossEntropyLoss</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">accuracy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> topk</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Computes the accuracy over the k top predictions for the specified</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    values of k</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        maxk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pred </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        correct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">expand_as</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> topk</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            correct_k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> correct</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">correct_k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_train_data_loader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        datasets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MNIST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;mnist_data&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            train</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            download</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transform</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Compose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ToTensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Normalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">train_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shuffle</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> train_loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_test_data_loader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        datasets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MNIST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;mnist_data&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            train</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            download</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transform</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Compose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ToTensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Normalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shuffle</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> train_loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_train_data_loader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_test_data_loader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> epoch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">global</span><span class="token plain"> min_loss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> batch_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data_loader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> criterion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zero_grad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> batch_idx </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Train Epoch: {} batch {} \t Loss: {:.6f}&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> loss</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AverageMeter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Acc@1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:6.2f&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AverageMeter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Acc@5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:6.2f&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tested_batches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> batch_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_loader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tested_batches </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> criterion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            acc1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> topk</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top5</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc5</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> tested_batches </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train_float_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SGD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> momentum</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> nepoch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epoch_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nepoch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;</span><span class="token builtin">float</span><span class="token plain"> training Epoch </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">d </span><span class="token punctuation" style="color:#393A34">:</span><span class="token builtin">float</span><span class="token plain"> evaluation accuracy on </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">d images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">%</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">2f&quot; </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nepoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_float_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cuda&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>If you want to perform quantization-aware training on an existing floating-point model, you can first load the float model and then proceed with the steps for(fusion operators) and quantization training. If you&#x27;re directly quantizing after float training without any intermediate step, there&#x27;s no need to explicitly load the model. You can proceed directly.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cpu&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Load the float model for quantization-aware training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qat_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> load_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="set-bpu">Set BPU architecture<a href="#set-bpu" class="hash-link" aria-label="Direct link to Set BPU architecture" title="Direct link to Set BPU architecture">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Set march to BERNOULLI2 for **RDK X3** and BAYES for **RDK Ultra**.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">march</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_march</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">march</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">March</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BAYES</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="op-fuse">Operator fusion<a href="#op-fuse" class="hash-link" aria-label="Direct link to Operator fusion" title="Direct link to Operator fusion">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fuse_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="float-to-quantized">Convert floating-point model to quantized model<a href="#float-to-quantized" class="hash-link" aria-label="Direct link to Convert floating-point model to quantized model" title="Direct link to Convert floating-point model to quantized model">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_and_prepare_qat_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Load pre-trained floating-point model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">global</span><span class="token plain"> qat_model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qat_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;</span><span class="token builtin">float</span><span class="token plain"> evaluation accuracy on </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">d images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">%</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">2f&quot; </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">neval_batches </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Set the quantization parameters for quantizing the weights and outputs of operators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qconfig </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_default_qat_qconfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Turn off quantization for the output layer to improve accuracy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qconfig </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_default_qat_out_qconfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Convert the floating-point model to quantized model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prepare_qat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inplace</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;After preparation for QAT, note fake-quantization modules \n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conv0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qat_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_and_prepare_qat_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cuda&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="quantization-tnjkraining">Quantization Tnjkraining<a href="#quantization-tnjkraining" class="hash-link" aria-label="Direct link to Quantization Tnjkraining" title="Direct link to Quantization Tnjkraining">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">quantization_training</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Quantization training for the quantized model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SGD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.0001</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> nepoch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nepoch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Evaluate the quantized model for one epoch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qat_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;QAT Epoch %d :float evaluation accuracy on %d images, %2.2f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nepoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quantization_training</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cuda&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="convert-quantized-model-to-fixed-point-model">Convert Quantized Model to Fixed-point Model<a href="#convert-quantized-model-to-fixed-point-model" class="hash-link" aria-label="Direct link to Convert Quantized Model to Fixed-point Model" title="Direct link to Convert Quantized Model to Fixed-point Model">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">quantized_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">convert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qat_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inplace</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="check-and-compile-the-fixed-point-prediction-model">Check and Compile the Fixed-point Prediction Model<a href="#check-and-compile-the-fixed-point-prediction-model" class="hash-link" aria-label="Direct link to Check and Compile the Fixed-point Prediction Model" title="Direct link to Check and Compile the Fixed-point Prediction Model">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compile_quantized_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    example_input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ones</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">neval_batches</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traced_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quantized_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> example_input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">traced_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> neval_batches</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;Traced : int evaluation accuracy on %d images, %2.2f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">neval_batches </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Check if the model can be compiled using hbdk. hbdk is a tool for compiling fixed-point models.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">check_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quantized_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> example_input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> advice</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hbdk_dir </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hbdk_model&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hbdk_dir</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hbdk_dir</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Compile the model, and the model.hbm in the hbdk_model directory is the compiled on-board model.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compile_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">traced_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">example_input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opt</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hbm</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hbdk_dir </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/model.hbm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Static performance analysis of the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">perf_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traced_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">example_input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opt</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_source</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pyramid&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer_details</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hbdk_dir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">horizon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">visualize_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traced_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">example_input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    save_path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hbdk_dir </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/model.svg&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    show</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compile_quantized_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;cuda&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="supported-general-operators">Supported General Operators<a href="#supported-general-operators" class="hash-link" aria-label="Direct link to Supported General Operators" title="Direct link to Supported General Operators">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overall-explanation">Overall Explanation<a href="#overall-explanation" class="hash-link" aria-label="Direct link to Overall Explanation" title="Direct link to Overall Explanation">​</a></h3>
<ol>
<li>Unless otherwise specified, the inputs and outputs of Bernoulli2 architecture-constrained operators are all 4-dimensional.</li>
<li>In eager mode, some operators need to be manually replaced, while fx mode does not need to replace operators manually.</li>
<li>By default, the supported operators do not perform operator fusion. For operators that can be fused (such as (conv, bn), relu), refer to the <a href="/rdk_doc/en/Advanced_development/toolchain_development/expert/advanced_content#op_fusion"><strong>Operator Fusion</strong></a> section.</li>
<li>In the inference phase, transparent operators (such as Identity, Dropout) will be optimized out during deployment.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="torch-function-class">torch function class<a href="#torch-function-class" class="hash-link" aria-label="Direct link to torch function class" title="Direct link to torch function class">​</a></h3>
<table><thead><tr><th>Operator</th><th>Eager mode equivalent operator</th><th>Bernoulli2</th><th>Input</th><th>Output</th><th>Bayes</th><th>Output</th><th>Other constraints</th></tr></thead><tbody><tr><td></td><td></td><td>Input</td><td>Output</td><td>Other constraints</td><td>Input</td><td>Output</td><td>Other constraints</td></tr><tr><td>torch.abs</td><td></td><td>Not supported</td><td></td><td></td><td>qint8, qint16</td><td>Same as input</td><td></td></tr><tr><td>torch.acos</td><td>horizon.nn.Acos</td><td>Not supported</td><td></td><td></td><td>qint8, qint16</td><td>qint8, qint16</td><td>Implementation using a lookup table, with accuracy risks</td></tr><tr><td>torch.acosh</td><td>horizon.nn.Acosh</td><td>Not supported</td><td></td><td></td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.add</td><td>torch.nn.quantized.FloatFunctional or horizon.nn.quantized.FloatFunctional</td><td>qint8, qint16</td><td>qint8, qint16</td><td>in_channel<code>&lt;=</code>2048, not supported for operands as constants</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Supports broadcasting except for N dimensions, only one input can be broadcasted, call add_scalar if one of the operands is a scalar</td></tr><tr><td>torch.argmax</td><td></td><td>Refer to torch.max</td><td></td><td></td><td>Refer to torch.max</td><td></td><td></td></tr><tr><td>torch.argmin</td><td></td><td>Refer to torch.max</td><td></td><td></td><td>Refer to torch.max</td><td></td><td></td></tr><tr><td>torch.asin</td><td>horizon.nn.Asin</td><td>Not supported</td><td></td><td></td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.asinh</td><td>horizon.nn.Asinh</td><td>Not supported</td><td></td><td></td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.atan</td><td>horizon.nn.Atan</td><td>Not supported</td><td></td><td></td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.atanh</td><td>horizon.nn.Atanh</td><td>Not supported</td><td></td><td></td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.cat</td><td>torch.nn.quantized.FloatFunctional or horizon.nn.quantized.FloatFunctional</td><td>qint8, qint16</td><td>qint8, qint16</td><td></td><td>qint8, qint16</td><td>qint8, qint16</td><td>input shape: [N, C, H, W], N<code>&lt;=</code>4096, HWC<code>&lt;=</code>65536, 2<code>&lt;=</code>input number<code>&lt;=</code>1024</td></tr><tr><td>torch.ceil</td><td>horizon.nn.Ceil</td><td>Not supported</td><td></td><td></td><td>qint8, qint16</td><td>Same as input</td><td>Do not exceed the level of 1e6 for int8 input and the level of 1e8 for int16 input.</td></tr><tr><td>torch.clamp</td><td>Not supported</td><td>No</td><td>qint8, qint16</td><td>Same as input</td><td>Supports min and max inputs as Tensor/Constant Tensor/Scalar/None. For Constant Tensor, the input data range should be consistent with input to avoid precision issues.</td><td></td><td></td></tr><tr><td>torch.clip</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.clamp</td><td>-</td><td></td><td></td></tr><tr><td>torch.cos</td><td>horizon.nn.Cos</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.cosh</td><td>horizon.nn.Cosh</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.div</td><td>horizon.nn.Div</td><td>Not supported</td><td>qint16</td><td>qint16</td><td>-</td><td></td><td></td></tr><tr><td>torch.eq</td><td>Not supported</td><td>No</td><td>qint8, qint16</td><td>qbool</td><td>-</td><td></td><td></td></tr><tr><td>torch.erf</td><td>horizon.nn.Erf</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.exp</td><td>horizon.nn.Exp</td><td>qint8</td><td>qint8</td><td>Uses table lookup, has precision risk</td><td>Refer to torch.acos</td><td>-</td><td></td></tr><tr><td>torch.floor</td><td>horizon.nn.Floor</td><td>Not supported</td><td>qint8, qint16</td><td>Same as input</td><td>Int8 inputs should not exceed 1e6 in magnitude, int16 inputs should not exceed 1e8.</td><td></td><td></td></tr><tr><td>torch.gather</td><td>Not supported</td><td>No</td><td>qint8, qint16, qint32</td><td>Same as input</td><td>-</td><td></td><td></td></tr><tr><td>torch.ge</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.greater</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.greater_equal</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.gt</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.le</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.less</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.less_equal</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.log</td><td>horizon.nn.HardLog</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.lt</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.eq</td><td>-</td><td></td><td></td></tr><tr><td>torch.matmul</td><td>horizon.nn.quantized.FloatFunctional</td><td>qint8</td><td>qint8, qint32</td><td>-</td><td><code>Input shape: [N, C, H, W], input size &lt; 1 GB, N &lt;= 4096, C, H, W &lt;= 8192.</code></td><td></td><td></td></tr><tr><td>torch.max</td><td></td><td>qint8</td><td>Same as input</td><td>Only for model output. Output format differs from torch: Compiler supports a Tensor with max_value in one channel and max_value_index in another.</td><td>qint8, qint16 output; int32 index</td><td><code>Index can only be used as model output. Input shape: [N, C, H, W], 1 &lt;= N &lt;= 4096, 1 &lt;= H, W, C &lt;= 65535. Supports min and max inputs as Tensor/Constant Tensor/Scalar/None. Consistency in input data range with min and max is required for precision.</code></td><td></td></tr><tr><td>torch.maximum</td><td>horizon.nn.quantized.FloatFunctional</td><td>Not supported</td><td>-</td><td>-</td><td>input: qint8, qint16<br> other: qint8, qint16</td><td>qint8, qint16</td><td>-</td></tr><tr><td>torch.mean</td><td>horizon.nn.quantized.FloatFunctional</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Supports channel-wise mean only. QAT has training parameters, don&#x27;t use standalone in inference.</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Supports mean in CHW. QAT has quantization parameters.</td></tr><tr><td>torch.min</td><td>Not supported</td><td>No</td><td>-</td><td>Refer to torch.max</td><td>-</td><td></td><td></td></tr><tr><td>torch.minimum</td><td>horizon.nn.quantized.FloatFunctional</td><td>Not supported</td><td>-</td><td>Refer to torch.maximum</td><td>-</td><td></td><td></td></tr><tr><td>torch.mul</td><td>torch.nn.quantized.FloatFunctional or horizon.nn.quantized.FloatFunctional</td><td>Refer to torch.add</td><td>-</td><td>Refer to torch.add</td><td>-</td><td></td><td></td></tr><tr><td>torch.pow</td><td>horizon.nn.Pow</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.reciprocal</td><td>horizon.nn.Reciprocal</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.selu</td><td>horizon.nn.Selu</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.sin</td><td>horizon.nn.Sin</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.sinh</td><td>horizon.nn.Sinh</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.split</td><td></td><td>qint8, qint16</td><td>Same as input</td><td>-</td><td>qint8, qint16</td><td>Same as input</td><td>-</td></tr><tr><td>torch.sqrt</td><td>horizon.nn.Sqrt</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.sub</td><td>horizon.nn.quantized.FloatFunctional</td><td>qint8, qint16</td><td>qint8, qint16</td><td><code>in_channel &lt;= 2048</code></td><td>qint8, qint16</td><td>qint8, qint16</td><td>Supports broadcasting except N dimensions. Only one input can broadcast.</td></tr><tr><td>torch.sum</td><td>horizon.nn.quantized.FloatFunctional</td><td>qint8</td><td>qint8, qint32</td><td>Supports batch and channel-wise sum.</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Supports sum in HWC only.</td></tr><tr><td>torch.tan</td><td>horizon.nn.Tan</td><td>Not supported</td><td>-</td><td>Refer to torch.acos</td><td>-</td><td></td><td></td></tr><tr><td>torch.topk</td><td>Not supported</td><td>No</td><td>qint8, qint16, qint32</td><td>Same as input</td><td>-</td><td></td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchnnfunctional-function-class">torch.nn.functional function class<a href="#torchnnfunctional-function-class" class="hash-link" aria-label="Direct link to torch.nn.functional function class" title="Direct link to torch.nn.functional function class">​</a></h3>
<table><thead><tr><th>Operator</th><th>Eager Mode Replacement Operator</th><th>Bernoulli2</th><th></th><th></th><th>Bayes</th><th></th><th></th></tr></thead><tbody><tr><td></td><td></td><td>input</td><td>output</td><td>other limits</td><td>input</td><td>output</td><td>other limits</td></tr><tr><td>torch.nn.functional.grid_sample</td><td>N/A</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Input: qint8 <br> Grid: qint8, qint16</td><td>Output: qint8</td><td>Input shape: [N, C, H, W], 1≤H, W≤1024 and H<em>W≤720</em>1024. Supports bilinear and nearest interpolation with padding modes only zeros and border.</td></tr><tr><td>torch.nn.functional.interpolate</td><td>qint8</td><td>qint8</td><td>Supports nearest and bilinear interpolation. 1/256 ≤ scale ≤ 256</td><td>qint8</td><td>qint8</td><td>Supports nearest and bilinear interpolation. Input shape: [N, C, H, W], 1≤C, H, W≤8192. align_corners supports False and None. Requires recompute_scale_factors to be True when scale=[].</td><td></td></tr><tr><td>torch.nn.functional.pad</td><td>N/A</td><td>Not supported</td><td>Not supported</td><td>N/A</td><td>qint8, qint16</td><td>Same as input</td><td>Reflect mode not supported.</td></tr><tr><td>torch.nn.functional.relu</td><td>torch.nn.ReLU</td><td>qint8</td><td>qint8</td><td></td><td>qint8</td><td>Same as input</td><td>Fused Conv2d+BN+ReLU operations will be automatically applied.</td></tr><tr><td>torch.nn.functional.relu6(fused)</td><td>torch.nn.ReLU6</td><td>N/A</td><td>N/A</td><td></td><td>qint8</td><td>Same as input</td><td>N/A</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchnn-module-class">torch.nn Module Class<a href="#torchnn-module-class" class="hash-link" aria-label="Direct link to torch.nn Module Class" title="Direct link to torch.nn Module Class">​</a></h3>
<table><thead><tr><th>Operator</th><th>Eager Mode Replacement</th><th>Bernoulli2</th><th>Input</th><th>Output</th><th>Other Constraints</th><th>Input (Bayes)</th><th>Output (Bayes)</th><th>Other Constraints (Bayes)</th></tr></thead><tbody><tr><td>torch.nn.AdaptiveAvgPool2d</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8</td><td>Same as input</td><td>Converted with AvgPool2d, accuracy issue</td><td></td></tr><tr><td>torch.nn.AvgPool2d</td><td>qint8</td><td>Same as input</td><td><code>1&lt;=kernel&lt;=7, 1&lt;=stride&lt;=185</code></td><td></td><td></td><td></td><td><code>1&lt;=kernel, stride, padding&lt;=256</code>;</td><td></td></tr><tr><td>torch.nn.BatchNorm2d</td><td></td><td></td><td></td><td>BN2d absorbed in QAT, not present in prediction models. Limited by compiler, uses BpuConvolution for standalone usage</td><td>qint8</td><td>qint8</td><td>BN2d absorbed in QAT, not shown in model. See Conv2d constraints for standalone use</td><td></td></tr><tr><td>torch.nn.BatchNorm3d</td><td></td><td></td><td></td><td>BN3d absorbed in QAT, not present in prediction models. Limited by compiler, uses BpuConvolution for standalone usage</td><td>qint8</td><td>qint8</td><td>BN3d absorbed in QAT, not shown in model. See Conv2d constraints for standalone use</td><td></td></tr><tr><td>torch.nn.ChannelShuffle</td><td>qint8</td><td>Same as input</td><td></td><td>qint8, qint16</td><td>Same as input</td><td>shuffle_index values must be unique</td><td></td><td></td></tr><tr><td>torch.nn.ConstantPad2d</td><td></td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td></td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td></td></tr><tr><td>torch.nn.Conv2d</td><td>qint8</td><td>qint8, qint32</td><td></td><td>input: qint8, qint16; weight: qint8; bias: qint32</td><td>qint8, qint16, qint32</td><td><code>out_channel&lt;=8192, max out_channel for model output: 16384. Input channel&lt;=8192, kernel&lt;32, dilation&lt;=16, stride=1 when dilation!=1. Supports sumin, sumin conv only supports stride (1, 1) or (2, 2). Weight shape: [N, C, H, W], N, C&lt;=8192, H, W&lt;=31. For model output, C&lt;=16384, weight_size &lt; 65535. Padding&lt;=256. qint16 input overflow limits apply.</code></td><td></td><td></td></tr><tr><td>torch.nn.Conv3d</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>input: qint8, weight: qint8, bias: qint32</td><td>qint8</td><td><code>input: [N, C, D, H, W] int8, N&lt;=128; H, W, D, C&lt;=65536; weight: [C_o, C_i, D, H, W] int8, N, C&lt;=65536, D, H&lt;=9, W&lt;=8191; bias: int32; output: [N, C, D, H, W] int8, int16, int32; stride: [D, H, W], D, H, W=1 or 2, same for all; padding: [D, H, W], D&lt;=kernel_d/2, H&lt;=kernel_h/2, W&lt;=kernel_w/2 (kernel_w is the W dimension of weight); group, dilation unsupported</code></td><td></td></tr><tr><td>torch.nn.ConvTranspose2d</td><td>qint8</td><td>qint8</td><td><code>2&lt;=kernel&lt;=14, channel&lt;=2048. Padding H*W=[0, (kernel_h-1)/2] * [0, (kernel_w-1)/2]. 2&lt;=stride&lt;=4, dilation=(1, 1)</code></td><td>qint8</td><td>qint8</td><td><code>Input shape: [N, C, H, W], 1&lt;=N&lt;=128, 1&lt;=channel&lt;=2048; Weight shape: [N, C, H, W], 1&lt;=N, C&lt;=2048, 2&lt;=H, W&lt;=14, weight_size&lt;=65535; kernel&gt;=stride, 1&lt;=stride&lt;=14, 1&lt;=out_channel&lt;=2048, in_channel&lt;=2048, pad&lt;=kernel/stride, 0&lt;=out_pad&lt;=1; Bias int32 type. Supports sumin, sumin input int8 type; 0&lt;=output_padding&lt;=1; Supports group, requires weight_n and input channel divisible by group; dilation=1</code></td><td></td><td></td></tr><tr><td>torch.nn.Dropout</td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.Dropout2d</td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.ELU</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.GELU</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.GLU</td><td>Not supported</td><td>Not supported</td><td></td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td><td></td></tr><tr><td>torch.nn.HardSigmoid</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.Identity</td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.LayerNorm</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td></td><td>qint8</td><td>qint8, qint16</td><td>Lower-level implementation uses multiple lookups, higher risk of precision loss. Use rsqrt_kwargs to control internal rsqrt lookup parameters. <code>H * W &lt;= 16384</code>, normalized_shape <code>H * W &lt; 16384</code></td><td></td></tr><tr><td>torch.nn.LeakyReLU</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.Linear</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>input: qint8; weight: qint8; bias: qint32</td><td>qint8</td><td><code>in_features &lt;= 8192, out_features &lt;= 8192.</code></td><td></td></tr><tr><td>torch.nn.LSTMCell</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Input is 2-dimensional</td><td></td></tr><tr><td>torch.nn.MaxPool2d</td><td>qint8</td><td>Same as input</td><td><code>1&lt;=kernel&lt;=64, 1&lt;=stride&lt;=256, padding&gt;=0</code></td><td>qint8</td><td>Same as input</td><td><code>Input_shape: [N, C, H, W], 1&lt;=H, W, C&lt;=8192; 1&lt;=kernel, stride&lt;=256; 0&lt;=padding&lt;=255;</code></td><td></td><td></td></tr><tr><td>torch.nn.MultiheadAttention</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>qint8, qint16</td><td>Unsupported: add_bias_kv, add_zero_attn, qkv embed_dim inconsistencies. Supports int8/int16 inputs, potential precision risks from table lookups and masking</td><td></td></tr><tr><td>torch.nn.PixelShuffle</td><td>qint8, qint16</td><td>Same as input</td><td></td><td>qint8, qint16</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.PixelUnshuffle</td><td>qint8, qint16</td><td>Same as input</td><td></td><td>qint8, qint16</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.PReLU</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.ReLU</td><td>qint8</td><td>Same as input</td><td></td><td>qint8, qint16</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.ReLU6</td><td>qint8</td><td>Same as input</td><td></td><td>qint8, qint16</td><td>Same as input</td><td></td><td></td><td></td></tr><tr><td>torch.nn.ReplicationPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td>Refer to torch.nn.ZeroPad2d</td><td></td><td></td></tr><tr><td>torch.nn.Sigmoid</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.SiLU</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.exp</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td></tr><tr><td>torch.nn.Softmax</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8</td><td>qint8, qint16</td><td>Multiple lookups and summations involved, high precision risk</td><td></td><td></td></tr><tr><td>torch.nn.Softplus</td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.acos</td><td>Refer to torch.acos</td><td></td><td></td><td></td></tr><tr><td>torch.nn.SyncBatchNorm</td><td>qint8</td><td>qint8</td><td>Uses torch.nn.Conv2d composition</td><td>qint8</td><td>qint</td><td></td><td></td><td></td></tr></tbody></table>
<table><thead><tr><th>Operator</th><th>Eager Mode Replacement Operator</th><th>Bernoulli2</th><th></th><th>Constraints</th><th>Bayes</th><th></th><th></th></tr></thead><tbody><tr><td>torch.quantization.DeQuantStub</td><td></td><td>qint8, qint16, qint32</td><td>float32</td><td>Common Use: Segmented network models, dequantizing data from BPU to CPU for CPU processing convenience.</td><td>qint8, qint16, qint32</td><td>float32</td><td>Same as above</td></tr><tr><td>torch.quantization.QuantStub</td><td>horizon.quantization.QuantStub</td><td>float32</td><td>qint8, qint16</td><td>Common Use: Model inputs, or before data is quantized from CPU to BPU in segmented models. Scale parameter setup: Set based on input data, aiming for high precision quantization of float data to int8. For example, if input float range is (-1, 1), use scale = 1 / 128. Pre-trained float models: In pre-trained models, use a special conv layer to handle scale settings, as the model may not follow this method. Requires uniform input distribution for QuantStub.</td><td>float32</td><td>qint8, qint16</td><td>Same as above with additional note about pre-trained models.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchtensor-method-class">torch.Tensor method Class<a href="#torchtensor-method-class" class="hash-link" aria-label="Direct link to torch.Tensor method Class" title="Direct link to torch.Tensor method Class">​</a></h3>
<table><thead><tr><th>Operator</th><th>Eager Mode Replacement</th><th>Bernoulli2</th><th></th><th></th><th>Bayes</th><th></th><th></th></tr></thead><tbody><tr><td>torch.Tensor.<strong>getitem</strong></td><td></td><td>qint8, qint16, qint32</td><td>Same as input</td><td></td><td></td><td></td><td></td></tr><tr><td>torch.Tensor.transpose</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16, qint32</td><td>Tensor.dtype</td><td>Not supported for N-dimensional transposes</td></tr><tr><td>torch.Tensor.argmax</td><td></td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td></tr><tr><td>torch.Tensor.argmin</td><td></td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td></tr><tr><td>torch.Tensor.clamp</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>Tensor.dtype</td><td><code>dim &lt;= 10, 1 &lt;= each_dim_size &lt; 65536</code></td></tr><tr><td>torch.Tensor.clip</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.Tensor.clip</td><td>Refer to torch.Tensor.clip</td><td>Refer to torch.Tensor.clip</td></tr><tr><td>torch.Tensor.eq</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.expand</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>Tensor.dtype</td><td></td></tr><tr><td>torch.Tensor.ge</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.greater</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.greater_equal</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.gt</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.le</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.less</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.less_equal</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td><td>Refer to torch.eq</td></tr><tr><td>torch.Tensor.max</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.max</td><td>Refer to torch.max</td><td>Refer to torch.max</td></tr><tr><td>torch.Tensor.min</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>Refer to torch.max</td><td></td><td></td></tr><tr><td>torch.Tensor.repeat</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>Tensor.dtype</td><td></td></tr><tr><td>torch.Tensor.reshape</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td></td><td>Tensor.dtype</td><td></td></tr><tr><td>torch.Tensor.tile</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>Tensor.dtype</td><td></td></tr><tr><td>torch.Tensor.abs</td><td></td><td>Not supported</td><td>Not supported</td><td>Not supported</td><td>qint8, qint16</td><td>Tensor.dtype</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchvision-operations">torchvision Operations<a href="#torchvision-operations" class="hash-link" aria-label="Direct link to torchvision Operations" title="Direct link to torchvision Operations">​</a></h3>
<table><thead><tr><th>Operator</th><th>Eager Mode Replacement</th><th>Bernoulli2</th><th>Notes</th><th>Input</th><th>Bayesian</th><th>Output</th><th>Additional Constraints</th></tr></thead><tbody><tr><td>torchvision.models.detection.rpn.AnchorGenerator</td><td>horizon.nn.AnchorGenerator</td><td>qint8, qint16, qint32, float32</td><td>Supports Tensor.shape determinable offline</td><td>qint8, qint16, qint32, float32</td><td>float32</td><td>float32</td><td>Input: int8/int16/int32/float32, Output: float32</td></tr><tr><td>torchvision.ops.MultiScaleRoIAlign</td><td>horizon.nn.MultiScaleRoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td><td>Refer to torchvision.ops.RoIAlign</td></tr><tr><td>torchvision.ops.RoIAlign</td><td></td><td>qint8</td><td>qint8</td><td></td><td>qint8</td><td>qint8</td><td><code>1 &lt;= feature number &lt;= 5; Bboxes only support List[Tensor] format with shape [1, box_num, 4], where the last dimension represents [left, top, right, bottom].</code></td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-11-26T16:21:55.000Z" itemprop="dateModified">Nov 26, 2025</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rdk_doc/en/Advanced_development/toolchain_development/expert/api_reference"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">API Manual</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rdk_doc/en/FAQ"><div class="pagination-nav__sublabel">Next </div><div class="pagination-nav__label">8. 常见问题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eager-mode" class="table-of-contents__link toc-highlight">Eager Mode</a><ul><li><a href="#difference-with-fx-mode" class="table-of-contents__link toc-highlight">Difference with fx mode</a></li><li><a href="#usage-flow" class="table-of-contents__link toc-highlight">Usage Flow</a><ul><li><a href="#build-float-model" class="table-of-contents__link toc-highlight">Build Float Model</a></li><li><a href="#float-model-pretrain" class="table-of-contents__link toc-highlight">Float Model Pretraining</a></li><li><a href="#set-bpu" class="table-of-contents__link toc-highlight">Set BPU architecture</a></li><li><a href="#op-fuse" class="table-of-contents__link toc-highlight">Operator fusion</a></li><li><a href="#float-to-quantized" class="table-of-contents__link toc-highlight">Convert floating-point model to quantized model</a></li><li><a href="#quantization-tnjkraining" class="table-of-contents__link toc-highlight">Quantization Tnjkraining</a></li><li><a href="#convert-quantized-model-to-fixed-point-model" class="table-of-contents__link toc-highlight">Convert Quantized Model to Fixed-point Model</a></li><li><a href="#check-and-compile-the-fixed-point-prediction-model" class="table-of-contents__link toc-highlight">Check and Compile the Fixed-point Prediction Model</a></li></ul></li></ul></li><li><a href="#supported-general-operators" class="table-of-contents__link toc-highlight">Supported General Operators</a><ul><li><a href="#overall-explanation" class="table-of-contents__link toc-highlight">Overall Explanation</a></li><li><a href="#torch-function-class" class="table-of-contents__link toc-highlight">torch function class</a></li><li><a href="#torchnnfunctional-function-class" class="table-of-contents__link toc-highlight">torch.nn.functional function class</a></li><li><a href="#torchnn-module-class" class="table-of-contents__link toc-highlight">torch.nn Module Class</a></li><li><a href="#torchtensor-method-class" class="table-of-contents__link toc-highlight">torch.Tensor method Class</a></li><li><a href="#torchvision-operations" class="table-of-contents__link toc-highlight">torchvision Operations</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.guyuehome.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GuYueHome<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contact US</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 D-Robotics.</div></div></div></footer></div>
</body>
</html>