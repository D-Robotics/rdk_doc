"use strict";(self.webpackChunkrdk_doc=self.webpackChunkrdk_doc||[]).push([[87130],{28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>c});var d=i(96540);const r={},o=d.createContext(r);function s(e){const n=d.useContext(o);return d.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),d.createElement(o.Provider,{value:n},e.children)}},45996:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>d,toc:()=>l});const d=JSON.parse('{"id":"Advanced_development/linux_development/driver_development/driver_codec_dev","title":"Audio Codec Adaptation Guide","description":"Overview","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/07_Advanced_development/02_linux_development/driver_development/driver_codec_dev.md","sourceDirName":"07_Advanced_development/02_linux_development/driver_development","slug":"/Advanced_development/linux_development/driver_development/driver_codec_dev","permalink":"/rdk_doc/en/Advanced_development/linux_development/driver_development/driver_codec_dev","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1761726760000,"sidebarPosition":15,"frontMatter":{"sidebar_position":15},"sidebar":"tutorialSidebar","previous":{"title":"Watchdog Driver Debugging Guide","permalink":"/rdk_doc/en/Advanced_development/linux_development/driver_development/driver_watchdog_dev"},"next":{"title":"7.2.3 RDK X5 Driver Development Guide","permalink":"/rdk_doc/en/Advanced_development/linux_development/driver_development_x5/"}}');var r=i(74848),o=i(28453);const s={sidebar_position:15},c="Audio Codec Adaptation Guide",t={},l=[{value:"Overview",id:"overview",level:3},{value:"Audio Development Instructions",id:"audio-development-instructions",level:3},{value:"I2S Parameters",id:"i2s-parameters",level:3},{value:"Adding a New Codec",id:"adding-a-new-codec",level:3},{value:"Adding codec driver",id:"adding-codec-driver",level:4},{value:"Adding build options",id:"adding-build-options",level:4},{value:"Enabling the driver in Kernel",id:"enabling-the-driver-in-kernel",level:4},{value:"Modifying dts File",id:"modifying-dts-file",level:3},{value:"Writing DAI LINK Driver",id:"writing-dai-link-driver",level:3},{value:"Debugging Instructions",id:"debugging-instructions",level:2},{value:"Sound Card Debugging",id:"sound-card-debugging",level:3},{value:"Loading Driver Modules",id:"loading-driver-modules",level:4},{value:"Confirming Successful Registration of Sound Card Driver",id:"confirming-successful-registration-of-sound-card-driver",level:4},{value:"Using the Sound Card",id:"using-the-sound-card",level:4},{value:"Common Debugging Methods",id:"common-debugging-methods",level:3}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"audio-codec-adaptation-guide",children:"Audio Codec Adaptation Guide"})}),"\n",(0,r.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"This chapter primarily explains the concept of audio and provides instructions for debugging and adding sound card configurations."}),"\n",(0,r.jsx)(n.p,{children:"Related concepts:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DAI"}),": ",(0,r.jsx)(n.strong,{children:"Digital Audio Interface"})," refers to a digital audio interface."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CPU DAI"}),": The digital audio interface on the CPU side, which can be understood as the ",(0,r.jsx)(n.code,{children:"X3"}),"'s ",(0,r.jsx)(n.code,{children:"I2S"})," interface."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CODEC DAI"}),": Refers to the ",(0,r.jsx)(n.code,{children:"Codec"})," itself. It controls the workflow of the ",(0,r.jsx)(n.code,{children:"Codec"})," and can be simply understood as the driver for the ",(0,r.jsx)(n.code,{children:"Codec"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DAI LINK"}),": Binds the ",(0,r.jsx)(n.code,{children:"CPU DAI"})," and the ",(0,r.jsx)(n.code,{children:"CODEC DAI"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PLATFORM"}),": Specifies the platform driver on the CPU side, typically a ",(0,r.jsx)(n.code,{children:"DMA"})," driver."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"audio-development-instructions",children:"Audio Development Instructions"}),"\n",(0,r.jsxs)(n.p,{children:["A complete sound card configuration consists of ",(0,r.jsx)(n.code,{children:"CPU DAI"}),", ",(0,r.jsx)(n.code,{children:"CODEC DAI"}),", ",(0,r.jsx)(n.code,{children:"PLATFORM"}),", and ",(0,r.jsx)(n.code,{children:"DAI LINK"}),". These correspond respectively to the ",(0,r.jsx)(n.code,{children:"i2s"})," driver, the ",(0,r.jsx)(n.code,{children:"codec"})," driver, the ",(0,r.jsx)(n.code,{children:"dma"})," driver, and the sound card driver (e.g., ",(0,r.jsx)(n.code,{children:"source/kernel/sound/soc/hobot/hobot-snd-wm8960.c"}),"). This section uses the addition of a new ",(0,r.jsx)(n.strong,{children:"full-duplex stereo"})," ",(0,r.jsx)(n.code,{children:"Codec"})," \u2013 ",(0,r.jsx)(n.code,{children:"WM8960"})," as an example to demonstrate how to add a sound card."]}),"\n",(0,r.jsx)(n.h3,{id:"i2s-parameters",children:"I2S Parameters"}),"\n",(0,r.jsx)(n.p,{children:"The I2S on the X3 chip has the following characteristics:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Channel support: Supports ",(0,r.jsx)(n.code,{children:"1/2/4/8/16"})," channel inputs for audio input and ",(0,r.jsx)(n.code,{children:"1/2"})," channel outputs for audio output."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Sampling rate support: ",(0,r.jsx)(n.code,{children:"8k/16k/32k/48k/44.1k/64k"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Sampling precision support: ",(0,r.jsx)(n.code,{children:"8bit/16bit"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Transmission protocol support: ",(0,r.jsx)(n.code,{children:"i2s/dsp(TDM)A"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Default clock in I2S master mode: mclk is 12.288M bclk is 2.048M. Under the condition that mclk remains unchanged, bclk supports frequencies of 6.144M, 4.096M, 3.072M, 2.048M, and 1.536M, dynamically adjusted based on the parameters transmitted by the application layer. The frequency adjustment strategy is located in the hobot_i2s_sample_rate_set function within ",(0,r.jsx)(n.code,{children:"sound/soc/hobot/hobot-cpudai.c"}),". For supporting the 44.1k sampling rate, the closest achievable frequency without adjusting PLL is 44.11764kHz."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"When I2S operates in slave mode, before any read or write operations to I2S registers are performed, it is essential to have the bclk clock signal inputted; otherwise, accessing I2S module registers will result in exceptions, causing the system to malfunction."})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For the board-level ",(0,r.jsx)(n.code,{children:"RDM X3 Module"}),", there are additional restrictions:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Only clock signals (",(0,r.jsx)(n.code,{children:"BCLK"}),", ",(0,r.jsx)(n.code,{children:"LRCK"}),") for ",(0,r.jsx)(n.code,{children:"I2S0"})," are exposed, and the clock signals of ",(0,r.jsx)(n.code,{children:"I2S1"})," are shorted to the clock signals of ",(0,r.jsx)(n.code,{children:"I2S0"})," on the core board, meaning both share the same clock."]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{title:"Warning",type:"danger",children:(0,r.jsxs)(n.p,{children:["It is crucial to remember that when I2S operates as a ",(0,r.jsx)(n.strong,{children:"Slave"}),", ",(0,r.jsx)(n.strong,{children:"it is mandatory"})," to ensure the bclk signal is present before attempting to access any I2S-related registers on the ",(0,r.jsx)(n.strong,{children:"X3"})," side!"]})}),"\n",(0,r.jsx)(n.h3,{id:"adding-a-new-codec",children:"Adding a New Codec"}),"\n",(0,r.jsx)(n.h4,{id:"adding-codec-driver",children:"Adding codec driver"}),"\n",(0,r.jsxs)(n.p,{children:["After obtaining the ",(0,r.jsx)(n.code,{children:"Codec"})," driver code, copy it to the ",(0,r.jsx)(n.code,{children:"source/kernel/sound/soc/codecs/"})," directory."]}),"\n",(0,r.jsx)(n.h4,{id:"adding-build-options",children:"Adding build options"}),"\n",(0,r.jsxs)(n.p,{children:["Modify the ",(0,r.jsx)(n.code,{children:"Kconfig"})," and ",(0,r.jsx)(n.code,{children:"Makefile"})," files in the ",(0,r.jsx)(n.code,{children:"source/kernel/sound/soc/codecs/"})," directory to include the ",(0,r.jsx)(n.code,{children:"WM8960"})," driver in the driver compilation process."]}),"\n",(0,r.jsxs)(n.p,{children:["Add the following to ",(0,r.jsx)(n.code,{children:"Kconfig"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-makefile",children:'config SND_SOC_WM8960\n\ttristate "Wolfson Microelectronics WM8960 CODEC"\n\tdepends on I2C\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Add the following to ",(0,r.jsx)(n.code,{children:"Makefile"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-makefile",children:"snd-soc-wm8960-objs := wm8960.o\n"})}),"\n",(0,r.jsx)(n.h4,{id:"enabling-the-driver-in-kernel",children:"Enabling the driver in Kernel"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Device Drivers ---\x3e\n    <*> Sound card support ---\x3e\n        <*> Advanced Linux Sound Architecture ---\x3e\n            <*> ALSA for SoC audio support ---\x3e\n                CODEC drivers --\x3e\n                    [*] Wolfson Microelectronics WM8960 CODEC\n"})}),"\n",(0,r.jsx)(n.p,{children:"Save the kernel configuration."}),"\n",(0,r.jsx)(n.h3,{id:"modifying-dts-file",children:"Modifying dts File"}),"\n",(0,r.jsxs)(n.p,{children:["In the corresponding ",(0,r.jsx)(n.code,{children:"i2c"})," section, add ",(0,r.jsx)(n.code,{children:"codec"})," information. For instance, if ",(0,r.jsx)(n.code,{children:"WM8960"})," is connected to the ",(0,r.jsx)(n.code,{children:"i2c0"})," bus, add the following configuration under ",(0,r.jsx)(n.code,{children:"i2c0"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'&i2c0 {   \n        status = "okay";\n        #address-cells = <1>;\n        #size-cells = <0>;\n           \n        wm8960:wm8960@0x1a{\n            compatible = "wlf,wm8960";\n            reg = <0x1a>;\n            #sound-dai-cells = <0>;\n        }; \n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["In the ",(0,r.jsx)(n.code,{children:"dts"})," file, configure the sound card information required for the corresponding ",(0,r.jsx)(n.code,{children:"Codec"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"WM8960"})," is used in a setup with one master (playback) and one slave (record) on the ",(0,r.jsx)(n.code,{children:"RDK X3 Module"}),", with both ",(0,r.jsx)(n.code,{children:"I2S"})," instances sharing the same clock."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'&i2s0 {\n    status = "okay";\n    #sound-dai-cells = <0>;\n    clocks = <&i2s0_mclk>, <&i2s0_bclk>;\n    clock-names = "i2s-mclk", "i2s-bclk";\n    ms = <1>; // This attribute determines whether this i2s acts as master or slave, where 1 means master\n    share_clk = <1>;  // This attribute is required for the shared clock to take effect\n    bclk_set = <1536000>; // Duplex mode\n};\n\n&i2s1 {\n    status = "okay";\n    #sound-dai-cells = <0>;\n    clocks = <&i2s1_mclk>, <&i2s1_bclk>;\n    clock-names = "i2s-mclk", "i2s-bclk";\n    ms = <4>; // This attribute determines whether this i2s acts as master or slave, where 4 means slave\n    share_clk = <1>; // This attribute is required for the shared clock to take effect\n    bclk_set = <1536000>;\n};\n\n\n\n&snd6 {\n    status = "okay";\n    model = "hobotsnd6"; // Sound card name\n    work_mode = <0>; /*0: simple mode; 1: duplex mode*/\n    dai-link@0 {\n        dai-format = "i2s"; // Operation mode\n        // bitclock-master; // Slave mode, does not send bclk\n        // frame-master; // Slave mode, does not send lrck\n        //frame-inversion; // Clock polarity\n        link-name = "hobotdailink0";\n        cpu {\n            sound-dai = <&i2s1>; // The i2s bound to this path, determined based on your hardware configuration\n        };\n        codec {\n            sound-dai = <&wm8960>; // Corresponding to the name set earlier for i2c0\n        };\n        platform {\n            sound-dai = <&i2sidma1>; // Corresponding to sound-dai, using i2sidma1 when using i2s1\n        };\n    };\n    dai-link@1 {\n        dai-format = "i2s"; // Operation mode\n        bitclock-master; // Master mode, sends bclk\n        frame-master; // Master mode, sends lrck\n        //frame-inversion;\n        link-name = "hobotdailink1";\n        cpu {\n            sound-dai = <&i2s0>; // The i2s bound to this path, determined based on your hardware configuration\n        };\n        codec {\n            sound-dai = <&wm8960>; // Corresponding to the name set earlier for i2c0\n        };\n        platform {\n            sound-dai = <&i2sidma0>; // Corresponding to sound-dai, using i2sidma0 when using i2s0\n        };\n    };\n};\n'})}),"\n",(0,r.jsx)(n.h3,{id:"writing-dai-link-driver",children:"Writing DAI LINK Driver"}),"\n",(0,r.jsxs)(n.p,{children:["This part of the driver is quite generic, and you can refer to ",(0,r.jsx)(n.code,{children:"source/kernel/sound/soc/hobot/hobot-snd-wm8960.c"})," for guidance when writing it. Be sure to match your implementation with the device tree configuration."]}),"\n",(0,r.jsxs)(n.p,{children:["After completing the driver, add it to both the ",(0,r.jsx)(n.code,{children:"Makefile"})," and ",(0,r.jsx)(n.code,{children:"Kconfig"}),", and then include this driver in the kernel build process to generate the complete driver module."]}),"\n",(0,r.jsx)(n.h2,{id:"debugging-instructions",children:"Debugging Instructions"}),"\n",(0,r.jsx)(n.h3,{id:"sound-card-debugging",children:"Sound Card Debugging"}),"\n",(0,r.jsx)(n.h4,{id:"loading-driver-modules",children:"Loading Driver Modules"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"modprobe snd-soc-wm8960\nmodprobe hobot-i2s-dma\nmodprobe hobot-cpudai\nmodprobe hobot-snd-wm8960\n"})}),"\n",(0,r.jsx)(n.h4,{id:"confirming-successful-registration-of-sound-card-driver",children:"Confirming Successful Registration of Sound Card Driver"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"root@ubuntu:~# cat /proc/asound/cards\n0 [hobotsnd6      ]: hobotsnd6 - hobotsnd6\n                     hobotsnd6\nroot@ubuntu:~# ls -l /dev/snd/\ntotal 0\ndrwxr-xr-x  2 root root       60 Mar 28 01:54 by-path\ncrw-rw----+ 1 root audio 116,  2 Mar 28 01:54 controlC0\ncrw-rw----+ 1 root audio 116,  4 Mar 28 01:54 pcmC0D0c\ncrw-rw----+ 1 root audio 116,  3 Mar 28 01:54 pcmC0D0p\ncrw-rw----+ 1 root audio 116,  6 Mar 28 01:54 pcmC0D1c\ncrw-rw----+ 1 root audio 116,  5 Mar 28 01:54 pcmC0D1p\ncrw-rw----+ 1 root audio 116, 33 Mar 28 01:54 timer\n"})}),"\n",(0,r.jsx)(n.h4,{id:"using-the-sound-card",children:"Using the Sound Card"}),"\n",(0,r.jsxs)(n.p,{children:["Please refer to ",(0,r.jsx)(n.a,{href:"../../../03_Basic_Application/02_audio/audio_board_x3.md",children:"Audio Adapter Board Usage"})," for instructions."]}),"\n",(0,r.jsx)(n.h3,{id:"common-debugging-methods",children:"Common Debugging Methods"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Check ",(0,r.jsx)(n.code,{children:"i2s"})," registers. When recording or playback fails, it's usually necessary to first examine whether the register configuration is correct to identify the problem."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["View ",(0,r.jsx)(n.code,{children:"i2s0"})," register configuration:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cat /sys/devices/platform/soc/a5007000.i2s/reg_dump\n"})}),"\n",(0,r.jsxs)(n.p,{children:["View ",(0,r.jsx)(n.code,{children:"i2s1"})," register configuration:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cat /sys/devices/platform/soc/a5008000.i2s/reg_dump\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Check ",(0,r.jsx)(n.code,{children:"codec"})," register configurations. Please consult your supplier for the relevant method."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Use an oscilloscope to measure audio signals including ",(0,r.jsx)(n.code,{children:"mclk/bclk/lrck/data"}),". Confirm that the clock signal frequencies ",(0,r.jsx)(n.code,{children:"bclk/lrck"})," match the configured sample rate. If they do not match, audio may play back too fast or slow."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);