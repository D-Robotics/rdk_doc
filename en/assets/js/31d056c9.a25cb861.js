"use strict";(self.webpackChunkrdk_doc=self.webpackChunkrdk_doc||[]).push([[49882],{28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>t});var s=i(96540);const o={},r=s.createContext(o);function d(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:d(e.components),s.createElement(r.Provider,{value:n},e.children)}},93256:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>a,frontMatter:()=>d,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Advanced_development/linux_development/driver_development_s100/driver_gpio_dev","title":"GPIO Usage","description":"The S100 Acore chip contains three sys GPIO devices: peri, cam, and video. Each device supports up to 32 GPIO pins, and every GPIO pin supports interrupts.","source":"@site/i18n/en/docusaurus-plugin-content-docs-docs_s/current/07_Advanced_development/02_linux_development/04_driver_development_s100/04_driver_gpio_dev.md","sourceDirName":"07_Advanced_development/02_linux_development/04_driver_development_s100","slug":"/Advanced_development/linux_development/driver_development_s100/driver_gpio_dev","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/driver_development_s100/driver_gpio_dev","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1764750792000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"I2C Debugging Guide","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/driver_development_s100/driver_i2c_dev"},"next":{"title":"Pinctrl Debugging Guide","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/driver_development_s100/driver_pinctrl_dev"}}');var o=i(74848),r=i(28453);const d={sidebar_position:4},t="GPIO Usage",l={},c=[{value:"Driver Code",id:"driver-code",level:2},{value:"Kernel Configuration",id:"kernel-configuration",level:3},{value:"Kernel DTS Configuration",id:"kernel-dts-configuration",level:3},{value:"GPIO Usage",id:"gpio-usage-1",level:2},{value:"Kernel Space",id:"kernel-space",level:3},{value:"DTS Configuration",id:"dts-configuration",level:4},{value:"Driver Code APIs",id:"driver-code-apis",level:4},{value:"User Space",id:"user-space",level:3},{value:"Control Interface",id:"control-interface",level:4},{value:"sysfs Interface Overview",id:"sysfs-interface-overview",level:3},{value:"export &amp; unexport",id:"export--unexport",level:4},{value:"direction",id:"direction",level:4},{value:"value",id:"value",level:4},{value:"edge",id:"edge",level:4},{value:"Debugging",id:"debugging",level:2},{value:"Determining gpio-index",id:"determining-gpio-index",level:3},{value:"Check drobot-s100-pinctrl.dtsi to obtain offset and base",id:"check-drobot-s100-pinctrldtsi-to-obtain-offset-and-base",level:3}];function p(e){const n={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"gpio-usage",children:"GPIO Usage"})}),"\n",(0,o.jsx)(n.p,{children:"The S100 Acore chip contains three sys GPIO devices: peri, cam, and video. Each device supports up to 32 GPIO pins, and every GPIO pin supports interrupts."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/02_linux_development/driver_development_s100/gpio_devs.png",alt:"gpio_devs"})}),"\n",(0,o.jsx)(n.h2,{id:"driver-code",children:"Driver Code"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kernel/drivers/gpio/gpio-dwapb.c # GPIO driver source file\n"})}),"\n",(0,o.jsx)(n.h3,{id:"kernel-configuration",children:"Kernel Configuration"}),"\n",(0,o.jsx)(n.p,{children:"GPIO_DWAPB"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/02_linux_development/driver_development_x5/GPIO_MENUCONFIG.png",alt:"image-GPIO_MENUCONFIG"})}),"\n",(0,o.jsx)(n.h3,{id:"kernel-dts-configuration",children:"Kernel DTS Configuration"}),"\n",(0,o.jsxs)(n.p,{children:["The device tree definition for the S100 GPIO controller is located in the file ",(0,o.jsx)(n.code,{children:"arch/arm64/boot/dts/hobot/drobot-s100-soc.dtsi"})," within the kernel folder of the SDK package."]}),"\n",(0,o.jsx)(n.admonition,{title:"Note",type:"info",children:(0,o.jsxs)(n.p,{children:["Nodes in ",(0,o.jsx)(n.code,{children:"s100.dtsi"})," primarily declare SoC-wide features and are independent of specific circuit boards. They generally do not require modification."]})}),"\n",(0,o.jsx)(n.h2,{id:"gpio-usage-1",children:"GPIO Usage"}),"\n",(0,o.jsx)(n.h3,{id:"kernel-space",children:"Kernel Space"}),"\n",(0,o.jsx)(n.h4,{id:"dts-configuration",children:"DTS Configuration"}),"\n",(0,o.jsxs)(n.p,{children:["GPIO configurations for all S100 pins are defined in the file ",(0,o.jsx)(n.code,{children:"arch/arm64/boot/dts/hobot/drobot-s100-soc.dtsi"})," within the kernel folder of the SDK package."]}),"\n",(0,o.jsx)(n.p,{children:"When users need to configure a specific pin as a GPIO, they can directly reference the predefined GPIO configurations:"}),"\n",(0,o.jsxs)(n.p,{children:["Device tree node properties for GPIO are typically named as ",(0,o.jsx)(n.code,{children:"<names>-gpios"})," or ",(0,o.jsx)(n.code,{children:"<names>-gpio"}),". For example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-c",children:"/**\n* peri_port0 represents the first GPIO device of the peri sys.\n* The following device node defines four GPIO pins:\n*       Pin 16 (0-based) of the first GPIO device in peri sys\n*       Pin 17 (0-based) of the second GPIO device in peri sys\n*       Pin 28 (0-based) of the first GPIO device in cam sys\n*       Pin 18 (0-based) of the first GPIO device in video sys\n* GPIO_ACTIVE_HIGH indicates active-high logic, typically set to GPIO_ACTIVE_HIGH.\n*/\ngpio-test {\n        test-gpios = <&peri_port0 16 GPIO_ACTIVE_HIGH\n                      &peri_port1 17 GPIO_ACTIVE_HIGH\n                      &cam_port0 28 GPIO_ACTIVE_HIGH\n                      &video_port0 18 GPIO_ACTIVE_HIGH>;\n};\n"})}),"\n",(0,o.jsx)(n.h4,{id:"driver-code-apis",children:"Driver Code APIs"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-c",children:"/* include/linux/gpio.h */\n/* Request a GPIO */\nint gpio_request(unsigned gpio, const char *label);\n/* Initialize GPIO as output and set its output level */\nint gpio_direction_output(unsigned gpio, int value);\n/* Initialize GPIO as input */\nint gpio_direction_input(unsigned gpio);\n/* Read the GPIO level */\nint gpio_get_value(unsigned int gpio);\n/* Set the GPIO level */\nvoid gpio_set_value(unsigned int gpio, int value);\n/* Release the GPIO */\nvoid gpio_free(unsigned gpio);\n/* Request a GPIO interrupt; the returned value can be passed to request_irq and free_irq */\nint gpio_to_irq(unsigned int gpio);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"user-space",children:"User Space"}),"\n",(0,o.jsx)(n.h4,{id:"control-interface",children:"Control Interface"}),"\n",(0,o.jsxs)(n.p,{children:["In user space, GPIO operations can be performed via the ",(0,o.jsx)(n.code,{children:"/sys/class/gpio"})," sysfs interface."]}),"\n",(0,o.jsx)(n.p,{children:"The following nodes exist under the sysfs directory:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"# Request a GPIO\necho <gpio_num> > /sys/class/gpio/export\n# Release a GPIO\necho <gpio_num> > /sys/class/gpio/unexport\n# Set GPIO as output\n# When direction is set to 'out', writing 1/0 to 'value' sets high/low level respectively.\necho out > /sys/class/gpio/gpio<gpio_num>/direction\n# Set high level\necho 1 > /sys/class/gpio/gpio<gpio_num>/value\n# Set low level\necho 0 > /sys/class/gpio/gpio<gpio_num>/value\n\n# Set GPIO as input; when direction is 'in', reading 'value' returns the input level (0 = low, 1 = high).\necho in > /sys/class/gpio/gpio<gpio_num>/direction\n# Read the external GPIO value\ncat /sys/class/gpio/gpio<gpio_num>/value\n\n\n# View GPIO debug information\ncat /sys/kernel/debug/gpio\n\n# View the relationship between GPIO and pinctrl\n# Shows the mapping between system pins and GPIO numbers\ncat /sys/kernel/debug/pinctrl/<pinctrl_dev>/gpio-ranges\n"})}),"\n",(0,o.jsx)(n.h3,{id:"sysfs-interface-overview",children:"sysfs Interface Overview"}),"\n",(0,o.jsx)(n.h4,{id:"export--unexport",children:"export & unexport"}),"\n",(0,o.jsxs)(n.p,{children:["The nodes ",(0,o.jsx)(n.code,{children:"/sys/class/gpio/export"})," and ",(0,o.jsx)(n.code,{children:"/sys/class/gpio/unexport"})," are write-only."]}),"\n",(0,o.jsx)(n.p,{children:"User programs request kernel to export control of a specific GPIO to user space by writing the GPIO number, provided that no kernel code has already claimed this GPIO. For example, to request GPIO number 480:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"echo 480 > export\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This operation creates a directory named ",(0,o.jsx)(n.code,{children:"gpio480"})," under ",(0,o.jsx)(n.code,{children:"/sys/class/gpio"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"/sys/class/gpio/unexport"})," performs the opposite action. For example, to remove the ",(0,o.jsx)(n.code,{children:"gpio480"})," node:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"echo 480 > unexport # This removes the gpio480 node and releases GPIO number 480.\n"})}),"\n",(0,o.jsx)(n.h4,{id:"direction",children:"direction"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"direction"})," file indicates the GPIO direction. Reading it returns either ",(0,o.jsx)(n.code,{children:"in"})," or ",(0,o.jsx)(n.code,{children:"out"}),". Writing ",(0,o.jsx)(n.code,{children:"out"})," configures the GPIO as an output; writing ",(0,o.jsx)(n.code,{children:"in"})," configures it as an input."]}),"\n",(0,o.jsx)(n.h4,{id:"value",children:"value"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["When direction is set to ",(0,o.jsx)(n.code,{children:"in"}),", reading ",(0,o.jsx)(n.code,{children:"value"})," returns the input level (0 = low, 1 = high)."]}),"\n",(0,o.jsxs)(n.li,{children:["When direction is set to ",(0,o.jsx)(n.code,{children:"out"}),", writing ",(0,o.jsx)(n.code,{children:"1"})," or ",(0,o.jsx)(n.code,{children:"0"})," to ",(0,o.jsx)(n.code,{children:"value"})," sets the output to high or low level, respectively."]}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"edge",children:"edge"}),"\n",(0,o.jsxs)(n.p,{children:["To configure interrupts from user space, set ",(0,o.jsx)(n.code,{children:"direction"})," to ",(0,o.jsx)(n.code,{children:"in"}),", then write an appropriate value to the ",(0,o.jsx)(n.code,{children:"edge"})," file."]}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.th,{children:["Value of ",(0,o.jsx)(n.code,{children:"edge"})]}),(0,o.jsx)(n.th,{children:"Meaning"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"none"}),(0,o.jsx)(n.td,{children:"Pin is configured as input but not as an interrupt pin"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"rising"}),(0,o.jsx)(n.td,{children:"Pin is an interrupt input triggered on rising edge"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"falling"}),(0,o.jsx)(n.td,{children:"Pin is an interrupt input triggered on falling edge"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"both"}),(0,o.jsx)(n.td,{children:"Pin is an interrupt input triggered on both edges"})]})]})]}),"\n",(0,o.jsx)(n.h2,{id:"debugging",children:"Debugging"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"cat /sys/kernel/debug/gpio\n"})}),"\n",(0,o.jsx)(n.p,{children:"Querying this node provides information about currently used GPIOs and their states (in, out, IRQ)."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"root@ubuntu:~# cat /sys/kernel/debug/gpio\ngpiochip4: GPIOs 423-438, parent: i2c/3-0076, 3-0076, can sleep:\ngpio-423 (                    |io-ser-reset0       ) out hi\ngpio-424 (                    |io-ser-reset1       ) out hi\ngpio-425 (                    |io-ser-reset2       ) out hi\ngpio-426 (                    |io-ser-reset3       ) out hi\n\ngpiochip3: GPIOs 439-455, parent: platform/360b0000.gpio, 360b0000.gpio:\n\ngpiochip2: GPIOs 456-473, parent: platform/370f5000.gpio, 370f5000.gpio:\n\ngpiochip1: GPIOs 474-479, parent: platform/39500000.gpio, 39500000.gpio:\n\ngpiochip0: GPIOs 480-511, parent: platform/394f0000.gpio, 394f0000.gpio:\ngpio-481 (                    |sysfs               ) out hi ACTIVE LOW\ngpio-491 (                    |sysfs               ) in  hi\ngpio-495 (                    |sysfs               ) in  hi\ngpio-496 (                    |sysfs               ) in  hi\ngpio-498 (                    |sysfs               ) in  hi\ngpio-503 (                    |io-ext-reset        ) out lo\nroot@ubuntu:~#\n"})}),"\n",(0,o.jsx)(n.h3,{id:"determining-gpio-index",children:"Determining gpio-index"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"kernel_index = base + offset"}),", where ",(0,o.jsx)(n.code,{children:"base"})," is obtained from ",(0,o.jsx)(n.code,{children:"/sys/class/gpio"})," or ",(0,o.jsx)(n.code,{children:"/sys/kernel/debug/gpio"}),", and ",(0,o.jsx)(n.code,{children:"offset"})," is obtained from the DTS."]}),"\n",(0,o.jsxs)(n.p,{children:["Take pin ",(0,o.jsx)(n.code,{children:"sensor8_err"})," as an example: by examining ",(0,o.jsx)(n.code,{children:"drobot-s100-pinctrl.dtsi"}),", we find that ",(0,o.jsx)(n.code,{children:"sensor8_err"})," corresponds to GPIO chip ",(0,o.jsx)(n.code,{children:"video_port0: gpio@360b0000"})," with an offset of 13.",(0,o.jsx)(n.br,{}),"\n","Checking ",(0,o.jsx)(n.code,{children:"/sys/kernel/debug/gpio"}),", we see that ",(0,o.jsx)(n.code,{children:"video_port0: gpio@360b0000"})," has a base of 439.",(0,o.jsx)(n.br,{}),"\n","Thus, the kernel GPIO index for ",(0,o.jsx)(n.code,{children:"sensor8_err"})," is: 439 + 13 = 452."]}),"\n",(0,o.jsx)(n.h3,{id:"check-drobot-s100-pinctrldtsi-to-obtain-offset-and-base",children:"Check drobot-s100-pinctrl.dtsi to obtain offset and base"}),"\n",(0,o.jsxs)(n.p,{children:["From the device tree below, we can see that ",(0,o.jsx)(n.code,{children:"sensor8_err"})," corresponds to ",(0,o.jsx)(n.code,{children:"video_sensor8_err"}),", and its associated GPIO chip is ",(0,o.jsx)(n.code,{children:'"video_port0: gpio@360b0000"'}),".The offset of ",(0,o.jsx)(n.code,{children:"video_gnss_int"})," is 0, and offsets increment sequentially; therefore, the offset of ",(0,o.jsx)(n.code,{children:"video_sensor8_err"})," is 13."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:'pinctrl_video: pinctrl@36090000 {\n   compatible = "drobot,s100-pinctrl";\n   reg = <0x0 0x36090000 0x0 0x1000>,\n         <0x0 0x360a0000 0x0 0x1000>;\n   pctldev-name = "video";\n   status = "okay";\n\n   video_gpio: video_gpio_func {\n      pinmux {\n         function = "video_gpio";\n         pins = "video_gnss_int", "video_peri_rsto",\n                  "video_cam_pint", "video_sd_1v8", "video_sd_bus_pow",\n                  "video_sensor0_err", "video_sensor1_err",\n                  "video_sensor2_err", "video_sensor3_err", "video_sensor4_err",\n                  "video_sensor5_err", "video_sensor6_err",\n                  "video_sensor7_err", "video_sensor8_err",\n                  "video_sensor9_err", "video_sensor10_err", "video_sensor11_err";\n      };\n      pinconf {\n         pins = "video_gnss_int", "video_peri_rsto",\n                  "video_cam_pint", "video_sd_1v8", "video_sd_bus_pow",\n                  "video_sensor0_err", "video_sensor1_err",\n                  "video_sensor2_err", "video_sensor3_err", "video_sensor4_err",\n                  "video_sensor5_err", "video_sensor6_err",\n                  "video_sensor7_err", "video_sensor8_err",\n                  "video_sensor9_err", "video_sensor10_err", "video_sensor11_err";\n         drive-strength = <1>;\n      };\n   };\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["For example, in this line: gpiochip3: GPIOs 439-455, parent: platform/360b0000.gpio,",(0,o.jsx)(n.br,{}),"\n",'360b0000.gpio:"GPIOs 439-455" indicates that the base is 439.']}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"cat /sys/kernel/debug/gpio\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-{.shell}",children:"root@ubuntu:~# cat /sys/kernel/debug/gpio\ngpiochip4: GPIOs 423-438, parent: i2c/3-0076, 3-0076, can sleep:\ngpio-423 (                    |io-ser-reset0       ) out hi\ngpio-424 (                    |io-ser-reset1       ) out hi\ngpio-425 (                    |io-ser-reset2       ) out hi\ngpio-426 (                    |io-ser-reset3       ) out hi\n\ngpiochip3: GPIOs 439-455, parent: platform/360b0000.gpio, 360b0000.gpio:\n\ngpiochip2: GPIOs 456-473, parent: platform/370f5000.gpio, 370f5000.gpio:\ngpio-464 (                    |scl                 ) out lo\ngpio-465 (                    |sda                 ) in  lo\ngpio-466 (                    |scl                 ) out lo\ngpio-467 (                    |sda                 ) in  lo\ngpio-468 (                    |scl                 ) out lo\ngpio-469 (                    |sda                 ) in  lo\ngpio-470 (                    |scl                 ) out lo\ngpio-471 (                    |sda                 ) in  lo\ngpio-472 (                    |scl                 ) out lo\ngpio-473 (                    |sda                 ) in  lo\n\ngpiochip1: GPIOs 474-479, parent: platform/39500000.gpio, 39500000.gpio:\n\ngpiochip0: GPIOs 480-511, parent: platform/394f0000.gpio, 394f0000.gpio:\ngpio-495 (                    |scl                 ) out lo\ngpio-496 (                    |sda                 ) in  lo\ngpio-503 (                    |io-ext-reset        ) out lo\n"})})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}}}]);