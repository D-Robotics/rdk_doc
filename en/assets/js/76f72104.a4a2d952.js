"use strict";(self.webpackChunkrdk_doc=self.webpackChunkrdk_doc||[]).push([[43474],{28453:(e,s,t)=>{t.d(s,{R:()=>a,x:()=>d});var n=t(96540);const i={},r=n.createContext(i);function a(e){const s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:s},e.children)}},68454:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>o,contentTitle:()=>d,default:()=>p,frontMatter:()=>a,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"Advanced_development/linux_development/hardware_unit_test/spi_stress","title":"SPI Stress Test","description":"Test Principle","source":"@site/i18n/en/docusaurus-plugin-content-docs-docs_s/current/07_Advanced_development/02_linux_development/05_hardware_unit_test/04-spi_stress.md","sourceDirName":"07_Advanced_development/02_linux_development/05_hardware_unit_test","slug":"/Advanced_development/linux_development/hardware_unit_test/spi_stress","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/hardware_unit_test/spi_stress","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1764174115000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"UART Stress Test","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/hardware_unit_test/uart_stress"},"next":{"title":"Wi-Fi Performance Testing","permalink":"/rdk_doc/en/rdk_s/Advanced_development/linux_development/hardware_unit_test/wifi_performance"}}');var i=t(74848),r=t(28453);const a={sidebar_position:4},d="SPI Stress Test",o={},c=[{value:"Test Principle",id:"test-principle",level:2},{value:"Test Content",id:"test-content",level:3},{value:"Preparation",id:"preparation",level:2},{value:"<span></span> Stress Test Script Usage Instructions",id:"-stress-test-script-usage-instructions",level:3},{value:"Test Procedure",id:"test-procedure",level:2},{value:"Test Metrics",id:"test-metrics",level:2},{value:"SPI Stress Test Results",id:"spi-stress-test-results",level:3},{value:"Notes",id:"notes",level:3},{value:"SPI Internal Loopback Test",id:"spi-internal-loopback-test",level:4},{value:"SPI External Loopback Test",id:"spi-external-loopback-test",level:4}];function l(e){const s={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"spi-stress-test",children:"SPI Stress Test"})}),"\n",(0,i.jsx)(s.h2,{id:"test-principle",children:"Test Principle"}),"\n",(0,i.jsxs)(s.p,{children:["The SPI bus test tool (",(0,i.jsx)(s.code,{children:"spidev_tc"}),") is used to verify the basic functionality and performance of SPI devices. It simulates high-load conditions by configuring various parameters to evaluate key performance metrics such as SPI bus stability, throughput, latency, and error rate."]}),"\n",(0,i.jsx)(s.h3,{id:"test-content",children:"Test Content"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"1. Test Procedure:"}),(0,i.jsx)(s.br,{}),"\n","The core of the SPI stress test involves loopback testing for data transmission and reception. The main logic is reflected in the source code as follows:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Data Transfer Test"}),": The functions ",(0,i.jsx)(s.code,{children:"transfer_buf"})," and ",(0,i.jsx)(s.code,{children:"transfer_read_write"})," are used to perform pure data transmission, reading, and verification. The packet length is controlled by the ",(0,i.jsx)(s.code,{children:"transfer_size"})," parameter, and the test runs repeatedly for a number of iterations (controlled by ",(0,i.jsx)(s.code,{children:"iterations"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Throughput and Rate Calculation"}),": Global variables ",(0,i.jsx)(s.code,{children:"_read_count"})," and ",(0,i.jsx)(s.code,{children:"_write_count"})," record the number of bytes read and written, respectively. The transfer rate is periodically calculated and printed. The function ",(0,i.jsx)(s.code,{children:"show_transfer_rate"})," computes and outputs the throughput (in kbps)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Transfer Mode Switching"}),": By varying SPI mode, bit width, and speed parameters, the tool tests SPI device performance under different conditions. For example, users can adjust the data buffer size or SPI bus speed (",(0,i.jsx)(s.code,{children:"speed"}),") to evaluate device stability and performance under varying loads."]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"2. Command Parsing:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Test Command"}),":",(0,i.jsx)(s.br,{}),"\n",(0,i.jsx)(s.code,{children:'$\\{script_dir}/spidev_tc" -D "$Device" -s "$spi_speed" -I "$StressCount" -e 3 -S 32 > "$spi_test_log_file" 2>&1'})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Parameter Explanation"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:'-D "$Device"'}),": Specifies the SPI device file to operate on (e.g., ",(0,i.jsx)(s.code,{children:"/dev/spidev2.0"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:'-s "$spi_speed"'}),": Sets the SPI bus communication speed in Hertz (Hz)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:'-I "$StressCount"'}),": Specifies the number of test iterations."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-e 3"}),": Specifies the test mode or type. The number following ",(0,i.jsx)(s.code,{children:"-e"})," usually indicates different test types; for example, ",(0,i.jsx)(s.code,{children:"3"})," in the script represents loopback testing."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-S 32"}),": Specifies the data size per transfer in bytes."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:'> "$spi_test_log_file" 2>&1'}),": Redirects command output.","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:'> "$spi_test_log_file"'}),": Redirects standard output (",(0,i.jsx)(s.code,{children:"stdout"}),") to the specified log file (",(0,i.jsx)(s.code,{children:"$spi_test_log_file"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"2>&1"}),": Redirects standard error (",(0,i.jsx)(s.code,{children:"stderr"}),") to the same log file, ensuring all output (including error messages) is captured."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"preparation",children:"Preparation"}),"\n",(0,i.jsxs)(s.h3,{id:"-stress-test-script-usage-instructions",children:[(0,i.jsx)("span",{id:"test-script-user-manual"})," Stress Test Script Usage Instructions"]}),"\n",(0,i.jsxs)(s.p,{children:["The serial stress test script supports the ",(0,i.jsx)(s.code,{children:"-h"})," suffix to display command parameter descriptions. For example:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"sunrise@ubuntu:/app/chip_base_test/04_spi_test# ./spistress.sh -h\nUsage: ./spistress.sh [options]\n\nOptions:\n  -d <device>      Set the SPI device to test (default: /dev/spidev0.0).\n  -c <count>       Set the stress test count (default: 100).\n  -s <speed>       Set the SPI speed in Hz (default: 12000000).\n  -o <directory>   Set the output directory for logs (default: '../log').\n  -h               Show this help message and exit.\n"})}),"\n",(0,i.jsx)(s.p,{children:"Parameter details:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-d <device>"}),": Specifies the SPI device to test. Default path is ",(0,i.jsx)(s.code,{children:"/dev/spidev0.0"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-c <count>"}),": Sets the number of stress test iterations."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-s <speed>"}),": Sets the SPI speed in Hz. Default value is 12000000 (i.e., 12 MHz)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-o <directory>"}),": Sets the log output directory. Default is ",(0,i.jsx)(s.code,{children:"../log"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Example:"}),(0,i.jsx)(s.br,{}),"\n","For instance, the command:",(0,i.jsx)(s.br,{}),"\n",(0,i.jsx)(s.code,{children:"./spistress.sh -d /dev/spidev0.0 -c 500 -s 24000000 -o /userdata/spi_test_logs"}),(0,i.jsx)(s.br,{}),"\n","customizes the test for SPI device ",(0,i.jsx)(s.code,{children:"/dev/spidev0.0"}),", sets the transfer speed to 24 MHz, runs 500 iterations, and saves logs to ",(0,i.jsx)(s.code,{children:"/app/chip_base_test"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["Detailed parameters and command explanations from the ",(0,i.jsx)(s.code,{children:"spidev_tc"})," source code are as follows:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:'-D --device: Specify the SPI device to use.\n-s, --speed: Set maximum speed (Hz).\n-d, --delay: Set delay (microseconds).\n-b, --bpw: Set bits per word.\n-i, --input: Input data from a file (e.g., "test.bin").\n-o, --output: Output data to a file (e.g., "results.bin").\n-l, --loop: Enable loopback test.\n-H, --cpha: Clock phase.\n-O, --cpol: Clock polarity.\n-L, --lsb: Least significant bit first.\n-C, --cs-high: Chip select active high.\n-3, --3wire: Shared SI/SO signal.\n-v, --verbose: Verbose mode (display transmit buffer).\n-p : Send data (e.g., "1234\\xde\\xad").\n-N, --no-cs: Disable chip select.\n-R, --ready: Slave pulls low to pause.\n-2, --dual: Dual-line transfer.\n-4, --quad: Quad-line transfer.\n-S, --size: Specify test data size (bytes).\n-I, --iter: Number of iterations; defaults to infinite loop when `-e` extended test mode is set.\n-e, --mode: Specify test mode: 1=read, 2=write, 3=read and write.\n-h, --help: Display help information.\n'})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"1."})," Refer to the RDK_S100 schematic to locate the pins and connector positions for SPI0_MOSI and SPI0_MISO, as shown below:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/Spi_Schematic_diagram.png",alt:"Spi_Schematic_diagram"})}),"\n",(0,i.jsx)(s.p,{children:"Then, connect SPI0_MOSI and SPI0_MISO using a female-to-female Dupont jumper wire, as illustrated:"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/Spi_Connection_diagram.png",alt:"Spi_Connection_diagram"})}),"\n",(0,i.jsx)(s.admonition,{title:"Note",type:"caution",children:(0,i.jsxs)(s.p,{children:["The RDKS100 Acore supports two SPI interfaces, and both SPI0 and SPI1 can only operate as SPI Masters.",(0,i.jsx)(s.br,{}),"\n","Internal SPI loopback testing is only supported in SPI Master mode. The principle is that the SPI hardware IP\u2019s TX FIFO sends data directly to the RX FIFO, forming a loopback."]})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"3."})," Confirm that the files ",(0,i.jsx)(s.code,{children:"spistress.sh"}),", ",(0,i.jsx)(s.code,{children:"spidev_tc.c"}),", and ",(0,i.jsx)(s.code,{children:"spidev_tc"})," exist either in the SDK path ",(0,i.jsx)(s.code,{children:"/app/chip_base_test/04_spi_test"})," or on the board at ",(0,i.jsx)(s.code,{children:"sunrise@ubuntu:/app/chip_base_test/04_spi_test#"}),"."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"(base) root@//app/chip_base_test/04_spi_test# tree\n.\n\u251c\u2500\u2500 spidev_tc\n\u251c\u2500\u2500 spidev_tc.c\n\u2514\u2500\u2500 spistress.sh\n"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"4."})," If users need to customize test modes or features, it is recommended to rebuild the executable in the SDK compilation environment using the following command:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"gcc -o spidev_tc spidev_tc.c\n"})}),"\n",(0,i.jsx)(s.h2,{id:"test-procedure",children:"Test Procedure"}),"\n",(0,i.jsx)(s.p,{children:"After completing the preparations, run the test command:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"./spistress.sh\n"})}),"\n",(0,i.jsx)(s.p,{children:"After running for a while, the log output appears as follows:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"sunrise@ubuntu:/app/chip_base_test/04_spi_test# ./spistress.sh\nSPI test starting...\nTest configuration:\n  Device: /dev/spidev0.0\n  Stress Count: 100\n  SPI Speed: 12000000 Hz\n  Output Directory: /app/chip_base_test/log\n  Log file: /app/chip_base_test/log/spi_test_log3.txt\nSPI test completed successfully! Log saved to: /app/chip_base_test/log/spi_test_log1.txt\n"})}),"\n",(0,i.jsxs)(s.p,{children:["If no additional information appears in the console output, check the log file ",(0,i.jsx)(s.code,{children:"spi_test_log1.txt"})," directly under ",(0,i.jsx)(s.code,{children:"/app/chip_base_test/log/"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"sunrise@ubuntu:/app/chip_base_test# cat log/spi_test_log1.txt\nspi mode: 0x0\nbits per word: 8\nmax speed: 12000000 Hz (12000 kHz)\nUserspace spi read and write test, test_len=32 iterations=100\nTest times: 0 Data verification Successful\nTest times: 1 Data verification Successful\nTest times: 2 Data verification Successful\nTest times: 3 Data verification Successful\n.....\nTest times: 98 Data verification Successful\nTest times: 99 Data verification Successful\n"})}),"\n",(0,i.jsx)(s.h2,{id:"test-metrics",children:"Test Metrics"}),"\n",(0,i.jsxs)(s.p,{children:["After the test program starts, the following files are generated in the ",(0,i.jsx)(s.code,{children:"/app/chip_base_test/log/"})," directory:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"spi_test_log*.txt"}),": Records printed messages and current status during stress testing."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["The test objective is to ensure the system can run stably for 48 hours without rebooting or hanging. To verify stability during testing, use the following command to check for abnormal keywords such as ",(0,i.jsx)(s.code,{children:"fail"}),", ",(0,i.jsx)(s.code,{children:"error"}),", or ",(0,i.jsx)(s.code,{children:"timeout"})," in the log files:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"cd \"/app/chip_base_test/log/\" && grep -iE 'error|fail|timeout' spi_test_log*.txt\n"})}),"\n",(0,i.jsx)(s.h3,{id:"spi-stress-test-results",children:"SPI Stress Test Results"}),"\n",(0,i.jsx)(s.p,{children:"After the test script completes, inspect the log files. If no abnormal status messages appear, the stress test passes."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"Test times: 97 Data verification Successful\nTest times: 98 Data verification Successful\nTest times: 99 Data verification Successful\n"})}),"\n",(0,i.jsx)(s.h3,{id:"notes",children:"Notes"}),"\n",(0,i.jsx)(s.h4,{id:"spi-internal-loopback-test",children:"SPI Internal Loopback Test"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"1."})," For internal SPI loopback testing, simply modify the ",(0,i.jsx)(s.code,{children:"-e"})," parameter in the script ",(0,i.jsx)(s.code,{children:"./spistress.sh"})," to select a different test mode. For example, to perform an SPI read-write mode test:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"./spidev_tc -D /dev/spidev0.0 -s 12000000 -I 1 -e 3 -S 32 -v\nspi mode: 0x0\nbits per word: 8\nmax speed: 12000000 Hz (12000 kHz)\nUserspace spi read and write test, test_len=32 iterations=1\nTX | 67 C6 69 73 51 FF 4A EC 29 CD BA AB F2 FB E3 46 7C C2 54 F8 1B E8 E7 8D 76 5A 2E 63 33 9F C9 9A  |g.isQ.J.)......F|.T.....vZ.c3...|\nRX | 67 C6 69 73 51 FF 4A EC 29 CD BA AB F2 FB E3 46 7C C2 54 F8 1B E8 E7 8D 76 5A 2E 63 33 9F C9 9A  |g.isQ.J.)......F|.T.....vZ.c3...|\nTest times: 0 Data verification Successful\n"})}),"\n",(0,i.jsx)(s.h4,{id:"spi-external-loopback-test",children:"SPI External Loopback Test"}),"\n",(0,i.jsx)(s.p,{children:"Prepare an RDK_S100 development board and wire out the four SPI lines. The Master can use SPI0, while the SPI Slave uses an external SPI device (selected by the user)."}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/images_to_upload/SPI_wiring_diagram.png",alt:"SPI_wiring_diagram"})}),"\n",(0,i.jsx)(s.p,{children:"Ensure that the SPI baud rate and transfer mode settings match between Master and Slave. On the Slave device side, first execute the data reception test command;"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"./spidev_tc -D /dev/spidev0.0 -s 12000000 -I 1 -e 2 -S 32 -v\nbits per word: 8\nmax speed: 1000000 Hz (1000 KHz)\nuserspace spi write test, len=10 times=1\ntest, times=0\nTX | 67 C6 69 73 51 FF 4A EC 29 CD __ __ __ __ __ __ __ __ __ __ __ __ __ __ __\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"./spidev_tc -D /dev/spidev0.0 -s 12000000 -I 10 -e 1 -S 32 -v\nspi mode: 0x0\nbits per word: 8\nmax speed: 1000000 Hz (1000 KHz)\nuserspace spi read test, len=10 times=1\ntest, times=0\nRX | 67 C6 69 73 51 FF 4A EC 29 CD __ __ __ __ __ __ __ __ __ __ __ __ __ __ __\n"})}),"\n",(0,i.jsxs)(s.admonition,{title:"Note",type:"caution",children:[(0,i.jsx)(s.p,{children:"Performance Note: The reference maximum SPI communication rate is 30 Mbps. The actual rate may vary due to system load and other factors; therefore, real-world testing is recommended. If you encounter FIFO overrun/underrun warnings during testing, consider reducing the communication speed."}),(0,i.jsx)(s.p,{children:"Note: When performing an external loopback test, execute the SPI Slave program first, followed by the SPI Master program. If the SPI Master program runs before the SPI Slave program, data loss may occur due to lack of synchronization between Master and Slave."})]})]})}function p(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);