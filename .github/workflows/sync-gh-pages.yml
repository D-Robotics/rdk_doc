name: Sync gh-pages to OSS

on:
  workflow_run:
    workflows: ["Deploy Docusaurus site to GitHub Pages"]  # deploy.yml workflow 名称
    types:
      - completed

jobs:
  sync-gh-pages:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          fetch-depth: 0   # 拉取完整历史，保证可以 push

      - name: Upload to OSS via Custom Domain
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |
          # 下载最新版 ossutil
          wget -q https://gosspublic.alicdn.com/ossutil/1.7.20/ossutil64
          chmod +x ossutil64

          # 直接使用命令行参数，避免配置步骤
          ./ossutil64 cp -r . oss://cn-rdk-front-prod/rdk_doc/ \
            --endpoint=https://cn-rdk-front-prod.d-robotics.cc \
            --access-key-id="$OSS_ACCESS_KEY_ID" \
            --access-key-secret="$OSS_ACCESS_KEY_SECRET" \
            --update \
            --retry-times=3
