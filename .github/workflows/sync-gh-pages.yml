name: Sync gh-pages to OSS

on:
  workflow_run:
    workflows: ["Deploy Docusaurus site to GitHub Pages"]  # deploy.yml workflow 名称
    types:
      - completed

jobs:
  sync-gh-pages:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          fetch-depth: 0   # 拉取完整历史，保证可以 push

      - name: Setup ossutil v2
        run: |
          # 下载并设置 ossutil v2
          curl -o ossutil.zip https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-2.1.2-linux-amd64.zip
          unzip ossutil.zip
          cd ossutil-2.1.2-linux-amd64
          chmod 755 ossutil
          mv ossutil /usr/local/bin/ && sudo ln -s /usr/local/bin/ossutil /usr/bin/ossutil
          ossutil version

      - name: Upload to OSS via Custom Domain
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |

          # 直接使用命令行参数，避免配置步骤
          ossutil cp -r . oss://cn-rdk-front-prod/rdk_doc/ \
            --endpoint=https://cn-rdk-front-prod.d-robotics.cc \
            --access-key-id="$OSS_ACCESS_KEY_ID" \
            --access-key-secret="$OSS_ACCESS_KEY_SECRET" \
            --update \
            --retry-times=3
