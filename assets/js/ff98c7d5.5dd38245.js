"use strict";(self.webpackChunkrdk_doc=self.webpackChunkrdk_doc||[]).push([[68547],{28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var t=i(96540);const d={},r=t.createContext(d);function l(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:l(e.components),t.createElement(r.Provider,{value:n},e.children)}},68560:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>a,frontMatter:()=>l,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Advanced_development/linux_development/driver_development/driver_io_domain_dev","title":"IO-DOMAIN\u8c03\u8bd5\u6307\u5357","description":"IO-Domain\u7528\u6765\u914d\u7f6eX3J3\u90e8\u5206\u6a21\u5757\u7684\u7535\u538b\u57df\uff0c\u4ee5RGMII\u63a5\u53e3\u4e3a\u4f8b\uff0c\u5982\u679c\u7535\u8def\u8bbe\u8ba1\u65f6\u5916\u63a5\u7535\u538b\u57df\u4e3a3.3V\uff0c\u5219\u9700\u8981\u914d\u7f6eRGMII\u6a21\u5757\u7684IO-DOMAIN\u4e3a3.3V\uff0c\u5982\u679c\u7535\u8def\u8bbe\u8ba1\u65f6\u5916\u63a5\u7535\u538b\u57df\u4e3a1.8V\uff0c\u5219\u9700\u8981\u914d\u7f6e\u4e3a1.8v\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a","source":"@site/docs/07_Advanced_development/02_linux_development/driver_development/driver_io_domain_dev.md","sourceDirName":"07_Advanced_development/02_linux_development/driver_development","slug":"/Advanced_development/linux_development/driver_development/driver_io_domain_dev","permalink":"/rdk_doc/Advanced_development/linux_development/driver_development/driver_io_domain_dev","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1763984695000,"sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Pinctrl\u8c03\u8bd5\u6307\u5357","permalink":"/rdk_doc/Advanced_development/linux_development/driver_development/driver_pinctrl_dev"},"next":{"title":"SPI\u8c03\u8bd5\u6307\u5357","permalink":"/rdk_doc/Advanced_development/linux_development/driver_development/driver_spi_dev"}}');var d=i(74848),r=i(28453);const l={sidebar_position:6},o="IO-DOMAIN\u8c03\u8bd5\u6307\u5357",s={},c=[{value:"\u7ba1\u811a\u67e5\u8be2",id:"\u7ba1\u811a\u67e5\u8be2",level:2},{value:"\u9a71\u52a8\u4ee3\u7801",id:"\u9a71\u52a8\u4ee3\u7801",level:2},{value:"\u4ee3\u7801\u4f4d\u7f6e",id:"\u4ee3\u7801\u4f4d\u7f6e",level:3},{value:"IO-DOMAIN\u7684DTS",id:"io-domain\u7684dts",level:3},{value:"\u9a71\u52a8\u8c03\u7528\u65f6DTS\u914d\u7f6e",id:"\u9a71\u52a8\u8c03\u7528\u65f6dts\u914d\u7f6e",level:3},{value:"\u9a71\u52a8\u8c03\u7528\u793a\u4f8b\u4ee3\u7801",id:"\u9a71\u52a8\u8c03\u7528\u793a\u4f8b\u4ee3\u7801",level:3},{value:"uboot\u4e0b\u4fee\u6539\u7535\u538b\u57df",id:"uboot\u4e0b\u4fee\u6539\u7535\u538b\u57df",level:2}];function _(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"io-domain\u8c03\u8bd5\u6307\u5357",children:"IO-DOMAIN\u8c03\u8bd5\u6307\u5357"})}),"\n",(0,d.jsx)(n.p,{children:"IO-Domain\u7528\u6765\u914d\u7f6eX3J3\u90e8\u5206\u6a21\u5757\u7684\u7535\u538b\u57df\uff0c\u4ee5RGMII\u63a5\u53e3\u4e3a\u4f8b\uff0c\u5982\u679c\u7535\u8def\u8bbe\u8ba1\u65f6\u5916\u63a5\u7535\u538b\u57df\u4e3a3.3V\uff0c\u5219\u9700\u8981\u914d\u7f6eRGMII\u6a21\u5757\u7684IO-DOMAIN\u4e3a3.3V\uff0c\u5982\u679c\u7535\u8def\u8bbe\u8ba1\u65f6\u5916\u63a5\u7535\u538b\u57df\u4e3a1.8V\uff0c\u5219\u9700\u8981\u914d\u7f6e\u4e3a1.8v\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u5916\u63a5\u7535\u538b\u57df\u4e3a3.3V\u800c\u5bf9\u5e94\u7684IO-DOMAIN\u914d\u7f6e\u4e3a1.8V\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bf9\u82af\u7247\u6709\u635f\u4f24\uff1b"}),"\n",(0,d.jsx)(n.li,{children:"\u5916\u63a5\u7535\u538b\u57df\u4e3a1.8V\u800c\u5bf9\u5e94\u7684IO-DOMAIN\u914d\u7f6e\u4e3a3.3V\u65f6\uff0c\u76f8\u5e94\u7684\u6a21\u5757\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\uff1b"}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"\u7ba1\u811a\u67e5\u8be2",children:"\u7ba1\u811a\u67e5\u8be2"}),"\n",(0,d.jsxs)(n.p,{children:["IO\u7ba1\u811a\u7684\u590d\u7528\u548c\u914d\u7f6e\u53ef\u4ee5\u5728 ",(0,d.jsx)(n.a,{href:"https://archive.d-robotics.cc/downloads/datasheets/",children:"datasheets"})," \u67e5\u9605\u300aPL-2500-3-X3 PIN SW Reg-V1.2.xls\u300b \u548c\u300aRM-2500-5-X3M Register Reference Manual-GPIO&PIN-V1.1.pdf\u300b\u3002"]}),"\n",(0,d.jsx)(n.p,{children:"\u5728 \u300aPL-2500-3-X3 PIN SW Reg-V1.2.xls\u300b\u53ef\u4ee5\u6bd4\u8f83\u76f4\u89c2\u7684\u67e5\u8be2\u5230\u7ba1\u811a\u7684\u4e0a\u7535\u9ed8\u8ba4\u72b6\u6001\u3001\u590d\u7528\u3001\u9a71\u52a8\u80fd\u529b\u3001\u4e0a\u4e0b\u62c9\u3001\u65bd\u5bc6\u7279\u89e6\u53d1\u914d\u7f6e\u3002"}),"\n",(0,d.jsx)(n.p,{children:"\u5728 \u300aRM-2500-5-X3M Register Reference Manual-GPIO&PIN-V1.1.pdf\u300b\u6587\u6863\u4e2d\u67e5\u9605 SD_MODE_CTRL \u548c IO_MODE_CTRL \u4e24\u4e2a\u5bc4\u5b58\u5668\u6765\u786e\u5b9a\u7535\u538b\u57df\u914d\u7f6e\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"\u9a71\u52a8\u4ee3\u7801",children:"\u9a71\u52a8\u4ee3\u7801"}),"\n",(0,d.jsx)(n.h3,{id:"\u4ee3\u7801\u4f4d\u7f6e",children:"\u4ee3\u7801\u4f4d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"drivers/pinctrl/pinctrl-single.c # pinctrl \u9a71\u52a8\u4ee3\u7801\u6e90\u6587\u4ef6\ninclude/linux/platform_data/pinctrl-single.h # pinctrl \u9a71\u52a8\u4ee3\u7801\u5934\u6587\u4ef6\n"})}),"\n",(0,d.jsx)(n.h3,{id:"io-domain\u7684dts",children:"IO-DOMAIN\u7684DTS"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-c",children:'/* arch/arm64/boot/dts/hobot/hobot-pinctrl-xj3.dtsi */\n/* pinctrl_voltage used to config X/J3 pin mode, for example,\n* when SD2 external power supply is 3.3v, we need config pin-mode to\n* 3.3v, otherwise X/J3 chip will be damaged.\n* when SD2 external power supply is 1.8v, we need config pin-mode to\n* 1.8v, otherwise SD2 will not work.\n*/\npinctrl_voltage: pinctrl_voltag@0xA6003000 {\n    compatible = "pinctrl-single";\n    reg = <0x0 0xA6003170 0x0 0x8>;\n    #pinctrl-cells = <2>;\n    #gpio-range-cells = <0x3>;\n    pinctrl-single,bit-per-mux;\n    pinctrl-single,register-width = <32>;\n    pinctrl-single,function-mask = <0x1>;\n    status = "okay";\n    /* rgmii 1.8v func */\n        rgmii_1_8v_func: rgmii_1_8v_func {\n            pinctrl-single,bits = <\n                0x4 MODE_1_8V RGMII_MODE_P1\n                0x4 MODE_1_8V RGMII_MODE_P0\n                >;\n        };\n    /*rgmii 3.3v func */\n        rgmii_3_3v_func: rgmii_3_3v_func {\n            pinctrl-single,bits = <\n                0x4 MODE_3_3V RGMII_MODE_P1\n                0x4 MODE_3_3V RGMII_MODE_P0\n                >;\n        };\n    ...\n};\n'})}),"\n",(0,d.jsx)(n.p,{children:"\u7531\u4e8eIO-DOMAIN\u5728Pinctrl-single\u7684\u6846\u67b6\u4e0b\u5b9e\u73b0\uff0c\u56e0\u6b64\u5176DTS\u548cPinctrl\u7684\u7c7b\u4f3c\uff0c\u5728IO-DOMAIN\u7684DTS\u91cc\u5df2\u7ecf\u5217\u51fa\u4e86\u6240\u6709\u6a21\u57571.8V\u548c3.3V\u7684\u914d\u7f6e\u7ec4\uff0c\u5ba2\u6237\u4e00\u822c\u4e0d\u9700\u8981\u4fee\u6539\uff0c\u5728\u5177\u4f53\u5f00\u53d1\u65f6\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u9009\u62e9\u4f7f\u7528\u5373\u53ef\u3002"}),"\n",(0,d.jsx)(n.h3,{id:"\u9a71\u52a8\u8c03\u7528\u65f6dts\u914d\u7f6e",children:"\u9a71\u52a8\u8c03\u7528\u65f6DTS\u914d\u7f6e"}),"\n",(0,d.jsx)(n.p,{children:"\u548cPinctrl\u7684\u4f7f\u7528\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u9a71\u52a8\u5728\u81ea\u5df1\u7684DTS\u4e2d\u5f15\u7528\u9700\u8981\u914d\u7f6e\u7684IO-DOMAIN\uff0c\u4ee5bt1120\u9a71\u52a8\u4e3a\u4f8b\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-c",children:'xxx: xxx@0xA6000000 {\n    ...\n    pinctrl-names = "default", "xxx_voltage_func", ;\n    pinctrl-0 = <&xxx_func>;\n    pinctrl-1 = <&xxx_1_8v_func>; // pinctrl-3\u4e3a1.8v\u7684IO-DOMAIN\u914d\u7f6e\n    ...\n};\n'})}),"\n",(0,d.jsx)(n.h3,{id:"\u9a71\u52a8\u8c03\u7528\u793a\u4f8b\u4ee3\u7801",children:"\u9a71\u52a8\u8c03\u7528\u793a\u4f8b\u4ee3\u7801"}),"\n",(0,d.jsx)(n.p,{children:"\u548cPinctrl\u8c03\u7528\u65b9\u6cd5\u4e00\u81f4\uff0c\u9a71\u52a8\u5148\u901a\u8fc7Pinctrl-names\u67e5\u627e\u5bf9\u5e94\u7684pinctrl state\uff0c\u7136\u540e\u518d\u5207\u6362\u5230\u5bf9\u5e94\u7684state\u3002"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-c",children:'static int hobot_xxx_probe(struct platform_device *pdev)\n{\n    ...\n    g_xxx_dev->pinctrl = devm_pinctrl_get(&pdev->dev);\n    if (IS_ERR(g_xxx_dev->pinctrl)) {\n        dev_warn(&pdev->dev, "pinctrl get none\\n");\n        g_xxx_dev->pins_voltage = NULL;\n    }\n    ...\n        /* \u6309\u7167pinctrl-names lookup state */\n        g_xxx_dev->pins_voltage = pinctrl_lookup_state(g_xxx_dev->pinctrl,\n                "xxx_voltage_func");\n    if (IS_ERR(g_xxx_dev->pins_voltage)) {\n        dev_info(&pdev->dev, "xxx_voltage_func get error %ld\\n",\n                PTR_ERR(g_xxx_dev->pins_voltage));\n        g_xxx_dev->pins_voltage = NULL;\n    }\n    ...\n        /* select state */\n        if (g_xxx_dev->pins_voltage) {\n            ret = pinctrl_select_state(g_xxx_dev->pinctrl, g_xxx_dev->pins_voltage);\n            if (ret) {\n                dev_info(&pdev->dev, "xxx_voltage_func set error %d\\n", ret);\n            }\n        }\n    ...\n}\n'})}),"\n",(0,d.jsx)(n.h2,{id:"uboot\u4e0b\u4fee\u6539\u7535\u538b\u57df",children:"uboot\u4e0b\u4fee\u6539\u7535\u538b\u57df"}),"\n",(0,d.jsx)(n.p,{children:"\u5728uboot\u6e90\u7801 board/hobot/xj3/xj3.c \u6587\u4ef6\u4e2d\uff0c\u6839\u636e\u786c\u4ef6\u5b9e\u9645\u7535\u538b\u60c5\u51b5\uff0c\u8c03\u7528init_io_vol\u63a5\u53e3\u914d\u7f6e\u7535\u538b\u57df\uff0c\u5982\u679c\u786c\u4ef6\u4e0a\u9762\u7ba1\u811a\u7684\u7535\u6e90\u57df\u662f1.8v\u90a3\u4e48\u6539\u7ba1\u811a\u5bf9\u5e94\u7684\u4f4d\u662f1\uff0c\u5982\u679c\u662f3.3v\u5219\u8be5\u7ba1\u811a\u5bf9\u5e94\u7684bit\u662f0\uff0c\u6700\u540e\u9762\u628a\u62fc\u6210\u768416\u8fdb\u5236\u503cvalue\u5199\u5165base+0x170\u548cbase+0x174\u4e2d\uff08base\uff1a 0xA6003000\uff09\uff0c\u5bc4\u5b58\u5668\u8be6\u7ec6\u8bf4\u660e\u53ef\u4ee5\u67e5\u9605\u300aRM-2500-5-X3 Register Reference Manual-GPIO&PIN-V1.1.pdf\u300b"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-c",children:"int init_io_vol(void)\n{\n    uint32_t value = 0;\n    uint32_t base_board_id = 0;\n    struct hb_info_hdr *bootinfo = (struct hb_info_hdr*)HB_BOOTINFO_ADDR;\n\n    hb_board_id = bootinfo->board_id;\n    /* work around solution for xj3 bring up ethernet,\n     * all io to v1.8 except bt1120\n     * BIFSPI and I2C2 is 3.3v in J3DVB, the other is 1.8v\n     */\n    /*\n     * 1'b0=3.3v mode;  1'b1=1.8v mode\n     * 0x170 bit[3]       sd2\n     *       bit[2]       sd1\n     *       bit[1:0]     sd0\n     *\n     * 0x174 bit[11:10]   rgmii\n     *       bit[9]       i2c2\n     *       bit[8]       i2c0\n     *       bit[7]       reserved\n     *       bit[6:4]     bt1120\n     *       bit[3:2]     bifsd\n     *       bit[1]       bifspi\n     *       bit[0]       jtag\n     */\n    value = 0xF0F;\n    base_board_id = hb_base_board_type_get();\n    if (base_board_id == BASE_BOARD_J3_DVB) {\n        value = 0xD0D;\n    }\n    writel(value, GPIO_BASE + 0x174);\n    writel(0xF, GPIO_BASE + 0x170);\n    return 0;\n}\n"})})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(_,{...e})}):_(e)}}}]);