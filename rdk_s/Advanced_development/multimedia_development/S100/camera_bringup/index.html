<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-docs_s docs-version-current docs-doc-page docs-doc-id-Advanced_development/multimedia_development/S100/camera_bringup" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Camera点亮 | RDK DOC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.d-robotics.cc/rdk_doc/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.d-robotics.cc/rdk_doc/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-docs_s-current"><meta data-rh="true" property="og:title" content="Camera点亮 | RDK DOC"><meta data-rh="true" name="description" content="HBN sensor 点亮"><meta data-rh="true" property="og:description" content="HBN sensor 点亮"><link data-rh="true" rel="icon" href="/rdk_doc/img/logo.png"><link data-rh="true" rel="canonical" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"7. 进阶开发","item":"https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development"},{"@type":"ListItem","position":2,"name":"7.3 多媒体开发指南","item":"https://developer.d-robotics.cc/rdk_doc/rdk_s/03_multimedia_development"},{"@type":"ListItem","position":3,"name":"7.3.1 S100 多媒体开发指南","item":"https://developer.d-robotics.cc/rdk_doc/rdk_s/category/731-s100-多媒体开发指南"},{"@type":"ListItem","position":4,"name":"Camera点亮","item":"https://developer.d-robotics.cc/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup"}]}</script><script src="https://hm.baidu.com/hm.js?24dd63cad43b63889ea6bede5fd1ab9e" async></script>
<script src="/rdk_doc/js/dify-config.js"></script>
<script src="https://rdk.d-robotics.cc/embed.min.js" id="MltLQTHPb5EeP7uz" defer="defer"></script><link rel="stylesheet" href="/rdk_doc/assets/css/styles.e31f7a90.css">
<script src="/rdk_doc/assets/js/runtime~main.2604abd4.js" defer="defer"></script>
<script src="/rdk_doc/assets/js/main.4648abd1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/rdk_doc/img/logo.png" alt="地瓜机器人社区 logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rdk_doc/img/logo.png" alt="地瓜机器人社区 logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">D-Robotics</b></a><a class="navbar__item navbar__link" href="/rdk_doc/RDK">RDK X3 / X5</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rdk_doc/rdk_s/RDK">RDK S100</a><a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>CN</a><ul class="dropdown__menu"><li><a href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">CN</a></li><li><a href="/rdk_doc/en/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">EN</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rdk_doc/rdk_s/RDK">D-Robotics RDK 套件</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Quick_start">1. 快速开始</a><button aria-label="展开侧边栏分类 &#x27;1. 快速开始&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/System_configuration">2. 系统配置</a><button aria-label="展开侧边栏分类 &#x27;2. 系统配置&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Basic_Application">3. 基础应用开发</a><button aria-label="展开侧边栏分类 &#x27;3. 基础应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Basic_Development">4. 算法应用开发</a><button aria-label="展开侧边栏分类 &#x27;4. 算法应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Robot_development">5. 机器人应用开发</a><button aria-label="展开侧边栏分类 &#x27;5. 机器人应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Application_case">6. 应用开发指南</a><button aria-label="展开侧边栏分类 &#x27;6. 应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rdk_doc/rdk_s/Advanced_development">7. 进阶开发</a><button aria-label="折叠侧边栏分类 &#x27;7. 进阶开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/rdk_s/hardware_development">7.1 硬件开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.1 硬件开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/rdk_s/linux_development">7.2. Linux开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.2. Linux开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/rdk_s/03_multimedia_development">7.3 多媒体开发指南</a><button aria-label="折叠侧边栏分类 &#x27;7.3 多媒体开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/rdk_s/category/731-s100-多媒体开发指南">7.3.1 S100 多媒体开发指南</a><button aria-label="折叠侧边栏分类 &#x27;7.3.1 S100 多媒体开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camsys">Camsys子系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camera_bringup">Camera点亮</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/codec">编解码</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/display">显示子系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camerasync">多路Camera及与Lidar同步</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/rdk_s/02_multimedia_application">7.3.2 多媒体应用开发 </a><button aria-label="展开侧边栏分类 &#x27;7.3.2 多媒体应用开发 &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/rdk_s/04_toolchain_development">7.4 算法工具链开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.4 算法工具链开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/rdk_s/05_MCU_development">7.5 MCU开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.5 MCU开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/rdk_s/Advanced_development/rdk_gen">7.6 RDK S100构建系统开发指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/FAQ">8. 常见问题</a><button aria-label="展开侧边栏分类 &#x27;8. 常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/rdk_s/Appendix">9. 附录</a><button aria-label="展开侧边栏分类 &#x27;9. 附录&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rdk_doc/rdk_s/Release_Note/roadmap">10. 版本发布</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/rdk_doc/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/rdk_s/Advanced_development"><span>7. 进阶开发</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/rdk_s/03_multimedia_development"><span>7.3 多媒体开发指南</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/rdk_s/category/731-s100-多媒体开发指南"><span>7.3.1 S100 多媒体开发指南</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Camera点亮</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Camera点亮</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hbn-sensor-点亮">HBN sensor 点亮<a href="#hbn-sensor-点亮" class="hash-link" aria-label="HBN sensor 点亮的直接链接" title="HBN sensor 点亮的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="范围">范围<a href="#范围" class="hash-link" aria-label="范围的直接链接" title="范围的直接链接">​</a></h3>
<p>本章节概述了 RDK-S100 camera bring up 的过程，用于帮助读者快速了解并掌握
RDK-S100 camera 框架，如何快速的新增 camera 配置，并点亮 camera。</p>
<p>该部分内容以 RDK-S100 开发板 + imx219 camera
模组为例，进行配置讲解，其他硬件平台或者 camera 模组以实际情况为准。
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_01.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="准备工作">准备工作<a href="#准备工作" class="hash-link" aria-label="准备工作的直接链接" title="准备工作的直接链接">​</a></h3>
<p>硬件资源：RDK-S100 开发板、camera 模组。</p>
<p>软件资源：系统 SDK、camera 驱动源码、sensor datasheet、sensor 的 initialize
settings 等。</p>
<p>RDK-S100 开发板 camera 相关硬件资源如下：</p>
<table><thead><tr><th>RDK-S100</th><th>MIPI host</th><th>I2C</th><th>gpio_en</th><th>gpio_lpwm_mclk</th><th>其他</th></tr></thead><tbody><tr><td>RX0<br> 可接 imx219 模组</td><td><strong>0</strong><br>  4 lane</td><td><strong>1</strong></td><td>SPI1_CSN0<br>  gpio_number:502</td><td>可通过拨码开关进行选择<br>  • LPWM0_DOUT0<br>  gpio_number:456<br>  • mclk 24Mhz</td><td>注意： imx219 模组本身外接 24M 晶振，所以不需要 SOC 端输出 mclk</td></tr><tr><td>RX1<br> 可接 imx219 模组</td><td><strong>1</strong><br>   4 lane</td><td><strong>2</strong></td><td>SD_WPROT<br>  gpio_number:494</td><td>可通过拨码开关进行选择<br>  • LPWM0_DOUT1<br> gpio_number:457<br>  • mclk 24Mhz</td><td>注意： imx219 模组本身外接 24M 晶振，所以不需要 SOC 端输出 mclk</td></tr><tr><td>RX4<br> 用于接 serdes</td><td><strong>4</strong><br>  4 lane</td><td><strong>3</strong></td><td>暂无介绍</td><td>暂无介绍</td><td>解串器 max96712, addr: 0x29 poc: max20087, addr: 0x28</td></tr></tbody></table>
<p>硬件连接示意图：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_02.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加新-sensor-点亮步骤">添加新 sensor 点亮步骤<a href="#添加新-sensor-点亮步骤" class="hash-link" aria-label="添加新 sensor 点亮步骤的直接链接" title="添加新 sensor 点亮步骤的直接链接">​</a></h3>
<p>RDK-S100 平台进行<strong>新硬件</strong>和<strong>新 camera</strong> 适配时，需要修改平台设备树
dts，camera 驱动库及相关配置文件即可，系统库一般无需改动。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dts-修改">dts 修改<a href="#dts-修改" class="hash-link" aria-label="dts 修改的直接链接" title="dts 修改的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-gpio-配置">sensor gpio 配置<a href="#sensor-gpio-配置" class="hash-link" aria-label="sensor gpio 配置的直接链接" title="sensor gpio 配置的直接链接">​</a></h5>
<p>确保新硬件使用的 sensor gpio 在 drobot-s100-pinctrl.dtsi --&gt; pinctrl_video --&gt;
video_gpio节点中有配置，这样在开机启动时，系统才会将对应的 pin 设置为
gpio，用户程序方可 以操作 pin。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_03.png" alt="" class="img_ev3q"></p>
<p>vcon 是 RDK-S100 camera 用于管理 sensor 硬件相关的 dts 节点，如果 sensor
需要对应的时序才能正常启动，则需要在该节点中配置对应的
gpio。请根据硬件连接的实际情况配置，该相关信息可以从原理图及 pin list 中获取。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// dts： 在对应 vcon node 中设置 gpio，注意 vcon 端口号与 mipi rx 端口号 一 一对应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// vcon0 -- RX0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ....</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// vcon3 -- RX3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">vin_vcon0 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpio_poc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpio_des </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor_err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//gpio_oth = &lt;444 445&gt;; // imx219 无需配置，所以这里是注释掉，为空</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lpwm_chn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rx_phy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-i2c-配置">sensor i2c 配置<a href="#sensor-i2c-配置" class="hash-link" aria-label="sensor i2c 配置的直接链接" title="sensor i2c 配置的直接链接">​</a></h5>
<p>I2C bus number 需要在 dts vcon 中与 MIPI RX
端口进行绑定，请根据硬件连接的实际情况配置，该相关信息可以从原理图中获取。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 在对应 vcon 中设置 i2c bus，如 RX0 设置 I2C2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">vin_vcon0 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpio_poc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpio_des </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor_err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lpwm_chn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rx_phy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="mclk-配置">mclk 配置<a href="#mclk-配置" class="hash-link" aria-label="mclk 配置的直接链接" title="mclk 配置的直接链接">​</a></h5>
<p>RDK-S100 底座硬件暂时不支持 SOC 输出的 mclk 连接到 sensor
模组，目前只支持外带晶振的模组。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="dts-修改验证">dts 修改验证<a href="#dts-修改验证" class="hash-link" aria-label="dts 修改验证的直接链接" title="dts 修改验证的直接链接">​</a></h5>
<p>一般 dts 配置正确，硬件正确连接后，保证 sensor 供电及 mclk 正常 ，便可以使用 i2cdetect 检测到模组的 i2c 地址。
通过 echo 命令进行控制 sensor 上电或者 reset （注：该说明使用 imx219模组无需操作 gpio）</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">class</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">export</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo out </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">class</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio502</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">direction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">class</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio502</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sys</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">class</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gpio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">unexport</span><br></span></code></pre></div></div>
<p>使用 i2cdetect 检测 sensor i2c地址。如果检测到正确的地址，如下图所示，则表示 dts 配置正确，否则需要检查dts 配置。</p>
<table><thead><tr><th><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_04.png" alt="" class="img_ev3q"></th><th><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_05.png" alt="" class="img_ev3q"></th></tr></thead></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-驱动文件添加">sensor 驱动文件添加<a href="#sensor-驱动文件添加" class="hash-link" aria-label="sensor 驱动文件添加的直接链接" title="sensor 驱动文件添加的直接链接">​</a></h4>
<p>不同厂家的 sensor，都会搭配风格各异的 driver 和 setting。因此需要将原厂 sensor
驱动，转换成 RDK-S100 camera 驱动代码，并编译生成 so 库，然后将 so
库拷贝到设备的 /usr/hobot/lib/sensor/ 目录下。<strong>需要说明的是，在 mipi start
之前，必须保证 sensor 没有开流。</strong></p>
<p>系统 SDK 目录 hobot-camera/drivers/sensor 下提供了 sensor 驱动模板文件
imx219_utility.c 以及适配过的其他 sensor 驱动，当添加新 camera sensor
支持时，可以仿照该部分文件进行修改。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">CAMERA_FRAMEWORK_HBN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">SENSOR_MODULE_F</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CAM_MODULE_FLAG_A16D8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">sensor_module_t</span><span class="token plain"> imx219 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SENSOR_MNAME</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">sensor_module_t</span><span class="token plain"> imx219 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;imx219&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_stop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deinit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_deinit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aexp_gain_control </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_aexp_gain_control</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aexp_line_control </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_aexp_line_control</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">power_on </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_poweron</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">power_off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_poweroff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userspace_control </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sensor_userspace_control</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>如上代码所示，RDK-S100 camera 框架下的 sensor 驱动接口包含在 sensor_module_t
的结构体中，文件名、结构体名和 module 字段要统一，例如文件名为
imx219_utility.c，那么结构体名和 module 字段要统一为 imx219。对于新 sensor
点亮，下列函数需要用户自行实现：</p>
<p>• init：sensor 初始化、setting 下发</p>
<p>• deinit：sensor 去初始化</p>
<p>• start：sensor 开流</p>
<p>• stop：sensor 关流</p>
<p>• power on: sensor 上电</p>
<p>• power off: sensor 下电</p>
<p>• aexp_gain_control: sensor gain 增益控制</p>
<p>• aexp_line_control: sensor line 曝光控制</p>
<p>• userspace_control: 用户回调功能开启控制</p>
<p>对于 3A
控制，系统支持驱动注册和应用层回调两种方式，默认使用应用层回调函数的方式，接口定义如下 ：</p>
<table><thead><tr><th>函数</th><th>功能</th><th>传入参数</th></tr></thead><tbody><tr><td>aexp_gain_control</td><td>sensor 增益控制</td><td>info：sensor 总线信息 mode：senosr 运行模式；linear/hdr/pwl again：sensor again 参数，最大4个 dgain：sensor dgain 参数，最大4个 gain_num：sensor gain 参数个数</td></tr><tr><td>aexp_line_control</td><td>sensor 曝光控制</td><td>info：sensor 总线信息 mode：senosr 运行模式；linear/hdr/pwl line：sensor line 参数，最大4个 line_num：sensor line 参数个数</td></tr><tr><td>awb_control</td><td>sensor 端 awb 控制</td><td>info：sensor 总线信息； mode：senosr 运行模式；linear/hdr/pwl rgain：sensor rgain bgain：sensor bgain grgain：sensor rrgain gbgain：sensor gbgain</td></tr><tr><td>userspace_control</td><td>hal 层各类控制开关</td><td>port：sensor 端口号 enable：使能用户回调控制开关，默认全部关闭。 位定义： #define HAL_LINE_CONTROL 0x00000001 #define HAL_GAIN_CONTROL 0x00000002 #define HAL_AWB_CONTROL 0x00000004</td></tr></tbody></table>
<p>如下代码是对 sensor 驱动主要结构体的初始化，需要根据每个 sensor
的实际情况来对应填写</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// sensor 实际输出的宽度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1920</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// sensor 实际输出的高度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1080</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 每秒多少曝光行，计算公式为1/每行时间或者(fps*vts)，其中vts在不同sensor的里面的名字可能有所不同，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//可能是frame_length、vts等，但含义都是每帧的所含的总共行数，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//包括有效行和blanking。lines_per_second 亦可以理解成HMAX,需要注意的是  有些sensor 无HMAX 概念</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lines_per_second </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vts </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sensor_info</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">fps</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 短曝光最大曝光时间(短曝光每帧最大曝光行数),短曝光每帧最大曝光行数可以通过公式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//单帧曝光时间/单行曝光时间，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//即(1/fps)/(1/lines_per_second)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exposure_time_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vts</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// a_gain最大倍数，举一个例子，turning_data.sensor_data.analog_gain_max =126，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//最大倍率计算公式就是2^(X/32)，其中X就是126，X这个值每一个sensor厂家不一样，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//需要从sensor手册或者sensor厂家查找得到；最大倍率也可以这样得到：先获取sensor最大增益，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//然后查找J5-ISP的增益表，得到对应的索引值，该索引值就是最大倍率。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">analog_gain_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">109</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">digital_gain_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//短曝光最小曝光时间(短曝光每帧最小曝光行数)，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//每行的曝光时间可以用公式1秒/(帧率*(有效行+blank))即1/lines_per_second推算得出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exposure_time_min </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//长曝光最大曝光时间(长曝光每帧最大曝光行数)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exposure_time_long_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vts</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 填充 sensor 位宽data_width、bayer_start(RGGB pattern start (R/Gr/Gb/B))、</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// bayer_pattern(RGGB/RCCC/RIrGB/RGIrB) 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sensor_data_bayer_fill</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">BAYER_START_R</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">BAYER_PATTERN_RGGB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 填充 exposure_max_bit_width(pwl mode bits ) 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sensor_data_bits_fill</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensor_data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// setting stream ctrl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 开流、关流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stream_ctrl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data_length </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// again lut表，fireware根据index索引lut表，查找sensor对应的寄存器值，lut表区分a_gain/d_gain，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// lut表格大小：again_lut[again_control_num][256], dgain_lut[dgain_control_num][256]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">again_lut </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">again_lut </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">again_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">256</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">again_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> imx219_gain_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_gain_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dgain_lut </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dgain_lut </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dgain_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">256</span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turning_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dgain_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>• turning_data.sensor_data.active_width：sensor 实际输出的宽度。</p>
<p>• turning_data.sensor_data.active_height：sensor 实际输出的高度。</p>
<p>• turning_data.sensor_data.analog_gain_max：a_gain
最大倍数，举一个例子，turning_data.sensor_data.analog_gain_max
=126，最大倍率计算公式就是2^(X/32)，其中 X 就是 126，X这个值每一个 sensor
厂家不一样，需要从 sensor 手册或者 sensor 厂家查找得到。</p>
<p>• turning_data.sensor_data.digital_gain_max：d_gain 最大倍数。</p>
<p>• turning_data.sensor_data.exposure_time_min：短曝光最小曝光时间(短曝光每帧最小曝光行数)，每行的曝光时间可以用公式1秒/(帧率*(有效行+blank))即1/lines_per_second推算得出。</p>
<p>• turning_data.sensor_data.exposure_time_max：短曝光最大曝光时间(短曝光每帧最大曝光行数)，短曝光每帧最大曝光行数可以通过公式单帧曝光时间/单行曝光时间，即(1/fps)/(1/lines_per_second)。</p>
<p>• turning_data.sensor_data.exposure_time_long_max：长曝光最大曝光时间(长曝光每帧最大曝光行数)，HDR
sensor 会用到。</p>
<p>• turning_data.sensor_data.lines_per_second：每秒多少曝光行，计算公式为1/每行时间或者(fps*vts)，其中vts在不同
sensor
的里面的名字可能有所不同，可能是frame_length、vts等，但含义都是每帧的所含的总共行数，包括有效行和
blanking。lines_per_second 亦可以理解成HMAX,需要注意的是有些 sensor 无 HMAX
概念。</p>
<p>• turning_data.normal.again_lut：again lut 表，fireware 根据 index 索引 lut
表，查找 sensor 对应的寄存器值，lut 表区分 a_gain/d_gain，lut
表格大小：again_lut[again_control_num][256],
dgain_lut[dgain_control_num][256]。</p>
<p>注意事项1：当某个 gain 值不存在时，该位填充 0xffffffff，分配 gain
时，程序会向下查找，直到可以查到可以分配的 gain，下发到 kernel 中的 lut
表需要是完成高低位转换，避免在 kernel 中进行，比如gain = 0x1234，写入寄存器
0x3012，0x3013，有些 sensor 在 0x3012 中写 0x12，有些 sensor 在 0x3013 中写
0x12，在 hal 中转换屏蔽该差异性；</p>
<p>注意事项2：lut 表示 [0,255] 共 256 gain 控制，转换公式为 2^(x/32)，即实际的
gain 倍数为[2^(0/32),2^(255/32)]， gain 的控制曲线为 log 类型，即任何一颗
sensor 的 gain 的控制被离散为 256 个控制点，原因是现在 3a 的控制算法给出 256
个控制点，给出更多的控制点并不会提高 gain 的控制精度</p>
<p>camera 在 mipi start 之前，需要保证 sensor 没有开流，在 camera sensor init
settings 中进行更改。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> imx219_linear_init_setting</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 0x0100,0x01,  // 在 setting 最后不包含 开流 的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>当 sensor 驱动和 setting 编写完成后，拷贝 *_utility.c 和 *_setting.h 到 SDK
对应目录中，并重新编译 SDK 生成 sensor 驱动库，生成文件位于
out/deploy/rootfs/usr/hobot/lib/sensor 中。</p>
<p>一般代码结构没有问题，即使 tuning_data 参数配置有不当的地方，框架也能正常加载 sensor驱动。如果 logcat 有 sensor so check 失败或者加载失败，则需要检查代码结构，是否按照 HBN 框架来编写。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="用户程序">用户程序<a href="#用户程序" class="hash-link" aria-label="用户程序的直接链接" title="用户程序的直接链接">​</a></h4>
<p>参考 SDK 已有的用户程序，包含 CIM、ISP 的参数配置，这些配置需要根据具体的 sensor
的分辨率，帧率，数据格式进行配置。下面列出文件中需要单独配置的部分，其余部分可保持默认值，无需关注。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="mipi-配置">mipi 配置<a href="#mipi-配置" class="hash-link" aria-label="mipi 配置的直接链接" title="mipi 配置的直接链接">​</a></h5>
<table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>rx_enable</td><td>MIPI 接收(RX) 设备使能，使能对应的 MIPI RX 端口，默认填 1。 注意 该字段不是配置 MIPI RX 端口号，只是使能 MIPI RX。</td></tr><tr><td>phy</td><td>0: 代表 mipi dphy。</td></tr><tr><td>lane</td><td>mipi lane 数，目前每一个 MIPI RX 默认支持 4 lane。</td></tr><tr><td>datatype</td><td>mipi 输入的数据格式，与 sensor 配置保持一致。 常见的如下： RAW8：0x2A RAW10: 0x2B RAW12: 0x2C YUV422 8-bit: 0x1E</td></tr><tr><td>fps</td><td>帧率，供计算 MIPI 一些配置使用，按照 sensor 输出帧率填写即可，可从 FAE 获取。</td></tr><tr><td>mipiclk</td><td>mipi 总传输率 (所有 LANE)，可从 FAE 获取，一般 FAE 提供 sensor init setting 时有描述。</td></tr><tr><td>width</td><td>输入图像 宽度 piexl。</td></tr><tr><td>height</td><td>输入图像 高度 piexl。</td></tr><tr><td>linelenth</td><td>mipi linelenth， 根据 sensor 实际情况配置，可从sensor spec 寄存器读取，或者实际硬件测量。</td></tr><tr><td>framelenth</td><td>mipi framelenth， 根据 sensor 实际情况配置，可从sensor spec 寄存器读取，或者实际硬件测量。</td></tr><tr><td>settle</td><td>mipi settle， phy 的 settle 时间配置，可实际硬件测量。报 mipi phy 错时可调整， 0 - 120 范围。</td></tr><tr><td>channel_num</td><td>mipi 虚拟通道 number，linear mode 填 1，HDR DOL2 mode 填 2。</td></tr><tr><td>channel_sel[MIPIHOST_CHANNEL_NUM]</td><td>mipi 虚拟通道对应的 ipi channel。</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>商业支持</div><div class="admonitionContent_BuS1"><p>商业版提供更完整的功能支持、更深入的硬件能力开放和专属的定制内容。为确保内容合规、安全交付，我们将通过以下方式开放商业版访问权限。</p><p>商业版本获取流程：</p><ol>
<li>填写问卷：提交您的机构信息、使用场景等基本情况</li>
<li>签署保密协议（NDA）：我们将根据提交信息与您联系，双方确认后签署保密协议</li>
<li>内容释放：完成协议签署后，我们将通过私有渠道为您开放商业版本资料</li>
</ol><p>如您希望获取商业版内容，请点击下方链接填写问卷，我们将在 3 ～ 5 个工作日内与您联系：
<a href="https://horizonrobotics.feishu.cn/share/base/form/shrcnpBby71Y8LlixYF2N3ENbre" target="_blank" rel="noopener noreferrer">https://horizonrobotics.feishu.cn/share/base/form/shrcnpBby71Y8LlixYF2N3ENbre</a></p></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="camera-sensor-配置">camera sensor 配置<a href="#camera-sensor-配置" class="hash-link" aria-label="camera sensor 配置的直接链接" title="camera sensor 配置的直接链接">​</a></h5>
<table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>name[CAMERA_MODULE_NAME_LEN]</td><td>camera 模组名称，需要和 sensor lib名称对应，如：sensor 驱动名称为：libimx219.so，那么 name 为 imx219</td></tr><tr><td>addr</td><td>sensor 设备地址，一般是 i2c 7位地址。</td></tr><tr><td>sensor_mode</td><td>sensor 工作模式： 1：NORMAL_M，linear 模式 2：DOL2_M，hdr 2帧合成1帧 3：DOL3_M，hdr 3帧合成1帧 4: DOL4_M，hdr 4帧合成1帧 5: PWL_M，hdr 模式 sensor 内部合成</td></tr><tr><td>gpio_enable</td><td>是否使用 gpio 控制 camera sensor 的引脚，以满足 sensor 上下电的时序要求。如：使用 gpio 来控制 sensor XSHUTDN 引脚。<strong>注意</strong>：需要在 dts 中配置对应的 gpio number。 0: 不使用 gpio 来控制。  非 0: 使用 gpio 来控制 sensor，按照 bit 来使能 gpio 数量。 比如: 0x07 则代表使能 [a, b, c] 3 个 gpio。</td></tr><tr><td>gpio_level</td><td>如果选择 gpio_enable_bit，则可以配置 gpio_level 来控制 sensor 引脚高低电平。某个 gpio bit 与 sensor 管脚高低电平关系如下： 0: 先输出低电平，sleep 1s (休眠时间可以在 sensor 驱动文件 power_on 函数中，通过 usleep 自行定义)，再输出高电平。 1: 先输出高电平，sleep 1s，再输出低电平 比如：0x05 = 101，从 bit0 到 bit2 分别代表 gpio a 先输出高电平，再输出低电平，gpio b 先输出低电平，再输出高电平，gpio c 先输出高电平，再输出低电平。 <strong>注意</strong>：需要根据 sensor spec 上电时序来自定义。</td></tr><tr><td>fps</td><td>sensor 帧率配置</td></tr><tr><td>width</td><td>sensor 出图宽度 pixel</td></tr><tr><td>height</td><td>sensor 出图高度 piexl</td></tr><tr><td>format</td><td>sensor mipi 数据类型，常见的如下： RAW8：0x2A RAW10: 0x2B RAW12: 0x2C YUV422 8-bit: 0x1E</td></tr><tr><td>extra_mode</td><td>模组索引配置，部分 sensor 驱动中会用到</td></tr><tr><td>config_index</td><td>功能配置，部分 sensor 驱动中会用到</td></tr><tr><td>calib_lname</td><td>sensor 效果库路径，默认路径为 /usr/hobot/lib/sensor</td></tr><tr><td>end_flag</td><td>固定为 CAMERA_CONFIG_END_FLAG</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="vio-配置">vio 配  置<a href="#vio-配置" class="hash-link" aria-label="vio 配置的直接链接" title="vio 配置的直接链接">​</a></h5>
<table><thead><tr><th>字段1</th><th>字段2</th><th>字段3</th><th>描述</th></tr></thead><tbody><tr><td>VIN</td><td>cim</td><td>mipi_en</td><td>使能 mipi 接口</td></tr><tr><td></td><td></td><td>mipi_rx</td><td>mipi rx 端口号</td></tr><tr><td></td><td></td><td>vc_index</td><td>mipi virtual index，mipi 虚拟通道，默认填写 0 即可</td></tr><tr><td></td><td></td><td>ipi_channel</td><td>ipi channel number，linear mode 为 1， hdr mode dol2 为 2</td></tr><tr><td></td><td></td><td>cim_isp_flyby</td><td>cim/sif online 到 isp。 0: sif offline 到 isp，数据经过 ddr。 1：sif online 到 isp，数据不经过 ddr。</td></tr><tr><td></td><td>input channel</td><td>format</td><td>vin format，sensor 输出 format</td></tr><tr><td></td><td></td><td>width</td><td>sensor 输出分辨率 宽度 pixel</td></tr><tr><td></td><td></td><td>height</td><td>sensor 输出分辨率 高度 pixel</td></tr><tr><td></td><td>output channel / ddr</td><td>ddr_en</td><td>数据是否 dump 到 DDR</td></tr><tr><td></td><td></td><td>wstride</td><td>设置为 0，驱动会自动计算 wstride。</td></tr><tr><td></td><td></td><td>format</td><td>下 ddr 时，设置的 sensor format</td></tr><tr><td></td><td></td><td>buffers_num</td><td>cim/sif 下 ddr 的buffer number，设置为 1 - 6</td></tr><tr><td></td><td></td><td>flags</td><td>一般在程序设置</td></tr><tr><td></td><td></td><td></td><td>HB_MEM_USAGE_CPU_READ_OFTEN | HB_MEM_USAGE_CPU_WRITE_OFTEN | HB_MEM_USAGE_CACHED</td></tr><tr><td>ISP</td><td>base</td><td>hw_id 和 slot_id</td><td>CIM 硬件直连 ISP 情况： hw_id 需要与 cim 的 rx_index 一一对应。 在sched_mode配置为1的情况下，CIM online ISP slot_id 取值0 ~ 3，与cim vc_index一一对应。 在sched_mode配置为2的情况下，slot_id 固定为0，cim vc_index可视sensor实际接入情况设置为0 ~ 3。 CIM DDR 连接 ISP 情况： hw_id 无限制，  可视 sensor 实际接入情况和项目需要选择hw_id。 slot id只需从4开始到11即可。 注意：在多路压力场景下，采用CIM DDR的连接方式情况时，大分辨率的sensor通路连接尽量选择slot id取值较小的ISP通道上，可保证对sensor实时控制。</td></tr><tr><td></td><td></td><td>sched_mode</td><td>ISP的工作模式， 1: 表示manual，软件调度的方式， 2: 表示passthru模式，全online独占ISP的工作模式。</td></tr><tr><td></td><td></td><td>width</td><td>输入图像高度</td></tr><tr><td></td><td></td><td>height</td><td>输入图像宽度</td></tr><tr><td></td><td></td><td>frame_rate</td><td>输入帧率，无实际效果</td></tr><tr><td></td><td></td><td>algo_state</td><td>2a 的开关参数</td></tr><tr><td></td><td>output channel</td><td>stream_output_mode 和 axi_output_mode</td><td>isp 模式</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="板端运行程序">板端运行程序<a href="#板端运行程序" class="hash-link" aria-label="板端运行程序的直接链接" title="板端运行程序的直接链接">​</a></h4>
<p>执行对应的测试程序</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="isp-图像预览">isp 图像预览<a href="#isp-图像预览" class="hash-link" aria-label="isp 图像预览的直接链接" title="isp 图像预览的直接链接">​</a></h4>
<p><strong>SDK 代码添加 tuning 程序</strong></p>
<p>修改 /app/tuning_tool/scripts/tuning_menu.sh 文件，仿照已有的
sensor，进行添加。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ITEM_IMX219_RGGB</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;module:Raw10_IMX219_RDK-S100&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMX219_RGGB_Raw10_IMX219_RDK</span><span class="token operator" style="color:#393A34">-</span><span class="token function" style="color:#d73a49">S100</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IDESC</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;imx219 rggb raw10 RDK-S100&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setup_case $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">folder</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tuning_imx219_cim_isp_1080p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>在 /app/tuning_tool/cfg/matrix 目录下建立 tuning_imx219_cim_isp_1080p
文件夹，并添加对应的 hb_j6dev.json mipi.json vpm_config.json 三个文件。</p>
<p>编译 SDK 系统代码，确保板端已经包含修改和添加的文件。</p>
<p><strong>板端执行 tuning 程序</strong></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tuning_tool</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash run_tuning</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 按照交互页面提示，选择对应的 sensor</span><br></span></code></pre></div></div>
<p><strong>图像预览</strong></p>
<ol>
<li>
<p><a href="/rdk_doc/rdk_s/Quick_start/download#%E5%B7%A5%E5%85%B7%E4%B8%8B%E8%BD%BD">点击此处</a>下载图像浏览工具 hbplayer。</p>
</li>
<li>
<p>打开 hbplayer 并设置网络地址（PC需要与板子可以ping通），点 apply 设置生效，并点 connect 则可以看到实时视频流。实时预览操作示意如图所示。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_06.png" alt="" class="img_ev3q"></p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="错误码">错误码<a href="#错误码" class="hash-link" aria-label="错误码的直接链接" title="错误码的直接链接">​</a></h3>
<p>下面是 sensor 常见的错误码及简单的排查方向：</p>
<table><thead><tr><th>错误码</th><th>定义</th><th>排查方向</th></tr></thead><tbody><tr><td>203</td><td>HB_CAM_INIT_FAIL</td><td>sensor 初始化失败，一般可能 i2c 不通，配置的 sensor mode 不支持</td></tr><tr><td>205</td><td>HB_CAM_START_FAIL</td><td>sensor 启动失败，一般可能 i2c 不通，配置的 sensor mode 不支持</td></tr><tr><td>207</td><td>HB_CAM_I2C_WRITE_FAIL</td><td>sensor i2c 不通。</td></tr><tr><td>217</td><td>HB_CAM_SENSOR_POWERON_FAIL</td><td>sensor 上电失败，可能是 sensor gpio 配置错误。</td></tr><tr><td>218</td><td>HB_CAM_SENSOR_POWEROFF_FAIL</td><td>sensor 下电失败，可能是 sensor gpio 配置错误。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="faq">FAQ<a href="#faq" class="hash-link" aria-label="FAQ的直接链接" title="FAQ的直接链接">​</a></h3>
<p><strong>control-tool 使用说明</strong></p>
<p>进入tuning 目录，cd /app/tuning_tool/control_tool</p>
<p>按照交互界面提示，执行启动脚本 sh server_isp*_8000.sh，ISP 硬件具有两个 IP
核，每个核可以单独运行，若需要启动 isp 的控制则运行脚本 sh server_isp0_8000.sh.</p>
<p>启动方式如图所示。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_07.png" alt="" class="img_ev3q"></p>
<p>脚本会自动识别板子ip, 默认检查eth1网卡ip地址。若需要修改为启动eth0
网卡，修改脚本eth_id=eth0。修改位置如图所示。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_08.png" alt="" class="img_ev3q"></p>
<p>修改通信地址示意图</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_09.png" alt="" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="v4l2-sensor-点亮">V4L2 sensor 点亮<a href="#v4l2-sensor-点亮" class="hash-link" aria-label="V4L2 sensor 点亮的直接链接" title="V4L2 sensor 点亮的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="v4l2-sensor驱动编写说明">V4L2 sensor驱动编写说明<a href="#v4l2-sensor驱动编写说明" class="hash-link" aria-label="V4L2 sensor驱动编写说明的直接链接" title="V4L2 sensor驱动编写说明的直接链接">​</a></h3>
<p>S100 Camsys sensor v4l2 驱动软件框架为标准的v4l2 sub device驱动。
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_10.png" alt="" class="img_ev3q">
下面以IMX219驱动为例，介绍MIPI直连sensor v4l2 驱动开发流程，imx219驱动源码位于：kernel/drivers/media/i2c/imx219.c</p>
<p>####定义sensor私有结构体
imx219私有结构体如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">imx219</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev</span><span class="token plain"> sd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">media_pad</span><span class="token plain"> pad</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">i2c_client</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">i2c_client</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_ctrl</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">xxx_ctrl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>sd: v4l2 sub device 句柄，用于操作subdev ops；
pad: media pad，用于和后级模块建立media链接关系；
i2c_client: i2c client 句柄，用来通过i2c总线与sensor交互；
xxx_ctrl: v4l2控制属性，例如exposure、flip、blank控制，非必须实现；</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="v4l2回调函数实现">V4L2回调函数实现<a href="#v4l2回调函数实现" class="hash-link" aria-label="V4L2回调函数实现的直接链接" title="V4L2回调函数实现的直接链接">​</a></h4>
<p>符合v4l2标准的sensor驱动需要实现一些ops函数，V4L2框架会通过ops函数控制sensor</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev_ops</span><span class="token plain"> imx219_subdev_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219_core_ops</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">video </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219_video_ops</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pad </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219_pad_ops</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>实现v4l2 subdev ops回调，其中包含core ops、video ops、pad ops。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev_pad_ops</span><span class="token plain"> imx219_pad_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enum_mbus_code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_enum_mbus_code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_get_pad_format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_set_pad_format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enum_frame_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_enum_frame_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>pad ops定义了一些格式配置、格式协商的回调接口，必须实现。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev_video_ops</span><span class="token plain"> imx219_video_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s_stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_set_stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>video ops主要定义了sensor开关流的接口，必须实现。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev_core_ops</span><span class="token plain"> imx219_core_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v4l2_ctrl_subdev_subscribe_event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unsubscribe_event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v4l2_event_subdev_unsubscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>core ops定义了一些如ioctl event实现等，可选实现。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">v4l2_subdev_internal_ops</span><span class="token plain"> imx219_internal_ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">open </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imx219_open</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>internal ops主要定义了一些ops用于管理子设备的生命周期，按需实现open、close、release等回调。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-probe函数">sensor probe函数<a href="#sensor-probe函数" class="hash-link" aria-label="sensor probe函数的直接链接" title="sensor probe函数的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">imx219_probe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">i2c_client</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imx219 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">devm_kzalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">client</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">imx219</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GFP_KERNEL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">imx219</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">v4l2_i2c_subdev_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219_subdev_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> V4L2_SUBDEV_FL_HAS_DEVNODE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ┆   V4L2_SUBDEV_FL_HAS_EVENTS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">function </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MEDIA_ENT_F_CAM_SENSOR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pad</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MEDIA_PAD_FL_SOURCE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">media_entity_pads_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">pad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">v4l2_async_register_subdev_sensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imx219</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">sd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ol>
<li>初始化sensor结构体，分配内存；</li>
<li>初始化一个 v4l2 subdev，并绑定到 I2C client；</li>
<li>初始化 media entity 的 pad 信息，让media controller知道当前sensor有一个输出pad，可以连接到后级模块；</li>
<li>异步注册，把当前sensor subdev注册到v4l2框架；</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-device-tree">sensor device tree<a href="#sensor-device-tree" class="hash-link" aria-label="sensor device tree的直接链接" title="sensor device tree的直接链接">​</a></h4>
<p>S100默认加载imx219设备树，设备树组织格式如下面所示，如果接入其他的mipi sensor，需要以dts overlay的方式覆盖掉imx219的dts。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">i2c1 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imx219@</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                compatible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sony,imx219&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// sensor i2c地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cam_to_mipi_csi0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> endpoint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// MIPI 相关属性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                remote</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rdk_s100_mipi_csi0_from_cam</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 对接到mipi RX0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                clock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lanes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                data</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lanes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                link</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">frequencies </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bits</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">456000000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                virtual</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mipi_host0 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port@</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        rdk_s100_mipi_csi0_from_sensor0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> endpoint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                remote</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sensor0_to_mipi_csi0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                clock</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lanes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                data</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lanes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// mipi data lane 为 2lane</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                lane</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">1728</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// mipi 速率</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                vc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// sensor 输出的 virtual channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                emb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">en </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// sensor 输出是否包含 embedded data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="v4l2-gmsl-serdes接口调用说明">V4L2 GMSL SerDes接口调用说明<a href="#v4l2-gmsl-serdes接口调用说明" class="hash-link" aria-label="V4L2 GMSL SerDes接口调用说明的直接链接" title="V4L2 GMSL SerDes接口调用说明的直接链接">​</a></h3>
<p>S100 Camsys支持接入美信加串器的sensor，camera子板默认搭载美信解串器MAX96712。GMSL sensor同样作为一个v4l2 subdev接入v4l2框架，这里加串器及解串器驱动为gmsl sensor驱动提供操作函数集，不实现为v4l2 subdev。
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_11.png" alt="" class="img_ev3q"></p>
<p>serdes 相关的一些数据结构及回调函数定义在 kernel/include/media/i2c/serdes_core.h，需要包含该头文件，#include &lt;media/i2c/serdes_core.h&gt;
本小结以0820C GMSL sensor为例，介绍camsys gmsl sensor开发。
####sensor结构体新增成员</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ar0820</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_ctx</span><span class="token plain"> g_ctx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>sensor驱动需要包含ser_dev与dser_dev两个结构体，用来操作加串和解串;
需要包含serdes contex g_ctx成员，用来保存serdes相关属性，其中主要使用的结构体成员说明如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_ctx</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 serdes_csi_link</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 在 sensor 驱动中保存解串器的port 值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 ser_reg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//加串器i2c地址映射目标值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 sdev_reg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// sensor 实际i2c地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 sdev_def</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// sensor i2c地址映射目标值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 lane_num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 在 sensor 驱动中保存 sensor与加串器连接的mipi data lane数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 data_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 在 sensor 驱动中保存 sensor输出的数据类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 dst_vc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// 在 sensor 驱动中保存 sensor输出的virtual channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="serdes回调函数">serdes回调函数<a href="#serdes回调函数" class="hash-link" aria-label="serdes回调函数的直接链接" title="serdes回调函数的直接链接">​</a></h4>
<p>加串器与解串器都提供了下面的回调函数，供sensor driver中调用，调用需要使用SERDES_OP宏</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* 默认返回值大于等于 0 代表操作成功，返回值小于 0 则代表操作失败 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_ops</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 加串器和解串器做初始化用，只下一些基础配置 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 目前是给 d457 -&gt; max9295a 做额外初始化用，将 max929a 4个 pipe 都使能 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">init_ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 预留 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 将解析的 dts 值，通过 serdes_ctx 传递给加串器和解串器 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">set_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ┆      </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_ctx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 用于解串器建立 link 使用，默认 setting 是没有使能 link，在该ops 中会使能 link */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">setup_link</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ┆ </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* remote_contrl_get -&gt; map_addr -&gt; remote_contrl_put 配套使用，在 sensor/加串器 地址重映射期间，保证 sensor/加串器 的稳定性 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">remote_contrl_get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                ┆</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">remote_contrl_put</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 加串器调用，重新映射加串器和sensor 的i2c 地址 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">map_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 加串器拉高某个 mfp */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">enable_mfp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> gpio_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 加串器拉低某个 mfp */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">clear_mfp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> gpio_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 解串器打开 mipi tx，开始出流，加串器默认是打开的，所以无需主动调用 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">set_stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> enable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 解串器和加串器配置 gmsl video pipe 属性，属性由 dts 解析得到，默认配置加串器/解串器 pipe-z */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">set_pipe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 针对复杂场景，解串器和加串器配置 gmsl video pipe 数据，可根据每个 pipe 灵活配置 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">set_pipe_ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sen_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">uint8_t</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> vc_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> data_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 通过 virtual channel 值，查看解串器是否还有空余的 pipe，返回空余的 pipe id(0-3)，</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">           d457 sensor 在出流前使用，与 release_pipe_id 配套使用 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">get_pipe_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">uint8_t</span><span class="token plain"> vc_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 使用完解串器 video pipe，释放对应的 video pipe*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">release_pipe_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">serdes_device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serdes_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">uint8_t</span><span class="token plain"> pipe_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ol>
<li>在sensor probe中需要调用一些serdes的ops来做一些软件初始化，解析 dts 值，并通过 set_ctx 分别传递给加串器和解串器驱动。</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> set_ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">g_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> set_ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">g_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>分别调用加串器和解串器的set_ctx函数与加解串器建立软件上的链接关系；</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setup_link</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remote_contrl_get</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remote_contrl_put</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> set_pipe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> set_pipe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clear_mfp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mfp_reset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enable_mfp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mfp_reset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>调用ops做一些加解串器link、addr、pipe、mfp等初始化 ；
2. 在s_stream中配置解串器开流，加串器mfp使能等：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enable_mfp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mfp_trigger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> set_stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-device-tree-1">sensor device tree<a href="#sensor-device-tree-1" class="hash-link" aria-label="sensor device tree的直接链接" title="sensor device tree的直接链接">​</a></h4>
<p>S100 v4l2 gmsl sensor默认加载0820c的dts，gmsl sensor设备树组织格式如下面所示：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ar0820@</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                compatible</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;d-robotics,ar0820&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x11</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// map后的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// sensor i2c实际地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mfp</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">reset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// reset连接到加串器的mfp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mfp</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">trigger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">7</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// trigger pin链接到加串器的mfp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">robotics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">serdes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ser</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">device </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ser_a</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 链接至linkA上的加串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">robotics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">serdes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dser</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">device </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">dser</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 接入deserial</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cam_0_to_mipi_csi4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> endpoint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 接入mipi rx4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                remote</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mipi_csi4_from_cam_0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                virtual</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-dtbo-文件编写配置说明">Sensor dtbo 文件编写配置说明<a href="#sensor-dtbo-文件编写配置说明" class="hash-link" aria-label="Sensor dtbo 文件编写配置说明的直接链接" title="Sensor dtbo 文件编写配置说明的直接链接">​</a></h3>
<p>S100 uboot 支持 DTB Overlay 功能，可以在不修改当前启动使用的dts文件的情况下，通过编写配置对应的dtbo文件。对当前启动使用的dtb文件进行增/改（不支持删减）的功能</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-dtbo-文件生成">sensor dtbo 文件生成<a href="#sensor-dtbo-文件生成" class="hash-link" aria-label="sensor dtbo 文件生成的直接链接" title="sensor dtbo 文件生成的直接链接">​</a></h4>
<ol>
<li>编写dtso文件</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;dt-bindings/gpio/gpio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dts</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">plugin</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fragment@</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/soc/i2c@39450000/&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            __overlay__ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                d457@</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    compatible</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;intel,d4xx&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x11</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    def</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">640</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">480</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cam</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Depth&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    data_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0x2e</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lane_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    vc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">robotics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">serdes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ser</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">device </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ser_a</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">robotics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">serdes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dser</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">device </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">dser</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;okay&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    port </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        sensor_0_to_mipi_csi4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> endpoint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            remote</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mipi_csi4_from_sensor_0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            virtual</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ol start="2">
<li>在板端编译生成dtbo</li>
</ol>
<ul>
<li>安装dtc 工具</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install device</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tree</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compiler </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span></code></pre></div></div>
<ul>
<li>预处理dtso 文件</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#当编写的dtso中include 头文件 或者 有定义时，才需要用以下命令预处理dtso文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#获取dts 头文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEADER_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">find </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">maxdepth </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">type d </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">name </span><span class="token string" style="color:#e3116c">&quot;linux-headers-*&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sort </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Vr </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> head </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DTS_HEAD_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;$HEADER_DIR/include&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将编写的dtso文件预处理生成dtbi文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nostdinc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">I </span><span class="token string" style="color:#e3116c">&quot;$DTS_HEAD_PATH&quot;</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtso </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtbi</span><br></span></code></pre></div></div>
<ul>
<li>编译生成dtbo 文件
如果有dtbi文件，则通过dtbi文件生成最终的dtbo文件</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dtc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">@ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">I dts </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">O dtb </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtbo sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtbi</span><br></span></code></pre></div></div>
<p>如果没有dtbi文件，则通过编写的dtso文件生成最终的dtbo文件</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dtc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">@ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">I dts </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">O dtb </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtbo sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtso</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-dtbo-开机自动生效配置">sensor dtbo 开机自动生效配置<a href="#sensor-dtbo-开机自动生效配置" class="hash-link" aria-label="sensor dtbo 开机自动生效配置的直接链接" title="sensor dtbo 开机自动生效配置的直接链接">​</a></h4>
<ol>
<li>
<p>将编译生成的dtbo 文件放置到 /boot/overlays 目录下
若板端没有/boot/overlays目录，用户可自行添加/boot/overlays 目录， 或者通过安装hobot-camera.deb
来获取/boot/overlays 目录 和 d457 sensor dtbo 文件
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_12.png" alt="" class="img_ev3q"></p>
</li>
<li>
<p>修改config.txt 文件，配置要添加的dtbo文件
若该位置没有config.txt 文件， 用户可自行添加config.txt 文件
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_13.png" alt="" class="img_ev3q">
按照下面的方法，修改config.txt
dtbo_file_path=/overlays/v0p5_d457_2v_depth_color.dtbo</p>
</li>
<li>
<p>重启板子，使能配置的dtbo文件。在debug 版本的uboot log中，可以检查加载dtbo 的情况
<img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/03_multimedia_development/02_S100/camera_bringup/camera_bringup_14.png" alt="" class="img_ev3q"></p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sensor-gain-lut表编写说明">Sensor gain LUT表编写说明<a href="#sensor-gain-lut表编写说明" class="hash-link" aria-label="Sensor gain LUT表编写说明的直接链接" title="Sensor gain LUT表编写说明的直接链接">​</a></h3>
<p>RAW格式的sensor，对接到S100 ISP图像系统，除了编写sensor v4l2 驱动，另外需要制作一个so，存放sensor增益lut转换表，包括again lut、dgain lut等。人眼对亮度的感知更接近对数尺度而非线性尺度，dB单位更符合这种感知，S100 ISP这里sensor增益lut表存放的gain数组，需要存放db单位连续的sensor gain 寄存器配置值，供ISP调节sensor增益时找到对应的sensor寄存器值，下发到sensor。下面以imx219为例，介绍v4l2 sensor lut so如何制作。</p>
<p>imx219 sensor gain lut表制作目录在sdk中位于hobot-camera/v4l2/v4l2_helper/imx219_v4l2;</p>
<ol>
<li>添加&lt;sensor_name&gt;_camera_helper.c文件、Makefile及版本文件version.mk</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">imx219_v4l2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── imx219_camera_helper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── version</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mk</span><br></span></code></pre></div></div>
<ol start="2">
<li>在xxx_helper.c文件中，制作again lut表及dgain lut表，lut表为一个uint32类型的数组，最多256个成员，每个成员为gain寄存器的配置值，相邻成员对应的db要连续，以imx219为例：</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> imx219_again_lut</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 0db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.2db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0B</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.4db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0F</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.6db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.8db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xE7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约20.4db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xE8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 约20.6db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// end flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 0db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0106</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.2db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x010c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.4db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0112</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约0.6db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0f53</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约23.6db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0fa9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约23.8db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0fd9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 约24.0db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// end flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>lut表最后一个成员固定为0xffff。</p>
<ol start="3">
<li>编 写again index to reg、dgain index to reg callback函数，及获取callback的接口，复用219的即可：</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">AGainIndexToReg_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 传入uint8 index，获得uint32 sensor寄存器配置值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DGainIndexToReg_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同上</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AGainIndexToReg_t again_index_to_reg_callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DGainIndexToReg_t dgain_index_to_reg_callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Callbacks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// callback结构体，不需要更改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">again_index_to_reg_function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token plain"> isp_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isp_index </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_again_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isp_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_again_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> imx219_again_lut</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">isp_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dgain_index_to_reg_function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token plain"> isp_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isp_index </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isp_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> imx219_dgain_lut</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">isp_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Callbacks cb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">again_index_to_reg_function</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dgain_index_to_reg_function</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//get_index_to_reg_callbacks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Callbacks</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_index_to_reg_callbacks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cb</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>生成的so命名为lib&lt;sensor_name&gt;_v4l2.so，运行时会自动匹配并dlopen该so，调用符号最终获取到lut表。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="曝光同步sensor驱动说明">曝光同步sensor驱动说明<a href="#曝光同步sensor驱动说明" class="hash-link" aria-label="曝光同步sensor驱动说明的直接链接" title="曝光同步sensor驱动说明的直接链接">​</a></h3>
<p>S100 camsys serdes提供了trigger相关接口，sensor驱动中可以调用来配置lpwm硬件、使能lpwm。
硬件同步曝光目前仅支持gmsl sensor，sensor dts中需要配置正确的trigger mfp管脚。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trigger_cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> duty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>在sensor的初始化配置format格式中调用trigger_cfg，下发lpwm配置
period单位为ns，计算方式为（1000000/fps)*1000
duty单位为ns，没有特殊要求可以配置为10000</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SERDES_OP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trigger_enable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> priv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dser_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sen_dev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>在stream开关流时，调用trigger_enable打开或关闭lpwm输出</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2026-02-10T11:31:31.000Z" itemprop="dateModified">2026年2月10日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/camsys"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Camsys子系统</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rdk_doc/rdk_s/Advanced_development/multimedia_development/S100/codec"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">编解码</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#hbn-sensor-点亮" class="table-of-contents__link toc-highlight">HBN sensor 点亮</a><ul><li><a href="#范围" class="table-of-contents__link toc-highlight">范围</a></li><li><a href="#准备工作" class="table-of-contents__link toc-highlight">准备工作</a></li><li><a href="#添加新-sensor-点亮步骤" class="table-of-contents__link toc-highlight">添加新 sensor 点亮步骤</a><ul><li><a href="#dts-修改" class="table-of-contents__link toc-highlight">dts 修改</a><ul><li><a href="#sensor-gpio- 配置" class="table-of-contents__link toc-highlight">sensor gpio 配置</a></li><li><a href="#sensor-i2c-配置" class="table-of-contents__link toc-highlight">sensor i2c 配置</a></li><li><a href="#mclk-配置" class="table-of-contents__link toc-highlight">mclk 配置</a></li><li><a href="#dts-修改验证" class="table-of-contents__link toc-highlight">dts 修改验证</a></li></ul></li><li><a href="#sensor-驱动文件添加" class="table-of-contents__link toc-highlight">sensor 驱动文件添加</a></li><li><a href="#用户程序" class="table-of-contents__link toc-highlight">用户程序</a><ul><li><a href="#mipi-配置" class="table-of-contents__link toc-highlight">mipi 配置</a></li><li><a href="#camera-sensor-配置" class="table-of-contents__link toc-highlight">camera sensor 配置</a></li><li><a href="#vio-配置" class="table-of-contents__link toc-highlight">vio 配置</a></li></ul></li><li><a href="#板端运行程序" class="table-of-contents__link toc-highlight">板端运行程序</a></li><li><a href="#isp-图像预览" class="table-of-contents__link toc-highlight">isp 图像预览</a></li></ul></li><li><a href="#错误码" class="table-of-contents__link toc-highlight">错误码</a></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a></li></ul></li><li><a href="#v4l2-sensor-点亮" class="table-of-contents__link toc-highlight">V4L2 sensor 点亮</a><ul><li><a href="#v4l2-sensor驱动编写说明" class="table-of-contents__link toc-highlight">V4L2 sensor驱动编写说明</a><ul><li><a href="#v4l2回调函数实现" class="table-of-contents__link toc-highlight">V4L2回调函数实现</a></li><li><a href="#sensor-probe函数" class="table-of-contents__link toc-highlight">sensor probe函数</a></li><li><a href="#sensor-device-tree" class="table-of-contents__link toc-highlight">sensor device tree</a></li></ul></li><li><a href="#v4l2-gmsl-serdes接口调用说明" class="table-of-contents__link toc-highlight">V4L2 GMSL SerDes接口调用说明</a><ul><li><a href="#serdes回调函数" class="table-of-contents__link toc-highlight">serdes回调函数</a></li><li><a href="#sensor-device-tree-1" class="table-of-contents__link toc-highlight">sensor device tree</a></li></ul></li><li><a href="#sensor-dtbo-文件编写配置说明" class="table-of-contents__link toc-highlight">Sensor dtbo 文件编写配置说明</a><ul><li><a href="#sensor-dtbo-文件生成" class="table-of-contents__link toc-highlight">sensor dtbo 文件生成</a></li><li><a href="#sensor-dtbo-开机自动生效配置" class="table-of-contents__link toc-highlight">sensor dtbo 开机自动生效配置</a></li></ul></li><li><a href="#sensor-gain-lut表编写说明" class="table-of-contents__link toc-highlight">Sensor gain LUT表编写说明</a></li><li><a href="#曝光同步sensor驱动说明" class="table-of-contents__link toc-highlight">曝光同步sensor驱动说明</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">友情链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.guyuehome.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">古月居<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://space.bilibili.com/437998606" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiLiBiLi<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 D-Robotics.</div></div></div></footer></div>
</body>
</html>