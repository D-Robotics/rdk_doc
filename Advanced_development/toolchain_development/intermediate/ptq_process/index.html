<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Advanced_development/toolchain_development/intermediate/ptq_process" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">PTQ原理及步骤详解 | RDK DOC</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.d-robotics.cc/rdk_doc/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.d-robotics.cc/rdk_doc/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="PTQ原理及步骤详解 | RDK DOC"><meta data-rh="true" name="description" content="简介"><meta data-rh="true" property="og:description" content="简介"><link data-rh="true" rel="icon" href="/rdk_doc/img/logo.png"><link data-rh="true" rel="canonical" href="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/en/Advanced_development/toolchain_development/intermediate/ptq_process" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"7. 进阶开发","item":"https://developer.d-robotics.cc/rdk_doc/Advanced_development"},{"@type":"ListItem","position":2,"name":"7.4 算法工具链开发指南","item":"https://developer.d-robotics.cc/rdk_doc/04_toolchain_development"},{"@type":"ListItem","position":3,"name":"7.4.2 进阶指南","item":"https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/"},{"@type":"ListItem","position":4,"name":"PTQ原理及步骤详解","item":"https://developer.d-robotics.cc/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process"}]}</script><script src="https://hm.baidu.com/hm.js?24dd63cad43b63889ea6bede5fd1ab9e" async></script><link rel="stylesheet" href="/rdk_doc/assets/css/styles.0fbd7d27.css">
<script src="/rdk_doc/assets/js/runtime~main.8ba0e6dd.js" defer="defer"></script>
<script src="/rdk_doc/assets/js/main.65e02ae8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/rdk_doc/img/logo.png" alt="地瓜机器人社区 logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rdk_doc/img/logo.png" alt="地瓜机器人社区 logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">D-Robotics</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rdk_doc/RDK">RDK X3 / X5</a><a class="navbar__item navbar__link" href="/rdk_doc/rdk_s/RDK">RDK S100</a><a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>CN</a><ul class="dropdown__menu"><li><a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">CN</a></li><li><a href="/rdk_doc/en/Advanced_development/toolchain_development/intermediate/ptq_process" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">EN</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rdk_doc/RDK">D-Robotics RDK套件</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Quick_start">1. 快速开始</a><button aria-label="展开侧边栏分类 &#x27;1. 快速开始&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/System_configuration">2. 系统配置</a><button aria-label="展开侧边栏分类 &#x27;2. 系统配置&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Basic_Application">3. 基础应用开发</a><button aria-label="展开侧边栏分类 &#x27;3. 基础应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Basic_Development">4. 算法应用开发</a><button aria-label="展开侧边栏分类 &#x27;4. 算法应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Robot_development">5. 机器人应用开发</a><button aria-label="展开侧边栏分类 &#x27;5. 机器人应用开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Application_case">6. 应用开发指南</a><button aria-label="展开侧边栏分类 &#x27;6. 应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rdk_doc/Advanced_development">7. 进阶开发</a><button aria-label="折叠侧边栏分类 &#x27;7. 进阶开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/hardware_development">7.1 硬件开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.1 硬件开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/linux_development">7.2 Linux开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.2 Linux开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/03_multimedia_development">7.3 RDK X3 多 媒体开发指南</a><button aria-label="展开侧边栏分类 &#x27;7.3 RDK X3 多媒体开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/04_toolchain_development">7.4 算法工具链开发指南</a><button aria-label="折叠侧边栏分类 &#x27;7.4 算法工具链开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/overview">7.4.1 简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/">7.4.2 进阶指南</a><button aria-label="折叠侧边栏分类 &#x27;7.4.2 进阶指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/environment_config">环境安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/ptq_process">PTQ原理及步骤详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list">模型算子支持列表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/runtime_sample">模型上板运行应用开发说明</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rdk_doc/Advanced_development/toolchain_development/expert/">7.4.3 高阶指南</a><button aria-label="展开侧边栏分类 &#x27;7.4.3 高阶指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/FAQ">8. 常见问题</a><button aria-label="展开侧边栏分类 &#x27;8. 常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rdk_doc/Appendix">9. 附录</a><button aria-label="展开侧边栏分类 &#x27;9. 附录&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rdk_doc/Release_Note/release_note">10. 版本发布</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/rdk_doc/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/Advanced_development"><span>7. 进阶开发</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/04_toolchain_development"><span>7.4 算法工具链开发指南</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/"><span>7.4.2 进阶指南</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">PTQ原理及步骤详解</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>PTQ原理及步骤详解</h1></header>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="PTQ_introduction">简介<a href="#PTQ_introduction" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h3>
<p>模型转换是指将原始浮点模型转换为D-Robotics 混合异构模型的过程。原始浮点模型（文中部分地方也称为浮点模型）是指您通过TensorFlow/PyTorch等DL框架训练得到的可用模型，这个模型的计算精度为float32；混合异构模型是一种适合在D-Robotics 处理器上运行的模型格式。
本章节将反复使用到这两种模型名词，为避免理解歧义，请先理解这个概念再阅读下文。</p>
<p>配合D-Robotics 算法工具链的模型完整开发过程，需要经过 <strong>浮点模型准备</strong>、 <strong>模型验证</strong>、 <strong>模型转换</strong>、 <strong>性能评估</strong> 和 <strong>精度评估</strong> 共五个重要阶段，如下图:</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/model_conversion_flowchart.png" alt="model_conversion_flowchart" class="img_ev3q"></p>
<p><strong>浮点模型准备</strong> 本阶段用来确保原始浮点模型的格式为D-Robotics 模型转换工具支持的格式，原始浮点模型来自于您通过TensorFlow/PyTorch等DL框架训练得到可用模型。具体的浮点模型要求与建议，请阅读<a href="#model_preparation"><strong>浮点模型准备</strong></a>章节内容。</p>
<p><strong>模型验证</strong> 本阶段用来校验原始浮点模型是否满足D-Robotics 算法工具链的要求。D-Robotics 提供 <code>hb_mapper checker</code> 检查工具来完成浮点模型的检查。具体使用方法，请阅读<a href="#model_check"><strong>验证模型</strong></a> 章节内容。</p>
<p><strong>模型转换</strong> 本阶段用来完成浮点模型到D-Robotics 混合异构模型的转换，经过这个阶段，您将得到一个可以在D-Robotics 处理器上运行的模型。D-Robotics 提供 <code>hb_mapper makertbin</code> 转换工具来完成模型优化、量化和编译等关键步骤。具体使用方法，请阅读<a href="#model_conversion"><strong>模型转换</strong></a>章节内容。</p>
<p><strong>性能评估</strong> 本阶段主要用于测评D-Robotics 混合异构模型的推理性能情况，D-Robotics 提供了模型性能评估的工具，您可以使用这些工具验证模型性能是否达到应用要求。具体使用说明，请阅读 <a href="#performance_evaluation"><strong>模型性能分析与调优</strong></a>章节内容。</p>
<p><strong>精度评估</strong> 本阶段主要用于测评D-Robotics 混合异构模型的推理精度情况，D-Robotics 提供了模型精度评估的工具。具体使用说明，请阅读<a href="#accuracy_evaluation"><strong>模型精度分析与调优</strong></a>章节内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model_preparation">模型准备<a href="#model_preparation" class="hash-link" aria-label="模型准备的直接链接" title="模型准备的直接链接">​</a></h3>
<p>基于公开DL框架训练得到的浮点模型是D-Robotics 模型转换工具的输入，目前转换工具支持的DL框架如下：</p>
<table><thead><tr><th><strong>框架</strong></th><th>Caffe</th><th>PyTorch</th><th>TensorFlow</th><th>MXNet</th><th>PaddlePaddle</th></tr></thead><tbody><tr><td><strong>D-Robotics 工具链</strong></td><td>支持</td><td>支持（转ONNX）</td><td>支持（转ONNX）</td><td>支持（转ONNX）</td><td>支持（转ONNX）</td></tr></tbody></table>
<p>以上框架中， Caffe框架导出的caffemodel是直接支持的，PyTorch、TensorFlow和MXNet等DL框架通过转换到ONNX格式间接支持。</p>
<p>对于不同框架到ONNX的转换，目前都有对应的标准化方案，参考如下：</p>
<ul>
<li>
<p>Pytorch2Onnx：PytTorch官方API支持直接将模型导出为ONNX模型，参考链接：
<a href="https://pytorch.org/tutorials/advanced/super_resolution_with_onnxruntime.html%E3%80%82" target="_blank" rel="noopener noreferrer">https://pytorch.org/tutorials/advanced/super_resolution_with_onnxruntime.html。</a></p>
</li>
<li>
<p>Tensorflow2Onnx：基于ONNX社区的onnx/tensorflow-onnx 进行转换，参考链接：
<a href="https://github.com/onnx/tensorflow-onnx%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/onnx/tensorflow-onnx。</a></p>
</li>
<li>
<p>MXNet2Onnx：MXNet官方API支持直接将模型导出为ONNX模型，参考链接：
<a href="https://github.com/dotnet/machinelearning/blob/master/test/Microsoft.ML.Tests/OnnxConversionTest.cs%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/machinelearning/blob/master/test/Microsoft.ML.Tests/OnnxConversionTest.cs。</a></p>
</li>
<li>
<p>更多框架的ONNX转换支持，参考链接：
<a href="https://github.com/onnx/tutorials#converting-to-onnx-format%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/onnx/tutorials#converting-to-onnx-format。</a></p>
</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>关于Pytorch、PaddlePaddle、TensorFlow2框架的模型，我们也提供了如何导出ONNX及模型可视化的教程，请参考：</p><ul>
<li>
<p><a href="https://developer.d-robotics.cc/forumDetail/146177165367615499" target="_blank" rel="noopener noreferrer"><strong>Pytorch导出ONNX及模型可视化教程</strong></a> ；</p>
</li>
<li>
<p><a href="https://developer.d-robotics.cc/forumDetail/146177165367615500" target="_blank" rel="noopener noreferrer"><strong>PaddlePaddle导出ONNX及模型可视化教程</strong></a> ；</p>
</li>
<li>
<p><a href="https://developer.d-robotics.cc/forumDetail/146177165367615501" target="_blank" rel="noopener noreferrer"><strong>TensorFlow2导出ONNX及模型可视化教程</strong></a>  ；</p>
</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ul>
<li>
<p>浮点模型中所使用的算子需要符合D-Robotics 算法工具链的算子约束条件，具体请阅读 <a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list"><strong>模型算子支持列表</strong></a> 章节进行查询。</p>
</li>
<li>
<p>目前转换工具仅支持输出个数小于或等于32的模型进行转换。</p>
</li>
<li>
<p>支持 <code>caffe 1.0</code> 版本的caffe浮点模型和 <code>ir_version≤7</code> , <code>opset=10</code> 、 <code>opset=11</code> 版本的onnx浮点模型量化成D-Robotics 支持的定点模型, onnx模型的ir_version与onnx版本的对应关系请参考<a href="https://github.com/onnx/onnx/blob/main/docs/Versioning.md" target="_blank" rel="noopener noreferrer"><strong>onnx官方文档</strong></a> ；</p>
</li>
<li>
<p>模型输入维度只支持 <code>固定4维</code> 输入NCHW或NHWC（N维度只能为1），例如：1x3x224x224或1x224x224x3， 不支持动态维度及非4维输入；</p>
</li>
<li>
<p>浮点模型中不要包含有 <code>后处理算子</code>，例如：nms算子。</p>
</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model_check">模型验证<a href="#model_check" class="hash-link" aria-label="模型验证的直接链接" title="模型验证的直接链接">​</a></h3>
<p>模型正式转换前，请先使用 <code>hb_mapper checker</code> 工具进行模型验证，确保其符合D-Robotics 处理器的支持约束。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>建议参考使用D-Robotics 模型转换 <code>horizon_model_convert_sample</code> 示例包中的caffe、onnx等示例模型的脚本方法: <code>01_check_X3.sh</code> 或 <code>01_check_Ultra.sh</code>。</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用-hb_mapper-checker-工具验证模型">使用 <code>hb_mapper checker</code> 工具验证模型<a href="#使用-hb_mapper-checker-工具验证模型" class="hash-link" aria-label="使用-hb_mapper-checker-工具验证模型的直接链接" title="使用-hb_mapper-checker-工具验证模型的直接链接">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_mapper checker 工具的使用方式如下：</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_mapper checker --model-type ${model_type} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    --march ${march} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    --proto ${proto} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    --model ${caffe_model/onnx_model} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    --input-shape ${input_node} ${input_shape} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    --output ${output}</span><br></span></code></pre></div></div>
<p>hb_mapper checker 参数解释：</p>
<p>--model-type<br>
用于指定检查输入的模型类型，目前只支持设置 <code>caffe</code> 或者 <code>onnx</code>。</p>
<p>--march
用于指定需要适配的D-Robotics 处理器类型，可设置值为 <code>bernoulli2</code> 和 <code>bayes</code>；RDK X3设置为 <code>bernoulli2</code>，RDK Ultra设置为 <code>bayes</code>，RDK X5设置为 <code>bayes-e</code>。</p>
<p>--proto<br>
此参数仅在 <code>model-type</code> 指定 <code>caffe</code> 时有效，取值为Caffe模型的prototxt文件名称。</p>
<p>--model<br>
在 <code>model-type</code> 被指定为 <code>caffe</code> 时，取值为Caffe模型的caffemodel文件名称。
在 <code>model-type</code>  被指定为 <code>onnx</code> 时，取值为ONNX模型文件名称。</p>
<p>--input-shape<br>
可选参数，明确指定模型的输入shape。
取值为 <code>{input_name} {NxHxWxC/NxCxHxW}</code> ，<code>input_name</code> 与shape之间以空格分隔。
例如模型输入名称为 <code>data1</code>，输入shape为 <code>[1,224,224,3]</code>，
则配置应该为 <code>--input-shape data1 1x224x224x3</code>。
如果此处配置shape与模型内shape信息不一致，以此处配置为准。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>注意一个 <code>--input-shape</code> 只接受一个name和shape组合，如果您的模型有多个输入节点，
在命令中多次配置 <code>--input-shape</code> 参数即可。</p></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_BuS1"><p>--output参数已经废弃，log信息默认存储于 <code>hb_mapper_checker.log</code> 中。</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="检查异常处理">检查异常处理<a href="#检查异常处理" class="hash-link" aria-label="检查异常处理的直接链接" title="检查异常处理的直接链接">​</a></h4>
<p>如果模型检查步骤异常终止或者出现报错信息，则说明模型验证不通过，请根据终端打印或在当前路径下生成的 <code>hb_mapper_checker.log</code> 日志文件确认报错信息和修改建议。</p>
<p>例如：以下配置中含不可识别算子类型 <code>Accuracy</code>：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  layer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: &quot;data&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: &quot;Input&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top: &quot;data&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_param { shape: { dim: 1 dim: 3 dim: 224 dim: 224 } }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  layer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: &quot;Convolution1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: &quot;Convolution&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bottom: &quot;data&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top: &quot;Convolution1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convolution_param {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      num_output: 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      bias_term: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pad: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kernel_size: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stride: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      weight_filler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: &quot;msra&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  layer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: &quot;accuracy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: &quot;Accuracy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bottom: &quot;Convolution3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top: &quot;accuracy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      phase: TEST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre></div></div>
<p>使用 <code>hb_mapper checker</code> 检查这个模型，您会在 <code>hb_mapper_checker.log</code> 中得到如下  信息：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ValueError: Not support layer name=accuracy type=Accuracy</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ul>
<li>如果模型检查步骤异常终止或者出现报错信息，则说明模型验证不通过，请根据终端打印或在当前路径下生成的 <code>hb_mapper_checker.log</code> 日志文件确认报错信息和修改建议，错误信息可以在 <a href="/rdk_doc/FAQ/toolchain#model_convert_errors_and_solutions"><strong>模型量化错误及解决方法</strong></a> 章节来查找错误的解决方法，若以上步骤仍不能排除问题，请联系D-Robotics 技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，我们将在24小时内给您提供支持。</li>
</ul></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="check_result">检查结果解读<a href="#check_result" class="hash-link" aria-label="检查结果解读的直接链接" title="检查结果解读的直接链接">​</a></h4>
<p>如果不存在ERROR，则顺利通  过校验。 <code>hb_mapper checker</code> 工具将直接输出如下信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ==============================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node         ON   Subgraph  Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv1        BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv2_1/dw   BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv2_1/sep  BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv2_2/dw   BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv2_2/sep  BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv3_1/dw   BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv3_1/sep  BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre></div></div>
<p>结果中每行都代表一个模型节点的check情况，每行含Node、ON、Subgraph和Type四列，分别为节点名称、执行节点计算的硬件、节点所属子图和节点映射到的D-Robotics 算子名称。
如果模型在网络结构中出现了CPU计算的算子，hb_mapper checker工具将把这个算子前后连续在BPU计算的部分拆分为两个Subgraph（子图）。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="检查结果的调优指导">检查结果的调优指导<a href="#检查结果的调优指导" class="hash-link" aria-label="检查结果的调优指导的直接链接" title="检查结果的调优指导的直接链接">​</a></h4>
<p>在最理想的情况下，模型网络结构中的算子都应该在BPU上运行，也就是只有一个子图。 如果出现了CPU算子导致拆分多个子图， <code>hb_mapper checker</code> 工具会给出导致CPU算子出现的具体原因，以下给出了分别在RDK X3 和 RDK Ultra上示例模型验证的情况；</p>
<ul>
<li>以下在 <strong>RDK X3</strong> 上运行的Caffe模型出现了Reshape + Pow + Reshape 的结构, 从 <strong>RDK X3</strong> 的算子约束列表中我们可以看到, Reshape 算子目前为在CPU上运行的算子, 而Pow的shape也是非4维的，不符合X3 BPU算子约束条件。</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/model_reshape.png" alt="model_reshape" class="img_ev3q"></p>
<p>因此模型最终检查结果也会出现分段情况, 如下:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  2022-05-25 15:16:14,667 INFO The converted model node information:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node                                    ON   Subgraph  Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conv68                                  BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sigmoid16                               BPU  id(0)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  axpy_prod16                             BPU  id(0)     HzSQuantizedMul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIT_CONV_FOR_eltwise_layer16_add_1     BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prelu49                                 BPU  id(0)     HzPRelu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc1                                     BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc1_reshape_0                           CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/square                        CPU  --        Pow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/sum_pre_reshape               CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/sum                           BPU  id(1)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/sum_reshape_0                 CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/sqrt                          CPU  --        Pow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/expand_pre_reshape            CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/expand                        BPU  id(2)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc1_reshape_1                           CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/expand_reshape_0              CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fc_output/op                            CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>以下在 <strong>RDK Ultra</strong> 上运行的ONNX模型出现了Mul + Add + Mul的结构，从 <strong>RDK Ultra</strong> 的算子约束列表中我们可以看到，Mul和Add算子在五维上是支持BPU运行的，但前提要符合Ultra BPU算子约束条件，不然就会回退到CPU计算。</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/model_reshape_ONNX.png" alt="model_reshape" class="img_ev3q"></p>
<p>因此模型最终检查结果也会出现分段情况，如下:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ====================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node                                    ON   Subgraph  Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_199                             BPU  id(0)     Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transpose_200                           BPU  id(0)     Transpose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sigmoid_201                             BPU  id(0)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Split_202                               BPU  id(0)     Split</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_204                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Add_206                                 CPU  --        Add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_208                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_210                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pow_211                                 BPU  id(1)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_213                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Concat_214                              CPU  --        Concat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_215                             CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_216                                BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_217                             BPU  id(0)     Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transpose_218                           BPU  id(0)     Transpose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sigmoid_219                             BPU  id(0)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Split_220                               BPU  id(0)     Split</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_222                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Add_224                                 CPU  --        Add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_226                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_228                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pow_229                                 BPU  id(2)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_231                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Concat_232                              CPU  --        Concat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_233                             CPU  --        Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_234                                BPU  id(0)     HzSQuantizedConv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_235                             BPU  id(0)     Reshape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transpose_236                           BPU  id(0)     Transpose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sigmoid_237                             BPU  id(0)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Split_238                               BPU  id(0)     Split</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_240                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Add_242                                 CPU  --        Add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_244                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_246                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pow_247                                 BPU  id(3)     HzLut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul_249                                 CPU  --        Mul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Concat_250                              CPU  --        Concat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reshape_251                             CPU  --        Reshape</span><br></span></code></pre></div></div>
<p>根据 hb_mapper checker 给出的提示，一般来说算子运行在BPU上会有更好的性能表现，这里可以将pow、reshape 这类CPU算子从模型中移除，将对应算子的功能放入后处理中计算，从而减少子图数量。</p>
<p>当然，多个子图也不会影响整个转换流程，但会较大程度地影响模型性能，建议尽量调整模型算子到BPU上执行，可参考D-Robotics 处理器算子支持列表中的BPU算子支持列表来做同功能的算子替换或者将模型中的CPU算子移到模型推理的前、后处理中去做CPU计算。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model_conversion">模型转换<a href="#model_conversion" class="hash-link" aria-label="模型转换的直接链接" title="模型转换的直接链接">​</a></h3>
<p>模型转换阶段会完成浮点模型到D-Robotics 混合异构模型的转换，经过这个阶段，您将得到一个可以在D-Robotics 处理器上运行的模型。
在进行转换之前，请确保已经顺利通过了上文的验证模型过程。</p>
<p>模型转换使用 <code>hb_mapper makertbin</code> 工具完成，转换期间会完成模型优化和校准量化等重要过程，校准需要依照模型预处理要求准备校准数据。
为了方便您全面了解模型转换，本节将依次介绍校准数据准备、转换工具使用、转换内部过程解读、转换结果解读和转换产出物解读等内容。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="准备校准数据">准备校准数据<a href="#准备校准数据" class="hash-link" aria-label="准备校准数据的直接链接" title="准备校准数据的直接链接">​</a></h4>
<p>在进行模型转换时，校准阶段会需  要 <strong>100份左右</strong> 标定样本输入，每一份样本都是一个独立的数据文件。
为了确保转换后模型的精度效果，我们希望这些校准样本来自于您训练模型使用的 <strong>训练集或验证集</strong> ，不要使用非常少见的异常样本，例如 <strong>纯色图片、不含任何检测或分类目标的图片等</strong>。</p>
<p>转换配置文件中的 <code>preprocess_on</code> 参数，该参数启用和关闭状态下分别对应了两种不同的预处理样本要求。
(有关参数的详细配置可参考下文校准参数组中相关说明)
<code>preprocess_on</code> 关闭状态下，您需要把取自训练集/验证集的样本做与模型推理（inference）前一样的前处理，
处理完后的校准样本会与原始模型具备一样的数据类型( <code>input_type_train</code> )、尺寸( <code>input_shape</code> )和
layout( <code>input_layout_train</code> )，对于featuremap输入的模型，您可以通过 <code>numpy.tofile</code> 命令将数据保存为float32格式的二进制文件，
工具链校准时会基于 <code>numpy.fromfile</code> 命令进行读取。
例如，使用ImageNet训练的用于分类的原始浮点模型，它只有一个输入节点，输入信息描述如下：</p>
<ul>
<li>输入类型：<code>BGR</code></li>
<li>输入layout：<code>NCHW</code></li>
<li>输入尺寸：<code>1x3x224x224</code></li>
</ul>
<p>使用验证集做模型推理（inference）时的数据预处理如下：</p>
<ol>
<li>图像长宽等比scale,短边缩放到256。</li>
<li><code>center_crop</code> 方法获取224x224大小图像。</li>
<li>按通道减mean。</li>
<li>数据乘以scale系数。</li>
</ol>
<p>针对上述举例模型的样本处理代码如下：</p>
<p>为避免过长代码篇幅，各种简单transformer实现代码未贴出，具体使用请参考<a href="/rdk_doc/FAQ/toolchain#transposetransformer"><strong>transformer使用方法</strong></a> 章节内容。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>建议参考使用D-Robotics 模型转换 <code>horizon_model_convert_sample</code> 示例包中的caffe、onnx等示例模型的预处理步骤方法: <code>02_preprocess.sh</code> 和 <code>preprocess.py</code> 。</p></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  # 本示例使用skimage，如果是opencv会有所区别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 需要您特别注意的是，transformers中并没有体现减mean和乘scale的处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mean和scale操作已经融合到了模型中，请参考下文norm_type/mean_value/scale_value配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def data_transformer():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transformers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 长宽等比scale，短边缩放至256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ShortSideResizeTransformer(short_size=256),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # CenterCrop获取224x224图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CenterCropTransformer(crop_size=224),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # skimage读取结果为NHWC排布，转换为模型需要的NCHW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HWC2CHWTransformer(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # skimage读取结果通道顺序为RGB，转换为模型需要的BGR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RGB2BGRTransformer(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # skimage读取数值范围为[0.0,1.0]，调整为模型需要的数值范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScaleTransformer(scale_value=255)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transformers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # src_image 标定集中的原图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # dst_file 存放  最终标定样本数据的文件名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def convert_image(src_image, dst_file, transformers)：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image = skimage.img_as_float(skimage.io.imread(src_file))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for trans in transformers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image = trans(image)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型指定的input_type_train BGR数值类型是UINT8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image = image.astype(np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 二进制存储标定样本到数据文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image.tofile(dst_file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if __name__ == &#x27;__main__&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 此处表示原始标定图片集合，伪代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    src_images = [&#x27;ILSVRC2012_val_00000001.JPEG&#x27;，...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 此处表示最终标定文件名称（后缀名不限制），伪代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # calibration_data_bgr_f32是您在配置文件中指定的cal_data_dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dst_files = [&#x27;./calibration_data_bgr_f32/ILSVRC2012_val_00000001.bgr&#x27;，...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transformers = data_transformer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for src_image, dst_file in zip(src_images, dst_files):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convert_image(src_image, dst_file, transformers)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p><code>preprocess_on</code> 启用状态下，标定样本使用skimage支持读取的图片格式文件即可。
转换工具读取这些图片后，会将其缩放到模型输入节点要求的尺寸大小，以此结果作为校准的输入。
这样的操作会简单，但是对于量化的精度没有保障，因此我们强烈建议您使用关闭 <code>preprocess_on</code> 的方式。</p><div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>请注意，yaml文件中input_shape参数作用为指定原始浮点模型的输入数据尺寸。若为动态输入模型则可通过这个参数设置转换后的输入大小，而校准数据的shape大小应与input_shape保持一致。</p><p>例如：若原始浮点模型输入节点shape为?x3x224x224（“?”号代表占位符，即该模型第一维为动态输入）, 转换配置文件中设置input_shape: 8x3x224x224，则用户需要准备的每份校准数据大小为 8x3x224x224。
（请知悉，此类输入shape第一维不等于1的模型，不支持通过input_batch参数修改模型batch信息。）</p></div></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="makertbin">使用 hb_mapper makertbin 工具转换模型<a href="#makertbin" class="hash-link" aria-label="使用 hb_mapper makertbin 工具转换模型的直接链接" title="使用 hb_mapper makertbin 工具转换模型的直接链接">​</a></h4>
<p>hb_mapper makertbin提供两种模式，开启 <code>fast-perf</code> 模式和不开启 <code>fast-perf</code> 模式。</p>
<p><code>fast-perf</code> 模式开启后，会在转换过程中生成可以在板端运行最高性能的bin模型，工具内部主要进行以下操作：</p>
<ul>
<li>
<p>将BPU可执行算子尽可能运行在BPU上（若使用 <code>RDK Ultra</code> 和 <code>RDK X5</code> 则可以通过yaml文件中node_info参数指定在BPU上运行的算子， <code>RDK X3</code> 是自动优化，无法通过yaml配置文件指定算子）。</p>
</li>
<li>
<p>删除模型首尾不可删除的CPU算子，包括：Quantize/Dequantize、Transpose、Cast、Reshape等。</p>
</li>
<li>
<p>以性能最高的O3优化等级编译模型。</p>
</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>建议参考使用D-Robotics 模型转换 <code>horizon_model_convert_sample</code> 示例包中的caffe、onnx等示例模型的脚本方法: <code>03_build_X3.sh</code> 或 <code>03_build_Ultra.sh</code>。</p></div></div>
<p>hb_mapper makertbin命令使用方式如下：</p>
<p>不开启 <code>fast-perf</code> 模式：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hb_mapper makertbin --config ${config_file}  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --model-type  ${model_type}</span><br></span></code></pre></div></div>
<p>开启 <code>fast-perf</code> 模式：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hb_mapper makertbin --fast-perf --model ${caffe_model/onnx_model} --model-type ${model_type} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --proto ${caffe_proto} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --march ${march}</span><br></span></code></pre></div></div>
<p>hb_mapper makertbin参数解释：</p>
<p>--help<br>
显示帮助信息并退出。</p>
<p>-c, --config<br>
模型编译的配置文件，为yaml格式，文件名使用.yaml后缀，完整的配置文件模板参考如下章节内容。</p>
<p>--model-type<br>
用于指定转换输入的模型类型，目前支持设置 <code>caffe</code> 或者 <code>onnx</code>。</p>
<p>--fast-perf<br>
开启fast-perf模式，该模式开启后，会在转换过程中生成可以在板端运行最高性能的bin模型，方便您用于后续的模型性能评测。</p>
<p>如您开启了fast-perf模式，还需要进行如下配置：</p>
<p><code>--model</code><br>
Caffe或ONNX浮点模型文件。</p>
<p><code>--proto</code><br>
用于指定Caffe模型prototxt文件。</p>
<p><code>--march</code><br>
BPU的微架构。若使用 <code>RDK X3</code> 则设置为 <code>bernoulli2</code>，若使用 <code>RDK Ultra</code> 则设置为 <code>bayes</code>，若使用 <code>RDK X5</code> 则设置为 <code>bayes-e</code>。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ul>
<li>
<p><code>RDK X3 yaml配置文件</code>，可直接使用<a href="/rdk_doc/FAQ/toolchain#rdk_x3_caffe_yaml_template"><strong>RDK X3 Caffe模型量化yaml文件模板</strong></a> 和<a href="/rdk_doc/FAQ/toolchain#rdk_x3_onnx_yaml_template"><strong>RDK X3 ONNX模型量化yaml文件模板</strong></a>模板文件进行填写。</p>
</li>
<li>
<p><code>RDK Ultra yaml配置文件</code>，可直接使用<a href="/rdk_doc/FAQ/toolchain#rdk_ultra_caffe_yaml_template"><strong>RDK Ultra Caffe模型量化yaml文件模板</strong></a> 和<a href="/rdk_doc/FAQ/toolchain#rdk_ultra_onnx_yaml_template"><strong>RDK Ultra ONNX模型量化yaml文件模板</strong></a>模板文件进行填写。</p>
</li>
<li>
<p><code>RDK X5 yaml配置文件</code>，可直接使用<a href="/rdk_doc/FAQ/toolchain#rdk_x5_caffe_yaml_template"><strong>RDK X5 Caffe模型量化yaml文件模板</strong></a> 和<a href="/rdk_doc/FAQ/toolchain#rdk_x5_onnx_yaml_template"><strong>RDK X5 ONNX模型量化yaml文件模板</strong></a>模板文件进行填写。</p>
</li>
<li>
<p>若 hb_mapper makertbin 步骤异常终止或者出现报错信息，则说明模型转换失败，请根据终端打印或在当前路径下生成的 <code>hb_mapper_makertbin.log</code> 日志文件确认报错信息和修改建议，错误信息可以在 <a href="/rdk_doc/FAQ/toolchain#model_convert_errors_and_solutions"><strong>模型量化错误及解决方法</strong></a>章节来查找错误的解决方法，若以上步骤仍不能排除问题，请联系D-Robotics 技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，我们将在24小时内给您提供支持。</p>
</li>
</ul></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="yaml_config">模型转换yaml配置参数说明<a href="#yaml_config" class="hash-link" aria-label="模型转换yaml配置参数说明的直接链接" title="模型转  换yaml配置参数说明的直接链接">​</a></h4>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>要么是Caffe模型，要么是ONNX模型。即 <code>caffe_model</code> + <code>prototxt</code> 或者 <code>onnx_model</code> 二选一。
即，要么是Caffe模型，要么是ONNX模型。</p></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  # 模型参数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model_parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始Caffe浮点模型描述文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prototxt: &#x27;***.prototxt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始Caffe浮点模型数据模型文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    caffe_model: &#x27;****.caffemodel&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始Onnx浮点模型文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onnx_model: &#x27;****.onnx&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 转换的目标处理器架构，保持默认，D-Robotics RDK X3使用的是bernoulli2架构， RDK Ultra使用的是bayes架构。march: &#x27;bayes&#x27;， RDK X5使用的是bayes-e架构。march: &#x27;bayes-e&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    march: &#x27;bernoulli2&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型转换输出的用于上板执行的模型文件的名称前缀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_model_file_prefix: &#x27;mobilenetv1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型转换输出的结果的存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    working_dir: &#x27;./model_output_dir&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定转换后混合异构模型是否保留输出各层的中间结果的能力,保持默认即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer_out_dump: False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定模型的输出节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_nodes: {OP_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 批量删除某一类型的节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remove_node_type: Dequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 删除指定名称的节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remove_node_name: {OP_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 输入信息参数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始浮点模型的输入节点名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_name: &quot;data&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始浮点模型的输入数据格式（数量/顺序与input_name一致）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_type_train: &#x27;bgr&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始浮点模型的输入数据排布（数量/顺序与input_name一致）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_layout_train: &#x27;NCHW&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 原始浮点模型的输入数据尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shape: &#x27;1x3x224x224&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 网络实际执行时，输入给网络的batch_size, 默认值为1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_batch: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 在模型中添加的输入数据预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    norm_type: &#x27;data_mean_and_scale&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 预处理方法的图像减去的均值, 如果是通道均值，value之间必须  用空格分隔</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mean_value: &#x27;103.94 116.78 123.68&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 预处理方法的图像缩放比例，如果是通道缩放比例，value之间必须用空格分隔</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scale_value: &#x27;0.017&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 转换后混合异构模型需要适配的输入数据格式（数量/顺序与input_name一致）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_type_rt: &#x27;yuv444&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 输入数据格式的特殊制式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_space_and_range: &#x27;regular&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 转换后混合异构模型需要适配的输入数据排布（数量/顺序与input_name一致），若input_type_rt配置为nv12，则此处参数不需要配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_layout_rt: &#x27;NHWC&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 校准参数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  calibration_parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型校准使用的标定样本的存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cal_data_dir: &#x27;./calibration_data&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定校准数据二进制文件的数据存储类型。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cal_data_type: &#x27;float32&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 开启图片校准样本自动处理（skimage read; resize到输入节点尺寸）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #preprocess_on: False  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 校准使用的算法类型, 优先使用的 default 校准算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calibration_type: &#x27;default&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # max 校准方式的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # max_percentile: 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 强制指定OP在CPU上运行，一般不需要配置，在模型精度调优阶段可以开启此功能，用于尝试精度优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #run_on_cpu:  {OP_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 强制指定OP在BPU上运行， 一般不需要配置，在模型性能调优阶段可以开启此功能，用于尝试性能优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run_on_bpu:  {OP_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定是否针对每个channel进行校准</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #per_channel: False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定输出节点的数据精度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #optimization: set_model_output_int8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 编译参数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compiler_parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 编译策略选择</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compile_mode: &#x27;latency&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 是否打开编译的debug信息，保持默认的 False </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    debug: False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型运行核心数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core_num: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型编译的优化等级选择，保持默认的 O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimize_level: &#x27;O3&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定名称为data的输入数据来源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #input_source: {&quot;data&quot;: &quot;pyramid&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定模型的每个function call的最大可连续执行时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #max_time_per_fc: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 指定编译模型时的进程数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #jobs: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 此参数组，无需配置，只在有自定义CPU算子时开启使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #custom_op: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义op的校准方式, 推荐使用注册方式 register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #custom_op_method: register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义OP的实现文件, 多个文件可用&quot;;&quot;分隔, 该文件可由模板生成, 详情见自定义OP相关文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #op_register_files: sample_custom.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义OP实现文件所在的文件夹, 请使用相对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #custom_op_dir: ./custom_op</span><br></span></code></pre></div></div>
<p>配置文件主要包含模型参数组、输入信息参数组、校准参数组和编译参数组。
在您的配置文件中，四个参数组位置都需要存在，具体参数分为可选和必选，可选参数可以不配置。</p>
<p>具体参数的设置形式为： <code>param_name:  &#x27;param_value&#x27;</code> ；
若参数存在多个值时，每个值之间使用 <code>&#x27;;&#x27;</code> 符号进行分隔： <code>param_name:  &#x27;param_value1; param_value2; param_value3&#x27;</code> ；具体配置方法可参考：<code>run_on_cpu: &#x27;conv_0; conv_1; conv12&#x27;</code> 。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><ul>
<li>
<p>当模型为多输入模型时, 建议用户将可选参数（ <code>input_name</code>, <code>input_shape</code> 等）显式的写出, 以免造成参数对应顺序上的错误。</p>
</li>
<li>
<p>在配置march为bayes，即在进行RDK Ultra模型转换时，如您将优化等级optimize_level配置为O3，hb_mapper makerbin默认提供缓存能力。即在您第一次使用hb_mapper makerbin对模型进行编译时，会自动创建缓存文件，后续在您的working_dir不变的情况下，在重复编译时会自动调用此文件，降低您的编译时间。</p>
</li>
<li>
<p>在配置march为bayes-e，即在进行RDK X5模型转换时，如您将优化等级optimize_level配置为O3，hb_mapper makerbin默认提供缓存能力。即在您第一次使用hb_mapper makerbin对模型进行编译时，会自动创建缓存文件，后续在您的working_dir不变的情况下，在重复编译时会自动调用此文件，降低您的编译时间。</p>
</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ul>
<li>请注意，如果设置 <code>input_type_rt</code> 为 <code>nv12</code> 或 <code>yuv444</code> ，则模型的输入尺寸中不能出现奇数。</li>
<li>请注意，目前RDK X3上暂不支持 <code>input_type_rt</code> 为 <code>yuv444</code> 且 <code>input_layout_rt</code> 为 <code>NCHW</code> 组合的场景。</li>
<li>模型转换成功后，若出现符合D-Robotics BPU算子约束条件的OP仍然运行在CPU上，其主要原因是该OP属于被动量化OP，关于被动量化相关内容，请阅读 <a href="https://developer.d-robotics.cc/forumDetail/118364000835765793" target="_blank" rel="noopener noreferrer"><strong>算法工具链中的主动量化和被动量化逻辑</strong></a> 章节。</li>
</ul></div></div>
<p>以下是具体参数信息，参数会比较多，我们依照上述的参数组次序介绍。</p>
<ul>
<li>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="模型参数组">模型参数组<a href="#模型参数组" class="hash-link" aria-label="模型参数组的直接链接" title="模型参数组的直接链接">​</a></h6>
</li>
</ul>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>prototxt</code></td><td><strong>参数作用</strong>：指定Caffe浮点模型的prototxt文件名称。<br><strong>参数说明</strong>：在 <code>hb_mapper makertbin</code>的<code>model-type</code> 为 <code>caffe</code> 时必须配置。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>caffe_model</code></td><td><strong>参数作用</strong>：指定Caffe浮点模型的caffemodel文件名称。<br><strong>参数说明</strong>：在 <code>hb_mapper makertbin</code> 的<code>model-type</code> 为 <code>caffe</code> 时必须配置。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>onnx_model</code></td><td><strong>参数作用</strong>：指定ONNX浮点模型的onnx文件名称。<br><strong>参数说明</strong>：在 <code>hb_mapper makertbin</code> 的<code>model-type</code> 为 <code>onnx</code> 时必须配置。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>march</code></td><td><strong>参数作用</strong>：指定产出混合异构模型需要支持的平台架构。<br><strong>参数说明</strong>：两个可选配置值依次对应RDK X3 和 RDK Ultra 对应的BPU微框架。根据您使用的平台选择。</td><td><strong>取值范围</strong>：<code>bernoulli2</code> 或 <code>bayes</code>。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>output_model_file_prefix</code></td><td><strong>参数作用</strong>：指定转换产出混合异构模型的名称前缀。<br><strong>参数说明</strong>：输出的定点模型文件的名称前缀。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>working_dir</code></td><td><strong>参数作用</strong>：指定模型转换输出的结果的存放目录。<br><strong>参数说明</strong>：若该目录不存在, 则工具会自动创建目录。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：<code>model_output</code>。</td><td>可选</td></tr><tr><td><code>layer_out_dump</code></td><td><strong>参数作用</strong>：指定混合异构模型是否保留输出中间层值的能力。<br><strong>参数说明</strong>：输出中间层的值是调试需要用到的手段，常规状态下请不要开启。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr><tr><td><code>output_nodes</code></td><td><strong>参数作用</strong>：指定模型的输出节点。<br><strong>参数说明</strong>：一般情况下，转换工具会自动识别模型的输出节点。此参数用于支持您指定一些中间层次作为输出。设置值为模型中的具体节点名称，多个值的配置方法请参考前文对 <code>param_value</code> 配置描述。需要您注意的是，一旦设置此参数后，工具将不再自动识别输出节点，您通过此参数指定的节点就是全部的输出。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>remove_node_type</code></td><td><strong>参数作用</strong>：设置删除节点的类型。<br><strong>参数说明</strong>：该参数为隐藏参数，不设置或设置为空不影响模型转换过程。此参数用于支持您设置待删除节点的类型信息。被删除的节点必须在模型的开头或者末尾, 与模型的输入或输出连接。注意：待删除节点会按顺序依次删除，并动态更新模型结构；同时在节点删除前还会判断该节点是否位于模型的输入输出处。因此节点的删除顺序很重要。</td><td><strong>取值  范围</strong>：”Quantize”, “Transpose”, “Dequantize”, “Cast”, “Reshape”。不同类型用”;”分割。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>remove_node_name</code></td><td><strong>参数作用</strong>：设置删除节点的名称。<br><strong>参数说明</strong>：该参数为隐藏参数， 不设置或设置为空不影响模型转换过程。 此参数用于支持您设置待删除节点的名称。被删除的节点必须在模型的开头或者末尾, 与模型的输入或输出连接。注意：待删除节点会按顺序依次删除，并动态更新模型结构；同时在节点删除前还会判断该节点是否位于模型的输入输出处。因此节点的删除顺序很重要。</td><td><strong>取值范围</strong>：无。不同类型用&quot;;&quot;分割。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>set_node_data_type</code></td><td><strong>参数作用</strong>：配置指定op的输出数据类型为int16，此参数 <strong>只支持RDK Ultra和RDK X5配置！</strong> <br> <strong>参数说明</strong>：在模型转换过程中，大多数op的默认输入输出数据类型为int8，通过该参数可以指定特定op的输出数据类型为int16（在满足一定的约束条件下）。int16相关说明详见：<a href="#int16_config"><strong>int16配置说明</strong></a>部分的描述。 <br> <strong>注意：</strong> 该参数相关功能已合并至 <code>node_info</code> 参数中，后续版本计划废弃。</td><td><strong>取值范围</strong>：支持配置int16的算子范围您可参考<a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list"><strong>模型算子支持列表</strong></a>中RDK Ultra 和 RDK X5算子支持约束列表。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>debug_mode</code></td><td><strong>参数作用</strong>：保存用于精度debug分析的校准数据。<br><strong>参数说明</strong>：该参数作用为保存用于精度debug分析的校准数据，数据格式为.npy。该数据通过np.load()可直接送入模型进行推理。若不设置此参数，您也可自行保存数据并使用精度debug工具进行精度分析。</td><td><strong>取值范围</strong>：<code>&quot;dump_calibration_data&quot;</code><br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>node_info</code></td><td><strong>参数作用</strong>：支持配置指定OP的输入输出数据类型为int16以及强制指定算子在CPU或BPU上运行。此参数 <strong>只支持RDK Ultra和RDK X5配置！</strong> <br><strong>参数说明</strong>：基于减少yaml中的参数的原则，我们将 <code>set_node_data_type</code> 、<code>run_on_cpu</code> 和 <code>run_on_bpu</code> 三个参数的能力融合到本参数中，并在此基础上扩充支持配置指定op输入数据类型为int16的能力。<br> <code>node_info</code> 参数使用方式：  <br>- 仅指定OP运行在BPU/CPU上（下以BPU为例，CPU方法一致）：<br> node_info: <code>{ &lt;br/&gt;&quot;node_name&quot;:&lt;br/&gt; { &#x27;ON&#x27;: &#x27;BPU&#x27;, &lt;br/&gt;}  &lt;br/&gt;}</code> <br> - 仅配置节点数据类型： <br> node_info: &#x27;node_name1<!-- -->:int16<!-- -->;node_name2<!-- -->:int16<!-- -->&#x27; <br>  多个值的配置方法请参考 <code>param_value配置 &lt;param_value&gt;</code>。 <br> - 指定OP运行在BPU上，同时配置OP的输入输出数据类型：<br> node_info: <code>{ &lt;br/&gt;&quot;node_name&quot;: { &lt;br/&gt;&#x27;ON&#x27;: &#x27;BPU&#x27;, &lt;br/&gt;&#x27;InputType&#x27;: &#x27;int16&#x27;, &lt;br/&gt;&#x27;OutputType&#x27;: &#x27;int16&#x27;&lt;br/&gt; } &lt;br/&gt;  } </code> <br> &#x27;InputType&#x27;: &#x27;int16&#x27;代表指定算子的所有输入数据类型为int16。 <br>如需指定算子特定输入的InputType，可在InputType后通过指定数字来进行配置。如：<br>&#x27;InputType0&#x27;: &#x27;int16&#x27;代表指定算子的第一个输入数据类型为int16，<br>&#x27;InputType1&#x27;: &#x27;int16&#x27;代表指定算子的第二个输入数据类型为int16，以此类推。<br><strong>注意：</strong> &#x27;OutputType&#x27; 不支持指定算子特定输出的OutputType，配置后对算子的所有输出生效，不支持配置 &#x27;OutputType0&#x27; 、 &#x27;OutputType1&#x27;等。</td><td><strong>取值范围</strong>：支持配置int16的算子范围您可参考<a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list">模型算子支持列表</a>中RDK Ultra 和 RDK X5算子支持约束列表。可指定在CPU或BPU运行的算子需为模型中包含的算子。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr></tbody></table>
<ul>
<li>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="输入信息参数组">输入信息参数组<a href="#输入信息参数组" class="hash-link" aria-label="输入信息参数组的直接链接" title="输入信息参数组的直接链接">​</a></h6>
</li>
</ul>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>input_name</code></td><td><strong>参数作用</strong>：指定原始浮点模型的输入节点名称。<br><strong>参数说明</strong>：浮点模型只有一个输入节点情况时不需要配置。多于一个输入节点时必须配置以保证后续类型及校准数据输入顺序的准确性。多个值的配置方法请参考前文对param_value配置描述。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>input_type_train</code></td><td><strong>参数作用</strong>：指定原始浮点模型的输入数据类型。<br><strong>参数说明</strong>：每一个输入节点都需要配置一个确定的输入数据类型。存在多个输入节点时，设置的节点顺序需要与<code>input_name</code>里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。数据类型的选择请参考： 转换内部过程解读 部分的介绍。</td><td><strong>取值范围</strong>：<code>rgb</code>、<code>bgr</code>、<code>yuv444</code>、<code>gray</code>、<code>featuremap</code>。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>input_layout_train</code></td><td><strong>参数作用</strong>：指定原始浮点模型的输入数据排布。<br><strong>参数说明</strong>：每一个输入节点都需要配置一个确定的输入数据排布， 这个排布必须与原始浮点模型所采用的数据排布相同。存在多个输入节点时， 设置的节点顺序需要与 <code>input_name</code> 里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。什么是数据排布请参考： 转换内部过程解读 部分的介绍。</td><td><strong>取值范围</strong>：NHWC 、 NCHW。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>input_type_rt</code></td><td><strong>参数作用</strong>：转换后混合异构模型需要适配的输入数据格式。<br><strong>参数说明</strong>：这里是指明您需要使用的数据格式， 不要求与原始模型的数据格式一致， 但是需要注意在平台喂给模型的数据是使用这个格式。每一个输入节点都需要配置一个确定的输入数据类型，存在多个输入节点时， 设置的节点顺序需要与<code>input_name</code>里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。数据类型的选择请参考： 转换内部过程解读 部分的介绍。</td><td><strong>取值范围</strong>：<code>rgb</code>、<code>bgr</code>、<code>yuv444</code>、<code>nv12</code>、<code>gray</code>、<code>featuremap</code>。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>input_layout_rt</code></td><td><strong>参数作用</strong>：转换后混合异构模型需要适配的输入数据排布。<br><strong>参数说明</strong>：每一个输入节点都需要配置一个确定的输入数据排布， 这个输入是您希望给混合异构模型指定的排布。不合适的输入数据的排布设置将会影响性能， X3平台建议用户使用 NHWC 格式输入。若input_type_rt配置为nv12，则此处参数不需要配置。存在多个输入节点时，设置的节点顺序需要与<code>input_name</code>里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。什么是数据排布请参考： 转换内部过程解读 部分的介绍。</td><td><strong>取值范围</strong>：<code>NCHW</code>、 <code>NHWC</code>。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>input_space_and_range</code></td><td><strong>参数作用</strong>：指定输入数据格式的特殊制式。<br><strong>参数说明</strong>：这个参数是为了适配不同ISP输出的yuv420格式， 在相应 input_type_rt 为 nv12 时，该配置才有效。regular 就是常见的yuv420格式，数值范围为 [0,255]；bt601_video 是另一种视频制式yuv420，数值范围为 [16,235]。更多信息可以通过网络资料了解bt601， 在没有明确需要的情况下，您不要配置此参数。</td><td><strong>取值范围</strong>：<code>regular</code> , <code>bt601_video</code>。<br> <strong>默认配置</strong>：<code>regular</code>。</td><td>可选</td></tr><tr><td><code>input_shape</code></td><td><strong>参数作用</strong>：指定原始浮点模型的输入数据尺寸。<br><strong>参数说明</strong>：shape的几个维度以 x 连接，例如 1x3x224x224。原始浮点模型只有一个输入节点情况时可以不配置， 工具会自动读取模型文件中的尺寸信息。配置多个输入节点时，设置的节点顺序需要与<code>input_name</code>里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>input_batch</code></td><td><strong>参数作用</strong>：指定转换后混合异构模型需要适配的输入batch数量。<br><strong>参数说明</strong>：这里input_batch为转换后混合异构bin模型输入batch数量， 但不影响转换后onnx的模型的输入batch数量。此参数不配置时默认为1。此参数仅适用于单输入模型，且<code>input_shape</code>第一维必须为1。</td><td><strong>取值范围</strong>：<code>1-128</code>。<br> <strong>默认配置</strong>：<code>1</code>。</td><td>可选</td></tr><tr><td><code>norm_type</code></td><td><strong>参数作用</strong>：在模型中添加的输入数据预处理方法。<br><strong>参数说明</strong>：<code>no_preprocess</code> 表示不添加任何数据预处理；<code>data_mean</code> 表示提供减均值预处理；<code>data_scale</code> 表示提供乘scale系数预处理；<code>data_mean_and_scale</code> 表示提供先减均值再乘scale系数前处理。输入节点时多于一个时，设置的节点顺序需要与<code>input_name</code>里的顺序严格保持一致。多个值的配置方法请参考前文对<code>param_value</code>配置描述。配置该参数的影响请参考： 转换内部过程解读 部分的介绍。</td><td><strong>取值范围</strong>：<code>data_mean_and_scale</code> 、 <code>data_mean</code> 、<code>data_scale</code> 、 <code>no_preprocess</code>。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>mean_value</code></td><td><strong>参数作用</strong>：指定预处理方法的图像减去的均值。<br><strong>参数说明</strong>：当 <code>norm_type</code> 存在 <code>data_mean_and_scale</code> 或 data_mean 时需要配置该参数。对于每一个输入节点而言，存在两  种配置方式。第一种是仅配置一个数值，表示所有通道都减去这个均值；第二种是提供与通道数量一致的数值（这些数值以空格分隔开）， 表示每个通道都会减去不同的均值。配置的输入节点数量必须与 norm_type 配置的节点数量一致， 如果存在某个节点不需要 mean 处理，则为该节点配置 <code>&#x27;None&#x27;</code>。多个值的配置方法请参考前文对<code>param_value</code>配置描述。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>scale_value</code></td><td><strong>参数作用</strong>：指定预处理方法的数值scale系数。<br><strong>参数说明</strong>：当 <code>norm_type</code> 存在 <code>data_mean_and_scale</code> 或 <code>data_scale</code> 时需要配置该参数。对于每一个输入节点而言，存在两种配置方式。第一种是仅配置一个数值，表示所有通道都乘以这个系数；第二种是提供与通道数量一致的数值（这些数值以空格分隔开）， 表示每个通道都会乘以不同的系数。配置的输入节点数量必须与 <code>norm_type</code> 配置的节点数量一致， 如果存在某个节点不需要 <code>scale</code> 处理，则为该节点配置 <code>&#x27;None&#x27;</code>。多个值的配置方法请参考前文对 <code>param_value</code> 配置描述。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr></tbody></table>
<p><strong>input_type_rt/input_type_train补充说明</strong></p>
<p>RDK X5的计算平台架构，在设计时为了提升性能，做了两点假设：</p>
<ol>
<li>
<p>假设输入的数据都是int8的量化数据。</p>
</li>
<li>
<p>摄像头获取到的数据是nv12。</p>
</li>
</ol>
<p>因此，如果您在模型训练时使用rgb(NCHW)输入格式，但是想使这个模型能够高效处理nv12数据，只需要在模型转换时做如下配置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  input_parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      input_type_rt: &#x27;nv12&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      input_type_train: &#x27;rgb&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      input_layout_train: &#x27;NCHW&#x27;</span><br></span></code></pre></div></div>
<p><strong>小技巧：</strong></p>
<ul>
<li>
<p>若您在训练模型时使用gray格式，而实际使用中输入的数据格式为nv12格式，则可以将模型转换时的 <code>input_type_rt</code> 及 <code>input_type_train</code> 均配置为 <code>gray</code>，在嵌入式应用开发时仅使用nv12的y通道地址作为输入即可。</p>
</li>
<li>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="校准参数组">校准参数组<a href="#校准参数组" class="hash-link" aria-label="校准参数组的直接链接" title="校准参数组的直接链接">​</a></h6>
</li>
</ul>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>cal_data_dir</code></td><td><strong>参数作用</strong>：指定模型校准使用的标定样本的存放目录。<br><strong>参数说明</strong>：目录内校准数据需要符合输入配置的要求。具体请参考 准备校准数据 部分的介绍。配置多个输入节点时， 设置的节点顺序需要与 <code>input_name</code> 里的顺序严格保持一致。多个值的配置方法请参考前文对 <code>param_value</code> 配置描述。当calibration_type为 <code>load</code>, <code>skip</code> 时，cal_data_dir不用填。注意： 为了方便您的使用，如果未发现cal_data_type的配置，我们将根据文件夹 后缀对数据类型进行配置。如果文件夹后缀以 <code>_f32</code> 结尾，则认为数据 类型是float32，否则认为数据类型是uint8。当然，我们强烈建议您通过cal_data_type参数对数据类型进行约束。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>cal_data_type</code></td><td><strong>参数作用</strong>：指定校准数据二进制文件的数据存储类型。<br><strong>参数说明</strong>：指定模型校准时使用的二进制文件的数据存储类型。没有指定值的情况下将会使用文件夹名字后缀来做判断。</td><td><strong>取值范围</strong>：<code>float32</code>、<code>uint8</code>。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>preprocess_on</code></td><td><strong>参数作用</strong>：开启图片校准样本自动处理。<br><strong>参数说明</strong>：该选项仅适用于4维图像输入的模型， 非4维模型不要打开该选项。在启动该功能时，cal_data_dir 目录下存放的都是jpg/bmp/png 等图片数据，工具会使用skimage读取图片， 并resize到输入节点需要的尺寸。为了保证校准的效果，建议您保持该参数关闭。使用的影响请参考 准备校准数据 部分的介绍。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>： <code>False</code>。</td><td>可选</td></tr><tr><td><code>calibration_type</code></td><td><strong>参数作用</strong>：校准使用的算法类型。<br><strong>参数说明</strong>：每 <code>kl</code> 和 <code>max</code> 都是公开的校准量化算法， 其基本原理可以通过网络资料查阅。使用 <code>load</code> 方式校准时, qat模型必须是通过plugin导出的的模型。<code>mix</code> 是一个集成多种校准方法的搜索策略，能够自动确定量化敏感节点，并在节点粒度上从不同的校准方法中挑选出最佳方法，最终构建一个融合了多种校准方法优势的组合校准方式。<code>default</code> 是一个自动搜索的策略， 会尝试从系列校准量化参数中获得一个相对效果较好的组合。建议您先尝试 <code>default</code>， 如果最终的精度结果不满足预期， 再根据 精度调优 部分建议配置不同的校准参数。若您只想尝试对模型性能进行验证，但对精度没有要求， 则可以尝试 “skip” 方式进行校准。该方式会使用随机数进行校准， 不需要您准备校准数据，比较适合初次尝试对模型结构进行验证。注意： 使用skip方式时，因使用随机数校准, 得到的模型不可用于精度验证。</td><td><strong>取值范围</strong>：<code>default</code>、<code>mix`、```kl</code>、<code>max</code>、<code>load</code> 和 <code>skip</code>。<br> <strong>默认配置</strong>：<code>default</code>。</td><td>必选</td></tr><tr><td><code>max_percentile</code></td><td><strong>参数作用</strong>：该参数为 <code>max</code> 校准方法的参数，用以调整 <code>max</code> 校准的截取点。<br><strong>参数说明</strong>：此参数仅在 <code>calibration_type</code> 为 <code>max</code> 时有效。常用配置选项有：0.99999/0.99995/0.99990/0.99950/0.99900。建议您先尝试 <code>calibration_type</code> 配置 <code>default</code>， 如果最终的精度结果不满足预期， 再根据 精度调优 部分建议调整该参数。</td><td><strong>取值范围</strong>：<code>0.0</code>~<code>1.0</code> 。<br> <strong>默认配置</strong>：<code>1.0</code> 。</td><td>可选</td></tr><tr><td><code>per_channel</code></td><td><strong>参数作用</strong>：控制是否针对featuremap的每个channel进行校准。<br><strong>参数说明</strong>：<code>calibration_type</code> 设置非default时有效。建议您先尝试 <code>default</code>， 如果最终的精度结果不满足预期， 再根据 精度调优 部分建议调整该参数。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr><tr><td><code>run_on_cpu</code></td><td><strong>参数作用</strong>：强制指定算子在CPU上运行。<br><strong>参数说明</strong>：CPU上虽然性能不及BPU，但是提供的是float精度计算。如果您确定某些算子需要在CPU上计算， 可以通过该参数指定。 设置值为模型中的具体节点名称，多个值的配置方法请参考前文对 <code>param_value</code> 配置描述。<br> <strong>注意：</strong> <strong>RDK Ultra 和 RDK X5</strong> 中该参数相关功能已合并至 <code>node_info</code> 参数中，后续版本计划废弃。<strong>RDK X3</strong> 仍继续使用。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>run_on_bpu</code></td><td><strong>参数作用</strong>：强制指定OP在BPU上运行。<br><strong>参数说明</strong>：为了保证最终量化模型的精度，少部分情况下， 转换工具会将一些具备BPU计算条件的算子放在CPU上运行。如果您对性能有较高的要求，愿意以更多一些量化损失为代价， 则可以通过该参数明确指定算子运行在BPU上。设置值为模型中的具体节点名称， 多个值的配置方法请参考前文对 <code>param_value</code> 配置描述。<br> <strong>注意：</strong> <strong>RDK Ultra 和 RDK X5</strong> 中该参数相关功能已合并至 <code>node_info</code> 参数中，后续版本计划废弃。<strong>RDK X3</strong> 仍继续使用。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>optimization</code></td><td><strong>参数作用</strong>：使模型以 int8/int16 格式输出。<br><strong>参数说明</strong>：指定值为set_model_output_int8时，设置模型为 int8 格式低精度输出；指定值为set_model_output_int16时，设置模型为 int16 格式低精度输出。<br> <strong>注意：</strong>  <strong>RDK X3</strong> 只支持设置set_model_output_int8， <br><strong>RDK Ultra 和 RDK X5</strong> 可设置set_model_output_int8或者set_model_output_int16。</td><td><strong>取值范围</strong>：<code>set_model_output_int8</code> 或者 <code>set_model_output_int16</code> 。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr></tbody></table>
<ul>
<li>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="编译参数组">编译参数组<a href="#编译参数组" class="hash-link" aria-label="编译参数组的直接链接" title="编译参数组的直接链接">​</a></h6>
</li>
</ul>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>compile_mode</code></td><td><strong>参数作用</strong>：编译策略选择。<br><strong>参数说明</strong>：<code>latency</code> 以优化推理时间为目标；bandwidth 以优化ddr的访问带宽为目标。如果模型没有严重超过预期的带宽占用，建议您使用 <code>latency</code> 策略。</td><td><strong>取值范围</strong>：<code>latency</code>、 <code>bandwidth</code>。<br> <strong>默认配置</strong>：<code>latency</code>。</td><td>必选</td></tr><tr><td><code>debug</code></td><td><strong>参数作用</strong>：是否打开编译的debug信息。<br><strong>参数说明</strong>：开启该参数的场景下，模型的静态分析的性能结果将保存在模型中，您可以在模型成功转换后生成的静态性能评估文件html页和hb_perf时产生的html页内，在Layer Details选项卡中查看模型逐层BPU算子的性能信息（包括计算量、计算耗时 和数据搬运耗时）。 默认情况下，建议您保持该参数关闭。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>： <code>False</code>。</td><td>可选</td></tr><tr><td><code>core_num</code></td><td><strong>参数作用</strong>：模型运行核心数。<br><strong>参数说明</strong>：D-Robotics 平台支持利用多个AI加速器核心同时完成一个推理任务， 多核心适用于输入尺寸较大的情况， 理想状态下的双核速度可以达到单核的1.5倍左右。如果您的模型输入尺寸较大，对于模型速度有极致追求， 可以配置 <code>core_num=2</code>。<br> <strong>注意：</strong> <strong>RDK Ultra 和 RDK X5</strong> 该选项尚不支持, 默认配置为1，请勿配置!</td><td><strong>取值范围</strong>：<code>1</code>、 <code>2</code> 。<br> <strong>默认配置</strong>：<code>1</code>。</td><td>可选</td></tr><tr><td><code>optimize_level</code></td><td><strong>参数作用</strong>：模型编译的优化等级选择。<br><strong>参数说明</strong>：优化等级可选范围为 <code>O0</code> ~ <code>O3</code>。<code>O0</code> 不做任何优化, 编译速度最快，优化程度最低。<code>O1</code> - <code>O3</code> 随着优化等级提高， 预期编译后的模型的执行速度会更快， 但是所需编译时间也会变长。正常用于生成和验证性能的模型， 必须使用 <code>O3</code> 级别优化才能保证得到最优性能。某些流程验证或精度调试过程中， 可以尝试使用更低级别优化加快过程速度。</td><td><strong>取值范围</strong>：<code>O0</code> 、 <code>O1</code> 、 <code>O2</code> 、 <code>O3</code>。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>input_source</code></td><td><strong>参数作用</strong>：设置上板bin模型的输入数据来源。<br><strong>参数说明</strong>：这个参数是适配工程环境的选项， 建议您已 经全部完成模型验证后再配置。<code>ddr</code> 表示数据来自内存，<code>pyramid</code> 和 <code>resizer</code> 表示来自处理器上的固定硬件。注意：如果设置为resizer，模型的 h*w 要小于18432。具体在工程环境中如何适配 <code>pyramid</code> 和 <code>resizer</code> 数据源， 此参数配置有点特殊，例如模型输入名称为 data, 数据源为内存(ddr), 则此处应该配置值为 <code>{&quot;data&quot;: &quot;ddr&quot;}</code>。</td><td><strong>取值范围</strong>：<code>ddr</code>, <code>pyramid</code>, <code>resizer</code><br> <strong>默认配置</strong>：无，默认会根据input_type_rt的值从可选范围中自动选择。</td><td>可选</td></tr><tr><td><code>max_time_per_fc</code></td><td><strong>参数作用</strong>：指定模型的每个function-call的最大可连续执行时间(单位us)。<br><strong>参数说明</strong>：编译后的数据指令模型在BPU上进行推理计算时， 它将表现为1个或者多个function-call（BPU的执行粒度）的调用，取值为0代表不做限制。该参数用来限制每个function-call最大的执行时间, 模型只有在单个function-call执行完时才有机会被抢占。详情参见 模型优先级控制 部分的介绍。- 此参数仅用于实现模型抢占功能，如无需实现该功能则可以忽略。<br> - 模型抢占功能仅支持在开发板端实现，不支持PC端模拟器实现。</td><td><strong>取值范围</strong>：<code>0或1000-4294967295</code>。<br> <strong>默认配置</strong>：<code>0</code>。</td><td>可选</td></tr><tr><td><code>jobs</code></td><td><strong>参数作用</strong>：设置编译bin模型时的进程数。<br><strong>参数说明</strong>：在编译bin模型时，用于设置进程数。 一定程度上可提高编译速度。</td><td><strong>取值范围</strong>：<code>机器支持的最大核心数范围内。</code><br> <strong>默认配置</strong>：无。</td><td>可选</td></tr></tbody></table>
<ul>
<li>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="自定义算子参数组">自定义算子参数组<a href="#自定义算子参数组" class="hash-link" aria-label="自定义算子参数组的直接链接" title="自定义算子参数组的直接链接">​</a></h6>
</li>
</ul>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>custom_op_method</code></td><td><strong>参数作用</strong>：自定义算子策略选择。<br><strong>参数说明</strong>：目前仅支持register策略。</td><td><strong>取值范围</strong>：<code>register</code>。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>op_register_files</code></td><td><strong>参数作用</strong>：自定义算子的Python实现文件名称。<br><strong>参数说明</strong>：多个文件可用 <code>;</code> 分隔</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>： 无。</td><td>可选</td></tr><tr><td><code>custom_op_dir</code></td><td><strong>参数作用</strong>：自定义算子的Python实现文件存放路径。<br><strong>参数说明</strong>：设置路径时，请使用相对路径。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="int16_config">RDK Ultra 和 RDK X5 int16配置说明<a href="#int16_config" class="hash-link" aria-label="RDK Ultra 和 RDK X5 int16配置说明的直接链接" title="RDK Ultra 和 RDK X5 int16配置说明的直接链接">​</a></h5>
<p>在模型转换的过程中，模型中的大部分算子都会被量化到int8进行计算，而通过配置 <code>node_info</code> 参数，
可以详细指定某个op的输入/输出数据类型为int16计算（具体支持的算子范围可参考<a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list"><strong>模型算子支持列表</strong></a>章节中的RDK Ultra 和 RDK X5算子支持列表内容。
基本原理如下：</p>
<p>在您配置了某个op输入/输出数据类型为int16后，模型转换内部会自动进行op输入输出上下文（context）int16配置的更新和检查。
例如，当配置op_1输入/输出数据类型为int16时，实际上潜在同时指定了op_1的上/下一个op需要支持以int16计算。
对于不支持的场景，模型转换工具会打印log提示该int16配置组合暂时不被支持并回退到int8计算。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pre_process">预处理HzPreprocess算子说明<a href="#pre_process" class="hash-link" aria-label="预处理HzPreprocess算子说明的直接链接" title="预处理HzPreprocess算子说明的直接链接">​</a></h5>
<p>预处理HzPreprocess算子是D-Robotics 模型转换工具在模型转换过程中根据yaml配置文件生成的一个插在模型输入节点后的预处理算子节点，用来给模型的输入数据做归一化操作，本节主要介绍 <code>norm_type</code> 、 <code>mean_value</code> 、 <code>scale_value</code> 参数变量和模型预处理 HzPreprocess 算子节点生成的说明。</p>
<p><strong>norm_type参数说明</strong></p>
<ul>
<li>
<p>参数作用：此参数为在模型中添加的输入数据预处理方法。</p>
</li>
<li>
<p>参数取值范围及说明：</p>
<ul>
<li><code>no_preprocess</code> 表示不添加任何数据预处理。</li>
<li><code>data_mean</code> 表示提供减均值预处理。</li>
<li><code>data_scale</code> 表示提供乘scale系数预处理。</li>
<li><code>data_mean_and_scale</code> 表示提供先减均值再乘scale系数前处理。</li>
</ul>
</li>
</ul>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>当输入节点大于一个时，设置的节点顺序需要与 <code>input_name</code> 中的顺序严格保持一致。</p></div></div>
<p><strong>mean_value参数说明</strong></p>
<ul>
<li>
<p>参数作用：此参数表示指定预处理方法的图像减去的均值。</p>
</li>
<li>
<p>使用说明：当 <code>norm_type</code> 取值为 <code>data_mean_and_scale</code> 或 <code>data_mean</code> 时需要配置该参数。</p>
</li>
<li>
<p>参数说明：</p>
<ul>
<li>当只有一个输入节点时，仅需要配置一个数值，表示所有通道都减去这个均值。</li>
<li>当有多个节点时，提供与通道数量一致的数值（这些数值以空格分隔开），表示每个通道都会减去不同的均值。</li>
</ul>
</li>
</ul>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ol>
<li>配置的输入节点数量必须与 <code>norm_type</code> 配置的节点数量一致。</li>
<li>如果存在某个节点不需要 <code>mean</code> 处理，则为该节点配置 <code>&#x27;None&#x27;</code>。</li>
</ol></div></div>
<p><strong>scale_value参数说明</strong></p>
<ul>
<li>
<p>参数作用：此参数表示指定预处理方法的数值scale系数。</p>
</li>
<li>
<p>使用说明：当 <code>norm_type</code> 取值为 <code>data_mean_and_scale</code> 或 <code>data_scale</code> 时  需要配置该参数。</p>
</li>
<li>
<p>参数说明：</p>
<ul>
<li>当只有一个输入节点时，仅需要配置一个数值，表示所有通道都乘以这个系数。</li>
<li>当有多个节点时，提供与通道数量一致的数值（这些数值以空格分隔开），表示每个通道都会乘以不同的系数。</li>
</ul>
</li>
</ul>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ol>
<li>配置的输入节点数量必须与 <code>norm_type</code> 配置的节点数量一致。</li>
<li>如果存在某个节点不需要 <code>scale</code> 处理，则为该节点配置 <code>&#x27;None&#x27;</code>。</li>
</ol></div></div>
<p><strong>计算公式及示例说明</strong></p>
<ul>
<li>模型训练时的数据标准化处理计算公式</li>
</ul>
<p>yaml文件中的mean和scale参数与训练时的mean、std需要进行换算。</p>
<p>预处理节点中数据标准化操作的计算方式（即HzPreprocess节点中的计算公式）为<code>norm\_data = ( data − mean ) * scale</code>。</p>
<p>以yolov3为例，其训练时的预处理代码为：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">base_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">/=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">255</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">/=</span><span class="token plain"> std</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BaseTransform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.406</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.456</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.485</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.225</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.224</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.229</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">std </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>则计算公式为：<code>norm\_data= (\frac{data}{255}  −𝑚𝑒𝑎𝑛) * \frac{1}{𝑠𝑡𝑑}</code>，</p>
<p>改写为HzPreprocess节点的计算方式：<code>norm\_data= (\frac{data}{255}  −𝑚𝑒𝑎𝑛) * \frac{1}{𝑠𝑡𝑑} =(data−255𝑚𝑒𝑎𝑛) * \frac{1}{255𝑠𝑡𝑑}</code> ，</p>
<p>则：<code>mean\_yaml = 255 mean、𝑠𝑐𝑎𝑙𝑒\_𝑦𝑎𝑚𝑙=  \frac{1}{255 𝑠𝑡𝑑}</code> 。</p>
<ul>
<li>模型推理时的计算公式</li>
</ul>
<p>通过对yaml配置文件中的配置参数，决定是否加入HzPreprocess节点。
当配置mean/scale时，做模型转换时，会在输入端新增一个HzPreprocess节点，HzPreprocess节点可以理解为对输入数据做了一个conv操作。</p>
<p>HzPreprocess内的计算公式为：<code>((input（取值范围[-128,127]）+ 128) - mean) * scale</code>，其中 <code>weight=scale</code>， <code>bias=(128-mean) * scale</code> 。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ol>
<li>在yaml中添加mean/scale后，就不需要在前处理内添加MeanTransformer和ScaleTransformer。</li>
<li>在yaml中添加mean/scale，会将参数放入到HzPreprocess节点内，HzPreprocess节点为 BPU 节点。</li>
</ol></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="conversion_interpretation">转换内部过程解读<a href="#conversion_interpretation" class="hash-link" aria-label="转换内部过程解读的直接链接" title="转换内部过程解读的直接链接">​</a></h4>
<p>模型转换阶段完成浮点模型到D-Robotics 混合异构模型的转换。为了使得这个异构模型能快速高效地在嵌入式端运行，模型转换重点在解决 <strong>输入数据处理</strong> 和 <strong>模型优化编译</strong> 两个问题，本节会依次围绕这两个重点问题展开。</p>
<p><strong>输入数据处理</strong> D-Robotics X3处理器会为某些特定类型的模型输入通路提供硬件级的支撑方案。
例如：视频通路方面的视频处理子系统，为图像采集提供图像裁剪、缩放和其他图像质量优化功能，这些子系统的输出是YUV420 NV12格式图像，
而算法模型往往是基于bgr/rgb等一般常用图像格式训练得到的。</p>
<p>D-Robotics 针对此种情况提供的解决方案是：</p>
<ul>
<li>
<ol>
<li>每个转换的模型都提供两种描述，一种用于描述原始浮点模型的输入数据（ <code>input_type_train</code> 和 <code>input_layout_train</code> ），另一种则用于描述我们需要对接的处理器的输 入数据（ <code>input_type_rt</code> 和 <code>input_layout_rt</code> ）。</li>
</ol>
</li>
<li>
<ol start="2">
<li>图像数据的mean/scale也是比较常见的操作，但YUV420 NV12等处理器支持的数据格式不适合这样的操作，因此，我们也将这些常见图像前处理固化到了模型中。</li>
</ol>
</li>
</ul>
<p>经过以上两种方式处理后，模型转换阶段产出的 <code>***.bin</code> 异构模型的输入部分将变成如下图状态。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/input_data_process.png" alt="input_data_process" class="img_ev3q"></p>
<p>上图中的数据排布就只有NCHW和NHWC两种数据排布格式，N代表数量、C代表channel、H代表高度、W代表宽度，
两种不同的排布体现的是不同的内存访问特性。在TensorFlow模型NHWC较常用，Caffe中就都使用NCHW，
D-Robotics 处理器不会限制使用的数据排布，但是有两条要求：第一是 <code>input_layout_train</code> 必须与原始模型的数据排布一致；第二是在处理器上准备好与 <code>input_layout_rt</code> 一致排布的数据，正确的数据排布是顺利解析数据的基础。</p>
<p>模型转换工具会根据 <code>input_type_rt</code> 和 <code>input_type_train</code> 指定的数据格式自动添加数据转换节点，根据D-Robotics 的实际使用经验，
并不是任意类型组合都是需要的，为了避免您误用，我们只开放了一些固定的类型组合，如下表：</p>
<table><thead><tr><th><code>input_type_train</code> \ <code>input_type_rt</code></th><th>nv12</th><th>yuv444</th><th>rgb</th><th>bgr</th><th>gray</th><th>featuremap</th></tr></thead><tbody><tr><td>yuv444</td><td>Y</td><td>Y</td><td>N</td><td>N</td><td>N</td><td>N</td></tr><tr><td>rgb</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>bgr</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>gray</td><td>N</td><td>N</td><td>N</td><td>N</td><td>Y</td><td>N</td></tr><tr><td>featuremap</td><td>N</td><td>N</td><td>N</td><td>N</td><td>N</td><td>Y</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>表格中第一行是 <code>input_type_rt</code> 中支持的类型，第一列是 <code>input_type_train</code> 支持的类型，
其中的 <strong>Y/N</strong> 表示是否支持相应的 <code>input_type_rt</code> 到 <code>input_type_train</code> 的转换。
在模型转换得到的最终产出bin模型中， <code>input_type_rt</code> 到 <code>input_type_train</code> 是一个内部的过程，
您只需要关注 <code>input_type_rt</code> 的数据格式即可。
<strong>正确理解每种</strong> <code>input_type_rt</code> <strong>的要求，对于嵌入式应用准备推理数据很重要，以下是对</strong>
<code>input_type_rt</code> <strong>每种格式的说明：</strong></p><ul>
<li>rgb、bgr和gray都是比较常见的图像格式，注意每个数值都采用UINT8表示。</li>
<li>yuv444是一种常见的图像格式，注意每个数值都采用UINT8表示。</li>
<li>nv12是常见的yuv420图像格式，每个数值都采用UINT8表示。</li>
<li>nv12有个比较特别的情况是 <code>input_space_and_range</code> 设置 <code>bt601_video</code>
（参考前文对 <code>input_space_and_range</code> 参数的介绍），较于常规nv12情况，它的数值范围由[0,255]变成了[16,235]，
每个数值仍然采用UINT8表示。</li>
<li>featuremap输入模型的数据格式type只要求您的数据是四维的，每个数值采用float32表示。例如：雷达和语音等模型处理就常用这个格式。</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>校准数据只需处理到input_type_train即可，同时也要注意 <strong>不要做重复的norm操作</strong>。</p><p>以上 <code>input_type_rt</code> 与 <code>input_type_train</code> 是固化在算法工具链的处理流程中，如果您非常确定不需要转换，
可将两个 <code>input_type</code> 设置成相同的配置，这样 <code>input_type</code> 会做直通处理，不会影响模型的实际执行性能。</p><p>同样的，数据前处理也是固化在流程中，如果您不需要做任何前处理，通过 <code>norm_type</code> 配置关闭这个功能即可，不会影响模型的实际执行性能。</p></div></div>
<p><strong>模型优化编译</strong> 完成了模型解析、模型优化、模型校准与量化、模型编译几个重要阶段，其内部工作过程如下图所示。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/model_optimization.png" alt="model_optimization" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><ol>
<li>
<p><code>input_type_rt*</code> 表示input_type_rt的中间格式。</p>
</li>
<li>
<p>X3处理器架构只支持推理 <code>NHWC</code> 的数据，请用可视化工具Netron查看 <code>quantized_model.onnx</code> 输入节点的数据排布，决定是否要在预处理中增加 <code>layout转换</code>。</p>
</li>
</ol></div></div>
<p><strong>模型解析阶段</strong> 对于Caffe浮点模型会完成到ONNX浮点模型的转换。
在原始浮点模型上会根据转换配置yaml文件中的配置参数决定是否加入数据预处理节点，此阶段产出一个original_float_model.onnx。
这个ONNX模型计算精度仍然是float32，但在输入部分加入了一个数据预处理节点。</p>
<p>理想状态下，这个预处理节点应该完成 <code>input_type_rt</code> 到 <code>input_type_train</code> 的完整转换，
实际情况是整个type转换过程会配合D-Robotics 处理器硬件完成，ONNX模型里面并没有包含硬件转换的部分。
因此ONNX的真实输入类型会使用一种中间类型，这种中间类型就是硬件对 <code>input_type_rt</code> 的处理结果类型，
数据layout(NCHW/NHWC)会保持原始浮点模型的输入layout一致。
每种 <code>input_type_rt</code> 都有特定的对应中间类型，如下表：</p>
<table><thead><tr><th><strong>nv12</strong></th><th><strong>yuv444</strong></th><th><strong>rgb</strong></th><th><strong>bgr</strong></th><th><strong>gray</strong></th><th>featuremap</th></tr></thead><tbody><tr><td>yuv444_128</td><td>yuv444_128</td><td>RGB_128</td><td>BGR_128</td><td>GRAY_128</td><td>featuremap</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>表格中第一行加粗部分是 <code>input_type_rt</code> 指定的数据类型，第二行是特定 <code>input_type_rt</code> 对应的中间类型，
这个中间类型就是original_float_model.onnx的输入类型。每个类型解释如下：</p><ul>
<li>yuv444_128 是yuv444数据减去128结果，每个数值采用int8表示。</li>
<li>RGB_128 是RGB数据减去128的结果，每个数值采用int8表示。</li>
<li>BGR_128 是BGR数据减去128的结果，每个数值采用int8表示。</li>
<li>GRAY_128 是gray数据减去128的结果，每个数值采用int8表示。</li>
<li>featuremap 是一个四维张量数据，每个数值采用float32表示。</li>
</ul></div></div>
<p><strong>模型优化阶段</strong> 实现模型的一些适用于D-Robotics 平台的算子优化策略，例如BN融合到Conv等。
此阶段的产出是一个optimized_float_model.onnx，这个ONNX模型的计算精度仍然是float32，经过优化后不会影响模型的计算结果。
模型的输入数据要求还是与前面的original_float_model一致。</p>
<p><strong>模型校准阶段</strong> 会使用您提供的校准数据来计算必要的量化阈值参数，这些参数会直接输入到量化阶段，不会产生新的模型状态。</p>
<p><strong>模型量化阶段</strong> 使用校准得到的参数完成模型量化，此阶段的产出是一个quantized_model.onnx。
这个模型的计算精度已经是int8，使用这个模型可以评估到模型量化带来的精度损失情况。
这个模型要求输入的基本数据格式和layout仍然与 <code>original_float_model</code> 一样，不过layout和数值表示已经发 生了变化，
整体较于 <code>original_float_model</code> 输入的变化情况描述如下：</p>
<ul>
<li><code>RDK X3</code> 的数据layout均使用NHWC。</li>
<li>当 <code>input_type_rt</code> 的取值为非 <code>featuremap</code> 时，则输入的数据类型均使用INT8，
反之， 当 <code>input_type_rt</code> 取值为 <code>featuremap</code> 时，则输入的数据类型则为float32。</li>
</ul>
<p>数据排布layout关系对应如下例：</p>
<ul>
<li>原模型输入layout：NCHW。</li>
<li>input_layout_train： NCHW。</li>
<li>origin.onnx输入layout：NCHW。</li>
<li>calibrated_model.onnx输入layout：NCHW。</li>
<li>quanti.onnx输入layout：NHWC。</li>
</ul>
<p>即：input_layout_train、origin.onnx、calibrated_model.onnx输入的layout与原模型输入的layout一致。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>请注意，如果input_type_rt为nv12时，对应quanti.onnx的输入layout都是NHWC。</p></div></div>
<p><strong>模型编译阶段</strong> 会使用D-Robotics 模型编译器，将量化模型转换为D-Robotics 平台支持的计算指令和数据，
这个阶段的产出一个 <code>***.bin</code> 模型，这个bin模型就是可在D-Robotics 嵌入式平台运行的模型，也就是模型转换的最终产出结果。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="转换结果解读">转换结果解读<a href="#转换结果解读" class="hash-link" aria-label="转换结果解读的直接链接" title="转换结果解读的直接链接">​</a></h4>
<p>本节将依次介绍模型转换成功状态的解读、转换不成功的分析方法。
确认模型转换成功，需要您从 <code>makertbin</code> 状态信息、相似度信息和 <code>working_dir</code> 产出三个方面确认。
<code>makertbin</code> 状态信息方面，转换成功将在控制台输出信息尾部给出明确的提示信息如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  2021-04-21 11:13:08,337 INFO Convert to runtime bin file successfully!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2021-04-21 11:13:08,337 INFO End Model Convert</span><br></span></code></pre></div></div>
<p>相似度信息也存在于 <code>makertbin</code> 的控制台输出内容中，在 <code>makertbin</code> 状态信息之前，其内容形式如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ======================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node    ON   Subgraph  Type     Cosine Similarity  Threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ```bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...    ...     ...     ...       0.999936           127.000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...    ...     ...     ...       0.999868           2.557209</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...    ...     ...     ...       0.999268           2.133924</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...    ...     ...     ...       0.996023           3.251645</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...    ...     ...     ...       0.996656           4.495638</span><br></span></code></pre></div></div>
<p>上面列举的输出内容中，Node、ON、Subgraph、Type与 <code>hb_mapper checker</code> 工具的解读是一致的，
请参考前文 <a href="#check_result"><strong>检查结果解读</strong></a>；
Threshold是每个层次的校准阈值，用于异常状态下向D-Robotics 技术支持反馈信息，正常状况下不需要关注；
Cosine Similarity一列反映的是Node列中对应算子的原始浮点模型与量化模型输出结果的余弦相似度。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>一般情况下， <strong>模型的输出节点 Cosine Similarity &gt;= 0.99 可认为此模型量化正常</strong>，输出节点的相似度低于0.8就有了较明显的精度损失， 当然Cosine Similarity只是指明量化后数据稳定性的一种参考方式，对于模型精度的影响不存在明显的直接关联关系，
完全准确的精度情况还需要您阅读<a href="#accuracy_evaluation"><strong>模型精度分析与调优</strong></a>的内容。</p></div></div>
<p>转换产出存放在转换配置参数 <code>working_dir</code> 指定的路径中，成功完成模型转换后，
您可以在该目录下得到以下文件(***部分是您通过转换配置参数 <code>output_model_file_prefix</code> 指定的内容)：</p>
<ul>
<li>***_original_float_model.onnx</li>
<li>***_optimized_float_model.onnx</li>
<li>***_calibrated_model.onnx</li>
<li>***_quantized_model.onnx</li>
<li>***.bin</li>
</ul>
<p><a href="#conversion_output"><strong>转换产出物解读</strong></a>介绍了每个产出物的用途。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>在上板运行前，我们建议您完成<a href="#performance_evaluation"><strong>模型性能分析与调优</strong></a>介绍的模型性能&amp;精度评测过程，避免将模型转换问题延伸到后续嵌入式端。</p></div></div>
<p>如果以上验证模型转换成功的三个方面中，有任一个出现缺失都说明模型转换出现了错误。
一般情况下，<code>makertbin</code> 工具会在出现错误时将错误信息输出至控制台，
例如：我们在Caffe模型转换时不配置yaml文件中的 <code>prototxt</code> 和 <code>caffe_model</code> 参数，模型转换工具给出如下提示。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-04-21 14:45:34,085 ERROR Key &#x27;model_parameters&#x27; error:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Missing keys: &#x27;caffe_model&#x27;, &#x27;prototxt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-04-21 14:45:34,085 ERROR yaml file parse failed. Please double check your input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-04-21 14:45:34,085 ERROR exception in command: makertbin</span><br></span></code></pre></div></div>
<p>如果控制台输出日志信息不能帮助您发现问题，请参考<a href="/rdk_doc/FAQ/toolchain#model_convert_errors_and_solutions"><strong>模型量化错误及解决方法</strong></a>章节内容进行查找，若以上步骤仍不能排除问题，请联系D-Robotics 技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，我们将在24小时内给您提供支持。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="conversion_output">转换产出物解读<a href="#conversion_output" class="hash-link" aria-label="转换产出物解读的直接链接" title="转换产出物解读的直接链接">​</a></h4>
<p>上文提到模型成功转换的产出物包括以下四个部分，本节将介绍每个产出物的用途：</p>
<ul>
<li>***_original_float_model.onnx</li>
<li>***_optimized_float_model.onnx</li>
<li>***_calibrated_model.onnx</li>
<li>***_quantized_model.onnx</li>
<li>***.bin</li>
</ul>
<p>***_original_float_model.onnx的产出过程可以参考<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a>的介绍，
这个模型计算精度与转换输入的原始浮点模型是一模一样的，有个重要的变化就是为了适配D-Robotics 平台添加了一些数据预处理计算（增加了一个预处理算子节点 <code>HzPreprocess</code>, 可以使用netron工具打开onnx模型查看,此算子的详情可查看<a href="#pre_process"><strong>预处理HzPreprocess算子说明</strong></a> 内容）。
一般情况下，您不需要使用这个模型，若在转换结果出现异常时，通过上文介绍的定位方法仍不能解决您的问题，请将这个模型提供给D-Robotics 的技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，将有助于帮助您快速解决问题。</p>
<p>***_calibrated_model.onnx的产出过程可以参考<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a>的介绍，
这个模型是模型转换工具链将浮点模型经过结构优化后，通过校准数据计算得到的每个节点对应的量化参数并将其保存在校准节点中得到的中间产物。</p>
<p>***_optimized_float_model.onnx的产出过程可以参考<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a> 的介绍，
这个模型经过一些算子级别的优化操作，常见的就是算子融合。
通过与original_float模型的可视化对比，您可以明显看到一些算子结构级别的变化，不过这些都不影响模型的计算精度。
一般情况下，您不需要使用这个模型，若在转换结果出现异常时，通过上文介绍的定位方法仍不能解决您的问题，请将这个模型提供给D-Robotics 的技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，将有助于帮助您快速解决问题。</p>
<p>***_quantized_model.onnx的产出过程可以参考<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a> 的介绍，
这个模型已经完成了校准和量化过程，量化后的模型精度损失情况，可以阅读下文模型精度分析与调优内容来评估此模型。
这个模型是精度验证过程中必须要使用的模型，具体使用方式请参考<a href="#accuracy_evaluation"><strong>模型精度分析与调优</strong></a>的介绍。</p>
<p>***.bin就是可以用于在D-Robotics 处理器上加载运行的模型，
配合 上板运行(runtime)应用开发说明 章节介绍的内容，
您就可以将模型快速在D-Robotics 处理器上部署运行。不过为了确保模型的性能与精度效果是符合您的预期的，
我们建议完成<a href="#model_conversion"><strong>模型转换</strong></a>和<a href="#accuracy_evaluation"><strong>模型精度分析与调优</strong></a>
介绍的性能和精度分析过程后再进入到应用开发和部署。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>通常在模型转换阶段完成后就可以得到在D-Robotics 处理器上运行的模型，但是为了确保您得到的模型性能和精度都是符合应用要求的，D-Robotics 建议每次转换后都完成后续的性能评估与精度评估步骤。</p><p>模型转换过程会生成onnx模型, 该模型均为中间产物, 只是便于用户验证模型精度情况, 因此不保证其在版本间的兼容性。 若使用示例中的评测脚本对onnx模型进行单张图片评测或在测试集上评测时, 请用当前版本工具重新生成的onnx模型进行操作。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance_evaluation">模型性能分析<a href="#performance_evaluation" class="hash-link" aria-label="模型性能分析的直接链接" title="模型性能分析的直接链接">​</a></h3>
<p>本节介绍如何使用D-Robotics 提供的工具来评估模型性能，使用这些工具可以得到与实际上板执行基本一致的性能效果，如果发现评估结果不符合预期，建议您尽量根据D-Robotics 提供的优化建议解决性能问题，不要将模型的性能问题延伸到应用开发阶段。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_perf">开发机评测性能<a href="#hb_perf" class="hash-link" aria-label="开发机评测性能的直接链接" title="开发机评测性能的直接链接">​</a></h4>
<p>使用 <code>hb_perf</code> 工具评测模型性能，使用方式如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_perf  ***.bin</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>如果分析的是 <code>pack</code> 后的模型，需要加上一个 <code>-p</code> 参数，命令为 <code>hb_perf -p ***.bin</code>。
关于模型 <code>pack</code>，请查看其他模型工具(可选)部分的介绍。</p></div></div>
<p>命令中的 ***.bin是模型转换步骤生成的定点模型，命令执行完成后，在当前目录下生成 <code>hb_perf_result</code> 文件夹，里边包含具体的模型分析结果。
以下是示例模型MobileNetv1的评测结果：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_perf_result/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └── mobilenetv1_224x224_nv12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── MOBILENET_subgraph_0.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── MOBILENET_subgraph_0.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1_224x224_nv12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1_224x224_nv12.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1_224x224_nv12.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └── temp.hbm</span><br></span></code></pre></div></div>
<p>通过浏览器打开 <code>mobilenetv1_224x224_nv12.html</code> 主页面，其内容如下图：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/hb_mapper_perf_2.png" alt="hb_mapper_perf_2" class="img_ev3q"></p>
<p>分析结果主要由Model Performance Summary、Details和BIN Model Structure三个部分组成。
Model Performance Summary是bin模型的整体性能评估结果，其中各项指标为:</p>
<ul>
<li>Model Name——模型名称。</li>
<li>Model Latency(ms)——模型整体单帧计算耗时(单位为ms)。</li>
<li>Total DDR (loaded+stored) bytes per frame(MB per frame)——模型整体BPU部分数据加载和存储所占用的DDR总量（单位为MB/frame）。</li>
<li>Loaded Bytes per Frame——模型运行每帧读取数据量。</li>
<li>Stored Bytes per Frame——模型运行每帧存储数据量。</li>
</ul>
<p>BIN Model Structure部分提供的是bin模型的子图级可视化结果，图中深青色节点表示运行在BPU上的节点，灰色节点表示在CPU上计算的节点。</p>
<p>在查看Details和BIN Model Structure时，您需要了解子图（subgraph）的概念。
如果模型网络结构中出现CPU计算的算子，模型转换工具会将CPU算子前后连续在BPU计算的部分拆分为两个独立的子图（subgraph）。
具体可以参考 <a href="#model_check"><strong>验证模型</strong></a> 部分的介绍。</p>
<p>Details是每个模型BPU子图的具体信息，在 <code>mobilenetv1_224x224_nv12.html</code> 主页面中，子图的各项指标为：</p>
<ul>
<li>Model Subgraph Name——子图名称。</li>
<li>Model Subgraph Calculation Load (OPpf)——子图的单帧计算量。</li>
<li>Model Subgraph DDR Occupation(Mbpf)——子图的单帧读写数据量（单位为MB）。</li>
<li>Model Subgraph Latency(ms)——子图的单帧计算耗时（单位为ms）。</li>
</ul>
<p>每个子图结果都提供了详细的参考信息说明。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>参考信息说明页面会根据您是否启用调试配置，从而有所区别，
下图中的Layer Details仅当在yaml配置文件中设置 <code>debug</code> 参数为 <code>True</code> 时才可以拿到，
这个 <code>debug</code> 参数配置方法请参考<a href="#makertbin"><strong>使用 hb_mapper makertbin 工具转换模型</strong></a>部分的介绍。</p></div></div>
<p>Layer Details提供具体算子级别的分析，在模型调试分析阶段可以作为参考，例如：如果是某些BPU算子导致模型性能低，通过分析结果帮助您定位到具体的算子。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/layer_details.png" alt="layer_details" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p><code>hb_perf</code> 工具分析的结果可以帮助您了解bin模型的子图结构，以及模型中的BPU计算部分的静态分析指标；需要特别注意分析结果中不含CPU部分的计算评估，如果需要CPU计算的性能情况，请在开发板上实测模型性能。</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="开发板实测性能">开发板实测性能<a href="#开发板实测性能" class="hash-link" aria-label="开发板实测性能的直接链接" title="开发板实测性能的直接链接">​</a></h4>
<p>开发板上快速评测模型性能，请使用 <code>hrt_model_exec perf</code> 工具， 可直接在开发板上评测模型的推理性能、获取模型信息等。</p>
<p>使用 <code>hrt_model_exec perf</code> 工具前，请准备：</p>
<ol>
<li>
<p>确保您已经参考系统更新章节完成了开发板系统的更新。</p>
</li>
<li>
<p>需要将Ubuntu开发机上得到的bin模型拷贝到开发板上（建议放在/userdata目录），
开发板上是一个Linux系统，可以通过 <code>scp</code> 等Linux系统常用方式完成这个拷贝过程。</p>
</li>
</ol>
<p><code>hrt_model_exec perf</code> 工具命令如下（<strong>注意是在开发板上执行</strong>）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./hrt_model_exec perf --model_file mobilenetv1_224x224_nv12.bin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --model_name=&quot;&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --core_id=0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --frame_count=200 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --perf_time=0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --thread_num=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      --profile_path=&quot;.&quot;</span><br></span></code></pre></div></div>
<p>hrt_model_exec perf参数解析：</p>
<p>model_file：<br>
需要分析性能的bin模型名称。</p>
<p>model_name:<br>
需要分析性能的bin模型名字。若 <code>model_file</code> 只含一个模型，则可以省略。</p>
<p>core_id:<br>
默认值 <code>0</code>，运行模型使用的核心id，<code>0</code> 代表任意核心，<code>1</code> 代表核心0，<code>2</code> 代表核心1。若要分析双核极限帧率，请将此处设为 <code>0</code>。</p>
<p>frame_count：<br>
默认值 <code>200</code>，设置推理帧数，工具会执行指定次数后再分析平均耗时。 当 <code>perf_time</code> 为 <code>0</code> 时生效。</p>
<p>perf_time:<br>
默认值 <code>0</code>，单位分钟。设置推理时间，工具会执行指定时间后再分析平均耗时。</p>
<p>thread_num：<br>
默认值 <code>1</code>，设置运行的线程数，取值范围 <code>[1,8]</code>。若要分析极限帧率，请将线程数改大。</p>
<p>profile_path：<br>
默认关闭，统计工具日志产生路径。该参数引入的分析结果会存放在指定目录下的profiler.log和profiler.csv文件中。</p>
<p>下述示例是在 <strong>RDK X3</strong> 开发板实测结果，命令执行完成后，您将在控制台得到如下日志：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Running condition:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Thread number is: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Frame count   is: 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  core number   is: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Program run time: 818.985000 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Perf result:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Frame totally latency is: 800.621155 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Average    latency    is: 4.003106 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Frame      rate       is: 244.204717 FPS</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>评估结果中 <code>Average latency</code> 和 <code>Frame rate</code>，分别表示平均单帧推理延时和模型极限帧率。
如果想获得模型在板子上运行的极限帧率，请尝试调节 <code>thread_num</code> 的数值，并调节出最优线程数值，不同的数值会输出不同的性能结果。</p></div></div>
<p>控制台得到的信息只有整体情况，通过设置 <code>profile_path</code> 参数产生的node_profiler.log文件记录了更加丰富的模型性能信息：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;perf_result&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;FPS&quot;: 244.20471681410527,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;average_latency&quot;: 4.003105640411377</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;running_condition&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;core_id&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;frame_count&quot;: 200,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;model_name&quot;: &quot;mobilenetv1_224x224_nv12&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;run_time&quot;: 818.985,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;thread_num&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">***</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;chip_latency&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;BPU_inference_time_cost&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 3.42556,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;model_latency&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;BPU_MOBILENET_subgraph_0&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 3.42556,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 3.823,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 3.057</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Dequantize_fc7_1_HzDequantize&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.12307,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.274,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.044</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;MOBILENET_subgraph_0_output_layout_convert&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.025945,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.069,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.012</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Preprocess&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.009245,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.027,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.003</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Softmax_prob&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.13366999999999998,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.338,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;task_latency&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;TaskPendingTime&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.04952,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.12,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.009</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;TaskRunningTime&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 3.870965,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 4.48,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 3.219</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}  &quot;max_time&quot;: 3.823,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 3.057</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;CPU_inference_time_cost&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.29193,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.708,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;model_latency&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;BPU_MOBILENET_subgraph_0&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 3.42556,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 3.823,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 3.057</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Dequantize_fc7_1_HzDequantize&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.12307,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.274,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.044</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;MOBILENET_subgraph_0_output_layout_convert&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.025945,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.069,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.012</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Preprocess&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.009245,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.027,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.003</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Softmax_prob&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.13366999999999998,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.338,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;task_latency&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;TaskPendingTime&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 0.04952,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 0.12,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 0.009</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;TaskRunningTime&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;avg_time&quot;: 3.870965,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;max_time&quot;: 4.48,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;min_time&quot;: 3.219</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>上述日志内容对应到<a href="#hb_perf"><strong>使用hb_perf工具估计性能</strong></a>中的BIN Model Structure部分介绍的bin可视化图中，
图中每个节点都有对应的节点在profiler.log文件中，可以通过 <code>name</code> 对应起来，另外，profiler.log文件中也记录出每个节点的执行时间，对优化模型算子提供参考，由于模型中的BPU节点对输入输出有特殊要求，如特殊的layout和padding对齐要求，因此需要对BPU节点的输入、输出数据进行处理。</p>
<ul>
<li><code>Preprocess</code>：表示对模型输入数据进行padding和layout转换操作，其耗时统计在Preprocess中。</li>
<li><code>xxxx_input_layout_convert</code>： 表示对BPU节点的输入数据进行padding和layout转换的操作，其耗时统计在xxxx_input_layout_convert中。</li>
<li><code>xxxx_output_layout_convert</code>： 表示对BPU节点输出数据进行去掉padding和layout转换的操作，其耗时统计在xxxx_output_layout_convert中。
<code>profiler</code> 分 析是模型性能调优中经常使用的操作，前文 <a href="#check_result"><strong>检查结果解读</strong></a> 部分提到检查阶段不用过于关注CPU算子，此阶段可以看到CPU算子的具体耗时情况，可以根据对应算子的耗时情况来进行模型性能调优。</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>若模型耗时比较严重，也可以通过以下几种方法来进行性能优化：</p><ol>
<li>单帧单核：一帧数据进来，在一个核上启用模型去运行推理；</li>
<li>单帧双核：模型在编译时就指定为双核模型（yaml配置文件中的 core_num：2），运行后会自动占用两个核的资源，然后一帧数据进来，会拆成两部分分别计算，最后再拼起来。这种模式在一些大模型上优化效果才有比较明显，会降低一定的延迟，小模型反而可能会因为这种双核的调度变慢；</li>
<li>双帧双核：两个核分别启用一个模型，独立处理各自的数据帧，时延不会降低，但帧率差不多可以达到2倍</li>
</ol></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="模型性能优化">模型性能优化<a href="#模型性能优化" class="hash-link" aria-label="模型性能优化的直接链接" title="模型性能优化的直接链接">​</a></h4>
<p>通过以上 性能分析结果，您可能发现模型性能结果不及预期，本章节内容介绍D-Robotics 对提升模型性能的建议与措施，包括检查yaml配置参数、处理CPU算子、高性能模型设计建议、使用D-Robotics 平台友好结构&amp;模型几个方面。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>本章节中部分修改建议可能会影响原始浮点模型的参数空间，因此需要您重训模型，为了避免在性能调优过程中反复调整并训练模型，建议您在得到满意模型性能前，使用随机参数导出模型来验证性能。</p></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="检查影响模型性能的yaml参数">检查影响模型性能的yaml参数<a href="#检查影响模型性能的yaml参数" class="hash-link" aria-label="检查影响模型性能的yaml参数的直接链接" title="检查影响模型性能的yaml参数的直接链接">​</a></h5>
<p>在模型转换的yaml配置文件中，部分参数会实际影响模型的最终性能，请先检查是否已正确按照模型预期配置，
各参数的具体含义和作用，请参考<a href="#compiler_parameters"><strong>编译参数组</strong></a>章节内容。</p>
<ul>
<li><code>layer_out_dump</code>：指定模型转换过程中是否输出模型的中间结果，一般仅用于调试功能。
如果将其配置为 <code>True</code>，则会为每个卷积算子增加一个反量化输出节点，它会显著的降低模型上板后的性能。
所以在性能评测时，务必要将 该参数配置为 <code>False</code>。</li>
<li><code>compile_mode</code>：该参数用于选择模型编译时的优化方向为带宽还是时延，关注性能时请配置为 <code>latency</code>。</li>
<li><code>optimize_level</code>：该参数用于选择编译器的优化等级，实际使用中应配置为 <code>O3</code> 获取最佳性能。</li>
<li><code>core_num</code>：<strong>注意：</strong> 此参数只适用于 <strong>RDK X3</strong>，配置为 <code>2</code> 时可同时调用两个核运行，降低单帧推理延迟，但是也会影响整体的吞吐率。</li>
<li><code>debug</code>：配置为 <code>True</code> 将打开编译器的debug模式，能够输出性能仿真的相关信息，如帧率、DDR 带宽占用等。
一般用于性能评估阶段，在产品化交付时候，可关闭该参数减小模型大小，提高模型执行效率。</li>
<li><code>max_time_per_fc</code>：该参数用于控制编译后的模型数据指令的function-call的执行时长，从而实现模型优先级抢占功能。
设置此参数更改被抢占模型的function-call执行时长会影响该模型的上板性能。</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="处理cpu算子">处理CPU算子<a href="#处理cpu算子" class="hash-link" aria-label="处理CPU算子的直接链接" title="处理CPU算子的直接链接">​</a></h5>
<p>根据 <code>hrt_model_exec perf</code> 工具的评估，若可以确认模型的性能瓶颈是CPU算子导致的，此种情况下，建议您查看<a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list"><strong>模型算子支持列表</strong></a>的内容，确认当前运行在CPU上的算子是否具备BPU支持的能力。</p>
<p>如果该算子在模型算子支持列表中具备BPU支持能力，应该是该算子参数超过了BPU支持的参数约束范围，建议您将相应原始浮点模型计算参数调整到约束范围内。
为了方便您快速知晓超出约束的具体参数，建 议您再使用 <a href="#model_check"><strong>验证模型</strong></a> 部分介绍的方法做一遍检查，工具将会直接给出超出BPU支持范围的参数提示。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>修改原始浮点模型参数对模型计算精度的影响需要您自己把控，例如：Convolution的 <code>input_channel</code> 或 <code>output_channel</code> 超出范围就是一种较典型的情况，减少channel后，使该算子被BPU支持，但只做这一处修改也可能对模型精度产生影响。</p></div></div>
<p>如果算子并不具备BPU支持能力，就需要您根据以下情况做出对应优化操作：</p>
<ul>
<li>
<p>CPU 算子处于模型中部</p>
<p>对于CPU 算子处于模型中部的情况，建议您优先尝试参数调整、算子替换或修改模型。</p>
</li>
<li>
<p>CPU算子处于模型首尾部</p>
<p>对于CPU算子处于模型首尾部的情况，请参考以下示例，下面以量化/反量化节点为例：</p>
<ul>
<li>
<p>对于与模型输入输出相连的节点，可以在yaml文件model_parameters配置组（模型参数组）中增加 <code>remove_node_type</code> 参数，并重新编译模型。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  remove_node_type: &quot;Quantize; Dequantize&quot;</span><br></span></code></pre></div></div>
<p>或使用hb_model_modifier 工具对bin模型进行修改：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier x.bin -a Quantize -a Dequantize</span><br></span></code></pre></div></div>
</li>
<li>
<p>对于下图这种没有与输入输出节点相连的模型，则需要使用hb_model_modifier工具判断相连节点是否支持删除后按照顺序逐个进行删除。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/nodes_connected.png" alt="nodes_connected" class="img_ev3q"></p>
<p>先使用hb_perf工具获取模型结构图片，然后使用以下两条命令可以自上而下移除Quantize节点,
对于Dequantize节点自下而上逐个删除即可，每一步可删除节点的名称可以通过 <code>hb_model_modifier x.bin</code> 进行查看。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier x.bin -r res2a_branch1_NCHW2NHWC_LayoutConvert_Input0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier x_modified.bin -r data_res2a_branch1_HzQuantize</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="高性能模型设计建议">高性能模型设计建议<a href="#高性能模型设计建议" class="hash-link" aria-label="高性能模型设计建议的直接链接" title="高性能模型设计建议的直接链接">​</a></h5>
<p>根据性能评估结果，CPU上耗时占比可能很小，那模型的性能瓶颈就是BPU推理时间过长。
出现这种情况时，表明模型已经使用了所有的BPU的计算器件，因此下一步的可以提升计算资源的利用率来进行性能优化。
因为每种处理器都有自己的硬件特性，算法模型的计算参数是否很好地符合了相应的硬件特性，这些直接决定了模型的计算资源利用率，符合度越高则利用率越高，反之则越低。</p>
<p>本节内容重点介绍D-Robotics 处理器的硬件特性：D-Robotics 提供的是旨在加速CNN（卷积神经网络）的处理器，主要的计算资源都集中在处理各种卷积计算；建议您的模型是以卷积计算为主的模型，因为卷积之外的算子都会导致计算资源的利用率降低，不同OP的造成的性能影响程度不一样。</p>
<ul>
<li>
<p><strong>其他建议</strong></p>
<p>D-Robotics 处理器上的 <code>depthwise convolution</code> 的计算效率接近100%，所以对于 <code>MobileNet类</code> 的模型，BPU具有效率优势。</p>
<p>建议您在模型设计时，尽量让模型BPU段的输入输出维度降低，以减少量化、反量化节点的耗时和硬件的带宽压力。
以典型的分割模型为例，建议将Argmax算子直接合入模型本身，但需注意，只有满足以下条件，Argmax才支持BPU加速：</p>
<ol>
<li>Caffe中的Softmax层默认axis=1，而ArgMax层则默认axis=0，算子替换时要保持axis的一致</li>
<li>Argmax的Channel需小于等于64，否则只能在CPU上计算</li>
</ol>
</li>
<li>
<p><strong>BPU面向高效率模型优化</strong></p>
<p>D-Robotics 处理器的BPU对于 <code>Depthwise Convolution</code> 和 <code>Group Convolution</code> 都做了针对性的优化，所以我们更推荐采用Depthwise+Pointwise 结构的MobileNetv2、EfficientNet_lite， 以及D-Robotics 基于 GroupConv 手工设计自研的 VarGNet 作为模型的 Backbone，以便获得更高的性能收益。</p>
<p>更多的模型结构和业务模型都在持续探索中，我们将提供更加丰富的模型给您作为直接的参考，这些产出将不定期更新至 <a href="https://github.com/HorizonRobotics-Platform/ModelZoo/tree/master%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/HorizonRobotics-Platform/ModelZoo/tree/master。</a>
如果以上依然不能满足您的需要，欢迎在<a href="https://developer.d-robotics.cc" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>发帖与我们取得联系，我们将根据您的具体问题提供更具针对性的指导建议。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="accuracy_evaluation">模型精度分析<a href="#accuracy_evaluation" class="hash-link" aria-label="模型精度分析的直接链接" title="模型精度分析的直接链接">​</a></h3>
<p>基于几十或上百张校准数据实现浮点模型到定点模型转换的PTQ后量化方式，不可避免地会存在一定的精度损失。
D-Robotics 的PTQ转换工具经过大量实际使用经验验证，在筛选出最优的量化参数组合时，大部分情况下，都可以将模型的精度损失保持在 <code>1%</code> 以内。</p>
<p>本节先介绍如何正确地进行模型精度分析，如果通过评估发现不及预期，则可以参考 <strong>精度调优</strong> 小节的内容进行模型精度调优。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="精度分析">精度分析<a href="#精度分析" class="hash-link" aria-label="精度分析的直接链接" title="精度分析的直接链接">​</a></h4>
<p>前文提到模型成功转换的产出物包括以下四个部分：</p>
<ul>
<li>***_original_float_model.onnx</li>
<li>***_optimized_float_model.onnx</li>
<li>***_quantized_model.onnx</li>
<li>***.bin</li>
</ul>
<p>虽然最后的bin模型才是部署到D-Robotics 处理器上的模型，但考虑到方便在Ubuntu/CentOS开发机上快速得到模型精度，我们同时支持使用 ***_quantized_model.onnx 来完成模型的精度测试； ***_quantized_model.onnxquantized模型和X3处理器运行的bin模型具有一致的精度效果。</p>
<p>建议您使用D-Robotics 开发库加载ONNX模型来完成推理，基本流程如下所示：</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ol>
<li>
<p>示例代码不仅适用于quantized模型，对original和optimized模型同样适用，可以根据不同模型的输入类型和layout要求准备数据进行模型推理。</p>
</li>
<li>
<p>建议参考使用D-Robotics 模型转换 <code>horizon_model_convert_sample</code> 示例包中的caffe、onnx等示例模型的精度验证方法: <code>04_inference.sh</code> 和 <code>postprocess.py</code> 。</p>
</li>
</ol></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 加载D-Robotics 依赖库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from horizon_tc_ui import HB_ONNXRuntime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 准备模型运行的feed_dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def prepare_input_dict(input_names):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  feed_dict = dict()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for input_name in input_names:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # your_custom_data_prepare代表您的自定义数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 根据输入节点的类型和layout要求准备数据即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      feed_dict[input_name] = your_custom_data_prepare(input_name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return feed_dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &#x27;__main__&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 创建推理Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sess = HB_ONNXRuntime(model_file=&#x27;***_quantized_model.onnx&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 获取输入节点名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_names = [input.name for input in sess.get_inputs()]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 或</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_names = sess.input_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 获取输出节点名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_names = [output.name for output in sess.get_outputs()]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 或</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_names = sess.output_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 准备模型输入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  feed_dict = prepare_input_dict(input_names)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 开始模型推理，推理的返回值是一个list，依次与output_names指定名称一一对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 输入图像的类型范围为（RGB/BGR/NV12/YUV444/GRAY）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputs = sess.run(output_names, feed_dict, input_offset=128)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 输入数据的类型范围为（FEATURE）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputs = sess.run_feature(output_names, feed_dict, input_offset=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>上述代码中，<code>input_offset</code> 参数默认值为128。 对于有前处理节点的模型, 这里都需要做-128的操作。 如果模型输入前并未添加前处理节点, 则需要将 <code>input_offset</code> 设置为0。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>对于多输入模型：</p><ul>
<li>
<p>如果输入input_type_rt均属于（RGB/BGR/NV12/YUV444/GRAY），可以采用 sess.run 方法做推理。</p>
</li>
<li>
<p>如果输入input_type_rt均属于（FEATUREMAP），可以采用 sess.run_feature 方法做推理。</p>
</li>
<li>
<p>请注意，目前暂不支持输入input_type_rt为FEATUREMAP与非FEATUREMAP的混合类型使用 sess.* 方法做推理。</p>
</li>
</ul></div></div>
<p>此外, <code>your_custom_data_prepare</code> 函数所代表的输入数据准备过程是最容易出现误操作的部分。
相对于您设计&amp;训练原始浮点模型的精度验证过程，建议您在数据预处理后将推理输入数据进行调整：主要  是数据格式（RGB、NV12等）、数据精度（int8、float32等）和数据排布（NCHW或NHWC）。
调整方法是您在模型转换时yaml配置文件中设置的 <code>input_type_train</code>、 <code>input_layout_train</code>、 <code>input_type_rt</code> 和 <code>input_layout_rt</code> 四个参数共同决定，其详细规则请参考<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a> 章节介绍。</p>
<p>例如：使用ImageNet训练的用于分类的原始浮点模型，它只有一个输入节点。这个节点接受BGR顺序的三通道图片，输入数据排布为NCHW。
那么，在原始浮点模型设计&amp;训练阶段，验证集推理模型前做的数据预处理如下：</p>
<ol>
<li>图像长宽等比scale,短边缩放到256。</li>
<li><code>center_crop</code> 方法获取224x224大小图像。</li>
<li>按通道减mean。</li>
<li>数据乘以scale系数。</li>
</ol>
<p>使用D-Robotics 转换这个原始浮点模型时，
<code>input_type_train</code> 设置 <code>bgr</code>、 <code>input_layout_train</code> 设置 <code>NCHW</code>、 <code>input_type_rt</code> 设置 <code>bgr</code>、
<code>input_layout_rt</code> 设置 <code>NHWC</code>。
根据<a href="#conversion_interpretation"><strong>转换内部过程解读</strong></a> 部分介绍的规则， ***_quantized_model.onnx接受的输入应该为bgr_128、NHWC排布。
对应到前文的示例代码， <code>your_custom_data_prepare</code> 部分提供的数据处理过程如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 本示例使用skimage，如果是opencv会有所区别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 需要您特别注意的是，transformers中并没有体现减mean和乘scale的处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># mean和scale操作已经融合到了模型中，参考前文norm_type/mean_value/scale_value配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def your_custom_data_prepare_sample(image_file):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #skimage读取图片，已经是NHWC排布</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = skimage.img_as_float(skimage.io.imread(image_file))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 长宽等比scale，短边缩放至256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = ShortSideResize(image, short_size=256)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # CenterCrop获取224x224图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = CenterCrop(image, crop_size=224)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # skimage读取结果通道顺序为RGB，转换为bgr_128需要的BGR顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = RGB2BGR(image)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 如果原模型是 NCHW 输入（input_type_rt为nv12除外）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if layout == &quot;NCHW&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image = HWC2CHW(image)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # skimage读取数值范围为[0.0,1.0]，调整为bgr需要的数值范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = image * 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # bgr_128是bgr减去128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = image - 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #bgr_128使用int8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image = image.astype(np.int8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return image</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="精度调优">精度调优<a href="#精度调优" class="hash-link" aria-label="精度调优的直接链接" title="精度调优的直接链接">​</a></h4>
<p>基于前文的精度分析工作，如果确定模型的量化精度不符合预期，则主要可分为以下两种情况进行解决：</p>
<ul>
<li>
<ol>
<li>精度有较明显损失（损失大于4%）。
这种问题往往是由于yaml配置不当，校验数据集不均衡等导致的，建议根据D-Robotics 接下来提供的建议逐一排查。</li>
</ol>
</li>
<li>
<ol start="2">
<li>精度损失较小（1.5%~3%）。
排除1导致的精度问题后，如果仍然出现精度有小幅度损失，往往是由于模型自身的敏感性导致，建议使用D-Robotics 提供的精度调优工具进行调优。</li>
</ol>
</li>
<li>
<ol start="3">
<li>在尝试1和2后，如果精度仍无法满足预期，可以尝试使用我们提供的精度debug工具进行进一步尝试。</li>
</ol>
</li>
</ul>
<p>整体精度问题解决流程示意如下图：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/accuracy_problem.png" alt="accuracy_problem" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="精度有明显损失4以上">精度有明显损失（4%以上）<a href="#精度有明显损失4以上" class="hash-link" aria-label="精度有明显损失（4%以上）的直接链接" title="精度有明显损失（4%以上）的直接链接">​</a></h5>
<p>若模型精度损失大于4%，通常是因为yaml配置不当，校验数据集不均衡等导致的，建议依次从pipeline、模型转换配置、一致性检查几个方面进行排查。</p>
<p><strong>pipeline检查</strong></p>
<p>pipeline是指您完成数据预处理、模型转换、模型推理、后处理、精度评测的全过程，这些步骤请根据上文对应章节来进行检查。
在以往的实际问题跟进经验中，我们发现大部分情况是在原始浮点模型训练阶段中有变动，却没有及时更新到模型转换步骤，从而精度验证时导致异常。</p>
<p><strong>模型转换配置检查</strong></p>
<ul>
<li>
<p><code>input_type_rt</code> 和 <code>input_type_train</code> 该参数用来区分转后混合异构模型与原始浮点模型需要的数据格式，需要认真检查是否符合预期，尤其是BGR和RGB通道顺序是否正确。</p>
</li>
<li>
<p><code>norm_type</code>、 <code>mean_value</code>、 <code>scale_value</code> 等参数是否配置正确。通过转换配置可以直接在模型中插入mean和scale操作节点，需要确认是否对校验/测试图片进行了重复的mean和scale操作 <strong>重复预处理是错误的易发区</strong>。</p>
</li>
</ul>
<p><strong>数据处理一致性检查</strong></p>
<p>该部分检查主要针对参考算法工具链开发包示例准备校准数据以及评测代码的用户，主要有以下常见错误：</p>
<ul>
<li>
<p>未正确指定 <code>read_mode</code>：02_preprocess.sh中可通过--read_mode参数指定读图方式，支持 <code>opencv</code> 及 <code>skimage</code>。
此外preprocess.py中亦是通过imread_mode参数设定读图方式，也需要做出修改。使用 skimage的图片读取，得到的是 <code>RGB</code> 通道顺序，取值范围为 <code>0~1</code>，数值类型为 <code>float</code>； 而使用 opencv，得到的是 <code>BGR</code> 通道顺序，取值范围为 <code>0~255</code>，数据类型为 <code>uint8</code>。</p>
</li>
<li>
<p>校准数据集的存储格式设置不正确：目前D-Robotics 采用的是 <code>numpy.tofile</code> 来保存校准数据，这种方式不会保存shape和类型信息；如果input_type_train为 <code>非featuremap</code> 格式，则会通过校准数据存放路径是否包含 “f32” 来判断数据dtype，若包含f32关键字，则按float32解析数据；反之则按uint8解析数据。
此外，为方便用户设置校准数据的解析方式，在X3算法工具链v2.2.3a版本之后，在yaml中新增了参数 <code>cal_data_type</code> 来设置二进制文件的数据存储类型。</p>
</li>
<li>
<p>transformer实现方式不一致：D-Robotics 提供了一系列常见预处理函数，存放在 <code>/horizon_model_convert_sample/01_common/python/data/transformer.py</code> 文件中，部分预处理操作的实现方式可能会有所区别，例如ResizeTransformer，采用的是opencv默认插值方式（linear），
若为其他插值方式可直接修改transformer.py源码，确保与训练时预处理代码保持一致, 具体使用请参考<a href="/rdk_doc/FAQ/toolchain#transposetransformer"><strong>transformer使用方法</strong></a>章节内容。</p>
</li>
<li>
<p>建议您在D-Robotics 算法工具链使用过程中，依然使用原始浮点模型训练验证阶段依赖的数据处理库。
对于鲁棒性较差的模型，不同库实现的功能resize、crop等典型功能都可能引起扰动，进而影响模型精度。</p>
</li>
<li>
<p>校验图片集是否合理设置。校准图片集数量应该在 <code>一百张</code> 左右，同时最好可以覆盖到数据分布的各种场合，例如在多任务或多分类时，校验图片集可以覆盖到各个预测分支或者各个类别。
同时避免偏离数据分布的异常图片（过曝光等）。</p>
</li>
<li>
<p>使用 <code>***_original_float_model.onnx</code> 再验证一遍精度，正常情况下，这个模型的精度应该是与原始浮点模型精度保持 <code>小数点后三到五位对齐</code> 。
如果验证发现不满足这种对齐程度，则表明您的数据处理需要再仔细检查。</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="较小精度损失提升">较小精度损失提升<a href="#较小精度损失提升" class="hash-link" aria-label="较小精度损失提升的直接链接" title="较小精度损失提升的直接链接">​</a></h5>
<p>一般情况下，为降低模型精度调优的难度，建议您优先尝试将 <code>calibration_type</code> 配置为 <code>default</code>。default为自动搜索功能，以第一张校准数据输出节点余弦相似度为依据，从max、max-Percentile 0.99995和KL等校准方法中选取最优的方案，
最终选取的校准方法可关注转换日志中类似 <code>“Select kl method.”</code> 的提示。若自动搜索的精度结果仍然与预期有差距，可尝试以下建议进行调优：</p>
<p><strong>调整校准方式</strong></p>
<ul>
<li>
<p>手动指定 calibration_type，可以选择 <code>kl/max</code>；</p>
</li>
<li>
<p>将 calibration_type 配置为 max，并配置 max_percentile 为不同的分位数（取值范围是0-1之间），我们推荐您优先尝试 0.99999、0.99995、0.9999、0.9995、0.999，通过这五个配置观察模型精度的变化趋势，最终找到一个最佳的分位数；</p>
</li>
<li>
<p>尝试启用 <code>per_channel</code>，可与之前任意校准方式配合使用。</p>
</li>
</ul>
<p><strong>调准校准数据集</strong></p>
<ul>
<li>
<p>可以尝试适当 <code>增加 或减少</code> 数据数量（通常来说检测场景相较于分类场景需要的校准数据要少；此外可以观察模型输出的漏检情况，适当增加对应场景的校准数据）；</p>
</li>
<li>
<p>不要使用纯黑纯白等异常数据，尽量减少使用无目标的背景图作为校准数据；尽可能全面的覆盖典型任务场景，使得校准数据集的分布与训练集近似。</p>
</li>
</ul>
<p><strong>将部分尾部算子回退到 CPU 高精度计算</strong></p>
<ul>
<li>
<p>一般我们仅会尝试将模型输出层的 <code>1～2</code> 个算子回退至 <code>CPU</code>，太多的算子会较大程度影响模型最终性能，判断依据可通过观察模型的 <code>余弦相似度</code>；</p>
</li>
<li>
<p>指定算子运行在 CPU 上请通过yaml文件中的 <code>run_on_cpu</code> 参数，通过指定节点名称将对应算子运行在cpu上（参考示例：run_on_cpu: conv_0）。</p>
</li>
<li>
<p>若run_on_cpu之后模型编译报错，请联系D-Robotics 技术支持团队。</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="精度debug工具">精度Debug工具<a href="#精度debug工具" class="hash-link" aria-label="精度Debug工具的直接链接" title="精度Debug工具的直接链接">​</a></h5>
<p>在尝试了上述两种精度调优方法后，如果您的精度仍无法满足预期，为了方便您定位问题，我们提供了精度debug工具用于协助您定位问题。
该工具能够协助您对校准模型进行节点粒度的量化误差分析，快速定位出现精度异常的节点。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>若您使用的是 <strong>RDK Ultra 和 RDK X5</strong> 产品，那么您也可以通过配置部分op以int16计算来进行尝试精度调优（<strong>RDK X3</strong> 不支持算子int16计算）：</p><p>在模型转换过程中，大部分op默认会以int8的数据计算，在一些场景下部分op使用int8计算会导致精度损失明显。
针对 <strong>RDK Ultra 和 RDK X5</strong> 产品，目前算法工具链已经提供了指定特定op以int16 bit计算的能力，
详情可参考 <a href="#int16_config"><strong>int16配置说明</strong></a> 参数配置的说明。
通过配置量化精度损失敏感op（以余弦相似度为参考）以int16 bit计算，一些场景下可以解决精度损失问题。</p></div></div>
<p>在模型转换的过程中，难免会因为浮点到定点的量化过程而引入精度损失，通常情况下造成精度损失的主要原因可能有以下几点：</p>
<ol>
<li>
<p>模型中的一部分节点对量化比较敏感会引入较大误差，即敏感节点量化问题。</p>
</li>
<li>
<p>模型中各个节点的误差累积导致模型整体出现较大的校准误差，主要包含：权重量化导致的误差累积、激活量化导致的误差累积以及全量量化导致的误差累积。</p>
</li>
</ol>
<p>针对该情况，D-Robotics 提供了精度debug工具用以协助您自主定位模型量化过程中产生的精度问题。
该工具能够协助您对校准模型进行节点粒度的量化误差分析，最终帮助您快速定位出现精度异常的节点。</p>
<p>精度debug工具提供多种分析功能供您使用，例如：</p>
<ul>
<li>
<p>获取节点量化敏感度。</p>
</li>
<li>
<p>获取模型累积误差曲线。</p>
</li>
<li>
<p>获取指定节点的数据分布。</p>
</li>
<li>
<p>获取指定节点输入数据通道间数据分布箱线图等。</p>
</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="使用方法说明">使用方法说明<a href="#使用方法说明" class="hash-link" aria-label="使用方法说明的直接链接" title="使用方法说明的直接链接">​</a></h6>
<p>使用精度debug工具主要有以下几个步骤：</p>
<ol>
<li>
<p>在yaml中的 <strong>模型参数组(model_parameters)</strong> 配置参数 <code>debug_mode=&quot;dump_calibration_data&quot;</code> ，保存校准数据。</p>
</li>
<li>
<p>导入debug模块，加载校准模型和数据。</p>
</li>
<li>
<p>通过精度debug工具提供的API或命令行，对精度损失明显的模型进行分析。</p>
</li>
</ol>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>对于当前版本的精度debug调试工具： <strong>RDK Ultra</strong> 对应的 <code>bayes</code> 架构模型支持命令行和API方式，<strong>RDK X5</strong> 对应的 <code>bayes-e</code> 架构模型支持命令行和API方式， <strong>RDK X3</strong> 对应的 <code>bernoulli2</code> 架构模型只支持API方式进行debug调试。</p></div></div>
<p>整体流程如下图所示：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/accuracy_debug_process.png" alt="accuracy_debug_process" class="img_ev3q"></p>
<ul>
<li><strong>校准模型与数据的保存</strong></li>
</ul>
<p>首先需要在yaml文件中配置 <code>debug_mode=&quot;dump_calibration_data&quot;</code> ，以开启精度debug功能，
并保存校准数据(calibration_data)，对应的校准模型(calibrated_model.onnx)为常态化保存。其中：</p>
<ol>
<li>
<p>校准数据(calibration_data)：在校准阶段，模型通过对这些数据进行前向推理来获取每个被量化节点的量化参数，包括：缩放因子(scale)和阈值(threshold)。</p>
</li>
<li>
<p>校准模型(calibrated_model.onnx)：将在校准阶段计算得到的每个被量化节点的量化参数保存在校准节点中，从而得到校准模型。</p>
</li>
</ol>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p><strong>此处保存的校准数据与02_preprocess.sh生成的校准数据的区别？</strong></p><p><code>02_preprocess.sh</code> 得到的校准数据是bgr颜色空间的数据，在工具链内部会将数据从bgr转换到yuv444/gray等模型实际输入的格式。
而此处保存的校准数据则是经过颜色空间转换以及预处理之后保存的.npy格式的数据，该数据可以通过np.load()直接送入模型进行推理。</p></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p><strong>校准模型(calibrated_model.onnx)解读</strong></p><p>校准模型是模型转换工具链将浮点模型经过结构优化后，通过校准数据计算得到的每个节点对应的量化参数并将其保存在校准节点中得到的中间产物。
校准模型的主要特点是模型中包含校准节点，校准节点的节点类型为HzCalibration。
这些校准节点主要分为两类： <strong>激活(activation)校准节点</strong> 和 <strong>权重(weight)校准节点</strong> 。</p><p><strong>激活校准节点</strong> 的输入是当前节点的上一个节点的输出，并基于当前激活校准节点中保存的量化参数(scales和thresholds)对输入数据进行量化及反量化后输出。</p><p><strong>权重校准节点</strong> 的输入为模型的原始浮点权重，基于当前权重校准节点中保存的量化参数(scales和thresholds)对输入的原始浮点权重进行量化及反量化后输出。</p><p>除却上述的校准节点，校准模型中的其他节点，精度debug工具将其称为 <strong>普通节点(node)</strong> 。
<strong>普通节点</strong> 的类型包括：Conv、Mul、Add等。</p></div></div>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/debug_node.png" alt="debug_node" class="img_ev3q"></p>
<p>calibration_data的文件夹结构如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |--calibration_data ：校准数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |----input.1 ：文件夹名为模型的输入节点并保存对应的输入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |--------0.npy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |--------1.npy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-------- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |----input.2 ：对于多输入模型将保存多个文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |--------0.npy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |--------1.npy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-------- ...</span><br></span></code></pre></div></div>
<ul>
<li><strong>精度debug模块导入与使用</strong></li>
</ul>
<p>接下来需要在代码中导入debug模块，并通过 <code>get_sensitivity_of_nodes</code> 接口获取节点量化敏感度（默认使用模型输出的余弦相似度）。
<code>get_sensitivity_of_nodes</code> 的详细参数说明可见 <code>get_sensitivity_of_nodes</code> 章节内容。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入log日志模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 若verbose=True时，需要先设置log level为INFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging.getLogger().setLevel(logging.INFO)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 获取节点量化敏感度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_message = dbg.get_sensitivity_of_nodes(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metrics=[&#x27;cosine-similarity&#x27;, &#x27;mse&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          output_node=None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          node_type=&#x27;node&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          data_num=None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          verbose=True,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interested_nodes=None)</span><br></span></code></pre></div></div>
<ul>
<li><strong>分析结果展示</strong></li>
</ul>
<p>下方为 <code>verbose=True</code> 时的打印结果：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ==========================node==========================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node        cosine-similarity   mse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_3      0.999009567957658   0.027825591154396534</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_2   0.9993462241612948  0.017706592209064044</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_6      0.9998359175828787  0.004541242333988731</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_5   0.9998616805443397  0.0038416787014844325</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_0      0.9999297948984     0.0019312848587735342</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_19     0.9999609772975628  0.0010773885699633795</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_8      0.9999629625907311  0.0010301886404004807</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_15     0.9999847687207736  0.00041888411550854263</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_12  0.9999853235024673  0.0004039733791544747</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_10     0.999985763659844   0.0004040437432614943</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_17     0.9999913985912616  0.0002379088904350423</span><br></span></code></pre></div></div>
<p>除此之外，该API会以字典(Dict)的形式将节点量化敏感度信息返回给您以供后续使用分析。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Out: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {&#x27;Conv_3&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.999009567957658&#x27;, &#x27;mse&#x27;: &#x27;0.027825591154396534&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_2&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9993462241612948&#x27;, &#x27;mse&#x27;: &#x27;0.017706592209064044&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_6&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9998359175828787&#x27;, &#x27;mse&#x27;: &#x27;0.004541242333988731&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_5&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9998616805443397&#x27;, &#x27;mse&#x27;: &#x27;0.0038416787014844325&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_0&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999297948984&#x27;, &#x27;mse&#x27;: &#x27;0.0019312848587735342&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_19&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999609772975628&#x27;, &#x27;mse&#x27;: &#x27;0.0010773885699633795&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_8&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999629625907311&#x27;, &#x27;mse&#x27;: &#x27;0.0010301886404004807&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_15&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999847687207736&#x27;, &#x27;mse&#x27;: &#x27;0.00041888411550854263&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_12&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999853235024673&#x27;, &#x27;mse&#x27;: &#x27;0.0004039733791544747&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_10&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.999985763659844&#x27;, &#x27;mse&#x27;: &#x27;0.0004040437432614943&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_17&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999913985912616&#x27;, &#x27;mse&#x27;: &#x27;0.0002379088904350423&#x27;}}</span><br></span></code></pre></div></div>
<p>更多功能请参考 <strong>功能说明</strong> 章节。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>精度debug工具还可以通过命令行 <code>hmct-debugger -h/--help</code> 查看每个功能对应的子命令。
各个子命令的详细参数和用法详见 <strong>功能说明</strong> 章节。</p></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="功能说明">功能说明<a href="#功能说明" class="hash-link" aria-label="功能说明的直接链接" title="功能说明的直接链接">​</a></h6>
<ul>
<li><strong>get_sensitivity_of_nodes</strong></li>
</ul>
<p><strong>功能</strong>：获取节点量化敏感度。</p>
<p><strong>命令行格式</strong>：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger get-sensitivity-of-nodes MODEL_OR_FILE CALIBRATION_DATA --other options</span><br></span></code></pre></div></div>
<p>可通过 <code>hmct-debugger get-sensitivity-of-nodes -h/--help</code> 查看相关参数。</p>
<p><strong>参数组</strong>：</p>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>model_or_file</code></td><td><strong>参数作用</strong>：指定校准模型。<br><strong>参数说明</strong>：必选，指定需要分析的校准模型。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>metrics 或 - m</code></td><td><strong>参数作用</strong>：节点量化敏感度的度量方式。   <br><strong>参数说明</strong>：指定节点量化敏感度的计算方式，该参数可以为列表(List)，即以多种方式计算量化敏感度，但是输出结果仅以列表中第一位的计算方式进行排序，排名越靠前说明量化该节点引入的误差越大。</td><td><strong>取值范围</strong>：<code>&#x27;cosine-similarity&#x27;</code> , <code>&#x27;mse&#x27;</code> , <code>&#x27;mre&#x27;</code> , <code>&#x27;sqnr&#x27;</code> , <code>&#x27;chebyshev&#x27;</code> 。<br> <strong>默认配置</strong>：<code>&#x27;cosine-similarity&#x27;</code>。</td><td>可选</td></tr><tr><td><code>calibrated_data</code></td><td><strong>参数作用</strong>：指定校准数据。<br><strong>参数说明</strong>：必选，指定分析所需要的校准数据。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>output_node 或 -o</code></td><td><strong>参数作用</strong>：指定输出节点。<br><strong>参数说明</strong>：此参数支持您指定中间节点作为输出并计算节点量化敏感度。若保持默认参数None，则精度debug工具会获取模型的最终输出，并在此基础上计算节点的量化敏感度。</td><td><strong>取值范围</strong>：校准模型中的具有对应校准节点的普通节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>node_type 或 -n</code></td><td><strong>参数作用</strong>：节点类型。<br><strong>参数说明</strong>：需要计算量化敏感度的节点类型，包括：node（普通节点）、weight（权重校准节点）、activation（激活校准节点）。</td><td><strong>取值范围</strong>：<code>&#x27;node&#x27;</code> , <code>&#x27;weight&#x27;</code> , <code>&#x27;activation&#x27;</code>。<br> <strong>默认配置</strong>：<code>&#x27;node&#x27;</code>。</td><td>可选</td></tr><tr><td><code>data_num 或 -d</code></td><td><strong>参数作用</strong>：计算量化敏感度需要的数据数量。<br><strong>参数说明</strong>：设置计算节点量化敏感度时所需要的数据数量。默认为None，此时默认使用calibration_data中的所有数据进行计算。最小设置为1，最大为 calibration_data中的数据数量。</td><td><strong>取值范围</strong>：大于0，小于等于calibration_data中数据的总数。 <br> <strong>默认配置</strong>：None</td><td>可选</td></tr><tr><td><code>verbose 或 -v</code></td><td><strong>参数作用</strong>：选择是否将信息打印在终端上。<br><strong>参数说明</strong>：若为True，则将量化敏感度信息打印在终端上。若metrics包含多种度量方式，则按照第一位进行排序。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr><tr><td><code>interested_nodes 或 -i</code></td><td><strong>参数作用</strong>：设置感兴趣节点。<br><strong>参数说明</strong>：若指定则只获取该节点的量化敏感度，其余节点不获取。同时，若该参数被指定，将忽视node_type指定的节点类型，也就是说该参数的优先级要高于node_type。若保持默认参数None，则计算模型中所有可被量化节点的量化敏感度。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr></tbody></table>
<p>函数使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入log日志模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 若verbose=True时，需要先设置log level为INFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging.getLogger().setLevel(logging.INFO)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 获取节点量化敏感度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_message = dbg.get_sensitivity_of_nodes(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metrics=[&#x27;cosine-similarity&#x27;, &#x27;mse&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          output_node=None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          node_type=&#x27;node&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          data_num=None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          verbose=True,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interested_nodes=None)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger get-sensitivity-of-nodes calibrated_model.onnx calibration_data -m [&#x27;cosine-similarity&#x27;,&#x27;mse&#x27;] -v True</span><br></span></code></pre></div></div>
<p><strong>分析结果展示</strong>：</p>
<p><strong>描述</strong>：首先您通过node_type设置需要计算敏感度的节点类型，然后工具获取校准模型中所有符合node_type的节点，并获取这些节点的量化敏感度。
当verbose设置为True时，工具会将节点量化敏感度进行排序后打印在终端，排序越靠前，说明该节点量化引入的量化误差越大。</p>
<p>verbose=True时，打印结果如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ==========================node==========================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Node        cosine-similarity   mse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_3      0.999009567957658   0.027825591154396534</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_2   0.9993462241612948  0.017706592209064044</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_6      0.9998359175828787  0.004541242333988731</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_5   0.9998616805443397  0.0038416787014844325</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_0      0.9999297948984     0.0019312848587735342</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_19     0.9999609772975628  0.0010773885699633795</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_8      0.9999629625907311  0.0010301886404004807</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_15     0.9999847687207736  0.00041888411550854263</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxPool_12  0.9999853235024673  0.0004039733791544747</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conv_10     0.999985763659844   0.0004040437432614943</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Gemm_17     0.9999913985912616  0.0002379088904350423</span><br></span></code></pre></div></div>
<p>函数返回值：</p>
<p>函数返回值为以字典格式（Key为节点名称，Value为节点的量化敏感度信息）保存的量化敏感度，格式如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Out: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {&#x27;Conv_3&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.999009567957658&#x27;, &#x27;mse&#x27;: &#x27;0.027825591154396534&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_2&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9993462241612948&#x27;, &#x27;mse&#x27;: &#x27;0.017706592209064044&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_6&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9998359175828787&#x27;, &#x27;mse&#x27;: &#x27;0.004541242333988731&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_5&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9998616805443397&#x27;, &#x27;mse&#x27;: &#x27;0.0038416787014844325&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_0&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999297948984&#x27;, &#x27;mse&#x27;: &#x27;0.0019312848587735342&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_19&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999609772975628&#x27;, &#x27;mse&#x27;: &#x27;0.0010773885699633795&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_8&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999629625907311&#x27;, &#x27;mse&#x27;: &#x27;0.0010301886404004807&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_15&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999847687207736&#x27;, &#x27;mse&#x27;: &#x27;0.00041888411550854263&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;MaxPool_12&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999853235024673&#x27;, &#x27;mse&#x27;: &#x27;0.0004039733791544747&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Conv_10&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.999985763659844&#x27;, &#x27;mse&#x27;: &#x27;0.0004040437432614943&#x27;}, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;Gemm_17&#x27;: {&#x27;cosine-similarity&#x27;: &#x27;0.9999913985912616&#x27;, &#x27;mse&#x27;: &#x27;0.0002379088904350423&#x27;}} ...}</span><br></span></code></pre></div></div>
<ul>
<li><strong>plot_acc_error</strong></li>
</ul>
<p><strong>功能</strong>：只量化浮点模型中的某一个节点，并依次计算该模型与浮点模型中节点输出的误差，获得累积误差曲线。</p>
<p><strong>命令行格式</strong>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-acc-error MODEL_OR_FILE CALIBRATION_DATA --other options</span><br></span></code></pre></div></div>
<p>可通过 <code>hmct-debugger plot-acc-error -h/--help</code> 查看相关参数。</p>
<p><strong>参数组</strong>：</p>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>save_dir 或 -s</code></td><td><strong>参数作用</strong>：保存路径。<br><strong>参数说明</strong>：可选，指定分析结果的保存路径。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>calibrated_data</code></td><td><strong>参数作用</strong>：指定校准数据。 <br><strong>参数说明</strong>：必选，指定需要分析的校准数据。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>： 无。</td><td>必选</td></tr><tr><td><code>model_or_file</code></td><td><strong>参数作用</strong>：指定校准模型。<br><strong>参数说明</strong>：必选，指定需要分析的校准模型。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>quantize_node 或 -q</code></td><td><strong>参数作用</strong>：只量化模型中指定的节点，查看误差累积曲线。<br><strong>参数说明</strong>：可选参数。指定模型中需要量化的节点，同时保证其余节点均不量化。<br>通过判断该参数是否为嵌套列表进而决定是单节点量化还是部分量化。<br>例如：<br>- quantize_node=[&#x27;Conv_2&#x27;,&#x27;Conv_9&#x27;]：分别只量化Conv_2和Conv_9，同时保证其余节点不量化。<br>- quantize_node=[[&#x27;Conv_2&#x27;],[&#x27;Conv_9&#x27;,&#x27;Conv_2&#x27;]]：只量化Conv_2以及同时量化Conv_2和Conv_9，分别测试模型累积误差。<br>- quantize_node 包含两个特殊参数：&#x27;weight&#x27; 和 &#x27;activation&#x27;。<br>当：<br>- quantize_node = [&#x27;weight&#x27;]：只量化权重，不量化激活。<br>- quantize_node = [&#x27;activation&#x27;]：只量化激活，不量化权重。<br>- quantize_node = [&#x27;weight&#x27;,&#x27;activation&#x27;]：权重和激活分别量化。<br>注：quantize_node和non_quantize_node不可同时为None，必须指定其一。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>non_quantize_node 或 -nq</code></td><td><strong>参数作用</strong>：指定累积误差的类型。<br><strong>参数说明</strong>：可选参数。指定模型中不量化的节点，同时保证其余节点全都量化。<br>通过判断该参数是否为嵌套列表进而决定是单节点不量化还是部分量化。<br>例如：<br>- non_quantize_node=[&#x27;Conv_2&#x27;,&#x27;Conv_9&#x27;]：分别解除Conv_2和Conv_9节点的量化，同时保证其余节点全部量化。<br>- non_quantize_node=[[&#x27;Conv_2&#x27;],[&#x27;Conv_9&#x27;,&#x27;Conv_2&#x27;]]：只解除Conv_2量化以及同时解除Conv_2和Conv_9量化，分别测试模型累积误差。 <br>注：quantize_node和non_quantize_node不可同时为None，必须指定其一。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>metric 或 -m</code></td><td><strong>参数作用</strong>：误差度量方式。<br><strong>参数说明</strong>：设置计算模型误差的计算方式。</td><td><strong>取值范围</strong>：<code>&#x27;cosine-similarity&#x27;</code> , <code>&#x27;mse&#x27;</code> , <code>&#x27;mre&#x27;</code> , <code>&#x27;sqnr&#x27;</code> , <code>&#x27;chebyshev&#x27;</code><br> <strong>默认配置</strong>：<code>&#x27;cosine-similarity&#x27;</code>。</td><td>可选</td></tr><tr><td><code>average_mode 或 -a</code></td><td><strong>参数作用</strong>：指定累积误差曲线的输出模式。<br><strong>参数说明</strong>：默认为False。若为True，那么获取累积误差的平均值作为结果。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr></tbody></table>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir: str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data: str or CalibrationDataSet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file: ModelProto or str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantize_node: List or str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          non_quantize_node: List or str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric: str = &#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode: bool = False)</span><br></span></code></pre></div></div>
<p><strong>分析结果展示</strong></p>
<p><strong>1.指定节点量化累积误差测试</strong></p>
<ul>
<li>指定单节点量化</li>
</ul>
<p><strong>配置方式</strong>：quantize_node=[&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]，quantize_node为单列表。</p>
<p>API函数使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantize_node=[&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=False)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-acc-error calibrated_model.onnx calibrated_data -q [&#x27;Conv_2&#x27;,&#x27;Conv_90&#x27;]</span><br></span></code></pre></div></div>
<p><strong>描述</strong>：当quantize_node为单列表时，针对您设置的quantize_node，
分别单独量化quantize_node中的节点并保持模型中其他节点不量化，得到对应的模型后，
对该模型中每个节点的输出计算其与浮点模型中对应节点输出的之间的误差，并得到对应的累积误差曲线。</p>
<p>average_mode = False时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/average_mode_false_1.png" alt="average_mode_false_1" class="img_ev3q"></p>
<p>average_mode = True时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/average_mode_true_1.png" alt="average_mode_true_1" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p><strong>average_mode</strong></p><p>average_mode默认为False。对于一些模型，此时无法通过累积误差曲线判断哪种量化策略更加有效，
因此需要将average_mode设置为True，此时会对前n个节点的累积误差求均值作为第n个节点的累积误差。</p><p>具体计算方式如下，例如：</p><p>average_mode=False时，accumulate_error=[1.0, 0.9, 0.9, 0.8]。</p><p>而将average_mode=True后，accumulate_error=[1.0, 0.95, 0.933, 0.9]。</p></div></div>
<ul>
<li>指定多个节点量化</li>
</ul>
<p><strong>配置方式</strong>：quantize_node=[[&#x27;Conv_2&#x27;], [&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]]，quantize_node为嵌套列表</p>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantize_node=[[&#x27;Conv_2&#x27;], [&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=False)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-acc-error calibrated_model.onnx calibration_data -q [[&#x27;Conv_2&#x27;],[&#x27;Conv_2&#x27;,&#x27;Conv_90&#x27;]]</span><br></span></code></pre></div></div>
<p><strong>描述</strong>：当quantize_node为嵌套列表时，针对您设置的quantize_node，分别量化quantize_node中的
每个单列表指定的节点并保持模型中其他节点不量化，得到对应的 模型后，对该模型中每个节点的输出计算
其与浮点模型中对应节点输出的之间的误差，并得到对应的累积误差曲线。</p>
<ul>
<li>
<p>partial_qmodel_0：只量化Conv_2节点，其余节点不量化；</p>
</li>
<li>
<p>partial_qmodel_1：只量化Conv_2和Conv_90节点，其余节点不量化。</p>
</li>
</ul>
<p>average_mode=False时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/new_average_mode_false_1.png" alt="new_average_mode_false_1" class="img_ev3q"></p>
<p>average_mode=True时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/new_average_mode_true_1.png" alt="new_average_mode_true_1" class="img_ev3q"></p>
<p><strong>2.解除模型部分节点量化后累积误差测试</strong></p>
<ul>
<li>指定单节点不量化</li>
</ul>
<p><strong>配置方式</strong>：non_quantize_node=[&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]，non_quantize_node为单列表。</p>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          non_quantize_node=[&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=True)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-acc-error calibrated_model.onnx calibration_data -nq [&#x27;Conv_2&#x27;,&#x27;Conv_90&#x27;] -a True</span><br></span></code></pre></div></div>
<p><strong>描述</strong>：当non_quantize_node为单列表时，针对您设置的non_quantize_node，
分别解除non_quantize_node中各个节点的量化同时保持其他节点全部量化，得到对应的模型后，
对该模型中每个节点的输出计算其与浮点模型中对应节点输出的之间的误差，并得到对应的累积误差曲线。</p>
<p>average_mode = False时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/average_mode_false_2.png" alt="average_mode_false_2" class="img_ev3q"></p>
<p>average_mode = True时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/average_mode_true_2.png" alt="average_mode_true_2" class="img_ev3q"></p>
<ul>
<li>指定多个节点不量化</li>
</ul>
<p><strong>配置方式</strong>：non_quantize_node=[[&#x27;Conv_2&#x27;], [&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]]，non_quantize_node为嵌套列表。</p>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          non_quantize_node=[[&#x27;Conv_2&#x27;], [&#x27;Conv_2&#x27;, &#x27;Conv_90&#x27;]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=False)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-acc-error calibrated_model.onnx calibration_data -nq [[&#x27;Conv_2&#x27;],[&#x27;Conv_2&#x27;,&#x27;Conv_90&#x27;]]</span><br></span></code></pre></div></div>
<p><strong>描述</strong>：当non_quantize_node为嵌套列表时，针对您设置的non_quantize_node，
分别不量化non_quantize_node中的每个单列表指定的节点并保持模型中其他节点均量化，
得到对应的模型后，对该模型中每个节点的输出计算其与浮点模型中对应节点输出的之间的误差，
并得到对应的累积误差曲线。</p>
<ul>
<li>
<p>partial_qmodel_0：不量化Conv_2节点，其余节点量化；</p>
</li>
<li>
<p>partial_qmodel_1：不量化Conv_2和Conv_90节点，其余节点量化。</p>
</li>
</ul>
<p>average_mode = False时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/new_average_mode_false_2.png" alt="new_average_mode_false_2" class="img_ev3q"></p>
<p>average_mode = True时：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/new_average_mode_true_2.png" alt="new_average_mode_true_2" class="img_ev3q"></p>
<p><strong>测试技巧</strong>：</p>
<p>测试部分量化精度时，您可能会按照量化敏感度排序进行多组量化策略的精度对比，此时可以参考以下用法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 首先使用量化敏感度排序函数获取模型中节点的量化敏感度排序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_message = dbg.get_sensitivity_of_nodes(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metrics=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          output_node=None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          node_type=&#x27;node&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          verbose=False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interested_nodes=None)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # node_message为字典类型，其key值为节点名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodes = list(node_message.keys())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 通过nodes来指定不量化节点，可以方便使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          non_quantize_node=[nodes[:1],nodes[:2]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=True)</span><br></span></code></pre></div></div>
<p><strong>3.激活权重分别量化</strong></p>
<p><strong>配置方式</strong>：quantize_node=[&#x27;weight&#x27;,&#x27;activation&#x27;]。</p>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_acc_error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data/&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          quantize_node=[&#x27;weight&#x27;,&#x27;activation&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metric=&#x27;cosine-similarity&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          average_mode=False)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot_acc_error calibrated_model.onnx calibration_data -q [&#x27;weight&#x27;,&#x27;activation&#x27;]</span><br></span></code></pre></div></div>
<p><strong>描述</strong>：quantize_node也可直接指定&#x27;weight&#x27;或者&#x27;activation&#x27;。当：</p>
<ul>
<li>
<p>quantize_node = [&#x27;weight&#x27;]：只量化权重，不量化激活。</p>
</li>
<li>
<p>quantize_node = [&#x27;activation&#x27;]：只量化激活，不量化权重。</p>
</li>
<li>
<p>quantize_node = [&#x27;weight&#x27;, &#x27;activation&#x27;]：权重和激活分别量化。</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/weight_activation_quantized.png" alt="weight_activation_quantized" class="img_ev3q"></p>
<ul>
<li><strong>plot_distribution</strong></li>
</ul>
<p><strong>功能</strong>：选取节点，分别获取该节点在浮点模型和校准模型中的输出，得到输出数据分布。另外，将两个输出结果做差，获取两个输出之间的误差分布。</p>
<p><strong>命令行格式</strong>：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-distribution MODEL_OR_FILE CALIBRATION_DATA --other options</span><br></span></code></pre></div></div>
<p>可通过 <code>hmct-debugger plot-distribution -h/--help</code> 查看相关参数。</p>
<p><strong>参数组</strong>：</p>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>save_dir 或 -s</code></td><td><strong>参数作用</strong>：保存路径。<br><strong>参数说明</strong>：可选，指定分析结果的保存路径。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>model_or_file</code></td><td><strong>参数作用</strong>：指定校准模型。<br><strong>参数说明</strong>：必选，指定需要分析的校准模型。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>： 无。</td><td>必选</td></tr><tr><td><code>calibrated_data</code></td><td><strong>参数作用</strong>：指定校准数据。<br><strong>参数说明</strong>：必选，指定分析所需要的校准数据。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>nodes_list 或 -n</code></td><td><strong>参数作用</strong>：指定需要分析的节点。<br><strong>参数说明</strong>：必选，指定需要分析的节点。<br>若nodes_list中的节点类型为：<br>- 权重校准节点：绘制原始权重和经过校准之后的权重的数据分布。 <br>- 激活校准节点：绘制激活校准节点的输入数据分布。<br>- 普通节点：绘制该节点在量化前后的输出数据分布，同时绘制二者之间的误差分布。<br>注：nodes_list为 list 类型，可指定一系列节点，并且上述三种类型节点可同时指定。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr></tbody></table>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_distribution(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir: str, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file: ModelProto or str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data: str or CalibrationDataSet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodes_list: List[str] or str) </span><br></span></code></pre></div></div>
<p><strong>分析结果展示</strong>：</p>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.plot_distribution(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir=&#x27;./&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file=&#x27;./calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data=&#x27;./calibration_data&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodes_list=[&#x27;317_HzCalibration&#x27;, # 激活节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      &#x27;471_HzCalibration&#x27;, # 权重节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      &#x27;Conv_2&#x27;]) # 普通节点</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger plot-distribution calibrated_model.onnx calibration_data -n [&#x27;317_HzCalibration&#x27;,&#x27;471_HzCalibration&#x27;,&#x27;Conv_2&#x27;]</span><br></span></code></pre></div></div>
<p>node_output：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/node_output.png" alt="node_output" class="img_ev3q"></p>
<p>weight：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/weight.png" alt="weight" class="img_ev3q"></p>
<p>activation：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/activation.png" alt="activation" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>上方三幅图中，蓝色三角表示：数据绝对值的最大值。红色虚线表示：最小的校准阈值。</p></div></div>
<ul>
<li><strong>get_channelwise_data_distribution</strong></li>
</ul>
<p><strong>功能</strong>：绘制指定校准节点输入数据通道间数据分布的箱线图。</p>
<p><strong>命令行格式</strong>：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger get-channelwise-data-distribution MODEL_OR_FILE CALIBRATION_DATA --other options</span><br></span></code></pre></div></div>
<p>可通过 <code>hmct-debugger get-channelwise-data-distribution -h/--help</code> 查看相关参数。</p>
<p><strong>参数组</strong>：</p>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>save_dir 或 -s</code></td><td><strong>参数作用</strong>：保存路径。<br><strong>参数说明</strong>：可选，指定分析结果的保存路径。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>model_or_file</code></td><td><strong>参数作用</strong>：指定校准模型。 <br><strong>参数说明</strong>：必选，指定需要分析的校准模型。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>： 无。</td><td>必选</td></tr><tr><td><code>calibrated_data</code></td><td><strong>参数作用</strong>：指定校准数据。<br><strong>参数说明</strong>：必选，指定分析所需要的校准数据。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>nodes_list 或 -n</code></td><td><strong>参数作用</strong>：指定校准节点。<br><strong>参数说明</strong>：必选，指定校准节点。</td><td><strong>取值范围</strong>：校准模型中的所有权重校准节点和激活校准节点。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>axis 或 -a</code></td><td><strong>参数作用</strong>：指定channel所在的维度。<br><strong>参数说明</strong>：channel信息所在shape中的位置。参数默认为None，此时对于激活校准节点，默认认为节点输入数据的第二个维度表示channel信息，即axis=1；对于权重校准节点，会读取该节点属性中的axis参数作为channel信息。</td><td><strong>取值范围</strong>：小于节点输入数据的维度。 <br> <strong>默认配置</strong>：None。</td><td>可选</td></tr></tbody></table>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.get_channelwise_data_distribution(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          save_dir: str, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          model_or_file: ModelProto or str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          calibrated_data: str or CalibrationDataSet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodes_list: List[str],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          axis: int = None)</span><br></span></code></pre></div></div>
<p><strong>分析结果展示</strong>：</p>
<p><strong>描述</strong>：针对用户设置的校准节点列表node_list，从参数axis中获取channel所在的维度，获取节点输入数据通道间的数据分布。
其中axis默认为None，此时若节点为权重校准节点，则channel所在的维度默认为0；若节点为激活校准节点，则channel所在的维度默认为1。</p>
<p>权重校准节点：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/weight_calibration_node.png" alt="weight_calibration_node" class="img_ev3q"></p>
<p>激活校准节点：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/activate_calibration_node.png" alt="activate_calibration_node" class="img_ev3q"></p>
<p>输出结果如下图所示：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/box_plot.png" alt="box_plot" class="img_ev3q"></p>
<p>图中：</p>
<ul>
<li>
<p>横坐标表示节点输入数据的通道数，图例中输入数据有96个通道。</p>
</li>
<li>
<p>纵坐标表示每个channel的数据分布范围，其中红色实线表示该channel数据的中位数，蓝色虚线表示均值。</p>
</li>
<li>
<p><strong>runall</strong></p>
</li>
</ul>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>当前版本 runall 功能只适用于 <strong>RDK Ultra 和 RDK X5</strong> 产品。</p></div></div>
<p><strong>功能</strong>：一键运行原本debug工具中的所有功能。</p>
<p><strong>命令行格式</strong>：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger runall MODEL_OR_FILE CALIBRATION_DATA --other options</span><br></span></code></pre></div></div>
<p>可通过 <code>hmct-debugger runall -h/--help</code> 查看相关参数。</p>
<p><strong>参数组</strong>：</p>
<table><thead><tr><th>参数名称</th><th>参数配置说明</th><th>取值范围说明</th><th>可选/必选</th></tr></thead><tbody><tr><td><code>model_or_file</code></td><td><strong>参数作用</strong>：指定校准模型。<br><strong>参数说明</strong>：必选，指定需要分析的校准模型。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>：无。</td><td>必选</td></tr><tr><td><code>calibrated_data</code></td><td><strong>参数作用</strong>：指定校准数据。<br><strong>参数说明</strong>：必选，指定分析所需要的校准数据。</td><td><strong>取值范围</strong>：无。<br> <strong>默认配置</strong>： 无。</td><td>必选</td></tr><tr><td><code>save_dir 或 -s</code></td><td><strong>参数作用</strong>：保存路径。<br><strong>参数说明</strong>：指定分析结果的保存路径。</td><td><strong>取值范围</strong>：无 。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>ns_metrics 或 -nm</code></td><td><strong>参数作用</strong>：节点量化敏感度的度量方式。<br><strong>参数说明</strong>：指定节点量化敏感度的计算方式，该参数可以为列表(List)，即以多种方式计算量化敏感度，但是输出结果仅以列表中第一位的计算方式进行排序，排名越靠前说明量化该节点引入的误差越大。</td><td><strong>取值范围</strong>：<code>&#x27;cosine-similarity&#x27;</code> , <code>&#x27;mse&#x27;</code> , <code>&#x27;mre&#x27;</code> , <code>&#x27;sqnr&#x27;</code> , <code>&#x27;chebyshev&#x27;</code> 。<br> <strong>默认配置</strong>：<code>&#x27;cosine-similarity&#x27;</code>。</td><td>可选</td></tr><tr><td><code>output_node 或 -o</code></td><td><strong>参数作用</strong>：指定输出节点。<br><strong>参数说明</strong>：此参数支持您指定中间节点作为输出并计算节点量化敏感度。若保持默认参数None，则精度debug工具会获取模型的最终输出, 并在此基础上计算节点的量化敏感度。</td><td><strong>取值范围</strong>：校准模型中的具有对应校准节点的普通节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>node_type 或 -nt</code></td><td><strong>参数作用</strong>：节点类型。<br><strong>参数说明</strong>：需要计算量化敏感度的节点类型，包括：node（普通节点）、weight（权重校准节点）、activation（激活校准节点）。</td><td><strong>取值范围</strong>：<code>&#x27;node&#x27;</code> , <code>&#x27;weight&#x27;</code> , <code>&#x27;activation&#x27;</code>。<br> <strong>默认配置</strong>：<code>&#x27;node&#x27;</code>。</td><td>可选</td></tr><tr><td><code>data_num 或 -dn</code></td><td><strong>参数作用</strong>：计算量化敏感度需要的数据数量。<br><strong>参数说明</strong>：设置计算节点量化敏感度时所需要的数据数量。默认为None，此时默认使用calibration_data中的所有数据进行计算。 最小设置为1，最大为 calibration_data中的数据数量。</td><td><strong>取值范围</strong>：大于0，小于等于calibration_data中数据的总数。<br> <strong>默认配置</strong>：None 。</td><td>可选</td></tr><tr><td><code>verbose 或 -v</code></td><td><strong>参数作用</strong>：选择是否将信息打印在终端上。<br><strong>参数说明</strong>：若为True，则将量化敏感度信息打印在终端上。若metrics包含多种度量方式，则按照第一位进行排序。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr><tr><td><code>interested_nodes 或 -i</code></td><td><strong>参数作用</strong>：设置感兴趣节点。<br><strong>参数说明</strong>：若指定则只获取该节点的量化敏感度，其余节点不获取。同时，若该参数被指定，将忽视node_type指定的节点类型，也就是说该参数的优先级要高于node_type。若保持默认参数None，则计算模型中所有可被量化节点的量化敏感度。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>dis_nodes_list 或 -dnl</code></td><td><strong>参数作用</strong>：指定需要分析的节点。<br><strong>参数说明</strong>：指定需要分析的节点。<br>若nodes_list中的节点类型为： <br>- 权重校准节点：绘制原始权重和经过校准之后的权重的数据分布。<br>- 激活校准节点：绘制激活校准节点的输入数据分布。<br>- 普通节点：绘制该节点在量化前后的输出数据分布，同时绘制二者之间的误差分布。 <br>注：nodes_list为 list 类型，可指定一系列节点，并且上述三种类型节点可同时指定。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>cw_nodes_list 或 -cn</code></td><td><strong>参数作用</strong>：指定校准节点。<br><strong>参数说明</strong>：指定校准节点。</td><td><strong>取值范围</strong>：校准模型中的所有权重校准节点和激活校准节点。<br> <strong>默认配置</strong>：无。</td><td>可选</td></tr><tr><td><code>axis 或 -a</code></td><td><strong>参数作用</strong>：指定channel所在的维度。 <br><strong>参数说明</strong>：channel信息所在shape中的位置。参数默认为None，此时对于激活校准节点，默认认为节点输入数据的第二个维度表示channel信息，即axis=1；对于权重校准节点，会读取该节点属性中的axis参数作为channel信息。</td><td><strong>取值范围</strong>：小于节点输入数据的维度。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>quantize_node 或 -qn</code></td><td><strong>参数作用</strong>：只量化模型中指定的节点，查看误差累积曲线。<br><strong>参数说明</strong>：可选参数。指定模型中需要量化的节点，同时保证其余节点均不量化。<br>通过判断该参数是否为嵌套列表进而决定是单节点量化还是部分量化。<br>例如：<br>- quantize_node=[&#x27;Conv_2&#x27;,&#x27;Conv_9&#x27;]：分别只量化Conv_2和Conv_9，同时保证其余节点不量化。<br>- quantize_node=[[&#x27;Conv_2&#x27;],[&#x27;Conv_9&#x27;,&#x27;Conv_2&#x27;]]：只量化Conv_2以及同时量化Conv_2和Conv_9，分别测试模型累积误差。 <br>- quantize_node 包含两个特殊参数：&#x27;weight&#x27; 和 &#x27;activation&#x27;。<br>当：<br>- quantize_node = [&#x27;weight&#x27;]：只量化权重，不量化激活。<br>- quantize_node = [&#x27;activation&#x27;]：只量化激活，不量化权重。<br>- quantize_node = [&#x27;weight&#x27;,&#x27;activation&#x27;]：权重和激活分别量化。<br>注：quantize_node和non_quantize_node不可同时为None，必须指定其一。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>non_quantize_node 或 -nqn</code></td><td><strong>参数作用</strong>：指定累积误差的类型。<br><strong>参数说明</strong>：可选参数。指定模型中不量化的节点，同时保证其余节点全都量化。<br>通过判断该参数是否为嵌套列表进而决定是单节点不量化还是部分量化。<br>例如：<br>- non_quantize_node=[&#x27;Conv_2&#x27;,&#x27;Conv_9&#x27;]：分别解除Conv_2和Conv_9节点的量化，同时保证其余节点全部量化。<br>- non_quantize_node=[[&#x27;Conv_2&#x27;],[&#x27;Conv_9&#x27;,&#x27;Conv_2&#x27;]]：只解除Conv_2量化以及同时解除Conv_2和Conv_9量化，分别测试模型累积误差。 <br>注：quantize_node和non_quantize_node不可同时为None，必须指定其一。</td><td><strong>取值范围</strong>：校准模型中的所有节点。<br> <strong>默认配置</strong>：None。</td><td>可选</td></tr><tr><td><code>ae_metric 或 -am</code></td><td><strong>参数作用</strong>：累积误差度量方式。<br><strong>参数说明</strong>：设置计算模型误差的计算方式。</td><td><strong>取值范围</strong>：<code>&#x27;cosine-similarity&#x27;</code> , <code>&#x27;mse&#x27;</code> , <code>&#x27;mre&#x27;</code> , <code>&#x27;sqnr&#x27;</code> , <code>&#x27;chebyshev&#x27;</code> <br> <strong>默认配置</strong>：<code>&#x27;cosine-similarity&#x27;</code>。</td><td>可选</td></tr><tr><td><code>average_mode 或 -avm</code></td><td><strong>参数作用</strong>：指定累积误差曲线的输出模式。<br><strong>参数说明</strong>：默认为False。若为True，那么获取累积误差的平均值作为结果。</td><td><strong>取值范围</strong>：<code>True</code> 、 <code>False</code>。<br> <strong>默认配置</strong>：<code>False</code>。</td><td>可选</td></tr></tbody></table>
<p>API使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 导入debug模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import horizon_nn.debug as dbg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbg.runall(model_or_file=&#x27;calibrated_model.onnx&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             calibrated_data=&#x27;calibration_data&#x27;)</span><br></span></code></pre></div></div>
<p>命令行使用方法：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hmct-debugger runall calibrated_model.onnx calibration_data</span><br></span></code></pre></div></div>
<p>runall流程：</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/runall.png" alt="runall" class="img_ev3q"></p>
<p>当所有参数保持默认时，工具会依次执行以下功能：</p>
<p>1.分别获取权重校准节点和激活校准节点的量化敏感度.</p>
<p>2.根据step1的结果，分别取权重校准节点的top5和激活校准节点的top5绘制其数据分布。</p>
<p>3.针对step2获取的节点，分别绘制其通道间数据分布的箱线图。</p>
<p>4.绘制分别只量化权重和只量化激活的累积误差曲线。</p>
<p>当指定 <code>node_type=&#x27;node&#x27;</code> 时，工具会获取top5节点，并分别找到每个节点对应的校准节点，并获取校准节点的数据分布和箱线图。</p>
<p>根据以往的使用调优经验，以上策略已经可以应对各种实际问题。</p>
<p>如果经过以上尝试仍然未能解决您的问题，请根据<a href="/rdk_doc/FAQ/toolchain#checklist"><strong>精度调优checklist</strong></a>文档步骤填写模型配置的具体信息来进行检查，确保每一步排查都已完成，并根据checklist锁定是在模型转换的那个具体步骤出现异常，然后将填写完整的 <strong>精度调优checklist</strong> 信息、原始f浮点模型文件、模型量化相关的配置文件等一起反馈给D-Robotics 技术支持团队或在<a href="https://developer.d-robotics.cc/" target="_blank" rel="noopener noreferrer"><strong>D-Robotics 官方技术社区</strong></a>提出您的问题，我们将在24小时内给您提供支持。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="其它工具使用说明">其它工具使用说明<a href="#其它工具使用说明" class="hash-link" aria-label="其它工具使用说明的直接链接" title="其它工具使用说明的直接链接">​</a></h3>
<p>本章节主要介绍模型转换工具以外的其他debug工具的使用方法，这些工具可以协助开发者进行模型修改、模型分析、数据预处理等操作，工具列表如下：</p>
<ul>
<li>
<p>hb_perf</p>
</li>
<li>
<p>hb_pack</p>
</li>
<li>
<p>hb_model_info</p>
</li>
<li>
<p>hb_model_modifier</p>
</li>
<li>
<p>hb_model_verifier</p>
</li>
<li>
<p>hb_eval_preprocess</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_perf-工具"><code>hb_perf</code> 工具<a href="#hb_perf-工具" class="hash-link" aria-label="hb_perf-工具的直接链接" title="hb_perf-工具的直接链接">​</a></h4>
<p><code>hb_perf</code> 是用于分析D-Robotics 量化混合模型性能的分析工具。</p>
<ul>
<li>使用方法</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_perf [OPTIONS] BIN_FILE</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_perf的命令行参数:</p>
<p>--version<br>
显示版本并退出。</p>
<p>-m<br>
后接模型名称。当指定BIN_FILE为pack模型时, 仅输出指定模型的模型编译信息。</p>
<p>--help<br>
显示帮助信息。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p>模型的信息会输出在当前目录的 <code>hb_perf_result</code> 文件夹中。
其中会有以该模型为名的文件夹，该模型信息将会展示在以其模型名称命名的 <code>html</code> 文件中。目录结构如下示例所示:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_perf_result/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └── mobilenetv1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── mobilenetv1.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── MOBILENET_subgraph_0.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── MOBILENET_subgraph_0.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └── temp.hbm</span><br></span></code></pre></div></div>
<p>若该模型在编译时未设置为debug模式(<code>compiler_parameters.debug:True</code>) 则 <code>hb_perf</code> 工具会产生如下提示，
该提示仅表明子图信息中不包括逐层信息, 对模型整体信息的生成没有影响。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-12 10:41:40,000 WARNING bpu model don&#x27;t have per-layer perf info.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-12 10:41:40,000 WARNING if you need per-layer perf info please enable[compiler_parameters.debug:True] when use makertbin.</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_pack-工具"><code>hb_pack</code> 工具<a href="#hb_pack-工具" class="hash-link" aria-label="hb_pack-工具的直接链接" title="hb_pack-工具的直接链接">​</a></h4>
<p><code>hb_pack</code> 是用于将多个混合模型(*.bin)文件打包为一个模型文件的工具  。</p>
<ul>
<li>使用方法</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_pack [OPTIONS] BIN_FILE1 BIN_FILE2 BIN_FILE3 -o comb.bin</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_pack的命令行参数</p>
<p>--version<br>
显示版本并退出。</p>
<p>-o, --output_name<br>
pack模型的输出名称</p>
<p>--help<br>
显示帮助信息。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p>打包的模型会输出在当前目录文件夹中，该模型会被命名为 <code>output_name</code> 指定名称。
该打包模型中所有子模型的编译信息及性能信息均可通过 <code>hb_model_info</code> 及 <code>hb_perf</code> 获取得到。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>注意，<code>hb_pack</code> 不支持对已经打包的模型再次进行打包，否则工作台将会产生以下提示：</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ERROR exception in command: pack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR model: xxx.bin is a packed model, it can not be packed again!</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_model_info-工具"><code>hb_model_info</code> 工具<a href="#hb_model_info-工具" class="hash-link" aria-label="hb_model_info-工具的直接链接" title="hb_model_info-工具的直接链接">​</a></h4>
<p><code>hb_model_info</code> 是用于解析混合模型(*.bin)编译时的依赖及参数信息的工具。</p>
<ul>
<li>使用方法</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_info ${model_file}</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_model_info的命令行参数</p>
<p>--version<br>
显示版本并退出。</p>
<p>-m<br>
后接模型名称。当指定BIN_FILE为pack模型时, 仅输出指定模型的模型编译信息。</p>
<p>--help<br>
显示帮助信息。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p>输出部分将会是模型编译时的一些输入信息，如下所示：</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>以下代码块中的版本号信息将随发布包版本变化，此处仅为示例。</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Start hb_model_info....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_model_info version 1.3.35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">******** efficient_det_512x512_nv12 info *********</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############# model deps info #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_mapper version   : 1.3.35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hbdk version        : 3.23.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hbdk runtime version: 3.13.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">horizon_nn version  : 0.10.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############# model_parameters info #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">onnx_model          : /release/01_common/model_zoo/mapper/detection/efficient_det/efficientdet_nhwc.onnx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BPU march           : bernoulli2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">layer_out_dump      : False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">working dir         : /release/04_detection/05_efficient_det/mapper/model_output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output_model_file_prefix: efficient_det_512x512_nv12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############# input_parameters info #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------input info : data ---------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_name          : data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_type_rt       : nv12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_space&amp;range   : regular</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_layout_rt     : None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_type_train    : rgb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_layout_train  : NCHW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">norm_type           : data_mean_and_scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_shape         : 1x3x512x512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_value          : 123.68,116.779,103.939,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scale_value         : 0.017,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cal_data_dir        : /release/04_detection/05_efficient_det/mapper/calibration_data_rgb_f32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------input info : data end -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############# calibration_parameters info #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preprocess_on       : False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calibration_type    : max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############# compiler_parameters info #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hbdk_pass_through_params: --fast --O3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input-source        : {&#x27;data&#x27;: &#x27;pyramid&#x27;, &#x27;_default_value&#x27;: &#x27;ddr&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------- input/output types -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model input types   : [&lt;InputDataType.NV12: 7&gt;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model output types  : [&lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataTye.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InputDataType.F32: 5&gt;, &lt;InpuDataType.F32: 5&gt;]</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>当模型中存在被删除节点时，模型信息输出末尾会打印被删除节点的名称，同时会生成 <code>deleted_nodes_info.txt</code> 文件，文件中每一行记录了对应被删除节点的初始信息。打印被删除节点的名称如下所示：</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--------- deleted nodes -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv91_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv95_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv99_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv103_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv107_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv93_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv97_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv101_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv105_fwd_chw_HzDequantize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: spconvretinanethead0_conv109_fwd_chw_HzDequantize</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_model_modifier-工具"><code>hb_model_modifier</code> 工具<a href="#hb_model_modifier-工具" class="hash-link" aria-label="hb_model_modifier-工具的直接链接" title="hb_model_modifier-工具的直接链接">​</a></h4>
<p><code>hb_model_modifier</code> 工具用于对 <code>*.bin</code> 模型中输入端的Transpose、Quantize节点和输出端的Transpose、Dequanti、Cast、Reshape、Softmax节点进行删除操作，
并将删除节点的信息存放在BIN模型中，可以通过 <code>hb_model_info</code> 进行查看。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><ol>
<li>hb_model_modifier工具只能删除紧挨着模型输入或输出的节点。如果待删除节点后面接的是其他节点，则不能进行删除操作。</li>
<li>模型节点名称需要注意不要包括 &quot;;&quot; &quot;,&quot; 等特殊符号，否则可能会影响工具的使用。</li>
<li>工具不支持对打包的模型进行处理，否则将提示： <code>ERROR pack model is not supported</code>。</li>
<li>待删除节点会按顺序依次删除, 并 且会动态更新模型结构; 同时在节点删除前还会判断该节点是否位于模型的输入输出处, 因此节点的删除顺序很重要。</li>
</ol></div></div>
<p>由于删除特定节点后会对模型的输入情况有影响, 因此工具只对模型输入后只有一条通路的情况适用, 若如下图中所示, 同一输入对应了多个节点的情况尚不支持。</p>
<p><img decoding="async" loading="lazy" src="https://rdk-doc.oss-cn-beijing.aliyuncs.com/doc/img/07_Advanced_development/04_toolchain_development/intermediate/hb_model_modifier.png" alt="hb_model_modifier" class="img_ev3q"></p>
<ul>
<li>使用方式</li>
</ul>
<ol>
<li>查看可删除的节点：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin</span><br></span></code></pre></div></div>
<ol start="2">
<li>删除单个指定节点（以node1为例）：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin -r node1</span><br></span></code></pre></div></div>
<ol start="3">
<li>删除多个指定节点（以node1、node2、node3为例）：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin -r node1 -r node2 -r node3</span><br></span></code></pre></div></div>
<ol start="4">
<li>删除某类节点（以Dequantize为例）：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin --all Dequantize</span><br></span></code></pre></div></div>
<ol start="5">
<li>删除多种类型节点（以Reshape、Cast、Dequantize为例）：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin -a Reshape -a Cast -a Dequantize</span><br></span></code></pre></div></div>
<ol start="6">
<li>组合使用：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_modifier model.bin -a Reshape -a Cast -a Dequantize -r node1 -r node2 -r node3</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_model_modifier的命令行参数</p>
<p>--model_file<br>
runtime 模型文件名称。</p>
<p>-r<br>
后接指定删除节点的名称。若有多个节点需要删除, 需要指定多次。</p>
<p>-o<br>
后接修改后的模型输出名称(仅在有 <code>-r</code> 参数时生效)。</p>
<p>-a --all<br>
后接节点类型. 支持一键删除所有对应类型的功能. 若有多个类型节点需要删除, 需要指定多次。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p>若工具后不接任何参数，则工具会打印出可供候选的可删除节点（即模型中的位于输入输出位置的所有Transpose、Quantize、Dequantize、Cast、Reshape、Softmax节点）。</p>
<p>其中Quantize节点用于将模型 float 类型的输入数据量化至 int8 类型，其计算公式如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  qx = clamp(round(x / scale) + zero\_point, -128, 127)</span><br></span></code></pre></div></div>
<p><code>round(x)</code> 实现浮点数的四舍五入， <code>clamp(x)</code> 函数实现将数据钳位在-128~127之间的整数数值。 <code>zero_point</code> 为非对称量化零点偏移值，对称量化时 <code>zero_point = 0</code> 。</p>
<p>C++的参考实现如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token plain"> quantized_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">double</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  quantized_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quantized_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> min_int_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_int_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Dequantize节点则用于将模型 <code>int8</code> 或 <code>int32</code> 类型的输出数据反量化回 <code>float</code> 或 <code>double</code> 类型，其计算公式如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  deqx = (x - zero\_point) * scale</span><br></span></code></pre></div></div>
<p>C++的参考实现如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> scale</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>目前工具支持删除：</p><ol>
<li>输入部位的节点为Quantize或Transpose节点；</li>
<li>输出部位的节点为Transpose、Dequanti、Cast、Reshape、Softmax节点。</li>
</ol></div></div>
<p>工具打印信息如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_model_modifier resnet50_64x56x56_featuremap.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-04-21 18:22:30,207 INFO Nodes that can be deleted: [&#x27;data_res2a_branch1_HzQuantize_TransposeInput0&#x27;, &#x27;fc1000_reshape_0&#x27;]</span><br></span></code></pre></div></div>
<p>在指定 <code>-r</code> 选项后，工具会打印模型中该节点的类型，储存在bin文件中的节点信息以及告知指定节点已被删除：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_model_modifier resnet50_64x56x56_featuremap.bin -r data_res2a_branch1_HzQuantize_TransposeInput0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node &#x27;data_res2a_branch1_HzQuantize_TransposeInput0&#x27; found, its OP type is &#x27;Transpose&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node &#x27;data_res2a_branch1_HzQuantize_TransposeInput0&#x27; is removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modified model saved as resnet50_64x56x56_featuremap_modified.bin</span><br></span></code></pre></div></div>
<p>之后可以通过 <code>hb_model_info</code> 工具查看被删除节点信息，输出信息末尾会打印被删除节点的名称，同时会生成 <code>deleted_nodes_info.txt</code> 文件，文件中每一行记录了对应被删除节点的初始信息。打印被删除节点的名称如下所示：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hb_model_info resnet50_64x56x56_featuremap_modified.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start hb_model_info....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hb_model_info version 1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">********* resnet50_64x56x56_featuremap info *********</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------- deleted nodes -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deleted nodes: data_res2a_branch1_HzQuantize_TransposeInput0</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_model_verifier-工具"><code>hb_model_verifier</code> 工具<a href="#hb_model_verifier-工具" class="hash-link" aria-label="hb_model_verifier-工具的直接链接" title="hb_model_verifier-工具的直接链接">​</a></h4>
<p><code>hb_model_verifier</code> 工具是用于对指定的定点模型和runtime模型进行结果验证的工具。
该工具会使用指定图片，进行定点模型推理，runtime模型板端和x86端模拟器上的推理， runtime模型在板端的推理(如果给定ip可以ping通且板端已经安装 <code>hrt_tools</code>, 若无则可以使用工具链SDK包中 <code>package/board</code> 下的 <code>install.sh</code> 脚本进行安装) runtime模型在x86端的推理(确保host端已经安装 <code>hrt_tools</code>,
若无则可以使用工具链SDK包中 <code>package/host</code> 下的 <code>install.sh</code> 脚本进行安装)， 并对其三方的结果进行两两比较，给出是否通过的结论。 若未指定图片，则工具会用默认图片进行推理(featuremap模型会随机生成tensor数据)。</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p><code>package</code> 资料包获取方式，请参考<a href="#deliverables_instructions"><strong>交付物说明</strong></a>。</p></div></div>
<ul>
<li>使用方式</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_model_verifier -q ${quanti_model} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -b ${bin_model} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -a ${board_ip} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -i ${input_img} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -d ${digits}</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_model_verifier的命令行参数</p>
<p>-quanti_model, -q<br>
定点模型名称。</p>
<p>--bin_model, -b<br>
bin模型名称。</p>
<p>--arm-board-ip, -a<br>
上板测试使用的arm board ip地址。</p>
<p>--input-img, -i<br>
推理测试时使用的图片。 若不指定则会使用默认图片或随机tensor。 对于二进制形式的图片文件需要后缀名为 <code>.bin</code> 形式。</p>
<p>--compare_digits, -d<br>
比较推理结果数值精度，若不指定则会默认比较小数点后五位。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p>结果对比最终会在终端展示, 工具会对比ONNX模型运行结果, 模拟器运行及上板结果的两两对比情况, 若无问题应显示如下:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  Quanti onnx and Arm result Strict check PASSED</span><br></span></code></pre></div></div>
<p>在定点模型和runtime模型精度不一致时会输出不一致结果的具体信息。</p>
<p><code>mismatch line num</code> 为两种模型精度不一致结果的个数，包括三种不一致情况：</p>
<p><code>mismatch.line_miss num</code> 为输出结果数量不一致个数；
<code>mismatch.line_diff num</code> 为输出结果差距过大个数；
<code>mismatch.line_nan num</code> 为输出为nan的个数。</p>
<p><code>total line num</code> 为输出数据总个数。</p>
<p><code>mismatch rate</code> 为不一致数据个数占输出数据总个数的比例。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  INFO mismatch line num: 39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO ****************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO mismatch.line_miss num: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO mismatch.line_diff num: 39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO mismatch.line_nan num: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO ****************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO total line num: 327680</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INFO mismatch rate: 0.0001190185546875</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><ol>
<li><code>hb_model_verifier</code> 目前只支持单输入模型。</li>
<li>若模型有多个输出，则只会比较第一个输出的结果情况。</li>
<li>暂时不支持对已打包的*.bin模型进行验证，否则工作台将产生以下提示：</li>
</ol></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ERROR pack model is not supported</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hb_eval_preprocess"><code>hb_eval_preprocess</code> 工具<a href="#hb_eval_preprocess" class="hash-link" aria-label="hb_eval_preprocess的直接链接" title="hb_eval_preprocess的直接链接">​</a></h4>
<p>用于对模型精度进行评估时，在x86环境下对图片数据进行预处理。
所谓预处理是指图片数据在送入模型之前的特定处理操作。
比如：图片resize、crop和padding等。</p>
<ul>
<li>使用方法</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  hb_eval_preprocess [OPTIONS]</span><br></span></code></pre></div></div>
<ul>
<li>命令行参数</li>
</ul>
<p>hb_eval_preprocess的命令行参数</p>
<p>--version<br>
显示版本并退出。</p>
<p>-m, --model_name<br>
设置模型名称，支持的模型范围可通过 <code>hb_eval_preprocess --help</code> 查看。</p>
<p>-i, --image_dir<br>
输入图片路径。</p>
<p>-o, --output_dir<br>
输出路径。</p>
<p>-v, --val_txt<br>
设置评测所需图片的文件名称，预处理生成的图片将于此文件中的图片名称对应。</p>
<p>-h, --help<br>
显示帮助信息。</p>
<ul>
<li>输出内容说明</li>
</ul>
<p><code>hb_eval_preprocess</code> 命令将会在 <code>--output_dir</code> 指定的路径下生成图片二进制文件。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小技巧</div><div class="admonitionContent_BuS1"><p>更多关于 <code>hb_eval_preprocess</code> 工具在上板模型精度评估中的应用示例请参见嵌入式应用开发《公版模型评测说明》中的
<a href="/rdk_doc/Advanced_development/toolchain_development/intermediate/runtime_sample#data_preprocess"><strong>数据预处理</strong></a> 一节内容。</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2025-09-10T12:27:17.000Z" itemprop="dateModified">2025年9月10日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/environment_config"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">环境安装</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rdk_doc/Advanced_development/toolchain_development/intermediate/supported_op_list"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">模型算子支持列表</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#PTQ_introduction" class="table-of-contents__link toc-highlight">简介</a></li><li><a href="#model_preparation" class="table-of-contents__link toc-highlight">模型准备</a></li><li><a href="#model_check" class="table-of-contents__link toc-highlight">模型验证</a><ul><li><a href="#使用-hb_mapper-checker-工具验证模型" class="table-of-contents__link toc-highlight">使用 <code>hb_mapper checker</code> 工具验证模型</a></li><li><a href="#检查异常处理" class="table-of-contents__link toc-highlight">检查异常处理</a></li><li><a href="#check_result" class="table-of-contents__link toc-highlight">检查结果解读</a></li><li><a href="#检查结果的调优指导" class="table-of-contents__link toc-highlight">检查结果的调优指导</a></li></ul></li><li><a href="#model_conversion" class="table-of-contents__link toc-highlight">模型转换</a><ul><li><a href="#准备校准数据" class="table-of-contents__link toc-highlight">准备校准数据</a></li><li><a href="#makertbin" class="table-of-contents__link toc-highlight">使用 hb_mapper makertbin 工具转换模型</a></li><li><a href="#yaml_config" class="table-of-contents__link toc-highlight">模型转换yaml配置参数说明</a><ul><li><a href="#int16_config" class="table-of-contents__link toc-highlight">RDK Ultra 和 RDK X5 int16配置说明</a></li><li><a href="#pre_process" class="table-of-contents__link toc-highlight">预处理HzPreprocess算子说明</a></li></ul></li><li><a href="#conversion_interpretation" class="table-of-contents__link toc-highlight">转换内部过程解读</a></li><li><a href="#转换结果解读" class="table-of-contents__link toc-highlight">转换结果解读</a></li><li><a href="#conversion_output" class="table-of-contents__link toc-highlight">转换产出物解读</a></li></ul></li><li><a href="#performance_evaluation" class="table-of-contents__link toc-highlight">模型性能分析</a><ul><li><a href="#hb_perf" class="table-of-contents__link toc-highlight">开发机评测性能</a></li><li><a href="#开发板实测性能" class="table-of-contents__link toc-highlight">开发板实测性能</a></li><li><a href="#模型性能优化" class="table-of-contents__link toc-highlight">模型性能优化</a><ul><li><a href="#检查影响模型性能的yaml参数" class="table-of-contents__link toc-highlight">检查影响模型性能的yaml参数</a></li><li><a href="#处理cpu算子" class="table-of-contents__link toc-highlight">处理CPU算子</a></li><li><a href="#高性能模型设计建议" class="table-of-contents__link toc-highlight">高性能模型设计建议</a></li></ul></li></ul></li><li><a href="#accuracy_evaluation" class="table-of-contents__link toc-highlight">模型精度分析</a><ul><li><a href="#精度分析" class="table-of-contents__link toc-highlight">精度分析</a></li><li><a href="#精度调优" class="table-of-contents__link toc-highlight">精度调优</a><ul><li><a href="#精度有明显损失4以上" class="table-of-contents__link toc-highlight">精度有明显损失（4%以上）</a></li><li><a href="#较小精度损失提升" class="table-of-contents__link toc-highlight">较小精度损失提升</a></li><li><a href="#精度debug工具" class="table-of-contents__link toc-highlight">精度Debug工具</a></li></ul></li></ul></li><li><a href="#其它工具使用说明" class="table-of-contents__link toc-highlight">其它工具使用说明</a><ul><li><a href="#hb_perf-工具" class="table-of-contents__link toc-highlight"><code>hb_perf</code> 工具</a></li><li><a href="#hb_pack-工具" class="table-of-contents__link toc-highlight"><code>hb_pack</code> 工具</a></li><li><a href="#hb_model_info-工具" class="table-of-contents__link toc-highlight"><code>hb_model_info</code> 工具</a></li><li><a href="#hb_model_modifier-工具" class="table-of-contents__link toc-highlight"><code>hb_model_modifier</code> 工具</a></li><li><a href="#hb_model_verifier-工具" class="table-of-contents__link toc-highlight"><code>hb_model_verifier</code> 工具</a></li><li><a href="#hb_eval_preprocess" class="table-of-contents__link toc-highlight"><code>hb_eval_preprocess</code> 工具</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">友情链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.guyuehome.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">古月居<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/D-Robotics" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://space.bilibili.com/437998606" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiLiBiLi<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 D-Robotics.</div></div></div></footer></div>
</body>
</html>